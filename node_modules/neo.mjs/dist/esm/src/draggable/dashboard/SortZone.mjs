import e from"../../component/Base.mjs";import t from"../../manager/DragCoordinator.mjs";import o from"../DragProxyContainer.mjs";import r from"../../util/Array.mjs";import i from"../../util/Rectangle.mjs";import a from"../container/SortZone.mjs";import n from"../../util/VDom.mjs";export default Neo.setupClass(class extends a{static config={className:"Neo.draggable.dashboard.SortZone",ntype:"dashboard-sortzone",dragHandleSelector:".neo-draggable",dragProxyExtraCls:[],sortGroup:null};isRemoteDragging=!1;construct(e){super.construct(e),t.register(this)}acceptsRemoteDrag(e,t){let o=this;return o.ownerRect?e>=o.ownerRect.x&&e<=o.ownerRect.x+o.ownerRect.width&&t>=o.ownerRect.y&&t<=o.ownerRect.y+o.ownerRect.height:(o.isFetchingRect||(o.isFetchingRect=!0,o.owner.getDomRect([o.owner.id]).then(e=>{o.ownerRect=e[0],o.isFetchingRect=!1})),!1)}applyAbsolutePositioning(){let e,t=this;t.sortableItems.forEach((o,r)=>{let i=t.itemRects[r];e=o.wrapperStyle||{},t.adjustProxyRectToParent?.(i,t.ownerRect),console.log("applyAbsolutePositioning",{height:`${i.height}px`,left:`${i.left}px`,top:`${i.top}px`,width:`${i.width}px`}),o.wrapperStyle=Object.assign(e,{flex:"none",height:`${i.height}px`,left:`${i.left}px`,margin:"0px",position:"absolute",top:`${i.top}px`,width:`${i.width}px`})})}calculateExpandedLayout(){let e=this,t=e.ownerRect,o="horizontal"===e.sortDirection,r=o?t.width:t.height,i=[],a=0,n=0,s=[],l=0,d=0,c=0,g=0,h=0,p=0,m=0,w=e.adjustItemRectsToParent?0:t.x,x=e.adjustItemRectsToParent?0:t.y;if(e.itemRects.length>0){let i=e.itemRects[0],a=e.itemRects[e.itemRects.length-1];if(o){if(l=e.adjustItemRectsToParent?i.x:i.x-t.x,d=r-(e.adjustItemRectsToParent?a.x+a.width:a.x-t.x+a.width),g=e.adjustItemRectsToParent?i.y:i.y-t.y,h=t.height-(e.adjustItemRectsToParent?i.y+i.height:i.y-t.y+i.height),e.itemRects.length>1){let t=e.itemRects[1];c=t.x-(i.x+i.width)}}else if(l=e.adjustItemRectsToParent?i.y:i.y-t.y,d=r-(e.adjustItemRectsToParent?a.y+a.height:a.y-t.y+a.height),p=e.adjustItemRectsToParent?i.x:i.x-t.x,m=t.width-(e.adjustItemRectsToParent?i.x+i.width:i.x-t.x+i.width),e.itemRects.length>1){let t=e.itemRects[1];c=t.y-(i.y+i.height)}}for(let t=0;t<e.itemRects.length;t++){let r=e.indexMap[t];if(-1===r)continue;let s=e.owner.items[r];if(s===e.dragPlaceholder||s===e.dragComponent)continue;let l=e.itemRects[t];if(i.push({item:s,rect:l}),s.flex)a+=s.flex;else{n+=o?l.width:l.height}}let R=Math.max(0,i.length-1),y=Math.max(0,r-l-d-R*c-n),f=l;return i.forEach(({item:e,rect:r},i)=>{let n,l={};n=e.flex?e.flex/a*y:o?r.width:r.height,l=o?{left:`${w+f}px`,top:`${x+g}px`,height:t.height-g-h+"px",width:`${n}px`}:{left:`${w+p}px`,top:`${x+f}px`,height:`${n}px`,width:t.width-p-m+"px"},s.push({item:e,style:l}),f+=n+c}),s}destroy(){t.unregister(this),super.destroy()}getDragProxyConfig(){const e=super.getDragProxyConfig();return e.cls=e.cls.filter(e=>!e.includes("neo-viewport")),r.add(e.cls,this.dragProxyExtraCls),e}async onDragEnd(e){let o=this;o.isRemoteDragging||t.onDragEnd({draggedItem:o.dragComponent,sourceSortZone:o}),super.onDragEnd(e)}async onDragMove(e){let t=this;t.itemRects&&t.boundaryContainerRect&&!t.isScrolling&&await super.onDragMove(e)}async onRemoteDragLeave(e){let t=this;t.isRemoteDragging&&(t.isRemoteDragging=!1,await t.onDragEnd({}))}async onRemoteDragMove(e){let t=this;t.isRemoteDragging||await t.startRemoteDrag(e),t.onDragMove({clientX:e.localX,clientY:e.localY,proxyRect:e.proxyRect}),t.dragMove({clientX:e.localX,clientY:e.localY},!0)}async onRemoteDrop(e){let t=this,o=t.currentIndex;if(t.isRemoteDragging){await t.onDragEnd({});const r=e.parentId;r&&"document.body"!==r&&Neo.getComponent(r)?.remove(e,!1),t.owner.insert(o,e),t.isRemoteDragging=!1}}onRemoteDropOut(e){let t=this;if(t.owner.detachedItems)for(const[o,r]of t.owner.detachedItems.entries())if(r.widget===e){t.owner.detachedItems.delete(o);break}}onWindowDragContinue(e,o){let r=this;t.onDragMove({draggedItem:r.dragComponent,offsetX:r.offsetX,offsetY:r.offsetY,proxyRect:o.proxyRect,screenX:o.screenX,screenY:o.screenY,sourceSortZone:r})}resumeWindowDrag(e,t){this.owner.resumeWindowDrag(e,t)}async setupDragState(e){let t,o,r,i,a=this,{adjustItemRectsToParent:s,owner:l}=a,d=a.itemStyles=[],{layout:c}=l,g=l.style||{};i=l.items.filter(e=>!e.isDestroyed),t=i.indexOf(e),o={},Object.assign(a,{currentIndex:t,dragElement:n.find(l.vdom,e.id).vdom,dragProxyConfig:a.getDragProxyConfig(),indexMap:o,ownerStyle:{height:g.height,minWidth:g.minWidth,width:g.width},reversedLayoutDirection:"column-reverse"===c.direction||"row-reverse"===c.direction,sortableItems:i,sortDirection:c.direction?.includes("column")?"vertical":"horizontal",startIndex:t}),a.dragComponent=e,i.forEach((e,t)=>{o[t]=l.items.indexOf(e),d.push({height:e.height?`${e.height}px`:e.style?.height,width:e.width?`${e.width}px`:e.style?.width})}),r=await l.getDomRect([l.id].concat(i.map(e=>e.id))),r.forEach(e=>{console.log("itemRect",{height:`${e.height}px`,left:`${e.left}px`,top:`${e.top}px`,width:`${e.width}px`})}),a.ownerRect=r.shift(),a.boundaryContainerRect=a.ownerRect,l.style={...g,height:`${a.ownerRect.height}px`,minWidth:`${a.ownerRect.width}px`,width:`${a.ownerRect.width}px`},console.log("adjustItemRectsToParent",s),s&&r.forEach(e=>{e.x-=a.ownerRect.x,e.y-=a.ownerRect.y}),a.itemRects=r}async startRemoteDrag(t){let r,i=this,{owner:a}=i,{proxyRect:n}=t,s=t.draggedItem;i.isRemoteDragging=!0,i.dragElementRect={height:n.height,width:n.width,x:t.localX,y:t.localY,left:t.localX,top:t.localY},s.appName=i.appName,console.log("startRemoteDrag",s.id,s.windowId,s.parentId,s.parentComponent),s.parentId=null,s.parentComponent=null,s.mounted=!1,s.vnode=null,s.vnodeInitialized=!1,console.log("parent cleared:",s.parentId,s.parentComponent);let l=await a.getDomRect([a.id]);i.ownerRect=l[0],console.log("ownerRect",i.ownerRect),i.offsetX=t.offsetX,i.offsetY=t.offsetY,console.log("startRemoteDrag: ownerRect",i.ownerRect),console.log("startRemoteDrag: local coords",t.localX,t.localY),console.log("startRemoteDrag: calculated coords",t.localX-i.offsetX,t.localY-i.offsetY),r={module:o,appName:i.appName,cls:["neo-dragproxy",...i.owner.cls],items:[s],moveInMainThread:!1,windowId:i.windowId,style:{left:t.localX-i.offsetX+"px",top:t.localY-i.offsetY+"px"}},console.log("Creating local drag proxy",r),i.dragProxy=Neo.create(r),console.log("Created local drag proxy",i.dragProxy),i.dragPlaceholder=Neo.create({module:e,flex:"none",style:{height:`${n.height}px`,visibility:"hidden"}}),a.add(i.dragPlaceholder),await i.timeout(50),await i.setupDragState(i.dragPlaceholder);let d=i.sortableItems.indexOf(i.dragPlaceholder);if(d>-1){let e=i.itemRects[d];i.dragProxy.width=e.width,i.dragProxy.height=e.height}await i.timeout(50),i.applyAbsolutePositioning()}startWindowDrag(e){let t=this,{popupHeight:o,popupWidth:r,windowName:i}=e;t.dragProxy.style={opacity:0},t.isWindowDragging=!0,t.dragPlaceholder&&(t.dragPlaceholder.wrapperStyle={...t.dragPlaceholder.wrapperStyle,visibility:"hidden"}),t.calculateExpandedLayout().forEach(({item:e,style:t})=>{e.wrapperStyle={...e.wrapperStyle,...t}}),Neo.main.addon.DragDrop.startWindowDrag({popupHeight:o,popupName:i,popupWidth:r,windowId:t.windowId})}suspendWindowDrag(e){this.owner.suspendWindowDrag(e)}});