import t from"./DragZone.mjs";import e from"../../util/VDom.mjs";export default Neo.setupClass(class extends t{static config={className:"Neo.draggable.toolbar.SortZone",ntype:"toolbar-sortzone",adjustItemRectsToParent:!1,alwaysFireDragMove:!0,currentIndex:-1,indexMap:null,itemMargin:null,itemRects:null,itemStyles:null,ownerRect:null,ownerStyle:null,reversedLayoutDirection:!1,scrollLeft:0,scrollTop:0,sortDirection:"horizontal",startIndex:-1};isOverDragging=!1;moveTo(t,e){this.owner.moveTo(t,e)}async onDragEnd(t){let e,i=this,{itemStyles:r,owner:n}=i,o=n.style||{};await i.timeout(10),n.sortable&&(o.height=i.ownerStyle.height||null,o.minWidth=i.ownerStyle.minWidth||null,o.width=i.ownerStyle.width||null,n.style=o,n.items.forEach(((t,n)=>{e=t.wrapperStyle||{},Object.assign(e,{height:r[n].height||null,left:null,margin:null,position:null,top:null,width:r[n].width||null}),n===i.startIndex&&(e.visibility=null),t.wrapperStyle=e})),i.startIndex!==i.currentIndex&&i.moveTo(i.startIndex,i.currentIndex),Object.assign(i,{currentIndex:-1,indexMap:null,itemRects:null,itemStyles:null,ownerRect:null,startIndex:-1}),await i.timeout(30),i.dragEnd(t))}async onDragMove(t){if(!this.itemRects||this.isScrolling)return;let e,i,r,n,o,l,s=this,{clientX:a,clientY:d}=t,h=s.currentIndex,{itemRects:c}=s,u=c.length-1,g=s.adjustItemRectsToParent?s.ownerRect.x:0,w=s.adjustItemRectsToParent?s.ownerRect.y:0,m=s.reversedLayoutDirection;"horizontal"===s.sortDirection?(e=a-g+s.scrollLeft-s.offsetX-c[h].left,r=a>s.boundaryContainerRect.right,n=a<s.boundaryContainerRect.left,o="width"):(e=d-w+s.scrollTop-s.offsetY-c[h].top,r=d>s.boundaryContainerRect.bottom,n=d<s.boundaryContainerRect.top,o="height"),i=r||n,l=i?.02:.55,n?h>0&&(s.currentIndex--,await s.scrollToIndex(),s.switchItems(h,s.currentIndex)):r?h<u&&(s.currentIndex++,await s.scrollToIndex(),s.switchItems(h,s.currentIndex)):h>0&&(!m&&e<0||m&&e>0)?Math.abs(e)>c[h-1][o]*l&&(s.currentIndex--,s.switchItems(h,s.currentIndex)):h<u&&(!m&&e>0||m&&e<0)&&Math.abs(e)>c[h+1][o]*l&&(s.currentIndex++,s.switchItems(h,s.currentIndex)),s.isOverDragging=i&&0!==s.currentIndex&&s.currentIndex!==u,s.isOverDragging&&(await s.timeout(30),s.isOverDragging&&await s.onDragMove(t))}async onDragStart(t){let i,r,n,o,l=this,s=Neo.getComponent(t.path[0].id),{owner:a}=l,d=l.itemStyles=[],{layout:h}=a,c=a.style||{};a.sortable&&(i=a.indexOf(s.id),r={},Object.assign(l,{currentIndex:i,dragElement:e.find(a.vdom,s.id).vdom,dragProxyConfig:{...l.dragProxyConfig,cls:[...a.cls]},indexMap:r,ownerStyle:{height:c.height,minWidth:c.minWidth,width:c.width},reversedLayoutDirection:"column-reverse"===h.direction||"row-reverse"===h.direction,sortDirection:h.direction?.includes("column")?"vertical":"horizontal",startIndex:i}),await l.dragStart(t),a.items.forEach(((t,e)=>{r[e]=e,d.push({height:t.height?`${t.height}px`:t.style?.height,width:t.width?`${t.width}px`:t.style?.width})})),a.getDomRect([a.id].concat(a.items.map((t=>t.id)))).then((t=>{l.ownerRect=t[0],a.style={...c,height:`${t[0].height}px`,minWidth:`${t[0].width}px`,width:`${t[0].width}px`},t.shift(),l.adjustItemRectsToParent&&t.forEach((t=>{t.x-=l.ownerRect.x,t.y-=l.ownerRect.y})),l.itemRects=t,a.items.forEach(((e,i)=>{n=e.wrapperStyle||{},o=t[i],l.adjustProxyRectToParent?.(o,l.ownerRect),e.wrapperStyle=Object.assign(n,{height:`${o.height}px`,left:`${o.left}px`,margin:l.itemMargin,position:"absolute",top:`${o.top}px`,width:`${o.width}px`})})),l.timeout(5).then((()=>{n=s.wrapperStyle||{},n.visibility="hidden",s.wrapperStyle=n}))})))}async scrollToIndex(){let t=this;t.isScrolling=!0,await(t.owner.scrollToIndex?.(t.currentIndex,t.itemRects[t.currentIndex])),t.isScrolling=!1}switchItems(t,e){let i,r=this,n=r.reversedLayoutDirection;(!n&&e<t||n&&t<e)&&(i=t,t=e,e=i);let o=r.itemRects,l=r.indexMap,s=o[t],a=o[e],d=s.clone(),h=a.clone();"horizontal"===r.sortDirection?(s.width=h.width,a.x=d.x+h.width,a.width=d.width):(s.height=h.height,a.height=d.height,a.y=d.y+h.height),i=l[t],l[t]=l[e],l[e]=i,r.updateItem(t,s),r.updateItem(e,a)}updateItem(t,e){let i=this.owner.items[this.indexMap[t]],{wrapperStyle:r}=i;r.left=`${e.left}px`,r.top=`${e.top}px`,i.wrapperStyle=r}});