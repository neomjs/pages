import e from"../core/Base.mjs";import r from"../component/Base.mjs";import o from"./DragProxyComponent.mjs";import t from"./DragProxyContainer.mjs";import a from"../util/Array.mjs";import n from"../core/Observable.mjs";import d from"../util/VDom.mjs";export default Neo.setupClass(class extends e{static observable=!0;static config={className:"Neo.draggable.DragZone",ntype:"dragzone",addDragProxyCls:!0,allowOverdrag:!1,alwaysFireDragMove:!1,appName_:null,bodyCursorStyle:null,boundaryContainerId:null,boundaryContainerRect:null,data:null,dragElement:null,dragElementRect:null,dragProxy:null,dragProxyConfig_:null,dragProxyCls:"neo-dragproxy",dropZoneIdentifier:null,moveHorizontal:!0,moveInMainThread:!0,moveVertical:!0,offsetX:0,offsetY:0,owner:null,proxyParentId_:"document.body",scrollContainerId:null,scrollFactorLeft:1,scrollFactorTop:1,useProxyWrapper:!0,windowId_:null};construct(e){super.construct(e),Neo.main.addon.DragDrop||console.error("You can not use Neo.draggable.DragZone without adding Neo.main.addon.DragDrop to the main thread addons",this.id)}afterSetWindowId(e,r){e&&Neo.currentWorker.insertThemeFiles(e,this.__proto__)}beforeGetDragProxyConfig(e){return Neo.clone(e,!0,!0)}async createDragProxy(e,n=!0){let l,i,s=this,g=Neo.getComponent(s.getDragElementRoot().id)||s.owner,c=s.dragElementRect,m=s.dragProxyConfig||{},p=m.module===t,h=m.vdom,u=!p&&d.clone(h||s.dragElement);if(l={module:o,appName:s.appName,moveInMainThread:s.moveInMainThread,parentId:s.proxyParentId,windowId:s.windowId,...m},p?(l.height=`${e.height}px`,l.items=[],l.parentComponent=s.owner,l.width=`${e.width}px`,l.cls=l.cls||[],l.cls.push("neo-draggable")):(l.vdom=s.useProxyWrapper?{cn:[u]}:u,u.cls&&!s.useProxyWrapper&&(l.cls=l.cls||[],l.cls.push(...u.cls))),l.cls=l.cls||[],g&&l.cls.push(g.getTheme()),s.addDragProxyCls&&l.cls&&a.add(l.cls,s.dragProxyCls),l.style=l.style||{},Object.assign(l.style,{height:`${e.height}px`,left:`${s.moveHorizontal?e.x:c.x}px`,top:`${s.moveVertical?e.y:c.y}px`,width:`${e.width}px`}),n){if(p&&(l.autoInitVnode=!0,l.autoMount=!0),s.dragProxy=i=Neo.create(l),p){await i.mountedPromise,s.dragPlaceholder=Neo.create({module:r,flex:g.flex,style:{height:`${e.height}px`,visibility:"hidden",width:`${e.width}px`}}),g.minHeight&&(s.dragPlaceholder.minHeight=g.minHeight),g.minWidth&&(s.dragPlaceholder.minWidth=g.minWidth),s.dragStartIndex=s.owner.items.indexOf(g);const{vnode:o}=await Neo.vdom.Helper.create({vdom:s.dragPlaceholder.vdom});await Neo.applyDeltas(s.windowId,[{action:"insertNode",index:s.dragStartIndex,parentId:s.owner.getVdomItemsRoot().id,vnode:o},{action:"moveNode",id:g.id,index:0,parentId:i.id}]),s.dragPlaceholder.set({vnode:o,mounted:!0,vnodeInitialized:!0})}return i}return l}destroyDragProxy(){let e=this,r=e.dragProxy.id;e.timeout(e.moveInMainThread?0:30).then(()=>{Neo.applyDeltas(e.windowId,[{action:"removeNode",id:r}])}),e.dragProxy.destroy()}dragEnd(e){let r=this,{owner:o}=r,{cls:t}=o;a.remove(t,"neo-is-dragging"),o.cls=t,r.dragProxy&&(r.dragPlaceholder&&(r.dragPlaceholder.destroy(),r.dragPlaceholder=null),r.destroyDragProxy(),r.dragProxy=null),Object.assign(r,{dragElementRect:null,dragStartIndex:null,offsetX:0,offsetY:0,scrollContainerId:null}),r.fire("dragEnd",e),r.resetData()}dragMove(e,r=!1){let o,t=this;t.moveInMainThread&&!r||!t.dragProxy||(o=t.dragProxy.style,t.moveHorizontal&&(o.left=e.clientX-t.offsetX+"px"),t.moveVertical&&(o.top=e.clientY-t.offsetY+"px"),t.dragProxy.style=o),t.fire("dragMove",e)}async dragStart(e){let r,o,t,n=this,{appName:d,owner:l,windowId:i}=n,{cls:s}=l,g=n.getDragElementRect(e);n.setData(),r=await Neo.main.addon.DragDrop.setConfigs({appName:d,windowId:i,...n.getMainThreadConfigs()}),n.boundaryContainerRect=r.boundaryContainerRect,a.add(s,"neo-is-dragging"),l.cls=s,o=e.clientX-g.left,t=e.clientY-g.top,Object.assign(n,{dragElementRect:g,offsetX:o,offsetY:t}),await n.createDragProxy(g),n.fire("dragStart",{clientX:e.clientX,clientY:e.clientY,dragElementRect:g,eventData:e,id:n.id,offsetX:o,offsetY:t})}getDragElementRect(e){let r=this.getDragElementRoot().id;for(let o of e.path)if(o.id===r)return o.rect;for(let o of e.targetPath)if(o.id===r)return o.rect;return null}getDragElementRoot(){return this.dragElement}getMainThreadConfigs(){let e=this;return{allowOverdrag:e.allowOverdrag,alwaysFireDragMove:e.alwaysFireDragMove,bodyCursorStyle:e.bodyCursorStyle,boundaryContainerId:e.boundaryContainerId,dragElementRootId:e.getDragElementRoot().id,dragProxyCls:e.dragProxyCls,dragZoneId:e.id,dropZoneIdentifier:e.dropZoneIdentifier,moveHorizontal:e.moveHorizontal,moveVertical:e.moveVertical,scrollContainerId:e.scrollContainerId,scrollFactorLeft:e.scrollFactorLeft,scrollFactorTop:e.scrollFactorTop}}onDrop(e){this.fire("drop",e)}onDropEnter(e){this.fire("drop:enter",e)}onDropLeave(e){this.fire("drop:leave",e)}resetData(){this.timeout(50).then(()=>{this.data=null})}setData(e={}){let r=this;r.data={dragElement:r.getDragElementRoot(),dragZoneId:r.id,...e}}});