import e from"./DragZone.mjs";import t from"../../util/Array.mjs";import r from"../../util/Rectangle.mjs";import i from"../../util/VDom.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.draggable.container.SortZone",ntype:"container-sortzone",adjustItemRectsToParent:!1,alwaysFireDragMove:!0,currentIndex:-1,dragHandleSelector:null,enableProxyToPopup:!1,indexMap:null,itemRects:null,itemStyles:null,ownerRect:null,ownerStyle:null,reversedLayoutDirection:!1,scrollLeft:0,scrollTop:0,sortDirection:"horizontal",startIndex:-1};isOverDragging=!1;isWindowDragging=!1;adjustItemCls(e){let r=this;if(r.dragHandleSelector){const n=r.dragHandleSelector.startsWith(".")?r.dragHandleSelector.substring(1):r.dragHandleSelector;r.owner.items.filter(e=>"string"!=typeof e&&i.find(e.vdom,{cls:n})).forEach(r=>{const i=r.wrapperCls||[];t.toggle(i,"neo-draggable",e),r.wrapperCls=i})}else super.adjustItemCls(e)}getDragProxyConfig(){return{...this.dragProxyConfig,cls:[...this.owner.cls]}}moveTo(e,t){this.owner.moveTo(e,t)}async onDragEnd(e){let t,r=this,{itemStyles:i,owner:n}=r,o=n.style||{};if(await r.timeout(10),n.dragResortable){if(r.dragPlaceholder){const e=r.dragComponent,t=[],i=r.sortableItems.indexOf(r.dragPlaceholder);e&&i>-1&&(r.isWindowDragging||t.push({action:"moveNode",id:e.id,index:i,parentId:n.getVdomItemsRoot().id}),t.push({action:"removeNode",id:r.dragPlaceholder.id}),await Neo.applyDeltas(r.windowId,t))}if(o.height=r.ownerStyle.height||null,o.minWidth=r.ownerStyle.minWidth||null,o.width=r.ownerStyle.width||null,n.style=o,r.sortableItems?.forEach((e,n)=>{r.isWindowDragging&&e===r.dragComponent||(t=e.wrapperStyle||{},Object.assign(t,{height:i[n].height||null,left:null,margin:null,position:null,top:null,width:i[n].width||null}),n===r.startIndex&&(t.visibility=null),e.wrapperStyle=t)}),!r.isWindowDragging&&r.startIndex!==r.currentIndex){let e,t;if(r.dragPlaceholder){const i=r.dragComponent;e=r.owner.items.indexOf(i),t=r.owner.items.indexOf(r.sortableItems[r.currentIndex])}else e=r.owner.items.indexOf(r.sortableItems[r.startIndex]),t=r.owner.items.indexOf(r.sortableItems[r.currentIndex]);r.moveTo(e,t)}Object.assign(r,{currentIndex:-1,indexMap:null,isWindowDragging:!1,itemRects:null,itemStyles:null,ownerRect:null,startIndex:-1,sortableItems:null}),await r.timeout(30),r.dragEnd(e)}}async onDragMove(e){let t=this;if(!t.itemRects||t.isScrolling)return;if(t.dragProxy&&t.enableProxyToPopup){const{proxyRect:i}=e;if(i&&t.boundaryContainerRect){const e=t.boundaryContainerRect,n=r.getIntersection(i,e),o=i.width*i.height,a=n?n.width*n.height:0;if(t.isWindowDragging){if(t.isWindowDragging)return void(o>0&&a/o>.51&&(t.dragPlaceholder.wrapperStyle={...t.dragPlaceholder.wrapperStyle,visibility:"visible"},t.itemRects.forEach((e,r)=>{let i=t.indexMap[r];if(-1!==i){let r=t.owner.items[i];r!==t.dragPlaceholder&&r!==t.dragComponent&&(r.wrapperStyle={...r.wrapperStyle,height:`${e.height}px`,left:`${e.left}px`,top:`${e.top}px`,width:`${e.width}px`})}}),t.fire("dragBoundaryEntry",{draggedItem:t.dragComponent,proxyRect:i,sortZone:t})))}else if(o>0&&a/o<.5)return t.isWindowDragging=!0,void t.fire("dragBoundaryExit",{draggedItem:t.dragComponent,proxyRect:i,sortZone:t})}}let i,n,o,a,l,d,{clientX:s,clientY:h}=e,c=t.currentIndex,{itemRects:g}=t,p=g.length-1,m=t.adjustItemRectsToParent?t.ownerRect.x:0,w=t.adjustItemRectsToParent?t.ownerRect.y:0,u=t.reversedLayoutDirection;"horizontal"===t.sortDirection?(i=s-m+t.scrollLeft-t.offsetX-g[c].left,o=s>t.boundaryContainerRect.right,a=s<t.boundaryContainerRect.left,l="width"):(i=h-w+t.scrollTop-t.offsetY-g[c].top,o=h>t.boundaryContainerRect.bottom,a=h<t.boundaryContainerRect.top,l="height"),n=o||a,d=n?.02:.55,a?c>0&&(t.currentIndex--,await t.scrollToIndex(),t.switchItems(c,t.currentIndex)):o?c<p&&(t.currentIndex++,await t.scrollToIndex(),t.switchItems(c,t.currentIndex)):c>0&&(!u&&i<0||u&&i>0)?Math.abs(i)>g[c-1][l]*d&&(t.currentIndex--,t.switchItems(c,t.currentIndex)):c<p&&(!u&&i>0||u&&i<0)&&Math.abs(i)>g[c+1][l]*d&&(t.currentIndex++,t.switchItems(c,t.currentIndex)),t.isOverDragging=n&&0!==t.currentIndex&&t.currentIndex!==p,t.isOverDragging&&(await t.timeout(30),t.isOverDragging&&await t.onDragMove(e))}async onDragStart(e){let t,r,n,o,a,l,d=this,{adjustItemRectsToParent:s,dragHandleSelector:h,owner:c}=d,g=d.itemStyles=[],{layout:p}=c,m=c.style||{};if(c.dragResortable){if(h){const n=h.substring(1),o=e.path.find(e=>e.cls.includes(n));if(!o)return;for(let r=e.path.indexOf(o);r<e.path.length;r++){const i=e.path[r],n=Neo.getComponent(i.id);if(n&&c.items.includes(n)){t=n;break}}if(!t)return;if(l=c.items.filter(e=>i.find(e.vdom,{cls:h.startsWith(".")?h.substring(1):h})),r=l.indexOf(t),r<0)return}else t=Neo.getComponent(e.path[0].id),l=c.items,r=c.indexOf(t.id);n={},Object.assign(d,{currentIndex:r,dragElement:i.find(c.vdom,t.id).vdom,dragProxyConfig:d.getDragProxyConfig(),indexMap:n,ownerStyle:{height:m.height,minWidth:m.minWidth,width:m.width},reversedLayoutDirection:"column-reverse"===p.direction||"row-reverse"===p.direction,sortableItems:l,sortDirection:p.direction?.includes("column")?"vertical":"horizontal",startIndex:r}),d.dragComponent=t,l.forEach((e,t)=>{n[t]=c.items.indexOf(e),g.push({height:e.height?`${e.height}px`:e.style?.height,width:e.width?`${e.width}px`:e.style?.width})});const w=await c.getDomRect([c.id].concat(l.map(e=>e.id)));if(d.ownerRect=w.shift(),c.style={...m,height:`${d.ownerRect.height}px`,minWidth:`${d.ownerRect.width}px`,width:`${d.ownerRect.width}px`},s&&w.forEach(e=>{e.x-=d.ownerRect.x,e.y-=d.ownerRect.y}),d.itemRects=w,await d.dragStart(e),d.dragPlaceholder){const e=l.indexOf(t);e>-1&&(l[e]=d.dragPlaceholder),d.dragElement=d.dragPlaceholder.vdom}l.forEach((e,t)=>{o=e.wrapperStyle||{},a=d.itemRects[t],d.adjustProxyRectToParent?.(a,d.ownerRect),e.wrapperStyle=Object.assign(o,{height:`${a.height}px`,left:`${a.left}px`,margin:"0px",position:"absolute",top:`${a.top}px`,width:`${a.width}px`})}),await d.timeout(5),d.dragPlaceholder||(o=t.wrapperStyle||{},o.visibility="hidden",t.wrapperStyle=o)}}calculateExpandedLayout(){let e=this,t=e.ownerRect,r="horizontal"===e.sortDirection,i=r?t.width:t.height,n=[],o=0,a=0,l=[],d=0,s=0,h=0,c=0,g=0,p=0,m=0,w=e.adjustItemRectsToParent?0:t.x,u=e.adjustItemRectsToParent?0:t.y;if(e.itemRects.length>0){let n=e.itemRects[0],o=e.itemRects[e.itemRects.length-1];if(r){if(d=e.adjustItemRectsToParent?n.x:n.x-t.x,s=i-(e.adjustItemRectsToParent?o.x+o.width:o.x-t.x+o.width),c=e.adjustItemRectsToParent?n.y:n.y-t.y,g=t.height-(e.adjustItemRectsToParent?n.y+n.height:n.y-t.y+n.height),e.itemRects.length>1){let t=e.itemRects[1];h=t.x-(n.x+n.width)}}else if(d=e.adjustItemRectsToParent?n.y:n.y-t.y,s=i-(e.adjustItemRectsToParent?o.y+o.height:o.y-t.y+o.height),p=e.adjustItemRectsToParent?n.x:n.x-t.x,m=t.width-(e.adjustItemRectsToParent?n.x+n.width:n.x-t.x+n.width),e.itemRects.length>1){let t=e.itemRects[1];h=t.y-(n.y+n.height)}}for(let t=0;t<e.itemRects.length;t++){let i=e.indexMap[t];if(-1===i)continue;let l=e.owner.items[i];if(l===e.dragPlaceholder||l===e.dragComponent)continue;let d=e.itemRects[t];if(n.push({item:l,rect:d}),l.flex)o+=l.flex;else{a+=r?d.width:d.height}}let x=Math.max(0,n.length-1),y=Math.max(0,i-d-s-x*h-a),f=d;return n.forEach(({item:e,rect:i},n)=>{let a,d={};a=e.flex?e.flex/o*y:r?i.width:i.height,d=r?{left:`${w+f}px`,top:`${u+c}px`,height:t.height-c-g+"px",width:`${a}px`}:{left:`${w+p}px`,top:`${u+f}px`,height:`${a}px`,width:t.width-p-m+"px"},l.push({item:e,style:d}),f+=a+h}),l}async scrollToIndex(){let e=this;e.isScrolling=!0,await(e.owner.scrollToIndex?.(e.currentIndex,e.itemRects[e.currentIndex])),e.isScrolling=!1}startWindowDrag(e){let t=this,{popupHeight:r,popupWidth:i,windowName:n}=e;t.dragProxy.style={opacity:0},t.isWindowDragging=!0,t.dragPlaceholder&&(t.dragPlaceholder.wrapperStyle={...t.dragPlaceholder.wrapperStyle,visibility:"hidden"}),t.calculateExpandedLayout().forEach(({item:e,style:t})=>{e.wrapperStyle={...e.wrapperStyle,...t}}),Neo.main.addon.DragDrop.startWindowDrag({popupHeight:r,popupName:n,popupWidth:i,windowId:t.windowId})}switchItems(e,t){let r,i=this,n=i.reversedLayoutDirection;(!n&&t<e||n&&e<t)&&(r=e,e=t,t=r);let o=i.itemRects,a=i.indexMap,l=o[e],d=o[t],s=l.clone(),h=d.clone();if("horizontal"===i.sortDirection){const e=h.x-(s.x+s.width);l.width=h.width,d.x=s.x+h.width+e,d.width=s.width}else{const e=h.y-(s.y+s.height);l.height=h.height,d.height=s.height,d.y=s.y+h.height+e}r=a[e],a[e]=a[t],a[t]=r,i.updateItem(e,l),i.updateItem(t,d)}updateItem(e,t){let r,i=this,n=i.indexMap[e];if(-1===n){if(!i.dragPlaceholder)return;r=i.dragPlaceholder}else r=i.owner.items[n],i.dragPlaceholder&&r===i.dragComponent&&(r=i.dragPlaceholder);let{wrapperStyle:o}=r;o.left=`${t.left}px`,o.top=`${t.top}px`,r.wrapperStyle=o}});