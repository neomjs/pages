import e from"../../plugin/Base.mjs";import t from"../../form/field/Text.mjs";import o from"../../util/VDom.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.table.plugin.CellEditing",ntype:"plugin-table-cell-editing",cellCls:"neo-table-cell",disabled_:!1,editorCls:["neo-table-editor"],focusCells:!0};editors={};mountedEditor=null;construct(e){super.construct(e);let t=this,{owner:o}=t,{selectionModel:i}=o;o.on({cellDoubleClick:t.onCellDoubleClick,focusLeave:t.onFocusLeave,selectionModelChange:t.onSelectionModelChange,scope:t}),"NeoInstance"===Neo.typeOf(i)&&t.onSelectionModelChange({value:i}),o.body.keys.add({Enter:"onTableKeyDown",Space:"onTableKeyDown",scope:t})}afterSetDisabled(e,t){t&&this.unmountEditor()}destroy(...e){Object.values(this.editors).forEach(e=>{e.destroy(!1,!0)}),super.destroy(...e)}async mountEditor(e,i){if(this.disabled)return;let l,n=this,{appName:d,windowId:a}=n,{body:s}=n.owner,r=s.getCellId(e,i),c=o.find(s.vdom,r).vdom,u=n.owner.headerToolbar.getColumn(i),m=n.editors[i],E=e[i];n.mountedEditor&&(await n.unmountEditor(),await n.timeout(10)),u.editable&&(m?(m.originalConfig.value=E,m.setSilent({record:e,value:E})):(n.editors[i]=m=Neo.create({module:t,appName:d,cls:n.editorCls,dataField:i,hideLabel:!0,parentId:s.id,record:e,value:E,windowId:a,...u.editor}),l={Enter:"onEditorKeyEnter",Escape:"onEditorKeyEscape",Tab:"onEditorKeyTab",scope:n},m.keys?m.keys.add(l):m.keys=l),n.mountedEditor=m,c.cn=[m.createVdomReference()],delete c.html,s.updateDepth=-1,await s.promiseUpdate(),await n.timeout(30),m.focus())}async onCellDoubleClick({body:e,data:t,dataField:o,record:i}){await this.mountEditor(i,o)}async onEditorKeyEnter(e,t){let o=this;await o.submitEditor(),await o.timeout(20),o.selectCell(e)}async onEditorKeyEscape(e,t){let o=this;await o.unmountEditor(),await o.timeout(20),o.selectCell(e)}async onEditorKeyTab(e,t){let o=this,{store:i}=o.owner,l=i.indexOf(t.record),n=i.getCount(),d=(l+(e.altKey?-1:1)+n)%n,a=i.getAt(d);await o.submitEditor(),await o.mountEditor(a,t.dataField)}async onFocusLeave(e){await this.unmountEditor()}onSelectionChange(e){}onSelectionModelChange(e){let t=e.value;t.ntype.includes("cell")&&t.on("selectionChange",this.onSelectionChange,this)}async onTableKeyDown(e){let t,o,i=this,{target:l}=e,{body:n}=i.owner;!i.mountedEditor&&l.cls?.includes("neo-selected")&&(t=n.getCellDataField(l.id),o=n.getRecord(l.id),await i.mountEditor(o,t))}selectCell({path:e}){let t,o=this,{selectionModel:i}=o.owner,l=0,n=e.length;for(;l<n;l++)if(e[l].cls?.includes(o.cellCls)){t=e[l].id;break}t&&(i?.deselect(t,!0),i?.select(t),o.focusCells&&o.owner.focus(t))}async submitEditor(){let e=this,t=e.mountedEditor;t?.isValid()&&(t.isDirty?(e.mountedEditor=null,t.record[t.dataField]=t.getSubmitValue()):await e.unmountEditor())}async unmountEditor(){if(!this.mountedEditor)return;let e=this,t=e.mountedEditor.record,{body:o}=e.owner,i=o.store.indexOf(t);e.mountedEditor=null,o.getVdomRoot().cn[i]=o.createRow({record:t,rowIndex:i}),await o.promiseUpdate()}});