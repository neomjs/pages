import e from"../util/ClassSystem.mjs";import t from"../component/Base.mjs";import o from"../util/Array.mjs";import l from"../selection/table/RowModel.mjs";import r from"../util/VDom.mjs";export default Neo.setupClass(class extends t{static config={className:"Neo.table.View",ntype:"table-view",baseCls:["neo-table-view"],colspanField:"colspan",containerId:null,highlightModifiedCells_:!1,keys:{},recordVnodeMap:{},selectionModel_:null,selectedRecordField:"annotations.selected",store_:null,useRowRecordIds:!0,_vdom:{tag:"tbody",tabIndex:-1,cn:[]}};get selectedRows(){return"selection-table-rowmodel"===this.selectionModel.ntype?this.selectionModel.items:[]}construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onCellClick,dblclick:t.onCellDoubleClick,delegate:".neo-table-cell",scope:t},{click:t.onRowClick,dblclick:t.onRowDoubleClick,delegate:".neo-table-row",scope:t}])}afterSetSelectionModel(e,t){this.rendered&&e.register(this)}afterSetStore(e,t){let o=this,l={filter:o.onStoreFilter,load:o.onStoreLoad,recordChange:o.onStoreRecordChange,scope:o};t?.un(l),e?.on(l)}applyRendererOutput(e){let t,o,{cellId:l,column:r,columnIndex:d,record:n,rowIndex:i,tableContainer:s}=e,c=this,a=["neo-table-cell"],u=n[c.colspanField],{dataField:p}=r,{model:m}=c.store,h=n[p],g=!!m,{vdom:f}=c;if(!m?.getField(p)){let e=p.split("."),t=e.pop();h=Neo.ns(e,!1,n[Symbol.for("data")])?.[t]}switch(null==h&&(h=""),c.bindCallback(r.renderer,"renderer",r.rendererScope||s,r),o=r.renderer.call(r.rendererScope||s,{column:r,columnIndex:d,dataField:p,record:n,rowIndex:i,tableContainer:s,value:h}),Neo.typeOf(o)){case"Object":o.html?o.cls&&a.push(...o.cls):o=[o];break;case"Date":case"Number":case"String":o={cls:a,html:o?.toString()}}return null==o&&(o=""),"left"!==r.cellAlign&&a.push("neo-"+r.cellAlign),c.highlightModifiedCells&&n.isModifiedField(p)&&a.push("neo-is-modified"),l||(l=g?c.getCellId(n,r.dataField):f.cn[i]?.cn[c.getColumn(r.dataField,!0)]?.id||Neo.getId("td")),t={tag:"td",id:l,cls:a,style:o.style||{}},u&&Object.keys(u).includes(p)&&(t.colspan=u[p]),"Object"===Neo.typeOf(o)?t.innerHTML=o.html||"":t.cn=o,t}beforeSetSelectionModel(t,o){return o?.destroy(),e.beforeSetInstance(t,l)}createRow({record:e,rowIndex:t}){Neo.isNumber(t)||(t=this.store.indexOf(e));let l,r,d,n,i,s=this,c=s.parent,a=e[s.colspanField],u=a&&Object.keys(a),p=c.items[0].items,m=p.length,h=0,g=0,f=s.getRowId(e,t),{selectedRows:w}=s,C=s.getTrClass(e,t);for(s.recordVnodeMap[f]=t,w&&e[s.selectedRecordField]&&o.add(w,f),w?.includes(f)&&(C.push("neo-selected"),s.parent.fire("select",{record:e})),i={tag:"tr",id:f,cls:C,cn:[]},n=0;n<m;n++)r=p[n],l=s.applyRendererOutput({column:r,columnIndex:n,record:e,rowIndex:t,tableContainer:c}),r.dock&&(l.cls=["neo-locked",...l.cls||[]],"left"===r.dock&&(l.style.left=h+"px",h+=r.width+1)),r.flex&&(l.style.width="100%"),i.cn.push(l),u?.includes(r.dataField)&&(n+=a[r.dataField]-1);for(n=0;n<m;n++)d=m-n-1,r=p[d],"right"===r.dock&&(i.cn[d].style.right=g+"px",g+=r.width+1),u?.includes(r.dataField)&&(n+=a[r.dataField]-1);return 0===t&&Object.assign(c,{dockLeftMargin:h,dockRightMargin:g}),i}createViewData(){let e=this,{selectedRows:t,store:o}=e,l=o.getCount(),r=0,d=[];for(;r<l;r++)d.push(e.createRow({record:o.items[r],rowIndex:r}));e.vdom.cn=d,e.promiseUpdate().then((()=>{t?.length>0&&Neo.main.DomAccess.scrollToTableRow({appName:e.appName,id:t[0]})}))}destroy(...e){this.store=null,super.destroy(...e)}fireCellEvent(e,t){let o=this,l=e.currentTarget,r=o.getCellDataField(l),d=o.getRecord(l);o.parent.fire(t,{data:e,dataField:r,record:d,view:o})}fireRowEvent(e,t){let o=this,l=e.currentTarget,r=o.getRecord(l);o.parent.fire(t,{data:e,record:r,view:o})}getCellDataField(e){return e.split("__")[2]}getCellId(e,t){return this.id+"__"+e[this.store.keyProperty]+"__"+t}getColumn(e,t=!1){let o,l=this.parent.headerToolbar.items,r=0,d=l.length;for(;r<d;r++)if(o=l[r],o.dataField===e)return t?r:o;return null}getDataField(e){return e.split("__")[2]}getRecord(e){let t,o,l=this,d=l.getRecordByRowId(e);if(d)return d;for(t of(o=r.getParentNodes(l.vdom,e),o))if(d=l.getRecordByRowId(t.id),d)return d;return null}getRecordByRowId(e){return this.store.getAt(this.recordVnodeMap[e])}getRowId(e,t){let o=this,{store:l}=o;return o.useRowRecordIds?`${o.id}__tr__${e[l.keyProperty]}`:(t=Neo.isNumber(t)?t:l.indexOf(e),o.vdom.cn[t]?.id||Neo.getId("tr"))}getTrClass(e,t){return["neo-table-row"]}onCellClick(e){this.fireCellEvent(e,"cellClick")}onCellDoubleClick(e){this.fireCellEvent(e,"cellDoubleClick")}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onRowClick(e){this.fireRowEvent(e,"rowClick")}onRowDoubleClick(e){this.fireRowEvent(e,"rowDoubleClick")}onStoreFilter(){this.onStoreLoad()}onStoreLoad(e){let t=this;t.createViewData(),t.mounted&&t.timeout(50).then((()=>{Neo.main.DomAccess.scrollTo({direction:"top",id:t.vdom.id,value:0})}))}onStoreRecordChange({fields:e,record:t}){let o,l,d,n,i,s,c=this,a=e.map((e=>e.name)),u=!1,p=c.parent,m=c.store.indexOf(t),{selectionModel:h,vdom:g}=c;a.includes(c.colspanField)?(c.vdom.cn[m]=c.createRow({record:t,rowIndex:m}),c.update()):e.forEach((e=>{e.name===c.selectedRecordField?"selection-table-rowmodel"===h.ntype&&h[e.value?"select":"deselect"](c.getRowId(t)):(o=c.getCellId(t,e.name),l=r.find(g,o),l?.vdom&&(n=c.getColumn(e.name),i=l.index,u=!0,s=n.rendererScope||p,d=c.applyRendererOutput({cellId:o,column:n,columnIndex:i,record:t,rowIndex:m,tableContainer:p}),l.parentNode.cn[i]=d))})),u&&c.update()}});