import e from"../util/ClassSystem.mjs";import t from"../component/Base.mjs";import o from"../util/Array.mjs";import l from"../selection/table/RowModel.mjs";import r from"../util/VDom.mjs";export default Neo.setupClass(class extends t{static config={className:"Neo.table.Body",ntype:"table-body",baseCls:["neo-table-body"],colspanField:"colspan",containerId:null,highlightModifiedCells_:!1,keys:{},recordVnodeMap:{},selectionModel_:null,selectedRecordField:"annotations.selected",store_:null,useRowRecordIds:!0,_vdom:{tag:"tbody",tabIndex:-1,cn:[]}};get selectedRows(){return"selection-table-rowmodel"===this.selectionModel.ntype?this.selectionModel.items:[]}construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onCellClick,dblclick:t.onCellDoubleClick,delegate:".neo-table-cell",scope:t},{click:t.onRowClick,dblclick:t.onRowDoubleClick,delegate:".neo-table-row",scope:t}])}afterSetSelectionModel(e,t){this.vnodeInitialized&&e.register(this)}afterSetStore(e,t){let o=this,l={filter:o.onStoreFilter,load:o.onStoreLoad,recordChange:o.onStoreRecordChange,scope:o};t?.un(l),e?.on(l)}applyRendererOutput({cellId:e,column:t,columnIndex:o,record:l,rowIndex:r,tableContainer:d}){let n,i,s=this,c=["neo-table-cell"],a=l[s.colspanField],{dataField:u}=t,{model:m}=s.store,p=l[u],h=!!m,{vdom:g}=s;if(!m?.getField(u)){let e=u.split("."),t=e.pop();p=Neo.ns(e,!1,l[Symbol.for("data")])?.[t]}switch(null==p&&(p=""),s.bindCallback(t.renderer,"renderer",t.rendererScope||d,t),i=t.renderer.call(t.rendererScope||d,{column:t,columnIndex:o,dataField:u,record:l,rowIndex:r,tableContainer:d,value:p}),Neo.typeOf(i)){case"Object":i.html||i.text?i.cls&&c.push(...i.cls):i=[i];break;case"Date":case"Number":case"String":i={cls:c,html:i?.toString()}}return null==i&&(i=""),"left"!==t.cellAlign&&c.push("neo-"+t.cellAlign),s.highlightModifiedCells&&l.isModifiedField(u)&&c.push("neo-is-modified"),e||(e=h?s.getCellId(l,t.dataField):g.cn[r]?.cn[s.getColumn(t.dataField,!0)]?.id||Neo.getId("td")),n={tag:"td",id:e,cls:c,style:i.style||{}},a&&Object.keys(a).includes(u)&&(n.colspan=a[u]),"Object"===Neo.typeOf(i)?Object.hasOwn(i,"html")?n.html=i.html||"":n.text=i.text||"":n.cn=i,n}beforeSetSelectionModel(t,o){return o?.destroy(),e.beforeSetInstance(t,l)}createRow({record:e,rowIndex:t}){Neo.isNumber(t)||(t=this.store.indexOf(e));let l,r,d,n,i,s=this,c=s.parent,a=e[s.colspanField],u=a&&Object.keys(a),m=c.items[0].items,p=m.length,h=0,g=0,f=s.getRowId(e,t),{selectedRows:b}=s,C=s.getTrClass(e,t);for(s.recordVnodeMap[f]=t,b&&e[s.selectedRecordField]&&o.add(b,f),b?.includes(f)&&(C.push("neo-selected"),s.parent.fire("select",{record:e})),i={tag:"tr",id:f,cls:C,cn:[]},n=0;n<p;n++)r=m[n],l=s.applyRendererOutput({column:r,columnIndex:n,record:e,rowIndex:t,tableContainer:c}),r.dock&&(l.cls=["neo-locked",...l.cls||[]],"left"===r.dock&&(l.style.left=h+"px",h+=r.width+1)),r.flex&&(l.style.width="100%"),i.cn.push(l),u?.includes(r.dataField)&&(n+=a[r.dataField]-1);for(n=0;n<p;n++)d=p-n-1,r=m[d],"right"===r.dock&&(i.cn[d].style.right=g+"px",g+=r.width+1),u?.includes(r.dataField)&&(n+=a[r.dataField]-1);return 0===t&&Object.assign(c,{dockLeftMargin:h,dockRightMargin:g}),i}createViewData(){let e=this,{selectedRows:t,store:o}=e,l=o.getCount(),r=0,d=[];for(;r<l;r++)d.push(e.createRow({record:o.items[r],rowIndex:r}));e.vdom.cn=d,e.promiseUpdate().then(()=>{t?.length>0&&Neo.main.DomAccess.scrollToTableRow({appName:e.appName,id:t[0]})})}destroy(...e){this.store=null,super.destroy(...e)}fireCellEvent(e,t){let o=this,l=e.currentTarget,r=o.getCellDataField(l),d=o.getRecord(l);o.parent.fire(t,{body:o,data:e,dataField:r,record:d})}fireRowEvent(e,t){let o=this,l=e.currentTarget,r=o.getRecord(l);o.parent.fire(t,{body:o,data:e,record:r})}getCellDataField(e){return e.split("__")[2]}getCellId(e,t){return this.id+"__"+e[this.store.keyProperty]+"__"+t}getColumn(e,t=!1){let o,l=this.parent.headerToolbar.items,r=0,d=l.length;for(;r<d;r++)if(o=l[r],o.dataField===e)return t?r:o;return null}getDataField(e){return e.split("__")[2]}getRecord(e){let t,o,l=this,d=l.getRecordByRowId(e);if(d)return d;for(t of(o=r.getParentNodes(l.vdom,e),o))if(d=l.getRecordByRowId(t.id),d)return d;return null}getRecordByRowId(e){return this.store.getAt(this.recordVnodeMap[e])}getRowId(e,t){let o=this,{store:l}=o;return o.useRowRecordIds?`${o.id}__tr__${e[l.keyProperty]}`:(t=Neo.isNumber(t)?t:l.indexOf(e),o.vdom.cn[t]?.id||Neo.getId("tr"))}getTrClass(e,t){return["neo-table-row"]}onCellClick(e){this.fireCellEvent(e,"cellClick")}onCellDoubleClick(e){this.fireCellEvent(e,"cellDoubleClick")}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onRowClick(e){this.fireRowEvent(e,"rowClick")}onRowDoubleClick(e){this.fireRowEvent(e,"rowDoubleClick")}onStoreFilter(){this.onStoreLoad()}onStoreLoad(e){let t=this;t.createViewData(),t.mounted&&t.timeout(50).then(()=>{Neo.main.DomAccess.scrollTo({direction:"top",id:t.vdom.id,value:0})})}onStoreRecordChange({fields:e,record:t}){let o,l,d,n,i,s,c=this,a=e.map(e=>e.name),u=!1,m=c.parent,p=c.store.indexOf(t),{selectionModel:h,vdom:g}=c;a.includes(c.colspanField)?(c.vdom.cn[p]=c.createRow({record:t,rowIndex:p}),c.update()):e.forEach(e=>{e.name===c.selectedRecordField?"selection-table-rowmodel"===h.ntype&&h[e.value?"select":"deselect"](c.getRowId(t)):(o=c.getCellId(t,e.name),l=r.find(g,o),l?.vdom&&(n=c.getColumn(e.name),i=l.index,u=!0,s=n.rendererScope||m,d=c.applyRendererOutput({cellId:o,column:n,columnIndex:i,record:t,rowIndex:p,tableContainer:m}),l.parentNode.cn[i]=d))}),u&&c.update()}});