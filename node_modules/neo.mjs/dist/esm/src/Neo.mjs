import e from"./DefaultConfig.mjs";import{isDescriptor as t}from"./core/ConfigSymbols.mjs";const s=/-./g,r=Symbol.for("configSymbol"),n=Symbol("getSetCache"),o={function:e=>{if(e.prototype?.constructor.isClass)return"NeoClass"},object:e=>{if(e.constructor.isClass&&e instanceof a.core.Base)return"NeoInstance"}};let a=globalThis.Neo||{};a=globalThis.Neo=Object.assign({ntypeMap:{},insideWorker:"undefined"!=typeof DedicatedWorkerGlobalScope||"undefined"!=typeof WorkerGlobalScope,applyFromNs(e,t,s,r){let n;return e&&"Object"===a.typeOf(s)&&Object.entries(s).forEach(([s,o])=>{n=t[o],e[s]=r?n.bind(t):n}),e},applyToGlobalNs(e){let t="function"==typeof e?e.prototype:e,s=(t.isClass?t.config.className:t.className).split("."),r=s.pop();a.ns(s,!0)[r]=e},assignDefaults:(e,t)=>(e&&"Object"===a.typeOf(t)&&Object.entries(t).forEach(([t,s])=>{Object.hasOwn(e,t)||(e[t]=s)}),e),assignToNs(e,t,s=globalThis,r=!0){let n;(e=Array.isArray(e)?e:e.split(".")).length>1?(n=e.pop(),s=a.ns(e,!0,s)):n=e,(r||void 0===s[n])&&(s[n]=t)},camel:e=>e.replace(s,e=>e[1].toUpperCase()),capitalize:e=>e[0].toUpperCase()+e.slice(1),clone(e,t=!1,s=!1){let r;return{Array:()=>t?[...e.map(e=>a.clone(e,t,s))]:[...e],Date:()=>new Date(e.valueOf()),Map:()=>new Map(e),NeoInstance:()=>s?e:this.cloneNeoInstance(e),Set:()=>new Set(e),Object:()=>(r={},Object.entries(e).forEach(([e,n])=>{r[e]=t?a.clone(n,t,s):n}),r)}[a.typeOf(e)]?.()||e},cloneNeoInstance(e){let t={...e.originalConfig};return delete t._id,delete t.id,a.create(e.className,t)},create(e,t){let s,r,n=a.typeOf(e);if("NeoClass"===n)s=e;else{if("Object"===n){if(!(t=e).className&&!t.module)return console.error("Class created with object configuration missing className or module property",t),null;e=t.className||t.module.prototype.className}if(!f(e))throw new Error("Class "+e+" does not exist");s=a.ns(e)}return r=new s,r.construct(t),r.onConstructed(),r.onAfterConstructed(),r.init(),r},emptyFn(){},hasPropertySetter(e,t){let s;for(;e.__proto__;){if(s=Object.getOwnPropertyDescriptor(e,t),"object"==typeof s&&"function"==typeof s.set)return!0;e=e.__proto__}return!1},merge(e,t,s){if(s)return a.merge(a.merge(e,s),t);for(const s in t){const r=t[s];"Object"===a.typeOf(r)?e[s]=a.merge(e[s]||{},r):e[s]=r}return e},ns:(e,t=!1,s)=>(e=Array.isArray(e)?e:e.split(".")).reduce((e,s)=>{if(t&&!e[s]&&(e[s]={}),e)return e[s]},s||globalThis),nsWithArrays:(e,t=!1,s)=>(e=Array.isArray(e)?e:e.split(".")).reduce((e,s)=>{if(t&&!e[s]){if(s.endsWith("]"))return p(!0,s,e);e[s]={}}if(e)return s.endsWith("]")?p(!1,s,e):e[s]},s||globalThis),ntype(e,t){if("object"==typeof e){if(!(t=e).ntype)throw new Error("Class defined with object configuration missing ntype property. "+t.ntype);e=t.ntype}let s=a.ntypeMap[e];if(!s)throw new Error("ntype "+e+" does not exist");return a.create(s,t)},setupClass(e){let t,s,o,i,l,c=null,p=[],{ntypeMap:m}=a,g=e.prototype||e,h=a.ns(g.constructor.config.className,!1),b=[];if(h)return h;for(;g.__proto__;){if(o=g.constructor,Object.hasOwn(o,"classConfigApplied")){c=a.clone(o.config,!0),p=[...o.ntypeChain];break}b.unshift(g),g=g.__proto__}return s=c||{},b.forEach(i=>{let c;if(o=i.constructor,t=o.config||{},a.overwrites&&o.applyOverwrites?.(t),Object.entries(t).forEach(([e,s])=>{"_"===e.slice(-1)?(delete t[e],e=e.slice(0,-1),t[e]=s,function(e,t){if(a.hasPropertySetter(e,t))throw"Config "+t+"_ ("+e.className+") already has a set method, use beforeGet, beforeSet & afterSet instead";const s="_"+t,o=t[0].toUpperCase()+t.slice(1),i="beforeGet"+o,l="beforeSet"+o,c="afterSet"+o;a[n]||(a[n]={});if(!a[n][t]){const e={get(){let e=this,n=Object.hasOwn(e[r],t),o=e[r][t],a=n?o:e[s];return Array.isArray(a)?"items"!==t&&(a=[...a]):a instanceof Date&&(a=new Date(a.valueOf())),n&&(e[t]=a,a=e[s],delete e[r][t]),"function"==typeof e[i]&&(a=e[i](a)),a},set(e){if(void 0===e)return;const s=this.getConfig(t);if(!s)return;let n=this,o=s.get();delete n[r][t],"items"!==t&&"vnode"!==t&&(e=a.clone(e,!0,!0)),"function"==typeof n[l]&&void 0===(e=n[l](e,o))||s.set(e)&&(n[c]?.(e,o),n.afterSetConfig?.(t,e,o))}},o={get(){return this.getConfig(t)?.get()},set(e){this.getConfig(t)?.setRaw(e)}};a[n][t]=e,a[n][s]=o}Object.defineProperty(e,t,a[n][t]),Object.defineProperty(e,s,a[n][s])}(i,e)):a.hasPropertySetter(i,e)||Object.defineProperty(i,e,{enumerable:!0,value:s,writable:!0})}),Object.hasOwn(t,"ntype")){if(l=t.ntype,p.unshift(l),Object.hasOwn(m,l)&&t.className!==m[l])throw new Error(`ntype conflict for '${l}' inside the classes:\n${m[l]}\n${t.className}`);m[l]=t.className}c=Object.hasOwn(s,"mixins")&&s.mixins||[],o.observable&&c.push("Neo.core.Observable"),Object.hasOwn(t,"mixins")&&Array.isArray(t.mixins)&&t.mixins.length>0&&c.push(...t.mixins),c.length>0&&(!function(e,t){Array.isArray(t)||(t=[t]);let s,r,n,o=0,i=t.length,l={};for(;o<i;o++){if(s=t[o],s.isClass)n=s.prototype,r=a.ns(n.className);else{if(!f(s))throw new Error("Attempting to mixin an undefined class: "+s+", "+e.prototype.className);r=a.ns(s),n=r.prototype}n.className.split(".").reduce(u(r),l),Object.getOwnPropertyNames(n).forEach(y(e.prototype,n))}e.prototype.mixins=l}(o,c),a.ns("Neo.core.Observable",!1,o.prototype.mixins)&&(o.observable=!0)),delete t.mixins,delete s.mixins,Object.assign(s,t),Object.assign(o,{classConfigApplied:!0,config:a.clone(s,!0),isClass:!0,ntypeChain:p}),!s.singleton&&this.applyToGlobalNs(e)}),g=e.prototype||e,p.forEach(e=>{g[`is${a.capitalize(a.camel(e))}`]=!0}),g.singleton&&(e=a.create(e),a.applyToGlobalNs(e)),i={className:g.className,module:e,ntype:Object.hasOwn(g,"ntype")?g.ntype:null,parentClassName:g.__proto__?.className||null},a.manager?.ClassHierarchy?a.manager.ClassHierarchy.add(i):(a.classHierarchyMap??={},a.classHierarchyMap[g.className]=i),e},typeOf:e=>null==e?null:o[typeof e]?.(e)||e.constructor.name},a);const i=["_name","classConfigApplied","className","constructor","isClass","mixin","ntype","observable"],l=/\d+/g,c=/^(\w+)\s*((?:\[\s*\d+\s*\]\s*)*)$/;function p(e,t,s){let r,n,o=(p=t,(c.exec(p)||[null]).slice(1).reduce((e,t)=>[e].concat(t.match(l)))),a=1,i=o.length;var p;if(e?s[o[0]]=n=s[o[0]]||[]:n=s[o[0]],n){for(;a<i;a++)r=parseInt(o[a]),e&&(n[r]=n[r]||{}),n=n[r];return n}}function f(e){try{return!!e.split(".").reduce((e,t)=>e[t],globalThis)}catch(e){return!1}}function y(e,t){return function(s){if(!~i.indexOf(s)){if(e[s]?._from){if(t.className===e[s]._from)return void console.warn("Mixin set multiple times or already defined on a Base Class",e.className,t.className,s);throw new Error(`${e.className}: Multiple mixins defining same property (${t.className}, ${e[s]._from}) => ${s}`)}e[s]=t[s],Object.getOwnPropertyDescriptor(e,s)._from=t.className,"function"==typeof e[s]&&(e[s]._name=s)}}}function u(e){return(t,s,r,n)=>t[s]=r!==n.length-1?t[s]||{}:e}a.config=a.config||{},a.assignDefaults(a.config,e);export default a;