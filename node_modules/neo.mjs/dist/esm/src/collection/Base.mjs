import{isDescriptor as e}from"../core/ConfigSymbols.mjs";import t from"../core/Base.mjs";import r from"./Filter.mjs";import s from"../util/Logger.mjs";import i from"../core/Observable.mjs";import l from"./Sorter.mjs";const n=Symbol("countMutations"),o=Symbol.for("initialIndex"),a=Symbol("isFiltered"),u=Symbol("isSorted"),p=Symbol("silentUpdateMode"),c=Symbol("toAddArray"),d=Symbol("toRemoveArray"),m=Symbol("updatingIndex");class h extends t{static observable=!0;static config={className:"Neo.collection.Base",ntype:"collection",allItems:null,autoSort:!0,count_:0,filterMode:"primitive",filters_:[],internalIdMap_:null,items_:{[e]:!0,clone:"shallow",value:null},keyProperty:"id",keyPropertyIndex:-1,map_:null,sortDirections:null,sortProperties:null,sorters_:[],sourceId_:null,trackInternalId:!1};initialIndexCounter=0;construct(e){let t=this,r={enumerable:!1,writable:!0};Object.defineProperties(t,{[n]:{...r,value:!1},[a]:{...r,value:!1},[u]:{...r,value:!1},[p]:{...r,value:!1},[c]:{...r,value:[]},[d]:{...r,value:[]},[m]:{...r,value:0}}),super.construct(e),t.items=t.items||[],t.autoSort&&t._sorters.length>0&&t.doSort()}add(e){return this.splice(null,null,e).addedItems}afterSetFilters(e,t){let r=this;e.forEach(e=>{!1===e.listenerApplied&&(e.on("change",r.onFilterChange,r),e.listenerApplied=!0)}),t&&r.filter()}afterSetItems(e,t){if(e){let t,r,s=this,i=0,l=e.length;for(;i<l;i++)r=e[i],s.itemFactory?.(r),r&&(s.map.set(s.getKey(r),r),s.trackInternalId&&(t=s.getInternalKey(r),t&&s.internalIdMap.set(t,r)));s.count=l}}afterSetSorters(e,t){let r=this;r.applySorterConfigs(),e.forEach(e=>{!1===e.listenerApplied&&(e.on("change",r.onSorterChange,r),e.listenerApplied=!0)}),t&&r.autoSort&&r.doSort()}afterSetSourceId(e,t){if(e){let r=this,s=Neo.get(e);r._items=s._items.slice(),r.map=new Map(s.map),r.count=r._items.length,r.trackInternalId&&s.trackInternalId&&(r.internalIdMap=new Map(s.internalIdMap));const i={mutate:r.onMutate,scope:r};s.on(i),t&&(s=Neo.get(t),s.un(i))}}applySorterConfigs(){let e=this;e.sortDirections=[],e.sortProperties=[],e.sorters.forEach(t=>{e.sortDirections.push(t.directionMultiplier),e.sortProperties.push(t.property)})}beforeSetFilters(e,t){Array.isArray(e)||(e=e?[e]:[]);let s,i,l=t&&t.length||0;return e.forEach((n,o)=>{if(t)for(s=!1,i=0;i<l;i++){if(t[i]===n){t[i].set({operator:n.operator,property:n.property,value:n.value}),s=!0;break}if(t[i].operator===(n.operator||"===")&&t[i].property===n.property&&t[i].value===n.value){s=!0;break}}s?(e[o]=t[i],t.splice(i,1),l--):e[o]=Neo.create(r,n)}),Array.isArray(t)&&t.forEach(e=>{e.destroy()}),e}beforeSetInternalIdMap(e,t){return!e&&this.trackInternalId?new Map:e}beforeSetMap(e,t){return e||new Map}beforeSetSorters(e,t){Array.isArray(e)||(e=e?[e]:[]);let r,s,i=t?.length||0;return e.forEach((n,o)=>{if(t){r=!1,s=0;let{direction:e,property:l}=n;for(;s<i;s++){if(t[s]===n){t[s].set({direction:e,property:l}),r=!0;break}if(t[s].property===l&&t[s].direction===e){r=!0;break}}}r?(e[o]=t[s],t.splice(s,1),i--):e[o]=Neo.create(l,n)}),t?.forEach(e=>{e.destroy()}),e}cacheUpdate(e){}clear(e=!0){let t=this;e&&t.allItems?.clear(),t.splice(0,t.count),t.initialIndexCounter=0}clearFilters(e){this.filters=e?Neo.clone(this.originalConfig.filters,!0,!0):null}clearSilent(e=!0){let t=this;e&&t.allItems?.clearSilent(),t._items.splice(0,t.count),t.map.clear(),t.internalIdMap?.clear(),t.initialIndexCounter=0}clearSorters(e){this.sorters=e?Neo.clone(this.originalConfig.sorters,!0,!0):null}clone(){let e=this,t=Neo.clone(e.originalConfig,!0),r=e._filters||[],s=e._sorters||[];return t.keyProperty=e.keyProperty,delete t.id,delete t.filters,delete t.items,delete t.sorters,e._items.length>0&&(t.items=e._items.slice(),t.count=t.items.length),t.filters=[],t.sorters=[],r.forEach(function(e){t.filters.push(e.originalConfig)}),s.forEach(function(e){t.sorters.push(e.originalConfig)}),Neo.create(h,t)}createAllItems(e){return Neo.create(this.constructor,e)}destroy(){let e=this;e.allItems?.destroy(),e.filters?.forEach(e=>e?.destroy()),e.sorters?.forEach(e=>e?.destroy()),e._items.splice(0,e._items.length),e.map.clear(),e.internalIdMap?.clear(),super.destroy()}doSort(e=this._items,t=!1){let r,s,i,l,n,o,a,p,c=this,d=e.slice(),{sorters:h,sortDirections:f,sortProperties:I}=c,g=I.length||0,y=!1,S=!1;g>0&&(h.forEach(e=>{e.sortBy&&(y=!0),e.useTransformValue&&(S=!0)}),y?c._items.sort((e,t)=>{for(r=0;r<g;r++)if(l=h[r],o=l[l.sortBy?"sortBy":"defaultSortBy"](e,t),0!==o)return o;return 0}):(s=S?e.map((e,t)=>{for(i={index:t},r=0;r<g;r++)h[r].useTransformValue?i[I[r]]=h[r].transformValue(e[I[r]]):i[I[r]]=e[I[r]];return i}):e,s.sort((e,t)=>{for(r=0;r<g;r++){if(n=I[r],a=e[n],p=t[n],null==a&&null!=p)return 1;if(null!=a&&null==p)return-1;if(a>p)return 1*f[r];if(a<p)return-1*f[r]}return 0}),S&&(c._items=s.map(t=>e[t.index])))),c[u]=g>0,t||0!==c[m]||c.fire("sort",{items:c._items,previousItems:d,scope:c})}endUpdate(e){const t=this;t[m]>0&&t[m]--,e?t[p]=!1:(t.fire("mutate",{addedItems:t[c],removedItems:t[d]}),t[c].splice(0,t[c].length),t[d].splice(0,t[d].length))}exportFilters(){let e,t=[];return this.filters?.forEach(r=>{e=r.export(),e&&t.push(e)}),t}exportSorters(){let e,t=[];return this.sorters?.forEach(r=>{e=r.export(),e&&t.push(e)}),t}filter(){let e,t,r,s,i,l=this,n=l._filters,o=n.length,u=0,p=l.allItems?._items||l._items,c=0,d=p.length,m=[],h=!1,f=l._items.slice();for(;c<o;c++)n[c].disabled||u++;if(0===u&&l.allItems)l.sorters.length>0&&(h=!0),l._items.splice(0,l.count),l.map.clear(),l.internalIdMap?.clear(),l.initialIndexCounter=0,l.items=l.allItems._items.slice();else if(l.allItems||(e={...l.originalConfig},delete e.filters,delete e.items,delete e.sorters,l.allItems=l.createAllItems({...Neo.clone(e,!0,!0),id:l.id+"-all",keyProperty:l.keyProperty,sourceId:l.id}),l.allItems.items=l._items.slice()),l.map.clear(),l.internalIdMap?.clear(),"primitive"===l.filterMode){for(c=0;c<d;c++){for(t=!0,r=p[c],s=0;s<o;s++)if(n[s].isFiltered(r,p,p)){t=!1;break}if(t&&(m.push(r),l.map.set(l.getKey(r),r),l.trackInternalId)){const e=l.getInternalKey(r);e&&l.internalIdMap.set(e,r)}}l._items=m}else{for(m=p.slice(),s=0;s<o;s++){for(i=[],c=0;c<d;c++)n[s].isFiltered(m[c],m,p)||i.push(m[c]);m=i.slice(),d=m.length}l.items=m}l[a]=0!==u,h&&l.doSort(l.items,!0),l.count=l.items.length,l.fire("filter",{isFiltered:l[a],items:l.items,oldItems:f,scope:l})}find(e,t,r=!1){let s,i,l,n,o=this,a=[],u=o.isItem(e);for(s of(u&&(l=Object.entries(e),n=l.length),o.items))if(u){if(i=[],l.forEach(([e,t])=>{Neo.ns(e,!1,s)===t&&i.push(!0)}),i.length===n){if(r)return s;a.push(s)}}else if(Neo.ns(e,!1,s)===t){if(r)return s;a.push(s)}return r?null:a}findBy(e,t=this,r=0,s=this.count){let i=this,l=[],n=r;for(;n<s;n++)e.call(t,i.items[n])&&l.push(i.items[n]);return l}findFirst(e,t){return this.find(e,t,!0)}first(){return this.getAt(0)}get(e){return this.map.get(e)||this.trackInternalId&&this.internalIdMap?.get(e)||null}getAt(e){return this._items[e]}getByInternalId(e){return this.internalIdMap?.get(e)||null}getCount(){return this._count||0}getCountMutations(){return this[n]}getFilter(e){let t=this.filters||[],r=0,s=t.length;for(;r<s;r++)if(t[r].property===e)return t[r];return null}getInternalKey(e){return null}getKey(e){return e[this.keyProperty]}getKeyAt(e){let t=this._items[e];return t&&this.getKey(t)}getRange(e,t){return this._items.slice(e,t)}getSource(){return this.sourceId&&Neo.get(this.sourceId)}has(e){return this.map.has(e)}hasItem(e){return this.map.has(this.getKey(e))}indexOf(e){let t=this;return t._items.indexOf(t.isItem(e)?e:t.map.get(e))}indexOfItem(e){return this._items.indexOf(e)}indexOfKey(e){return this._items.indexOf(this.map.get(e))}insert(e,t){return this.splice(e,0,t).addedItems}isFiltered(){return this[a]}isFilteredItem(e){let t=this._filters,r=0,s=t.length,i=!1;for(;r<s;r++)if(t[r].isFiltered(e)){i=!0;break}return i}isItem(e){return"object"==typeof e}isSorted(){return this[u]}last(){return this.getAt(this.count-1)}move(e,t){if(e===t)return;let r=this._items;e>=r.length&&(e=r.length-1);const s=r.splice(e,1)[0];r.splice(t,0,s)}onFilterChange(e){this.filter()}onMutate(e){this.preventBubbleUp=!0,this.splice(null,e.removedItems,e.addedItems)}onSorterChange(e){this.applySorterConfigs(),this.doSort()}pop(){return this.splice(this.count-1,1).removedItems[0]}push(e){return this.add(e)}remove(e){return this.splice(0,Array.isArray(e)?e:[e]),this.count}removeAt(e){return this.splice(e,1),this.count}reverse(){return this._items.reverse()}shift(){return this.splice(0,1).addedItems[0]}some(...e){return this._items.some(...e)}forEach(e,t){this._items.forEach(e,t)}splice(e,t,r){let i,l,a,u,c,d,h=this,{keyProperty:f,map:I}=h,g=h.getSource(),y=[],S=h._items,b=[],_=Neo.isNumber(t)?t:null,v=Array.isArray(t)?t:null;if(!Neo.isNumber(e)&&_&&s.error(h.id+": If index is not passed, removeCountAtIndex cannot be used"),r=r&&!Array.isArray(r)?[r]:r,v&&(c=v.length)>0){for(r&&r.length>0&&(d=r.map(e=>h.getKey(e))),l=0;l<c;l++)if(a=v[l],u=h.isItem(a)?h.getKey(a):a,I.has(u)&&(!d||d&&d.indexOf(u)<0)){const e=S.splice(h.indexOfKey(u),1)[0];b.push(e),I.delete(u),h.trackInternalId&&(i=h.getInternalKey(e),i&&h.internalIdMap.delete(i))}}else _&&_>0&&(0===e&&_===h.count?(b=S,h._items=[],I.clear(),h.internalIdMap?.clear()):(b=S.splice(e,_),b.forEach(e=>{I.delete(h.getKey(e)),h.trackInternalId&&(i=h.getInternalKey(e),i&&h.internalIdMap.delete(i))})));if(r&&(c=r.length)>0){for(l=0;l<c;l++)a=r[l],h.itemFactory?.(a),u=h.getKey(a),null==u&&(a[f]=u=h.keyPropertyIndex,h.keyPropertyIndex--),Object.hasOwn(a,o)&&(a[o]=h.initialIndexCounter++),I.has(u)||h.isFilteredItem(a)||(y.push(a),I.set(u,a),h.trackInternalId&&(i=h.getInternalKey(a),i&&h.internalIdMap.set(i,a)));if(y.length>0){if(S&&0!==S.length){const t=Neo.isNumber(e)?e:S.length;if(y.length>5e3){const e=S.slice(0,t),r=S.slice(t);h._items=e.concat(y,r)}else S.splice(t,0,...y)}else h._items=y;h.autoSort&&h._sorters.length>0&&h.doSort(void 0,!0)}}return g&&(g.getSource()||(g.preventBubbleUp=!0),h.preventBubbleUp||(h.startUpdate(!0),g.splice(null,v||b,r),h.endUpdate(!0)),delete g.preventBubbleUp),(y.length>0||b.length>0)&&h[n]++,0===h[m]?(h.count=h._items.length,h.fire("mutate",{addedItems:r,preventBubbleUp:h.preventBubbleUp,removedItems:v||b})):h[p]||h.cacheUpdate({addedItems:y,removedItems:b}),0===h[m]&&delete h.preventBubbleUp,{addedItems:y,removedItems:b}}startUpdate(e){e&&(this[p]=!0),this[m]++}toJSON(){let e=this;return{...super.toJSON(),count:e.count,filters:e.filters.map(e=>e.toJSON()),keyProperty:e.keyProperty,sorters:e.sorters.map(e=>e.toJSON()),sourceId:e.sourceId}}unshift(e){return this.splice(0,0,e),this.count}}export default Neo.setupClass(h);