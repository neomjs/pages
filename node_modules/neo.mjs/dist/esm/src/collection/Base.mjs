import e from"../core/Base.mjs";import t from"./Filter.mjs";import r from"../util/Logger.mjs";import s from"../util/Array.mjs";import i from"../core/Observable.mjs";import o from"./Sorter.mjs";const l=Symbol("countMutations"),n=Symbol.for("initialIndex"),a=Symbol("isFiltered"),u=Symbol("isSorted"),p=Symbol("silentUpdateMode"),h=Symbol("toAddArray"),m=Symbol("toRemoveArray"),c=Symbol("updatingIndex");class d extends e{static observable=!0;static config={className:"Neo.collection.Base",ntype:"collection",allItems:null,autoSort:!0,count_:0,filterMode:"primitive",filters_:[],items_:null,keyProperty:"id",keyPropertyIndex:-1,map_:null,sortDirections:null,sortProperties:null,sorters_:[],sourceId_:null};initialIndexCounter=0;construct(e){let t=this,r={enumerable:!1,writable:!0};Object.defineProperties(t,{[l]:{...r,value:!1},[a]:{...r,value:!1},[u]:{...r,value:!1},[p]:{...r,value:!1},[h]:{...r,value:[]},[m]:{...r,value:[]},[c]:{...r,value:0}}),super.construct(e),t.items=t.items||[],t.autoSort&&t._sorters.length>0&&t.doSort()}add(e){return this.splice(null,null,e).addedItems}afterSetFilters(e,t){let r=this;e.forEach(e=>{!1===e.listenerApplied&&(e.on("change",r.onFilterChange,r),e.listenerApplied=!0)}),t&&r.filter()}afterSetItems(e,t){if(e){let t,r=this,{keyProperty:s}=r,i=0,o=e.length;for(;i<o;i++)t=e[i],r.map.set(t[s],t);r.count=o}}afterSetSorters(e,t){let r=this;r.applySorterConfigs(),e.forEach(e=>{!1===e.listenerApplied&&(e.on("change",r.onSorterChange,r),e.listenerApplied=!0)}),t&&r.autoSort&&r.doSort()}afterSetSourceId(e,t){if(e){let r=this,s=Neo.get(e);r._items=[...s._items],r.map=new Map(s.map);const i={mutate:r.onMutate,scope:r};s.on(i),t&&(s=Neo.get(t),s.un(i))}}applySorterConfigs(){let e=this;e.sortDirections=[],e.sortProperties=[],e.sorters.forEach(t=>{e.sortDirections.push(t.directionMultiplier),e.sortProperties.push(t.property)})}beforeSetFilters(e,r){Array.isArray(e)||(e=e?[e]:[]);let s,i,o=r&&r.length||0;return e.forEach((l,n)=>{if(r)for(s=!1,i=0;i<o;i++){if(r[i]===l){r[i].set({operator:l.operator,property:l.property,value:l.value}),s=!0;break}if(r[i].operator===(l.operator||"===")&&r[i].property===l.property&&r[i].value===l.value){s=!0;break}}s?(e[n]=r[i],r.splice(i,1),o--):e[n]=Neo.create(t,l)}),Array.isArray(r)&&r.forEach(e=>{e.destroy()}),e}beforeSetMap(e,t){return e||new Map}beforeSetSorters(e,t){Array.isArray(e)||(e=e?[e]:[]);let r,s,i=t?.length||0;return e.forEach((l,n)=>{if(t){r=!1,s=0;let{direction:e,property:o}=l;for(;s<i;s++){if(t[s]===l){t[s].set({direction:e,property:o}),r=!0;break}if(t[s].property===o&&t[s].direction===e){r=!0;break}}}r?(e[n]=t[s],t.splice(s,1),i--):e[n]=Neo.create(o,l)}),t?.forEach(e=>{e.destroy()}),e}cacheUpdate(e){}clear(){this.splice(0,this.count),this.initialIndexCounter=0}clearFilters(e){this.filters=e?Neo.clone(this.originalConfig.filters,!0,!0):null}clearSilent(){let e=this;e._items.splice(0,e.count),e.map.clear()}clearSorters(e){this.sorters=e?Neo.clone(this.originalConfig.sorters,!0,!0):null}clone(){let e=this,t=Neo.clone(e.originalConfig,!0),r=e._filters||[],s=e._sorters||[];return t.keyProperty=e.keyProperty,delete t.id,delete t.filters,delete t.items,delete t.sorters,e._items.length>0&&(t.items=[...e._items],t.count=t.items.length),t.filters=[],t.sorters=[],r.forEach(function(e){t.filters.push(e.originalConfig)}),s.forEach(function(e){t.sorters.push(e.originalConfig)}),Neo.create(d,t)}destroy(){let e=this;e._items.splice(0,e._items.length),e.map.clear(),super.destroy()}doSort(e=this._items,t=!1){let r,s,i,o,l,n,a=this,p=[...e],{sorters:h,sortDirections:m,sortProperties:d}=a,f=d.length||0,y=!1,g=!1;f>0&&(h.forEach(e=>{e.sortBy&&(y=!0),e.useTransformValue&&(g=!0)}),y?a._items.sort((e,t)=>{for(r=0;r<f;r++)if(o=h[r],n=o[o.sortBy?"sortBy":"defaultSortBy"](e,t),0!==n)return n;return 0}):(s=g?e.map((e,t)=>{for(i={index:t},r=0;r<f;r++)h[r].useTransformValue?i[d[r]]=h[r].transformValue(e[d[r]]):i[d[r]]=e[d[r]];return i}):e,s.sort((e,t)=>{for(r=0;r<f;r++){if(l=d[r],e[l]>t[l])return 1*m[r];if(e[l]<t[l])return-1*m[r]}return 0}),g&&(a._items=s.map(t=>e[t.index])))),a[u]=f>0,t||0!==a[c]||a.fire("sort",{items:a._items,previousItems:p,scope:a})}endUpdate(e){const t=this;t[c]>0&&t[c]--,e?t[p]=!1:(t.fire("mutate",{addedItems:t[h],removedItems:t[m]}),t[h].splice(0,t[h].length),t[m].splice(0,t[m].length))}exportFilters(){let e,t=[];return this.filters?.forEach(r=>{e=r.export(),e&&t.push(e)}),t}exportSorters(){let e,t=[];return this.sorters?.forEach(r=>{e=r.export(),e&&t.push(e)}),t}filter(){let e,t,r,s,i,o=this,l=o._filters,n=l.length,u=0,p=o.allItems?._items||o._items,h=0,m=p.length,c=[],d=!1,f=[...o._items];for(;h<n;h++)l[h].disabled||u++;if(0===u&&o.allItems)o.sorters.length>0&&(d=!0),o.clearSilent(),o.items=[...o.allItems._items];else if(o.allItems||(e={...o.originalConfig},delete e.filters,delete e.items,delete e.sorters,o.allItems=Neo.create(o.constructor,{...Neo.clone(e,!0,!0),id:o.id+"-all",items:[...o._items],keyProperty:o.keyProperty,sourceId:o.id})),o.map.clear(),"primitive"===o.filterMode){for(h=0;h<m;h++){for(t=!0,r=p[h],s=0;s<n;s++)if(l[s].isFiltered(r,p,p)){t=!1;break}t&&(c.push(r),o.map.set(r[o.keyProperty],r))}o._items=c}else{for(c=[...p],s=0;s<n;s++){for(i=[],h=0;h<m;h++)l[s].isFiltered(c[h],c,p)||i.push(c[h]);c=[...i],m=c.length}o.items=c}o[a]=0!==u,d&&o.doSort(o.items,!0),o.count=o.items.length,o.fire("filter",{isFiltered:o[a],items:o.items,oldItems:f,scope:o})}find(e,t,r=!1){let s,i,o,l,n=this,a=[],u=n.isItem(e);for(s of(u&&(o=Object.entries(e),l=o.length),n.items))if(u){if(i=[],o.forEach(([e,t])=>{Neo.ns(e,!1,s)===t&&i.push(!0)}),i.length===l){if(r)return s;a.push(s)}}else if(Neo.ns(e,!1,s)===t){if(r)return s;a.push(s)}return r?null:a}findBy(e,t=this,r=0,s=this.count){let i=this,o=[],l=r;for(;l<s;l++)e.call(t,i.items[l])&&o.push(i.items[l]);return o}findFirst(e,t){return this.find(e,t,!0)}first(){return this.getAt(0)}get(e){return this.map.get(e)||null}getAt(e){return this._items[e]}getCount(){return this._count||0}getCountMutations(){return this[l]}getFilter(e){let t=this.filters||[],r=0,s=t.length;for(;r<s;r++)if(t[r].property===e)return t[r];return null}getKeyAt(e){let t=this._items[e];return t?.[this.keyProperty]}getRange(e,t){return this._items.slice(e,t)}getSource(){return this.sourceId&&Neo.get(this.sourceId)}has(e){return this.map.has(e)}hasItem(e){return this.map.has(e[this.keyProperty])}indexOf(e){let t=this;return t._items.indexOf(t.isItem(e)?e:t.map.get(e))}indexOfItem(e){return this._items.indexOf(e)}indexOfKey(e){return this._items.indexOf(this.map.get(e))}insert(e,t){return this.splice(e,0,t).addedItems}isFiltered(){return this[a]}isFilteredItem(e){let t=this._filters,r=0,s=t.length,i=!1;for(;r<s;r++)if(t[r].isFiltered(e)){i=!0;break}return i}isItem(e){return"object"==typeof e}isSorted(){return this[u]}last(){return this.getAt(this.count-1)}move(e,t){if(e===t)return;let r=this._items;e>=r.length&&(e=r.length-1);const s=r.splice(e,1)[0];r.splice(t,0,s)}onFilterChange(e){this.filter()}onMutate(e){this.preventBubbleUp=!0,this.splice(null,e.removedItems,e.addedItems)}onSorterChange(e){this.applySorterConfigs(),this.doSort()}pop(){return this.splice(this.count-1,1).removedItems[0]}push(e){return this.add(e)}remove(e){return this.splice(0,Array.isArray(e)?e:[e]),this.count}removeAt(e){return this.splice(e,1),this.count}reverse(){return this._items.reverse()}shift(){return this.splice(0,1).addedItems[0]}some(...e){return this._items.some(...e)}forEach(e,t){this._items.forEach(e,t)}splice(e,t,s){let i,o,a,u,h,m=this,{keyProperty:d,map:f}=m,y=m.getSource(),g=[],I=m._items,S=[],b=Neo.isNumber(t)?t:null,_=Array.isArray(t)?t:null;if(!Neo.isNumber(e)&&b&&r.error(m.id+": If index is not passed, removeCountAtIndex cannot be used"),s=s&&!Array.isArray(s)?[s]:s,_&&(u=_.length)>0)for(s&&s.length>0&&(h=s.map(e=>e[d])),i=0;i<u;i++)o=_[i],a=m.isItem(o)?o[d]:o,f.has(a)&&(!h||h&&h.indexOf(a)<0)&&(S.push(I.splice(m.indexOfKey(a),1)[0]),f.delete(a));else b&&b>0&&(0===e&&b===m.count?(S=I,m._items=[],f.clear()):(S=I.splice(e,b),S.forEach(e=>{f.delete(e[d])})));if(s&&(u=s.length)>0){for(i=0;i<u;i++)o=s[i],a=o[d],a||(o[d]=a=m.keyPropertyIndex,m.keyPropertyIndex--),Object.hasOwn(o,n)&&(o[n]=m.initialIndexCounter++),f.has(a)||m.isFilteredItem(o)||(g.push(o),f.set(a,o));if(g.length>0){if(I&&0!==I.length){const t=Neo.isNumber(e)?e:I.length;if(g.length>5e3){const e=I.slice(0,t),r=I.slice(t);m._items=e.concat(g,r)}else I.splice(t,0,...g)}else m._items=g;m.autoSort&&m._sorters.length>0&&m.doSort(void 0,!0)}}return y&&(y.getSource()||(y.preventBubbleUp=!0),m.preventBubbleUp||(m.startUpdate(!0),y.splice(null,_||S,s),m.endUpdate(!0)),delete y.preventBubbleUp),(g.length>0||S.length>0)&&m[l]++,0===m[c]?(m.count=m._items.length,m.fire("mutate",{addedItems:s,preventBubbleUp:m.preventBubbleUp,removedItems:_||S})):m[p]||m.cacheUpdate({addedItems:g,removedItems:S}),0===m[c]&&delete m.preventBubbleUp,{addedItems:g,removedItems:S}}startUpdate(e){e&&(this[p]=!0),this[c]++}toJSON(){let e=this;return{...super.toJSON(),count:e.count,filters:e.filters.map(e=>e.toJSON()),keyProperty:e.keyProperty,sorters:e.sorters.map(e=>e.toJSON()),sourceId:e.sourceId}}unshift(e){return this.splice(0,0,e),this.count}}export default Neo.setupClass(d);