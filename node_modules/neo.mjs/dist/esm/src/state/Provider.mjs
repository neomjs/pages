import t from"../core/Base.mjs";import e from"../util/ClassSystem.mjs";import r from"../core/Config.mjs";import s from"../core/Effect.mjs";import a from"../core/Observable.mjs";import{createHierarchicalDataProxy as o}from"./createHierarchicalDataProxy.mjs";import{isDescriptor as n}from"../core/ConfigSymbols.mjs";const i=Symbol.for("twoWayBinding");export default Neo.setupClass(class extends t{static observable=!0;static config={className:"Neo.state.Provider",ntype:"state-provider",component:null,data_:{[n]:!0,merge:"deep",value:{}},formulas_:null,parent_:null,stores_:null};#t=new Map;#e={};#r=new Map;construct(t){Neo.isUsingStateProviders=!0,super.construct(t)}afterSetData(t,e){t&&this.processDataObject(t)}afterSetFormulas(t,e){const r=this;r.#r.forEach(t=>t.destroy()),r.#r.clear(),t&&Object.entries(t).forEach(([t,e])=>{const a=new s({fn:()=>{const s=r.getHierarchyData(),a=e(s);isNaN(a)?r.setData(t,null):r.setData(t,a)}});r.#r.set(t,a)})}beforeGetData(t){return this.getHierarchyData()}beforeSetStores(t,r){if(t){let r=this;Object.entries(t).forEach(([s,a])=>{Object.entries(a.listeners||{}).forEach(([t,e])=>{r.bindCallback(e,t,r,a.listeners)}),t[s]=e.beforeSetInstance(a)})}return t}createBinding(t,e,r,a){const o=this,n=new s({fn:()=>{const s=Neo.get(t);if(s&&!s.isDestroyed){const t=o.getHierarchyData(),a=Neo.isFunction(r)?r.call(o,t):t[r];s._skipTwoWayPush=e,s[e]=a,delete s._skipTwoWayPush}}});return o.#t.set(t,n),o.observeConfig(t,"isDestroying",e=>{e&&(n.destroy(),o.#t.delete(t))}),n}createBindings(t){let e=!1;Object.entries(t.bind||{}).forEach(([r,s])=>{let a=s;Neo.isObject(s)&&(s.twoWay&&(e=!0),a=s.key),this.isStoreValue(a)?this.resolveStore(t,r,a.substring(7)):this.createBinding(t.id,r,a,s.twoWay)}),e&&(t[i]=!0)}destroy(){const t=this;t.#r.forEach(t=>t.destroy()),t.#r.clear(),t.#t.forEach(t=>t.destroy()),t.#t.clear(),super.destroy()}getController(t){return this.component.getController(t)}getData(t){const e=this.getOwnerOfDataProperty(t);if(e)return e.owner.getDataConfig(e.propertyName).get()}getDataConfig(t){return this.#e[t]||null}getHierarchyData(){return o(this)}getOwnerOfDataProperty(t){let e=this;if(e.#e[t])return{owner:e,propertyName:t};const r=e.getParent();return r?r.getOwnerOfDataProperty(t):null}getParent(){let t=this;return t._parent?t._parent:t.component&&t.component.parent?.getStateProvider()||null}getStore(t,e=this){let r,{stores:s}=this;return s?.hasOwnProperty(t)?s[t]:(r=this.getParent(),r||console.error(`store '${t}' not found inside this stateProvider or parents.`,e),r.getStore(t,e))}hasNestedDataStartingWith(t){const e=`${t}.`;return!!Object.keys(this.#e).some(t=>t.startsWith(e))||(this.getParent()?.hasNestedDataStartingWith(t)||!1)}getTopLevelDataKeys(t){const e=new Set,r=t?`${t}.`:"";for(const t in this.#e)if(t.startsWith(r)){const s=t.substring(r.length).split(".")[0];s&&e.add(s)}return Array.from(e)}internalSetData(t,e,s){const a=this;if(Neo.isObject(e)&&e.isRecord){const r=a.getOwnerOfDataProperty(t),o=r?r.owner:s||a;return void a.#s(o,t,e,null)}if(Neo.isObject(t))return void Object.entries(t).forEach(([t,e])=>{a.internalSetData(t,e,s)});const o=a.getOwnerOfDataProperty(t),n=o?o.owner:s||a,i=t.split(".");let c="",f=null,l=n;for(let t=0;t<i.length;t++){const s=i[t];c=c?`${c}.${s}`:s,f=l.getDataConfig(c),t===i.length-1?a.#s(l,c,e,null):f?Neo.isObject(f.get())||f.set({}):(f=new r({}),l.#e[c]=f)}}isStoreValue(t){return Neo.isString(t)&&t.startsWith("stores.")}onDataPropertyChange(t,e,r){}processDataObject(t,e=""){let s=this;Object.entries(t).forEach(([t,a])=>{const o=e?`${e}.${t}`:t;s.#e[o]?s.#e[o].set(a):s.#e[o]=new r(a),"Object"===Neo.typeOf(a)&&s.processDataObject(a,o)})}resolveStore(t,e,r){let s=this.getStore(r);t[e]!==s&&(t[e]=s)}#s(t,e,s,a){let o=t.getDataConfig(e),n=a;o?(n=o.get(),o.set(s)):(o=new r(s),t.#e[e]=o,t.#t.forEach(t=>t.run())),t.onDataPropertyChange(e,s,n)}setData(t,e){this.internalSetData(t,e,this)}setDataAtSameLevel(t,e){this.internalSetData(t,e)}});