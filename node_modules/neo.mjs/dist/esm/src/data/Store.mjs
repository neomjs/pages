import e from"../collection/Base.mjs";import t from"../util/ClassSystem.mjs";import r from"./Model.mjs";import o from"../core/Observable.mjs";import s from"./RecordFactory.mjs";export default Neo.setupClass(class extends e{static observable=!0;static config={className:"Neo.data.Store",ntype:"store",api_:null,autoLoad:!1,currentPage_:1,data_:null,initialData_:null,initialChunkSize:0,isGrouped:!1,isLoaded:!1,isLoading:!1,model_:null,pageSize_:0,remoteFilter:!1,remoteSort:!1,responseRoot:"data",totalCount:0,url:null};construct(e){super.construct(e);let t=this;t.on({mutate:t.onCollectionMutate,sort:t.onCollectionSort,scope:t})}add(e){let t=this,r=Array.isArray(e)?e:[e],o=t.initialChunkSize;if(o>0&&r.length>o){const e=t.count+r.length,s=r.splice(0,o);return t.chunkingTotal=e,super.add(s),t.suspendEvents=!0,super.add(r),t.suspendEvents=!1,t.fire("load",{items:t.items,postChunkLoad:!0,total:t.chunkingTotal}),delete t.chunkingTotal,t.count}const s=super.add(r);return t.isLoaded=!0,s}afterSetCurrentPage(e,t){t&&this.load()}afterSetData(e,t){let r=this;r.configsApplied&&e&&(t?r.clear():r.initialData=[...e],r.isLoading=!1,r.add(e))}afterSetFilters(e,t){super.afterSetFilters(e,t);let r=this;r._currentPage=1,t&&r.remoteFilter&&r.load()}afterSetInitialData(e,t){}afterSetModel(e,t){e&&(e.storeId=this.id)}afterSetPageSize(e,t){t&&(this._currentPage=1,this.load())}afterSetSorters(e,t){super.afterSetSorters(e,t);let r=this;r._currentPage=1,t&&r.remoteSort&&r.load()}beforeSetApi(e,t){return"String"===Neo.typeOf(e)&&(e={create:e+".create",destroy:e+".destroy",read:e+".read",update:e+".update"}),e}beforeSetData(e,t){return e&&(this.isLoading=!0),e}beforeSetInitialData(e,t){return!e&&t?t:e}beforeSetModel(e,o){return o?.destroy(),t.beforeSetInstance(e,r)}createRecord(e){let t=!0;if(e){Array.isArray(e)||(t=!1,e=[e]);let r,o=this,i=0,a=e.length;for(;i<a;i++)r=e[i],s.isRecord(r)||(e[i]=s.createRecord(o.model,r))}return t?e:e[0]}find(e,t,r=!1){const o=super.find(e,t,r);return r?o?this.get(o[this.keyProperty]):null:o.map(e=>this.get(e[this.keyProperty]))}findBy(e,t=this,r=0,o=this.count){return super.findBy(e,t,r,o).map(e=>this.get(e[this.keyProperty]))}forEach(e,t){const r=this;for(let o=0;o<r.count;o++)e.call(t||r,r.getAt(o),o,r.items)}get(e){let t=this,r=super.get(e);if(r&&!s.isRecord(r)){const o=s.createRecord(t.model,r),i=t.indexOf(r);if(t.map.set(e,o),-1!==i&&(t._items[i]=o),t.allItems){const s=t.allItems.indexOf(r);-1!==s&&(t.allItems.map.set(e,o),t.allItems._items[s]=o)}return o}return r}getAt(e){let t=this,r=super.getAt(e);if(r&&!s.isRecord(r)){const o=s.createRecord(t.model,r);if(t.map.set(o[t.keyProperty],o),t._items[e]=o,t.allItems){const e=t.allItems.indexOf(r);-1!==e&&(t.allItems.map.set(o[t.keyProperty],o),t.allItems._items[e]=o)}return o}return r}getKeyProperty(){return this.keyProperty||this.model.keyProperty}getKeyType(){let{model:e}=this,t=e?.getField(this.getKeyProperty());return t?.type?.toLowerCase()||null}async load(e={}){let t=this,r={page:t.currentPage,pageSize:t.pageSize,...e.params};if(t.remoteFilter&&(r.filters=t.exportFilters()),t.remoteSort&&(r.sorters=t.exportSorters()),t.api){let e=t.api.read.split("."),o=e.pop(),s=Neo.ns(e.join("."));if(s){const e=await s[o](r);return e.success?(t.totalCount=e.totalCount,t.data=Neo.ns(t.responseRoot,!1,e),t.isLoaded=!0,t.data):null}console.error("Api is not defined",this)}else{e.url??=t.url;try{let r;if(globalThis.process?.release){const{readFile:t}=await import("fs/promises"),o=await t(e.url,"utf-8");r={json:JSON.parse(o)}}else r=await Neo.Xhr.promiseJson(e);return r&&(t.data=Neo.ns(t.responseRoot,!1,r.json)||r.json),t.isLoaded=!0,r?.json||null}catch(r){return console.error("Error for Neo.Xhr.request",{id:t.id,error:r,url:e.url}),null}}}onCollectionMutate(e){let t=this;t.isConstructed&&!t.isLoading&&t.fire("load",{items:t.items,total:t.chunkingTotal})}onCollectionSort(){this.isConstructed}onConstructed(){super.onConstructed();let e=this;e.data&&e.afterSetData(e.data),Promise.resolve().then(()=>{e.isLoaded?e.fire("load",{items:e.items}):e.autoLoad&&e.load()})}onFilterChange(e){let t=this;t.remoteFilter?(t._currentPage=1,t.load()):super.onFilterChange(e)}onRecordChange(e){this.fire("recordChange",{...e,index:this.indexOf(e.record)})}sort(e={}){let t=this;t._currentPage=1,t.configsApplied&&(e.direction?t.sorters=[{direction:e.direction,property:e.property}]:(t.remoteSort||(t.startUpdate(),t.clear()),t.sorters=[],t.remoteSort||(t.add([...t.initialData]),t.endUpdate(),t.fire("sort"))))}});