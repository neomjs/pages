import{internalId as e}from"../core/ConfigSymbols.mjs";import t from"../util/ClassSystem.mjs";import r from"../collection/Base.mjs";import o from"./Model.mjs";import s from"../core/Observable.mjs";import i from"./RecordFactory.mjs";import a from"../manager/Store.mjs";const n=Symbol.for("initialIndex");export default Neo.setupClass(class extends r{static observable=!0;static config={className:"Neo.data.Store",ntype:"store",api_:null,autoInitRecords:!0,autoLoad:!1,currentPage_:1,data_:null,initialChunkSize:0,isGrouped:!1,isLoaded:!1,isLoading:!1,model_:null,pageSize_:0,proxy_:null,remoteFilter:!1,remoteSort:!1,responseRoot:"data",totalCount:0,trackInternalId:!0,url:null};construct(e){(e=e||{}).itemFactory=this.assignInternalId.bind(this),super.construct(e);let t=this;t.on({mutate:t.onCollectionMutate,sort:t.onCollectionSort,scope:t}),a.register(t)}destroy(){a.unregister(this),super.destroy()}assignInternalId(t){t[e]||(t[e]=Neo.getId("record"))}abort(){this.proxy?.abort?.()}add(e,t=this.autoInitRecords){let r=this,o=Array.isArray(e)?e:[e],s=r.initialChunkSize;if(t)return super.add(o),r.isLoaded=!0,o.map(e=>r.get(r.getKey(e)));if(s>0&&o.length>s){const e=r.count+o.length,t=o.splice(0,s);return r.chunkingTotal=e,super.add(t),r.suspendEvents=!0,super.add(o),r.suspendEvents=!1,r.fire("load",{items:r.items,postChunkLoad:!0,total:r.chunkingTotal}),delete r.chunkingTotal,r.count}const i=super.add(o);return r.isLoaded=!0,i}afterSetCurrentPage(e,t){t&&this.load()}afterSetData(e,t){let r=this;r.configsApplied&&e&&(t&&r.clear(),r.isLoading=!1,r.add(e,r.autoInitRecords))}afterSetFilters(e,t){super.afterSetFilters(e,t);let r=this;r._currentPage=1,t&&r.remoteFilter&&r.load()}afterSetModel(e,t){e&&(e.storeId=this.id)}afterSetPageSize(e,t){t&&(this._currentPage=1,this.load())}afterSetSorters(e,t){super.afterSetSorters(e,t);let r=this;r._currentPage=1,t&&r.remoteSort&&r.load()}beforeSetApi(e,t){return"String"===Neo.typeOf(e)&&(e={create:e+".create",destroy:e+".destroy",read:e+".read",update:e+".update"}),e}beforeSetProxy(e,r){return r&&r.destroy(),t.beforeSetInstance(e,null,{store:this})}beforeSetData(e,t){return e&&(this.isLoading=!0),e}beforeSetModel(e,r){return r?.destroy(),t.beforeSetInstance(e,o)}createAllItems(e){return e.autoLoad=!1,super.createAllItems(e)}createRecord(e){let t=!0;if(e){Array.isArray(e)||(t=!1,e=[e]);let r,o=this,s=0,a=e.length;for(;s<a;s++)r=e[s],i.isRecord(r)||(e[s]=i.createRecord(o.model,r))}return t?e:e[0]}find(e,t,r=!1){const o=super.find(e,t,r);return r?o?this.get(this.getKey(o)):null:o.map(e=>this.get(this.getKey(e)))}findBy(e,t=this,r=0,o=this.count){return super.findBy(e,t,r,o).map(e=>this.get(this.getKey(e)))}forEach(e,t){const r=this;for(let o=0;o<r.count;o++)e.call(t||r,r.getAt(o),o,r.items)}get(e){let t=this,r=super.get(e);if(r&&!i.isRecord(r)){const e=i.createRecord(t.model,r),o=t.indexOf(r),s=e[t.keyProperty];if(t.map.set(s,e),-1!==o&&(t._items[o]=e),t.trackInternalId){const r=t.getInternalKey(e);r&&t.internalIdMap.set(r,e)}if(t.allItems){const o=t.allItems.indexOf(r);if(-1!==o&&(t.allItems.map.set(s,e),t.allItems._items[o]=e,t.allItems.trackInternalId)){const r=t.getInternalKey(e);r&&t.allItems.internalIdMap.set(r,e)}}return e}return r}getAt(e){let t=this,r=super.getAt(e);if(r&&!i.isRecord(r)){const o=i.createRecord(t.model,r);if(t.map.set(o[t.keyProperty],o),t._items[e]=o,t.trackInternalId){const e=t.getInternalKey(o);e&&t.internalIdMap.set(e,o)}if(t.allItems){const e=t.allItems.indexOf(r);if(-1!==e&&(t.allItems.map.set(o[t.keyProperty],o),t.allItems._items[e]=o,t.allItems.trackInternalId)){const e=t.getInternalKey(o);e&&t.allItems.internalIdMap.set(e,o)}}return o}return r}getInternalId(t){return t[e]||(t[e]=Neo.getId("record")),t[e]}getInternalKey(t){return t[e]}getKeyProperty(){return this.keyProperty||this.model.keyProperty}getKeyType(){let{model:e}=this,t=e?.getField(this.getKeyProperty());return t?.type?.toLowerCase()||null}initRecord(e){return i.isRecord(e)?e:this.get(this.getKey(e))}insert(e,t,r=this.autoInitRecords){let o=this,s=super.insert(e,t);return r?s.map(e=>o.get(o.getKey(e))):s}async load(e={}){let t=this,r={page:t.currentPage,pageSize:t.pageSize,...e.params};if(t.remoteFilter&&(r.filters=t.exportFilters()),t.remoteSort&&(r.sorters=t.exportSorters()),t.api){let e=t.api.read.split("."),o=e.pop(),s=Neo.ns(e.join("."));if(s){const e=await t.trap(s[o](r));return e.success?(t.totalCount=e.totalCount,t.data=Neo.ns(t.responseRoot,!1,e),t.isLoaded=!0,t.data):null}console.error("Api is not defined",this)}else if(t.proxy){t.items.length>0&&!e.append&&t.clear(),t.isLoading=!0;const o=e=>{t.add(e),t.isLoading&&(t.isLoading=!1)},s=e=>{t.fire("progress",e)};t.proxy.on({data:o,progress:s});try{e.url&&(r.url=e.url);const i=await t.proxy.read(r);return t.proxy.un({data:o,progress:s}),i.success?(t.totalCount=i.totalCount||t.count,t.isLoaded=!0,t.isLoading=!1,t.fire("load",{isLoading:!1,items:t.items,postChunkLoad:"proxy-stream"===t.proxy?.ntype,total:t.totalCount}),t.items):(t.isLoading=!1,null)}catch(e){throw t.proxy.un({data:o,progress:s}),t.isLoading=!1,e}}else{e.url??=t.url;try{let r;if(globalThis.process?.release){const{readFile:o}=await import("fs/promises"),s=await t.trap(o(e.url,"utf-8"));r={json:JSON.parse(s)}}else r=await t.trap(Neo.Xhr.promiseJson(e));return r&&(t.data=Neo.ns(t.responseRoot,!1,r.json)||r.json),t.isLoaded=!0,r?.json||null}catch(r){if(r===Neo.isDestroyed)throw r;return console.error("Error for Neo.Xhr.request",{id:t.id,error:r,url:e.url}),null}}}onCollectionMutate(e){let t=this;if(t.isConstructed&&!t.isLoading){const r=e.addedItems&&t.count===e.addedItems.length;t.fire("load",{isLoading:!!t.isStreaming,items:t.items,postChunkLoad:!!t.isStreaming&&!r,total:t.chunkingTotal})}}onCollectionSort(){let e=this;e.isConstructed&&e.fire("load",{items:e.items})}onConstructed(){super.onConstructed();let e=this;e.data&&e.afterSetData(e.data),Promise.resolve().then(()=>{e.isLoaded?e.fire("load",{items:e.items}):e.autoLoad&&e.load()})}onFilterChange(e){let t=this;t.remoteFilter?(t._currentPage=1,t.load()):super.onFilterChange(e)}onRecordChange(e){this.fire("recordChange",{...e,index:this.indexOf(e.record)})}sort(e={}){let t=this;t._currentPage=1,t.configsApplied&&(e.direction?t.sorters=[{direction:e.direction,property:e.property}]:t.remoteSort||(t.sorters=[{direction:"ASC",property:n}]))}doSort(e=this._items,t=!1){let r=this;if(!r.autoInitRecords&&r.model?.hasComplexFields&&r.sorters.length>0){const t=r.sorters.map(e=>e.property),o=t.length;e.forEach(e=>{if(!i.isRecord(e))for(let s=0;s<o;s++){const o=t[s];Object.hasOwn(e,o)||(e[o]=r.resolveField(e,o))}})}super.doSort(e,t)}filter(){let e=this;if(!e.autoInitRecords&&e.model?.hasComplexFields&&e.filters.length>0){const t=e.filters.filter(e=>!e.disabled&&null!==e.value).map(e=>e.property),r=t.length;if(r>0){(e.allItems?e.allItems._items:e._items).forEach(o=>{if(!i.isRecord(o))for(let s=0;s<r;s++){const r=t[s];Object.hasOwn(o,r)||(o[r]=e.resolveField(o,r))}})}}super.filter()}isFilteredItem(e){let t=this;return!t.autoInitRecords&&!i.isRecord(e)&&t.filters.length>0&&t.filters.forEach(r=>{r.disabled||null===r.value||Object.hasOwn(e,r.property)||(e[r.property]=t.resolveField(e,r.property))}),super.isFilteredItem(e)}resolveField(e,t){let r,o=this,s=o.model.getField(t);if(s){if(!i.isRecord(e)&&s.depends){let t,r=s.depends,i=0,a=r.length;for(;i<a;i++)t=r[i],void 0===e[t]&&(e[t]=o.resolveField(e,t))}if(s.calculate)r=s.calculate(e);else{if(s.mapping){let t=s.mapping.split("."),o=t.pop(),i=t.length>0?Neo.ns(t,!1,e):e;i&&Object.hasOwn(i,o)&&(r=i[o])}else r=e[t];s.convert&&(r=s.convert(r,e)),void 0===r&&Object.hasOwn(s,"defaultValue")&&(r=Neo.isFunction(s.defaultValue)?s.defaultValue():s.defaultValue)}return i.isRecord(e)||(e[t]=r),r}}getKey(e){let t,r=this,o=r.getKeyProperty();if(i.isRecord(e))return e.get(o);if(t=o.includes(".")?Neo.ns(o,!1,e):e[o],void 0===t&&r.model){let s=r.model.getField(o);if(s?.mapping){let r=s.mapping;t=r.includes(".")?Neo.ns(r,!1,e):e[r]}}return t}toJSON(){let e=this;return{...super.toJSON(),autoInitRecords:e.autoInitRecords,autoLoad:e.autoLoad,currentPage:e.currentPage,initialChunkSize:e.initialChunkSize,isGrouped:e.isGrouped,isLoaded:e.isLoaded,isLoading:e.isLoading,model:e.model?.toJSON(),pageSize:e.pageSize,remoteFilter:e.remoteFilter,remoteSort:e.remoteSort,totalCount:e.totalCount,url:e.url}}});