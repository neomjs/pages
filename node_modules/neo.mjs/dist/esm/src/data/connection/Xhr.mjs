import e from"../../core/Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.data.connection.Xhr",ntype:"xhr-connection",callback:null,defaultHeaders:null,requests:{},scope:null,timeout:5e3};getResponse(e){let{target:t}=e,{readyState:s,response:r,status:a,statusText:o}=t;return{readyState:s,response:r,status:a,statusText:o,headers:t.getAllResponseHeaders()}}onError(e){let t=this,s=e.currentTarget.neoId,r=t.requests[s],a=r.callback;a?.apply(r.scope||t,[t.getResponse(e),!1]),Object.entries(r).forEach((([e,t])=>{r[e]=null})),delete t.requests[s]}onLoad(e){let t=this,s=e.currentTarget.neoId,r=t.requests[s],a=r.callback;a?.apply(r.scope||t,[t.getResponse(e),!0]),Object.entries(r).forEach((([e,t])=>{r[e]=null})),delete t.requests[s]}onProgress(){}promiseJson(e){let t=this;return new Promise(((s,r)=>{e.callback=function(e,t){if(t){let t;try{t=JSON.parse(e.response),s(Object.assign(e,{json:t}))}catch(e){r({reject:!0,error:e.message})}}else r(e)},t.request(e)}))}promiseRequest(e){let t=this;return new Promise(((s,r)=>{e.callback=function(e,t){t?s(e):r(e)},t.request(e)}))}request(e){let t=this,s={...t.defaultHeaders,...e.headers||{}},r=Neo.getId("xhr-request"),a=e.method||"GET",o=new XMLHttpRequest;if(e.url)return e.insideNeo||!location.href.includes("/node_modules/neo.mjs/")||location.href.startsWith("https://neomjs.com/")||(e.url.startsWith("./")||e.url.startsWith("../"))&&(e.url="../../"+e.url),e.params&&(e.url+="?"+new URLSearchParams(e.params).toString()),o.neoId=r,t.requests[r]={callback:"function"==typeof e.callback&&e.callback,scope:e.scope,xhr:o},o.responseType=e.responseType||"text",o.timeout=t.timeout,o.addEventListener("abort",t.onError.bind(t)),o.addEventListener("error",t.onError.bind(t)),o.addEventListener("load",t.onLoad.bind(t)),o.addEventListener("progress",t.onProgress.bind(t)),o.open(a,e.url,!0),Object.entries(s).forEach((([e,t])=>{o.setRequestHeader(e,t)})),o.send(e.data),o;console.error("Neo.Xhr.request without a given url"+JSON.stringify(e))}sendForm(e,t){return t.data=new FormData(e),this.request(t)}setDefaultHeaders(e){this.defaultHeaders=e}});