import e from"./Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.data.proxy.Stream",ntype:"proxy-stream",chunkSize:500,compression:null,initialBurstCount:5,initialChunkSize:100,progressiveChunkSize:!1};abortController=null;abort(){this.abortController?.abort()}async read(e){let r=this,t=[],{chunkSize:o,progressiveChunkSize:n}=r,s=r.initialChunkSize||o,i=0,a=0,l=r.url||e.url;if(!l)throw new Error("No URL specified");r.abortController=new AbortController,r.store.isStreaming=!0;try{const e=await fetch(l,{signal:r.abortController.signal});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);if(!e.body)throw new Error("ReadableStream not supported in this environment.");let c=e.body;if(r.compression){if("undefined"==typeof DecompressionStream)throw new Error("DecompressionStream not supported in this environment.");c=c.pipeThrough(new DecompressionStream(r.compression))}const u=c.getReader(),p=new TextDecoder;let h="",m=0;const d=parseInt(e.headers.get("content-length")||0,10);for(;;){const{value:e,done:l}=await u.read();if(l){h.trim()&&(r.processLine(h,t),a++),t.length>0&&(r.fire("data",t),r.store.isStreaming=!1);break}m+=e.byteLength,r.fire("progress",{loaded:m,total:d}),h+=p.decode(e,{stream:!0});const c=h.split("\n");h=c.pop();for(const e of c)e.trim()&&(r.processLine(e,t),a++,t.length>=s&&(r.fire("data",t),i++,n?s=r.getProgressiveChunkSize(a):i>=r.initialBurstCount&&(s=o),await r.timeout(1),t=[]))}return{success:!0,count:a}}catch(e){if("AbortError"===e.name)return console.log("Stream request aborted"),r.store.isStreaming=!1,{success:!0,count:a,aborted:!0};throw e}finally{r.abortController=null}}getProgressiveChunkSize(e){return e<100?100:e<250?150:e<500?250:e<1e3?500:e<2500?1500:e<1e4?2500:e<2e4?5e3:1e4}processLine(e,r){try{r.push(JSON.parse(e))}catch(r){console.warn("JSON parse error in Stream proxy:",r,e)}}});