import e from"../core/Base.mjs";import t from"./mixin/DeltaUpdates.mjs";import o from"./DomUtils.mjs";import n from"../core/Observable.mjs";import s from"../util/Rectangle.mjs";import i from"../util/String.mjs";const r=e=>e.preventDefault(),l=e=>!e.classList.contains("neo-focus-trap")&&o.isTabbable(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP,a=/^\d+\w+$/,d={capture:!0,passive:!0},c=["font-family","font-kerning","font-size","font-size-adjust","font-stretch","font-style","font-weight","letter-spacing","line-height","text-decoration","text-transform","word-break"],u={Shift:1,Alt:1,Meta:1,Control:1};export default Neo.setupClass(class extends e{static config={className:"Neo.main.DomAccess",countDeltas:0,countDeltasPer250ms:0,countUpdates:0,mixins:[t,n],remote:{app:["addScript","align","applyBodyCls","blur","execCommand","focus","getAttributes","getBoundingClientRect","getScrollingDimensions","measure","monitorAutoGrow","monitorAutoGrowHandler","navigate","navigateTo","scrollBy","scrollIntoView","scrollTo","scrollToTableRow","selectNode","setBodyCls","setStyle","syncModalMask","trapFocus","windowScrollTo"]},renderCountDeltas_:!1,singleton:!0,voidAttributes:["checked","required"]};logDeltasIntervalId=0;get modalMask(){let e=this;return e._modalMask||(e._modalMask=document.createElement("div"),e._modalMask.className="neo-dialog-modal-mask",e._modalMask.addEventListener("mousedown",r,{capture:!0})),e._modalMask}construct(e){super.construct(e);let t=this;Neo.config.renderCountDeltas&&(t.renderCountDeltas=!0),t.initGlobalListeners(),t.syncAligns=t.syncAligns.bind(t)}addAligned(e){const t=this,{id:o}=e,n=t._aligns||(t._aligns=new Map),s=t._alignResizeObserver||(t._alignResizeObserver=new ResizeObserver(t.syncAligns)),{constrainToElement:i}=e;n.has(o)||(s.observe(e.offsetParent),s.observe(e.targetElement),i&&s.observe(i)),t.hasDocumentScrollListener||(document.addEventListener("scroll",t.syncAligns,{capture:!0,passive:!0}),t.hasDocumentScrollListener=!0),t.documentMutationObserver||(t.documentMutationObserver=new MutationObserver(t.onDocumentMutation.bind(t)),t.documentMutationObserver.observe(document.body,{childList:!0,subtree:!0})),n.set(o,e)}addScript(e){let t=document.createElement("script");e.hasOwnProperty("async")||(e.async=!0),Object.assign(t,e),document.head.appendChild(t)}afterSetRenderCountDeltas(e,t){let o,n=this,{logDeltasIntervalId:s}=n;e?0===s&&(n.logDeltasIntervalId=setInterval((()=>{o=document.getElementById("neo-delta-updates"),o&&(o.innerHTML=String(4*n.countDeltasPer250ms)),n.countDeltasPer250ms=0}),250)):(s&&clearInterval(s),n.logDeltasInterval=0)}async align(e){const t=this,{constrainTo:o}=e,n=e.subject=t.getElement(e.id),{style:s}=n,i={...e},r=t._aligns?.get(e.id);if(r&&n.classList.remove(`neo-aligned-${r.result.position}`),t.resetDimensions(i),i.target=t.getClippedRect({id:e.targetElement=t.getElementOrBody(e.target)}),!i.target)return Neo.worker.App.setConfigs({id:e.id,hidden:!0});e.offsetParent=e.targetElement.offsetParent,o&&(i.constrainTo=t.getBoundingClientRect({id:e.constrainToElement=t.getElementOrBody(o)}));const l=t.getBoundingClientRect(e),a=e.result=l.alignTo(i);Object.assign(s,{top:0,left:0,transform:`translate(${a.x}px,${a.y}px)`}),a.width!==l.width&&(s.width=`${a.width}px`),a.height!==l.height&&(s.height=`${a.height}px`),n.classList.add(`neo-aligned-${a.position}`),t.addAligned(e)}applyBodyCls(e){let t=e.cls||[];document.body.classList.add(...t)}blur(e){return this.getElement(e.id)?.blur(),{id:e.id}}execCommand(e){return document.execCommand(e.command),e}focus({children:e,id:t}){let n=this.getElement(t);return n&&(!o.isFocusable(n)&&e&&(n=o.query(n,o.isFocusable)),n&&(n.focus(),Neo.isNumber(n.selectionStart)&&(n.selectionStart=n.selectionEnd=n.value.length))),{id:t}}getAttributes({attributes:e,id:t}){let o;if(Array.isArray(t))o=[],t.forEach((t=>{o.push(this.getAttributes({attributes:e,id:t}))}));else{let n=this.getElementOrBody(t);o={},n&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{o[e]=n[e]})))}return o}getBoundingClientRect(e){let t,o=this;if(Array.isArray(e.id))return e.id.map((e=>o.getBoundingClientRect({id:e})));{let n,i,r,l=o.getElementOrBody(e.nodeType?e:e.id),d={};t={},l&&(d=l.getBoundingClientRect(),r=l.ownerDocument.defaultView.getComputedStyle(l),n=r.getPropertyValue("min-width"),i=r.getPropertyValue("min-height"),t=s.clone(d),a.test(n)&&"0px"!==n&&(t.minWidth=o.measure({value:n,id:l})),a.test(i)&&"0px"!==i&&(t.minHeight=o.measure({value:i,id:l})))}return t}getClippedRect(e){let t=this.getElement("object"==typeof e?e.id:e),{defaultView:o}=t.ownerDocument,n=this.getBoundingClientRect(t);for(let e=t.offsetParent;e&&n&&e!==document.documentElement;e=e.parentElement)"visible"!==o.getComputedStyle(e).getPropertyValue("overflow")&&(n=n.intersects(this.getBoundingClientRect(e)));return n}getElement(e){return(e?.nodeType?e:Neo.config.useDomIds?document.getElementById(e):document.querySelector(`[data-neo-id='${e}']`))||null}getElementOrBody(e="document.body"){return e?e.nodeType?e:"body"===e||"document.body"===e?document.body:this.getElement(e):null}getScrollingDimensions(e){let t=this;if(Array.isArray(e.id))return e.id.map((e=>t.getScrollingDimensions({id:e})));{let o=e.nodeType?e:t.getElementOrBody(e.id);return{clientHeight:o?.clientHeight,clientWidth:o?.clientWidth,scrollHeight:o?.scrollHeight,scrollWidth:o?.scrollWidth}}}initGlobalListeners(){let e=this;document.addEventListener("blur",e.onDocumentBlur.bind(e),d),document.addEventListener("keydown",e.onDocumentKeyDown.bind(e),d),document.addEventListener("keyup",e.onDocumentKeyUp.bind(e),d),document.addEventListener("mousedown",e.onDocumentMouseDown.bind(e),{capture:!0})}isAlignSubject(e){return[...this._aligns?.values()].some((t=>t.subject===e))}loadScript(e,t={defer:!0}){let o;return new Promise(((n,s)=>{o=document.createElement("script"),Object.assign(o,{...t,onerror:s,onload:n,src:e}),document.head.appendChild(o)}))}loadStylesheet(e,t=null){let o;return new Promise(((n,s)=>{o=document.createElement("link"),Object.assign(o,{href:e,onerror:s,onload:n,rel:"stylesheet",type:"text/css"}),t&&Object.assign(o.dataset,t),document.head.appendChild(o)}))}measure({value:e,id:t}){const o=1===t.nodeType?t:this.getElement(t);if(e.endsWith("%")){const t=parseFloat(e)/100;return(o.offsetParent?.getBoundingClientRect().height||0)*t}if(isNaN(e)&&!e.endsWith("px")){const t=o.ownerDocument.defaultView.getComputedStyle(o);let n=this._measuringDiv;n||(n=this._measuringDiv=document.createElement("div"),n.style="position:fixed;top:-10000px;left:-10000px"),document.body.appendChild(n),c.forEach((e=>{n.style[e]=t[e]})),n.className=o.className,n.style.width=e,e=t.width}else e=parseFloat(e);return e}async monitorAutoGrow(e){const t=this,o=e.subject=t.getElement(e.id);o[e.autoGrow?"addEventListener":"removeEventListener"]("input",t.monitorAutoGrowHandler),e.autoGrow&&t.monitorAutoGrowHandler({target:o})}monitorAutoGrowHandler(e){const t=e.target||this.getElement(e.id);if(t){const{style:e}=t,{style:o}=t.closest(".neo-textarea");e.height=e.minHeight=0,o.setProperty("--textfield-input-height",`${t.scrollHeight+5}px`),o.setProperty("height",""),e.height=e.minHeight=""}}onDocumentBlur(){Neo.altKeyDown=Neo.controlKeyDown=Neo.metaKeyDown=Neo.shiftKeyDown=!1}onDocumentKeyDown(e){u[e.key]&&(Neo[`${i.uncapitalize(e.key)}KeyDown`]=!0)}onDocumentKeyUp(e){u[e.key]&&(Neo[`${i.uncapitalize(e.key)}KeyDown`]=!1)}onDocumentMutation(e){const t=this;e.every((({type:e,addedNodes:o,removedNodes:n})=>{if("childList"===e){return[...Array.from(o),...Array.from(n)].every((e=>t.isAlignSubject(e)))}}))||t.syncAligns()}onDocumentMouseDown(e){let t=e.target?.closest("[data-focus]");t&&(e.preventDefault(),document.getElementById(t.dataset.focus)?.focus())}onDomContentLoaded(){Neo.config.applyBodyCls&&this.applyBodyCls({cls:["neo-body"]}),Neo.config.applyFixedPositionToHtmlTag&&document.documentElement.style.setProperty("position","fixed")}onGetOffscreenCanvas(e){let t=this.getElement(e.nodeId).transferControlToOffscreen();e.offscreen=t,Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!0},[t])}onReadDom(e){let t,o,n=e.attributes||[],s=e.functions||[],i=e.styles||[],{vnodeId:r}=e,l={},a={},d={},c=r?this.getElement(r):null;n.forEach((e=>{l[e]=c[e]})),s.forEach(((e,n)=>{Neo.isObject(e)?(e.params=e.params||[],e.paramIsDomNode=e.paramIsDomNode||[],o=e.scope?document[e.scope]:c,e.params.forEach(((t,o)=>{!0===e.paramIsDomNode[o]&&(e.params[o]=this.getElement(e.params[o]))})),t=e.returnFnName?e.returnFnName:n,a[t]=o[e.fn](...e.params),e.returnValue&&(a[t]=a[t][e.returnValue])):a[e]=c[e]()})),i.forEach((e=>{d[e]=c.style[e]})),Object.assign(e,{attributes:l,functions:a,styles:d}),Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!0})}onTrappedFocusMovement({target:e,relatedTarget:t}){const o=t&&4&e.compareDocumentPosition(t);if(e.matches(".neo-focus-trap")){const t=e.parentElement,n=t.$treeWalker,s=t.$topFocusTrap,i=t.$bottomFocusTrap;n.currentNode=o?i:s,n[o?"previousNode":"nextNode"](),requestAnimationFrame((()=>n.currentNode.focus()))}}read(e){"function"==typeof e&&e()}resetDimensions(e){Object.assign(this.getElement(e.id).style,{flex:e.configuredFlex,height:e.configuredHeight,maxHeight:e.configuredMaxHeight,maxWidth:e.configuredMaxWidth,minHeight:e.configuredMinHeight,minWidth:e.configuredMinWidth,width:e.configuredWidth})}scrollBy({behavior:e="auto",direction:t="top",id:o,value:n}){return this.getElement(o)?.scrollBy({behavior:e,[t]:n}),{id:o}}scrollIntoView({id:e,behavior:t="smooth",block:o="start",delay:n=500,inline:s="nearest",querySelector:i}){let r=e?this.getElement(e):document.querySelector(i),l={behavior:t,block:o,inline:s};if("smooth"===t)return new Promise((e=>{if(r){let t="scrollend"in window;t&&document.addEventListener("scrollend",(()=>e()),{capture:!0,once:!0}),r.scrollIntoView(l),!t&&this.timeout(n).then((()=>{e()}))}else e()}));r.scrollIntoView(l)}scrollTo({behavior:e="auto",direction:t="top",id:o,value:n}){return this.getElement(o)?.scrollTo({behavior:e,[t]:n}),{id:o}}scrollToTableRow({id:e,behavior:t="smooth",offset:o=34}){let n=this.getElement(e);if(n){let e=n.parentNode.parentNode,s=e.parentNode,i=e.getBoundingClientRect().top,r=n.getBoundingClientRect().top;s.scrollTo({behavior:t,top:r-i-o})}return{id:e}}selectNode(e){let t=this.getElement(e.id),o=Neo.isNumber(e.start)?e.start:0,n=Neo.isNumber(e.end)?e.end:99999;return t&&(t.select(),t.setSelectionRange(o,n)),{id:e.id}}setBodyCls(e){document.body.classList.remove(...e.remove||[]),document.body.classList.add(...e.add||[])}setStyle(e){let t=this.getElementOrBody(e.id);return t&&Object.entries(e.style).forEach((([e,o])=>{Neo.isString(o)&&o.includes("!important")?(o=o.replace("!important","").trim(),t.style.setProperty(Neo.decamel(e),o,"important")):t.style[Neo.decamel(e)]=o})),{id:e.id}}syncAligns(){const e=this,{_aligns:t}=e;t?.forEach((o=>{const n=document.contains(o.targetElement);if(document.contains(o.subject)&&n)e.align(o);else{n||Neo.worker.App.setConfigs({id:o.id,hidden:!0});const{_alignResizeObserver:s}=e,{constrainToElement:i}=o;s.unobserve(o.subject),s.unobserve(o.offsetParent),s.unobserve(o.targetElement),i&&s.unobserve(i),o.subject.classList.remove(`neo-aligned-${o.result?.position}`),t.delete(o.id)}}))}syncModalMask({id:e,modal:t}){const o=e&&this.getElement(e);if(o&&t&&o.ownerDocument.contains(o)&&"none"!==o.ownerDocument.defaultView.getComputedStyle(o).getPropertyValue("display"))document.body.insertBefore(this.modalMask,o);else{const e=document.querySelectorAll(".neo-modal"),t=e[e.length-1];t?this.syncModalMask({id:t.id,modal:!0}):this._modalMask?.remove()}}async trapFocus(e){const t=this,o=t.$boundOnTrappedFocusMovement||(t.$boundOnTrappedFocusMovement=t.onTrappedFocusMovement.bind(t)),n=e.subject=t.getElement(e.id),{trap:s=!0}=e;if(!n)return;let i=n.$topFocusTrap,r=n.$bottomFocusTrap;s?(n.$treeWalker||(n.$treeWalker=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,{acceptNode:l}),i=n.$topFocusTrap=document.createElement("div"),r=n.$bottomFocusTrap=document.createElement("div"),i.className=r.className="neo-focus-trap",i.setAttribute("tabIndex",0),r.setAttribute("tabIndex",0),n.addEventListener("focusin",o)),n.insertBefore(i,n.firstChild),n.appendChild(r)):n.removeEventListener("focusin",o)}windowScrollTo(e){window.scrollTo({behavior:e.behavior||"smooth",left:e.left||0,top:e.top||0})}write(e){this.du_insertNode({index:e.parentIndex,outerHTML:e.html||e.outerHTML,parentId:e.parentId})}});