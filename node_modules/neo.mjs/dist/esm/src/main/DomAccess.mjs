import e from"../core/Base.mjs";import t from"./DomUtils.mjs";import o from"../util/Rectangle.mjs";import n from"../util/String.mjs";const i=e=>e.preventDefault(),s=e=>!e.classList.contains("neo-focus-trap")&&t.isTabbable(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP,r=/^\d+\w+$/,l={capture:!0,passive:!0},a=["font-family","font-kerning","font-size","font-size-adjust","font-stretch","font-style","font-weight","letter-spacing","line-height","text-decoration","text-transform","word-break"],d={Shift:1,Alt:1,Meta:1,Control:1};export default Neo.setupClass(class extends e{static observable=!0;static config={className:"Neo.main.DomAccess",remote:{app:["addScript","align","applyBodyCls","blur","execCommand","focus","getAttributes","getBoundingClientRect","getScrollingDimensions","measure","monitorAutoGrow","monitorAutoGrowHandler","navigate","navigateTo","scrollBy","scrollIntoView","scrollTo","scrollToTableRow","selectNode","setBodyCls","setStyle","syncModalMask","trapFocus","windowScrollTo"]},singleton:!0};get modalMask(){let e=this;return e._modalMask||(e._modalMask=document.createElement("div"),e._modalMask.className="neo-dialog-modal-mask",e._modalMask.addEventListener("mousedown",i,{capture:!0})),e._modalMask}construct(e){super.construct(e);let t=this;t.initGlobalListeners(),t.syncAligns=t.syncAligns.bind(t)}addAligned(e){const t=this,{id:o}=e,n=t._aligns||(t._aligns=new Map),i=t._alignResizeObserver||(t._alignResizeObserver=new ResizeObserver(t.syncAligns)),{constrainToElement:s}=e;n.has(o)||(i.observe(e.offsetParent),i.observe(e.targetElement),s&&i.observe(s)),t.hasDocumentScrollListener||(document.addEventListener("scroll",t.syncAligns,{capture:!0,passive:!0}),t.hasDocumentScrollListener=!0),t.documentMutationObserver||(t.documentMutationObserver=new MutationObserver(t.onDocumentMutation.bind(t)),t.documentMutationObserver.observe(document.body,{childList:!0,subtree:!0})),n.set(o,e)}addScript(e){let t=document.createElement("script");e.hasOwnProperty("async")||(e.async=!0),Object.assign(t,e),document.head.appendChild(t)}async align(e){const t=this,{constrainTo:o}=e,n=e.subject=t.getElement(e.id),{style:i}=n,s={...e},r=t._aligns?.get(e.id);if(r&&n.classList.remove(`neo-aligned-${r.result.position}`),t.resetDimensions(s),s.target=t.getClippedRect({id:e.targetElement=t.getElementOrBody(e.target)}),!s.target)return Neo.worker.App.setConfigs({id:e.id,hidden:!0});e.offsetParent=e.targetElement.offsetParent,o&&(s.constrainTo=t.getBoundingClientRect({id:e.constrainToElement=t.getElementOrBody(o)}));const l=t.getBoundingClientRect(e),a=e.result=l.alignTo(s);Object.assign(i,{top:0,left:0,transform:`translate(${a.x}px,${a.y}px)`}),a.width!==l.width&&(i.width=`${a.width}px`),a.height!==l.height&&(i.height=`${a.height}px`),n.classList.add(`neo-aligned-${a.position}`),t.addAligned(e)}applyBodyCls(e){let t=e.cls||[];document.body.classList.add(...t)}blur(e){return this.getElement(e.id)?.blur(),{id:e.id}}execCommand(e){return document.execCommand(e.command),e}focus({children:e,id:o}){let n=this.getElement(o);return n&&(!t.isFocusable(n)&&e&&(n=t.query(n,t.isFocusable)),n&&(n.focus(),Neo.isNumber(n.selectionStart)&&(n.selectionStart=n.selectionEnd=n.value.length))),{id:o}}getAttributes({attributes:e,id:t}){let o;if(Array.isArray(t))o=[],t.forEach(t=>{o.push(this.getAttributes({attributes:e,id:t}))});else{let n=this.getElementOrBody(t);o={},n&&(Array.isArray(e)||(e=[e]),e.forEach(e=>{o[e]=n[e]}))}return o}getBoundingClientRect(e){let t,n=this;if(Array.isArray(e.id))return e.id.map(e=>n.getBoundingClientRect({id:e}));{let i,s,l,a=n.getElementOrBody(e.nodeType?e:e.id),d={};t={},a&&(d=a.getBoundingClientRect(),l=a.ownerDocument.defaultView.getComputedStyle(a),i=l.getPropertyValue("min-width"),s=l.getPropertyValue("min-height"),t=o.clone(d),r.test(i)&&"0px"!==i&&(t.minWidth=n.measure({value:i,id:a})),r.test(s)&&"0px"!==s&&(t.minHeight=n.measure({value:s,id:a})))}return t}getClippedRect(e){let t=this.getElement("object"==typeof e?e.id:e),{defaultView:o}=t.ownerDocument,n=this.getBoundingClientRect(t);for(let e=t.offsetParent;e&&n&&e!==document.documentElement;e=e.parentElement)"visible"!==o.getComputedStyle(e).getPropertyValue("overflow")&&(n=n.intersects(this.getBoundingClientRect(e)));return n}getElement(e){return(e?.nodeType?e:Neo.config.useDomIds?document.getElementById(e):document.querySelector(`[data-neo-id='${e}']`))||null}getElementOrBody(e="document.body"){return e?e.nodeType?e:"body"===e||"document.body"===e?document.body:this.getElement(e):null}getScrollingDimensions(e){let t=this;if(Array.isArray(e.id))return e.id.map(e=>t.getScrollingDimensions({id:e}));{let o=e.nodeType?e:t.getElementOrBody(e.id);return{clientHeight:o?.clientHeight,clientWidth:o?.clientWidth,scrollHeight:o?.scrollHeight,scrollWidth:o?.scrollWidth}}}initGlobalListeners(){let e=this;document.addEventListener("blur",e.onDocumentBlur.bind(e),l),document.addEventListener("keydown",e.onDocumentKeyDown.bind(e),l),document.addEventListener("keyup",e.onDocumentKeyUp.bind(e),l),document.addEventListener("mousedown",e.onDocumentMouseDown.bind(e),{capture:!0})}isAlignSubject(e){return[...this._aligns?.values()].some(t=>t.subject===e)}loadScript(e,t={defer:!0}){let o;return new Promise((n,i)=>{o=document.createElement("script"),Object.assign(o,{...t,onerror:i,onload:n,src:e}),document.head.appendChild(o)})}loadStylesheet(e,t=null){let o;return new Promise((n,i)=>{o=document.createElement("link"),Object.assign(o,{href:e,onerror:i,onload:n,rel:"stylesheet",type:"text/css"}),t&&Object.assign(o.dataset,t),document.head.appendChild(o)})}measure({value:e,id:t}){const o=1===t.nodeType?t:this.getElement(t);if(e.endsWith("%")){const t=parseFloat(e)/100;return(o.offsetParent?.getBoundingClientRect().height||0)*t}if(isNaN(e)&&!e.endsWith("px")){const t=o.ownerDocument.defaultView.getComputedStyle(o);let n=this._measuringDiv;n||(n=this._measuringDiv=document.createElement("div"),n.style="position:fixed;top:-10000px;left:-10000px"),document.body.appendChild(n),a.forEach(e=>{n.style[e]=t[e]}),n.className=o.className,n.style.width=e,e=t.width}else e=parseFloat(e);return e}async monitorAutoGrow(e){const t=this,o=e.subject=t.getElement(e.id);o[e.autoGrow?"addEventListener":"removeEventListener"]("input",t.monitorAutoGrowHandler),e.autoGrow&&t.monitorAutoGrowHandler({target:o})}monitorAutoGrowHandler(e){const t=e.target||this.getElement(e.id);if(t){const{style:e}=t,{style:o}=t.closest(".neo-textarea");e.height=e.minHeight=0,o.setProperty("--textfield-input-height",`${t.scrollHeight+5}px`),o.setProperty("height",""),e.height=e.minHeight=""}}onDocumentBlur(){Neo.altKeyDown=Neo.controlKeyDown=Neo.metaKeyDown=Neo.shiftKeyDown=!1}onDocumentKeyDown(e){d[e.key]&&(Neo[`${n.uncapitalize(e.key)}KeyDown`]=!0)}onDocumentKeyUp(e){d[e.key]&&(Neo[`${n.uncapitalize(e.key)}KeyDown`]=!1)}onDocumentMutation(e){const t=this;e.every(({type:e,addedNodes:o,removedNodes:n})=>{if("childList"===e){return[...Array.from(o),...Array.from(n)].every(e=>t.isAlignSubject(e))}})||t.syncAligns()}onDocumentMouseDown(e){let t=e.target?.closest("[data-focus]");t&&(e.preventDefault(),document.getElementById(t.dataset.focus)?.focus())}onDomContentLoaded(){Neo.config.applyBodyCls&&this.applyBodyCls({cls:["neo-body"]}),Neo.config.applyFixedPositionToHtmlTag&&document.documentElement.style.setProperty("position","fixed")}onGetOffscreenCanvas(e){let t=this.getElement(e.nodeId).transferControlToOffscreen();e.offscreen=t,Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!0},[t])}onReadDom(e){let t,o,n=e.attributes||[],i=e.functions||[],s=e.styles||[],{vnodeId:r}=e,l={},a={},d={},c=r?this.getElement(r):null;n.forEach(e=>{l[e]=c[e]}),i.forEach((e,n)=>{Neo.isObject(e)?(e.params=e.params||[],e.paramIsDomNode=e.paramIsDomNode||[],o=e.scope?document[e.scope]:c,e.params.forEach((t,o)=>{!0===e.paramIsDomNode[o]&&(e.params[o]=this.getElement(e.params[o]))}),t=e.returnFnName?e.returnFnName:n,a[t]=o[e.fn](...e.params),e.returnValue&&(a[t]=a[t][e.returnValue])):a[e]=c[e]()}),s.forEach(e=>{d[e]=c.style[e]}),Object.assign(e,{attributes:l,functions:a,styles:d}),Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!0})}onTrappedFocusMovement({target:e,relatedTarget:t}){const o=t&&4&e.compareDocumentPosition(t);if(e.matches(".neo-focus-trap")){const t=e.parentElement,n=t.$treeWalker,i=t.$topFocusTrap,s=t.$bottomFocusTrap;n.currentNode=o?s:i,n[o?"previousNode":"nextNode"](),requestAnimationFrame(()=>n.currentNode.focus())}}read(e){Neo.isFunction(e)&&e()}resetDimensions(e){Object.assign(this.getElement(e.id).style,{flex:e.configuredFlex,height:e.configuredHeight,maxHeight:e.configuredMaxHeight,maxWidth:e.configuredMaxWidth,minHeight:e.configuredMinHeight,minWidth:e.configuredMinWidth,width:e.configuredWidth})}scrollBy({behavior:e="auto",direction:t="top",id:o,value:n}){return this.getElement(o)?.scrollBy({behavior:e,[t]:n}),{id:o}}scrollIntoView({id:e,behavior:t="smooth",block:o="start",delay:n=500,inline:i="nearest",querySelector:s}){let r=e?this.getElement(e):document.querySelector(s),l={behavior:t,block:o,inline:i};if("smooth"===t)return new Promise(e=>{if(r){let t="scrollend"in window;t&&document.addEventListener("scrollend",()=>e(),{capture:!0,once:!0}),r.scrollIntoView(l),!t&&this.timeout(n).then(()=>{e()})}else e()});r.scrollIntoView(l)}scrollTo({behavior:e="auto",direction:t="top",id:o,value:n}){return this.getElement(o)?.scrollTo({behavior:e,[t]:n}),{id:o}}scrollToTableRow({id:e,behavior:t="smooth",offset:o=34}){let n=this.getElement(e);if(n){let e=n.parentNode.parentNode,i=e.parentNode,s=e.getBoundingClientRect().top,r=n.getBoundingClientRect().top;i.scrollTo({behavior:t,top:r-s-o})}return{id:e}}selectNode(e){let t=this.getElement(e.id),o=Neo.isNumber(e.start)?e.start:0,n=Neo.isNumber(e.end)?e.end:99999;return t&&(t.select(),t.setSelectionRange(o,n)),{id:e.id}}setBodyCls(e){document.body.classList.remove(...e.remove||[]),document.body.classList.add(...e.add||[])}setStyle(e){let t=this.getElementOrBody(e.id);return t&&Object.entries(e.style).forEach(([e,o])=>{Neo.isString(o)&&o.includes("!important")?(o=o.replace("!important","").trim(),t.style.setProperty(Neo.decamel(e),o,"important")):t.style[Neo.decamel(e)]=o}),{id:e.id}}syncAligns(){const e=this,{_aligns:t}=e;t?.forEach(o=>{const n=document.contains(o.targetElement);if(document.contains(o.subject)&&n)e.align(o);else{n||Neo.worker.App.setConfigs({id:o.id,hidden:!0});const{_alignResizeObserver:i}=e,{constrainToElement:s}=o;i.unobserve(o.subject),i.unobserve(o.offsetParent),i.unobserve(o.targetElement),s&&i.unobserve(s),o.subject.classList.remove(`neo-aligned-${o.result?.position}`),t.delete(o.id)}})}syncModalMask({id:e,modal:t}){const o=e&&this.getElement(e);if(o&&t&&o.ownerDocument.contains(o)&&"none"!==o.ownerDocument.defaultView.getComputedStyle(o).getPropertyValue("display"))document.body.insertBefore(this.modalMask,o);else{const e=document.querySelectorAll(".neo-modal"),t=e[e.length-1];t?this.syncModalMask({id:t.id,modal:!0}):this._modalMask?.remove()}}async trapFocus(e){const t=this,o=t.$boundOnTrappedFocusMovement||(t.$boundOnTrappedFocusMovement=t.onTrappedFocusMovement.bind(t)),n=e.subject=t.getElement(e.id),{trap:i=!0}=e;if(!n)return;let r=n.$topFocusTrap,l=n.$bottomFocusTrap;i?(n.$treeWalker||(n.$treeWalker=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,{acceptNode:s}),r=n.$topFocusTrap=document.createElement("div"),l=n.$bottomFocusTrap=document.createElement("div"),r.className=l.className="neo-focus-trap",r.setAttribute("tabIndex",0),l.setAttribute("tabIndex",0),n.addEventListener("focusin",o)),n.insertBefore(r,n.firstChild),n.appendChild(l)):n.removeEventListener("focusin",o)}windowScrollTo(e){window.scrollTo({behavior:e.behavior||"smooth",left:e.left||0,top:e.top||0})}});