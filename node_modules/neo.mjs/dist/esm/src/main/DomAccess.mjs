import e from"../core/Base.mjs";import t from"./DomUtils.mjs";import n from"../util/Rectangle.mjs";import o from"../util/String.mjs";const i=e=>e.preventDefault(),r=e=>!e.classList.contains("neo-focus-trap")&&t.isTabbable(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP,s=/^\d+\w+$/,a={capture:!0,passive:!0},l=["font-family","font-kerning","font-size","font-size-adjust","font-stretch","font-style","font-weight","letter-spacing","line-height","text-decoration","text-transform","word-break"],d={Shift:1,Alt:1,Meta:1,Control:1};export default Neo.setupClass(class extends e{static observable=!0;static config={className:"Neo.main.DomAccess",remote:{app:["addScript","align","applyBodyCls","blur","execCommand","focus","getAttributes","getBoundingClientRect","getComputedStyle","getOffscreenCanvas","getScrollingDimensions","measure","monitorAutoGrow","monitorAutoGrowHandler","scrollBy","scrollIntoView","scrollTo","scrollToTableRow","selectNode","setBodyCls","setStyle","startViewTransition","syncModalMask","trapFocus","windowScrollTo"]},singleton:!0};get modalMask(){let e=this;return e._modalMask||(e._modalMask=document.createElement("div"),e._modalMask.className="neo-dialog-modal-mask",e._modalMask.addEventListener("mousedown",i,{capture:!0})),e._modalMask}construct(e){super.construct(e);let t=this;t.initGlobalListeners(),t.syncAligns=t.syncAligns.bind(t)}addAligned(e){const t=this,{id:n}=e,o=t._aligns||(t._aligns=new Map),i=t._alignResizeObserver||(t._alignResizeObserver=new ResizeObserver(t.syncAligns)),{constrainToElement:r}=e;o.has(n)||(i.observe(e.offsetParent),i.observe(e.targetElement),r&&i.observe(r)),t.hasDocumentScrollListener||(document.addEventListener("scroll",t.syncAligns,{capture:!0,passive:!0}),t.hasDocumentScrollListener=!0),t.documentMutationObserver||(t.documentMutationObserver=new MutationObserver(t.onDocumentMutation.bind(t)),t.documentMutationObserver.observe(document.body,{childList:!0,subtree:!0})),o.set(n,e)}addScript(e){let t=document.createElement("script");e.hasOwnProperty("async")||(e.async=!0),Object.assign(t,e),document.head.appendChild(t)}async align(e){const t=this,{constrainTo:n}=e,o=e.subject=t.getElement(e.id),{style:i}=o,r={...e},s=t._aligns?.get(e.id);if(s&&o.classList.remove(`neo-aligned-${s.result.position}`),t.resetDimensions(r),r.target=t.getClippedRect({id:e.targetElement=t.getElementOrBody(e.target)}),!r.target)return Neo.worker.App.setConfigs({id:e.id,hidden:!0});e.offsetParent=e.targetElement.offsetParent,n&&(r.constrainTo=t.getBoundingClientRect({id:e.constrainToElement=t.getElementOrBody(n)}));const a=t.getBoundingClientRect(e),l=e.result=a.alignTo(r);Object.assign(i,{top:0,left:0,transform:`translate(${l.x}px,${l.y}px)`}),l.width!==a.width&&(i.width=`${l.width}px`),l.height!==a.height&&(i.height=`${l.height}px`),o.classList.add(`neo-aligned-${l.position}`),t.addAligned(e)}applyBodyCls(e){let t=e.cls||[];document.body.classList.add(...t)}blur(e){return this.getElement(e.id)?.blur(),{id:e.id}}execCommand(e){return document.execCommand(e.command),e}focus({children:e,id:n,preventScroll:o}){let i=this.getElement(n);return i&&(!t.isFocusable(i)&&e&&(i=t.query(i,t.isFocusable)),i&&(i.focus({preventScroll:o}),Neo.isNumber(i.selectionStart)&&(i.selectionStart=i.selectionEnd=i.value.length))),{id:n}}getAttributes({attributes:e,id:t}){let n;if(Array.isArray(t))n=[],t.forEach(t=>{n.push(this.getAttributes({attributes:e,id:t}))});else{let o=this.getElementOrBody(t);n={},o&&(Array.isArray(e)||(e=[e]),e.forEach(e=>{n[e]=o[e]}))}return n}getBoundingClientRect(e){let t,o=this;if(Array.isArray(e.id))return e.id.map(e=>o.getBoundingClientRect({id:e}));{let i,r,a,l=o.getElementOrBody(e.nodeType?e:e.id),d={};t={},l&&(d=l.getBoundingClientRect(),a=l.ownerDocument.defaultView.getComputedStyle(l),i=a.getPropertyValue("min-width"),r=a.getPropertyValue("min-height"),t=n.clone(d),s.test(i)&&"0px"!==i&&(t.minWidth=o.measure({value:i,id:l})),s.test(r)&&"0px"!==r&&(t.minHeight=o.measure({value:r,id:l})))}return t}getClippedRect(e){let t=this.getElement("object"==typeof e?e.id:e),{defaultView:n}=t.ownerDocument,o=this.getBoundingClientRect(t);for(let e=t.offsetParent;e&&o&&e!==document.documentElement;e=e.parentElement)"visible"!==n.getComputedStyle(e).getPropertyValue("overflow")&&(o=o.intersects(this.getBoundingClientRect(e)));return o}getComputedStyle({id:e,style:t}){let n=this.getElement(e),o={};if(n){let e=window.getComputedStyle(n);Array.isArray(t)||(t=[t]),t.forEach(t=>{o[t]=e.getPropertyValue(t)})}return o}getElement(e){if("window"===e)return globalThis;if("document"===e)return document;if("document.body"===e||"body"===e)return document.body;return(e?.nodeType?e:Neo.config.useDomIds?document.getElementById(e):document.querySelector(`[data-neo-id='${e}']`))||null}getElementOrBody(e="document.body"){return e?this.getElement(e):null}getScrollingDimensions(e){let t=this;if(Array.isArray(e.id))return e.id.map(e=>t.getScrollingDimensions({id:e}));{let n=e.nodeType?e:t.getElementOrBody(e.id);return{clientHeight:n?.clientHeight,clientWidth:n?.clientWidth,scrollHeight:n?.scrollHeight,scrollWidth:n?.scrollWidth}}}initGlobalListeners(){let e=this;document.addEventListener("blur",e.onDocumentBlur.bind(e),a),document.addEventListener("keydown",e.onDocumentKeyDown.bind(e),a),document.addEventListener("keyup",e.onDocumentKeyUp.bind(e),a),document.addEventListener("mousedown",e.onDocumentMouseDown.bind(e),{capture:!0})}isAlignSubject(e){return[...this._aligns?.values()].some(t=>t.subject===e)}loadScript(e,t={defer:!0}){let n;return new Promise((o,i)=>{n=document.createElement("script"),Object.assign(n,{...t,onerror:i,onload:o,src:e}),document.head.appendChild(n)})}loadStylesheet(e,t=null){let n;return new Promise((o,i)=>{n=document.createElement("link"),Object.assign(n,{href:e,onerror:i,onload:o,rel:"stylesheet",type:"text/css"}),t&&Object.assign(n.dataset,t),document.head.appendChild(n)})}measure({value:e,id:t}){const n=1===t.nodeType?t:this.getElement(t);if(e.endsWith("%")){const t=parseFloat(e)/100;return(n.offsetParent?.getBoundingClientRect().height||0)*t}if(isNaN(e)&&!e.endsWith("px")){const t=n.ownerDocument.defaultView.getComputedStyle(n);let o=this._measuringDiv;o||(o=this._measuringDiv=document.createElement("div"),o.style="position:fixed;top:-10000px;left:-10000px"),document.body.appendChild(o),l.forEach(e=>{o.style[e]=t[e]}),o.className=n.className,o.style.width=e,e=t.width}else e=parseFloat(e);return e}async monitorAutoGrow(e){const t=this,n=e.subject=t.getElement(e.id);n[e.autoGrow?"addEventListener":"removeEventListener"]("input",t.monitorAutoGrowHandler),e.autoGrow&&t.monitorAutoGrowHandler({target:n})}monitorAutoGrowHandler(e){const t=e.target||this.getElement(e.id);if(t){const{style:e}=t,{style:n}=t.closest(".neo-textarea");e.height=e.minHeight=0,n.setProperty("--textfield-input-height",`${t.scrollHeight+5}px`),n.setProperty("height",""),e.height=e.minHeight=""}}onDocumentBlur(){Neo.altKeyDown=Neo.controlKeyDown=Neo.metaKeyDown=Neo.shiftKeyDown=!1}onDocumentKeyDown(e){d[e.key]&&(Neo[`${o.uncapitalize(e.key)}KeyDown`]=!0)}onDocumentKeyUp(e){d[e.key]&&(Neo[`${o.uncapitalize(e.key)}KeyDown`]=!1)}onDocumentMutation(e){const t=this;e.every(({type:e,addedNodes:n,removedNodes:o})=>{if("childList"===e){return[...Array.from(n),...Array.from(o)].every(e=>t.isAlignSubject(e))}})||t.syncAligns()}onDocumentMouseDown(e){let t=e.target?.closest("[data-focus]");t&&(e.preventDefault(),document.getElementById(t.dataset.focus)?.focus())}onDomContentLoaded(){Neo.config.applyBodyCls&&this.applyBodyCls({cls:["neo-body"]}),Neo.config.applyFixedPositionToHtmlTag&&document.documentElement.style.setProperty("position","fixed")}getOffscreenCanvas(e){let t,n=this.getElement(e.nodeId);if(!n)return{result:{success:!1}};try{return t=n.transferControlToOffscreen(),{result:{offscreen:t},transfer:[t]}}catch(e){return{transferred:!0}}}onReadDom(e){let t,n,o=e.attributes||[],i=e.functions||[],r=e.styles||[],{vnodeId:s}=e,a={},l={},d={},c=s?this.getElement(s):null;o.forEach(e=>{a[e]=c[e]}),i.forEach((e,o)=>{Neo.isObject(e)?(e.params=e.params||[],e.paramIsDomNode=e.paramIsDomNode||[],n=e.scope?document[e.scope]:c,e.params.forEach((t,n)=>{!0===e.paramIsDomNode[n]&&(e.params[n]=this.getElement(e.params[n]))}),t=e.returnFnName?e.returnFnName:o,l[t]=n[e.fn](...e.params),e.returnValue&&(l[t]=l[t][e.returnValue])):l[e]=c[e]()}),r.forEach(e=>{d[e]=c.style[e]}),Object.assign(e,{attributes:a,functions:l,styles:d}),Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!0})}onTrappedFocusMovement({target:e,relatedTarget:t}){const n=t&&4&e.compareDocumentPosition(t);if(e.matches(".neo-focus-trap")){const t=e.parentElement,o=t.$treeWalker,i=t.$topFocusTrap,r=t.$bottomFocusTrap;o.currentNode=n?r:i,o[n?"previousNode":"nextNode"](),requestAnimationFrame(()=>o.currentNode.focus())}}read(e){Neo.isFunction(e)&&e()}resetDimensions(e){Object.assign(this.getElement(e.id).style,{flex:e.configuredFlex,height:e.configuredHeight,maxHeight:e.configuredMaxHeight,maxWidth:e.configuredMaxWidth,minHeight:e.configuredMinHeight,minWidth:e.configuredMinWidth,width:e.configuredWidth})}async startViewTransition(e){if(!document.startViewTransition)return!1;const t=document.startViewTransition(async()=>{await this.timeout(e.delay||50)});return e.animate&&t.ready.then(()=>{document.documentElement.animate(e.animate.keyframes,e.animate.options)}),!0}scrollBy({behavior:e="auto",direction:t="top",id:n,value:o}){return this.getElement(n)?.scrollBy({behavior:e,[t]:o}),{id:n}}scrollIntoView({id:e,behavior:t="smooth",block:n="start",delay:o=500,inline:i="nearest",querySelector:r}){let s=e?this.getElement(e):document.querySelector(r),a={behavior:t,block:n,inline:i};if("smooth"===t)return new Promise(e=>{if(s){let t="scrollend"in window;t&&document.addEventListener("scrollend",()=>e(),{capture:!0,once:!0}),s.scrollIntoView(a),!t&&this.timeout(o).then(()=>{e()})}else e()});s.scrollIntoView(a)}scrollTo({behavior:e="auto",direction:t="top",id:n,value:o}){return this.getElement(n)?.scrollTo({behavior:e,[t]:o}),{id:n}}scrollToTableRow({id:e,behavior:t="smooth",offset:n=34}){let o=this.getElement(e);if(o){let e=o.parentNode.parentNode,i=e.parentNode,r=e.getBoundingClientRect().top,s=o.getBoundingClientRect().top;i.scrollTo({behavior:t,top:s-r-n})}return{id:e}}selectNode(e){let t=this.getElement(e.id),n=Neo.isNumber(e.start)?e.start:0,o=Neo.isNumber(e.end)?e.end:99999;return t&&(t.select(),t.setSelectionRange(n,o)),{id:e.id}}setBodyCls(e){document.body.classList.remove(...e.remove||[]),document.body.classList.add(...e.add||[])}setStyle(e){let t=this.getElementOrBody(e.id);return t&&Object.entries(e.style).forEach(([e,n])=>{Neo.isString(n)&&n.includes("!important")?(n=n.replace("!important","").trim(),t.style.setProperty(Neo.decamel(e),n,"important")):t.style[Neo.decamel(e)]=n}),{id:e.id}}syncAligns(e){const t=this,{_aligns:n}=t,o="scroll"===e?.type,i=o?e.target:null,r=o&&(i===document||i===document.documentElement);n?.forEach(e=>{const s=document.contains(e.targetElement);if(document.contains(e.subject)&&s){if(o&&!r){if(!(i.contains(e.targetElement)||e.constrainToElement&&i.contains(e.constrainToElement)))return}t.align(e)}else{s||Neo.worker.App.setConfigs({id:e.id,hidden:!0});const{_alignResizeObserver:o}=t,{constrainToElement:i}=e;o.unobserve(e.subject),o.unobserve(e.offsetParent),o.unobserve(e.targetElement),i&&o.unobserve(i),e.subject.classList.remove(`neo-aligned-${e.result?.position}`),n.delete(e.id)}})}syncModalMask({id:e,modal:t}){const n=e&&this.getElement(e);if(n&&t&&n.ownerDocument.contains(n)&&"none"!==n.ownerDocument.defaultView.getComputedStyle(n).getPropertyValue("display"))document.body.insertBefore(this.modalMask,n);else{const e=document.querySelectorAll(".neo-modal"),t=e[e.length-1];t?this.syncModalMask({id:t.id,modal:!0}):this._modalMask?.remove()}}async trapFocus(e){const t=this,n=t.$boundOnTrappedFocusMovement||(t.$boundOnTrappedFocusMovement=t.onTrappedFocusMovement.bind(t)),o=e.subject=t.getElement(e.id),{trap:i=!0}=e;if(!o)return;let s=o.$topFocusTrap,a=o.$bottomFocusTrap;i?(o.$treeWalker||(o.$treeWalker=document.createTreeWalker(o,NodeFilter.SHOW_ELEMENT,{acceptNode:r}),s=o.$topFocusTrap=document.createElement("div"),a=o.$bottomFocusTrap=document.createElement("div"),s.className=a.className="neo-focus-trap",s.setAttribute("tabIndex",0),a.setAttribute("tabIndex",0),o.addEventListener("focusin",n)),o.insertBefore(s,o.firstChild),o.appendChild(a)):o.removeEventListener("focusin",n)}windowScrollTo(e){window.scrollTo({behavior:e.behavior||"smooth",left:e.left||0,top:e.top||0})}});