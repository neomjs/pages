import a from"./Base.mjs";import t from"../DomAccess.mjs";export default Neo.setupClass(class extends a{static config={className:"Neo.main.addon.AmCharts",charts:{},dataMap:{},downloadPath:"https://cdn.amcharts.com/lib/4/",fallbackPath:"https://raw.githubusercontent.com/neomjs/pages/main/resources_pub/amCharts/",remote:{app:["callMethod","create","destroy","setProperties","setProperty","updateData"]},useFallbackPath:!1};afterSetIsReady(a,t){if(super.afterSetIsReady(a,t),a){let a=this;a.timeout(1e3).then((()=>{Object.entries(a.dataMap).forEach((([t,e])=>{a.updateData(e)})),a.dataMap={}}))}}callMethod(a){let t=this;if(!t.isReady)return t.cacheMethodCall({fn:"callMethod",data:a});if(t.hasChart(a.id)){let e=t.charts[a.id],s=a.path.split("."),d=s.pop(),i=s.length<1?e:Neo.ns(s.join("."),!1,e);i[d].call(i,...a.params||[])}}combineSeriesTooltip(a){a.series.each((t=>{t.adapter.add("tooltipText",(()=>{let t="[bold]{dateX}[/]\n";return a.series.each((a=>{t+="["+a.stroke+"]●[/] "+a.name+": {"+a.dataFields.valueY+"}\n"})),t}))}))}create(a){let t=this;if(!t.isReady)return t.cacheMethodCall({fn:"create",data:a});am4core.useTheme(am4themes_dark),t.charts[a.id]=am4core.createFromConfig(a.config,a.id,globalThis[a.package][a.type||"XYChart"]),a.combineSeriesTooltip&&t.combineSeriesTooltip(t.charts[a.id]),a.data?t.updateData({data:a.data,dataPath:a.dataPath,id:a.id}):t.dataMap[a.id]&&(t.updateData(t.dataMap[a.id]),delete t.dataMap[a.id])}destroy(a){let t=this;if(!t.isReady)return t.cacheMethodCall({fn:"destroy",data:a});t.charts[a.id]?.dispose?.(),delete t.charts[a.id]}hasChart(a){return!!this.charts[a]}loadFiles(a=!1){let e,s=this,d=s.useFallbackPath||a;d&&Neo.config.isGitHubPages?(e="../../../../resources_pub/amCharts/","development"!==Neo.config.environment&&(e=`../../${e}`)):e=d?s.fallbackPath:s.downloadPath,s.isLoading=!0,t.loadScript(e+"core.js").then((()=>{Promise.all([t.loadScript(e+"charts.js"),t.loadScript(e+"maps.js"),t.loadScript(e+"themes/dark.js"),t.loadScript(e+"geodata/worldLow.js")]).then((()=>{s.isLoading=!1,s.isReady=!0}))})).catch((t=>{a||s.useFallbackPath||(console.log("Download from amcharts.com failed, switching to fallback",t),s.loadFiles(!0))}))}setProperties(a){let t=this;if(!t.isReady)return t.cacheMethodCall({fn:"setProperties",data:a});Object.entries(a.properties).forEach((([e,s])=>{t.setProperty({id:a.id,path:e,value:s})}))}setProperty(a){let t=this;if(!t.isReady)return t.cacheMethodCall({fn:"setProperty",data:a});if(this.hasChart(a.id)){let t=this.charts[a.id],e=a.path.split("."),s=e.pop();Neo.ns(e.join("."),!1,t)[s]=a.isColor?am4core.color(a.value):a.value}}updateData(a){let t=this;if(!t.isReady)return t.cacheMethodCall({fn:"updateData",data:a});if(t.hasChart(a.id)){let e=t.charts[a.id];""===a.dataPath?e.data=a.data:Neo.ns(a.dataPath,!1,e).data=a.data}else t.dataMap[a.id]=a}});