import e from"./Base.mjs";import t from"../DomAccess.mjs";import o from"../DomEvents.mjs";import i from"../DomUtils.mjs";const n={A:1,BUTTON:1};export default Neo.setupClass(class extends e{static config={className:"Neo.main.addon.Navigator",remote:{app:["navigateTo","subscribe","unsubscribe"]}};clickItem(e){if("function"==typeof e.click)e.click();else{const t=e.getBoundingClientRect(),o=t.x+t.width/2,i=t.y+t.height/2;e.dispatchEvent(new MouseEvent("click",{bubbles:!0,altKey:Neo.altKeyDown,ctrlKey:Neo.controlKeyDown,metaKey:Neo.metaKeyDown,shiftKey:Neo.shiftKeyDown,clientX:o,clientY:i}))}}fixItemFocusability(e){if(!e.subject.contains(e.eventSource))return;const t=Array.from(e.subject.querySelectorAll(e.selector)).reduce(((e,t)=>{const o=i.query(t,i.isFocusable);return o&&e.push(o),e}),[]),o=t[0]||e.subject.querySelector(e.selector);t.forEach((e=>e!==o&&(e.tabIndex=-1))),o&&(o.tabIndex=0)}navigateClickHandler(e,t){let o=e.target.closest(t.selector);o&&!t.findFocusable(o)&&this.navigateTo(o,t)}navigateFocusInHandler(e,t){let o=e.target.closest(t.selector),{relatedTarget:i}=e,{subject:n}=t;o&&(this.setActiveItem(o,t),n.contains(i)&&(i.tabIndex=-1))}navigateFocusOutHandler(e,t){let{target:o}=e;o.closest(t.selector)?.classList.remove(t.activeCls),i.isTabbable(o)||(o.tabIndex=0)}navigateGetAdjacent(e=1,t){let{treeWalker:o}=t;if(o.currentNode=this.navigatorGetActiveItem(t)||t.subject,o[e<0?"previousNode":"nextNode"](),o.currentNode){if(o.currentNode!==t.activeItem)return o.currentNode}else if(!1!==t.wrap){const o=t.subject.querySelector(t.selector);return o[1===e?0:o.length-1]}}navigateKeyDownHandler(e,t){const o=this,{subject:i,wrap:a}=t,r=i.querySelector(t.selector);if(!t.nextKey&&r){const e=getComputedStyle(i),o=getComputedStyle(r);"flex"===e.display&&"row"===e.flexDirection||"inline"===o.display||"inline-block"===o.display?(t.previousKey="ArrowLeft",t.nextKey="ArrowRight"):(t.previousKey="ArrowUp",t.nextKey="ArrowDown")}let s,{key:c,target:l}=e;switch(c){case t.previousKey:s=o.navigateGetAdjacent(-1,t),!s&&a&&(s=i.querySelector(`${t.selector}:last-of-type`));break;case t.nextKey:s=o.navigateGetAdjacent(1,t),!s&&a&&(s=i.querySelector(t.selector));break;case"Home":s=i.querySelector(t.selector);break;case"End":s=i.querySelector(`${t.selector}:last-of-type`);break;case"Enter":t.activeItem&&!n[l.tagName]&&this.clickItem(t.activeItem)}s&&(e.preventDefault(),o.navigateTo(s,t))}navigateMouseDownHandler(e,t){const o=e.target.closest(t.selector);o&&!t.findFocusable(o)&&e.preventDefault()}navigateNodeFilter(e,t){return e.offsetParent&&e.matches?.(t.selector)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}navigateTargetChildListChange(e,t){if(this.fixItemFocusability(t),t.keepFocusIndex&&t.activeItem&&!t.subject.contains(t.activeItem)){const e=t.subject.querySelectorAll(t.selector);e.length&&this.navigateTo(e[Math.max(Math.min(t.activeIndex,e.length-1),0)],t)}}navigateTo(e,o){if(!o.subject&&!(o=t.getElement(o.id)?.$navigator))return;if("number"==typeof e?e=o.subject.querySelectorAll(o.selector)?.[e]:"string"==typeof e&&(e=t.getElement(e)),!e)return;e.scrollIntoView({behavior:"smooth",block:"nearest"});const n=i.query(e,i.isFocusable);n?n.focus({preventScroll:!0}):this.setActiveItem(e,o)}navigatorGetActiveItem(e){let o=e.activeItem&&t.getElement(e.activeItem.id)||null;if(!o&&"activeIndex"in e){const t=e.subject.querySelectorAll(e.selector);o=t[Math.max(Math.min(e.activeIndex,t.length-1),0)]}return o}setActiveItem(e,t){const i=Array.from(t.subject.querySelectorAll(t.selector));"number"==typeof e&&(e=i[Math.max(Math.min(e,i.length-1),0)]),t.previousActiveIndex=t.activeIndex,(t.previousActiveItem=t.activeItem)?.classList.remove(t.activeCls),(t.activeItem=e)?.classList.add(t.activeCls),t.activeIndex=e?i.indexOf(e):-1,e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"}),(t.eventSource||t.subject).setAttribute("aria-activedescendant",t.activeItem.id),t.activeItem!==t.previousActiveItem&&o.sendMessageToApp({type:"neonavigate",target:t.id,path:[{id:t.id}],activeItem:t.activeItem.id,previousActiveItem:t.previousActiveItem?.id,activeIndex:t.activeIndex,previousActiveIndex:t.previousActiveIndex,altKey:Neo.altKeyDown,ctrlKey:Neo.controlKeyDown,metaKey:Neo.metaKeyDown,shiftKey:Neo.shiftKeyDown}),t.autoClick&&this.clickItem(e)}subscribe(e){const o=this,n=e.subject=t.getElement(e.id),a=e.eventSource=e.eventSource?t.getElement(e.eventSource):n;n&&(n.$navigator=e,e.activeCls||(e.activeCls="neo-navigator-active-item"),o.fixItemFocusability(e),e.findFocusable=t=>i.closest(t,(t=>i.isFocusable(t)&&n.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY&&t.closest(e.selector))),e.treeWalker=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,(t=>o.navigateNodeFilter(t,e))),(e.targetMutationMonitor=new MutationObserver((t=>o.navigateTargetChildListChange(t,e)))).observe(n,{childList:!0,subtree:!0}),a.addEventListener("keydown",e.l1=t=>o.navigateKeyDownHandler(t,e)),n.addEventListener("mousedown",e.l2=t=>o.navigateMouseDownHandler(t,e)),n.addEventListener("click",e.l3=t=>o.navigateClickHandler(t,e)),n.addEventListener("focusin",e.l4=t=>o.navigateFocusInHandler(t,e)),n.addEventListener("focusout",e.l5=t=>o.navigateFocusOutHandler(t,e)))}unsubscribe(e){const o=t.getElement(e.id);e=o?.$navigator,e&&(delete o.$navigator,e.targetMutationMonitor.disconnect(),e.eventSource.removeEventListener("keydown",e.l1),o.removeEventListener("mousedown",e.l2),o.removeEventListener("click",e.l3),o.removeEventListener("focusin",e.l4),o.removeEventListener("focusout",e.l5))}});