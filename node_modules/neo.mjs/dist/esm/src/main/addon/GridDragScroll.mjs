import e from"./Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.main.addon.GridDragScroll",remote:{app:["register","unregister"]}};activeDrag=null;registrations=new Map;autoScroll(e){let t=this,{friction:n,registration:r,velocity:i}=e;Math.abs(i.x)<.1&&Math.abs(i.y)<.1||(r.containerElement&&(r.containerElement.scrollLeft-=i.x),r.bodyElement&&(r.bodyElement.scrollTop-=i.y),i.x*=n,i.y*=n,t.activeDrag={id:e.id,animation:requestAnimationFrame(t.autoScroll.bind(t,e))})}getEventCoordinates(e){if(e.type.startsWith("touch")){let t=e.touches[0]||e.changedTouches[0];return{x:t.clientX,y:t.clientY}}return{x:e.clientX,y:e.clientY}}onDragEnd(e){let t=this;if(t.activeDrag){"mouseup"===e.type?(document.body.style.removeProperty("cursor"),document.removeEventListener("mousemove",t.activeDrag.listeners.move,{capture:!0}),document.removeEventListener("mouseup",t.activeDrag.listeners.end,{capture:!0})):(document.removeEventListener("touchmove",t.activeDrag.listeners.move,{capture:!0,passive:!1}),document.removeEventListener("touchend",t.activeDrag.listeners.end,{capture:!0}));let{history:n,id:r,registration:i}=t.activeDrag,o=Date.now()-100,a=n.filter(e=>e.time>o);if(a.length>1){let e=a[a.length-1],n=a[0],o=e.time-n.time,s=(e.x-n.x)/o*16,c=(e.y-n.y)/o*16;t.autoScroll({friction:.95,id:r,registration:i,velocity:{x:s,y:c}})}else t.activeDrag=null}}onDragMove(e){let t=this.activeDrag;if(!t)return;"touchmove"===e.type&&e.preventDefault();let{registration:n}=t,{x:r,y:i}=this.getEventCoordinates(e),o=t.lastX-r,a=t.lastY-i;0!==o&&n.containerElement&&(n.containerElement.scrollLeft+=o),0!==a&&n.bodyElement&&(n.bodyElement.scrollTop+=a),t.lastX=r,t.lastY=i,t.history.push({time:Date.now(),x:r,y:i}),t.history.length>10&&t.history.shift()}onDragStart(e){if("mousedown"===e.type&&0!==e.button)return;let t,n,r=this,i=e.composedPath();r.activeDrag?.animation&&(cancelAnimationFrame(r.activeDrag.animation),r.activeDrag=null);for(const[e,o]of r.registrations)if(i.includes(o.bodyElement)){t=e,n=o;break}if(!n)return;if(i.some(e=>e.classList?.contains("neo-draggable")))return;"mousedown"===e.type&&e.preventDefault();let{x:o,y:a}=r.getEventCoordinates(e);r.activeDrag={id:t,registration:n,history:[{time:Date.now(),x:o,y:a}],lastX:o,lastY:a,listeners:{move:r.onDragMove.bind(r),end:r.onDragEnd.bind(r)}},"mousedown"===e.type?(document.body.style.setProperty("cursor","grabbing","important"),document.addEventListener("mousemove",r.activeDrag.listeners.move,{capture:!0}),document.addEventListener("mouseup",r.activeDrag.listeners.end,{capture:!0})):(document.addEventListener("touchmove",r.activeDrag.listeners.move,{capture:!0,passive:!1}),document.addEventListener("touchend",r.activeDrag.listeners.end,{capture:!0}))}register({bodyId:e,containerId:t,id:n}){let r=this;r.registrations.has(n)&&r.unregister({id:n});let i=document.getElementById(e),o=document.getElementById(t);if(i){let e={bodyElement:i,containerElement:o,id:n,dragStartListener:r.onDragStart.bind(r)};Neo.config.hasTouchEvents?i.addEventListener("touchstart",e.dragStartListener,{capture:!0,passive:!1}):i.addEventListener("mousedown",e.dragStartListener,{capture:!0}),r.registrations.set(n,e)}}unregister({id:e}){let t=this,n=t.registrations.get(e);n&&(n.bodyElement&&(Neo.config.hasTouchEvents?n.bodyElement.removeEventListener("touchstart",n.dragStartListener,{capture:!0,passive:!1}):n.bodyElement.removeEventListener("mousedown",n.dragStartListener,{capture:!0})),t.activeDrag?.id===e&&t.onDragEnd({type:Neo.config.hasTouchEvents?"touchend":"mouseup"}),t.registrations.delete(e))}});