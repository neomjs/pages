import e from"./Base.mjs";import t from"../DomEvents.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.main.addon.GridDragScroll",delay:100,minDistance:5,mouseDownTime:0,mouseDownTimeout:null,remote:{app:["register","unregister"]}};activeDrag=null;monitorDrag=null;registrations=new Map;construct(e){super.construct(e),Neo.bindMethods(this,["onDragStart","onMonitorEnd","onMonitorMove"])}autoScroll(e){let t=this,{friction:o,registration:n,velocity:r}=e;Math.abs(r.x)<.1&&Math.abs(r.y)<.1||(n.containerElement&&(n.containerElement.scrollLeft-=r.x),n.bodyElement&&(n.bodyElement.scrollTop-=r.y),r.x*=o,r.y*=o,t.activeDrag={id:e.id,animation:requestAnimationFrame(t.autoScroll.bind(t,e))})}getEventCoordinates(e){if(e.type.startsWith("touch")){let t=e.touches[0]||e.changedTouches[0];return{x:t.clientX,y:t.clientY}}return{x:e.clientX,y:e.clientY}}onDragEnd(e){let t=this;if(t.activeDrag){"mouseup"===e.type?(document.body.style.removeProperty("cursor"),document.removeEventListener("mousemove",t.activeDrag.listeners.move,{capture:!0}),document.removeEventListener("mouseup",t.activeDrag.listeners.end,{capture:!0})):(document.removeEventListener("touchmove",t.activeDrag.listeners.move,{capture:!0,passive:!1}),document.removeEventListener("touchend",t.activeDrag.listeners.end,{capture:!0}));let{history:o,id:n,registration:r}=t.activeDrag,i=Date.now()-100,a=o.filter(e=>e.time>i);if(a.length>1){let e=a[a.length-1],o=a[0],i=e.time-o.time,s=(e.x-o.x)/i*16,c=(e.y-o.y)/i*16;t.autoScroll({friction:.95,id:n,registration:r,velocity:{x:s,y:c}})}else t.activeDrag=null}}onDragMove(e){let t=this.activeDrag;if(!t)return;"touchmove"===e.type&&!1!==e.cancelable&&e.preventDefault();let{registration:o}=t,{x:n,y:r}=this.getEventCoordinates(e),i=t.lastX-n,a=t.lastY-r;0!==i&&o.containerElement&&(o.containerElement.scrollLeft+=i),0!==a&&o.bodyElement&&(o.bodyElement.scrollTop+=a),t.lastX=n,t.lastY=r,t.history.push({time:Date.now(),x:n,y:r}),t.history.length>10&&t.history.shift()}onDragStart(e){if("mousedown"===e.type&&0!==e.button)return;let t,o,n=this,r=e.composedPath();n.activeDrag?.animation&&(cancelAnimationFrame(n.activeDrag.animation),n.activeDrag=null);for(const[e,i]of n.registrations)if(r.includes(i.bodyElement)){t=e,o=i;break}if(!o)return;if(r.some(e=>e.classList?.contains("neo-draggable")))return;"mousedown"===e.type&&e.preventDefault();let{x:i,y:a}=n.getEventCoordinates(e);n.monitorDrag={id:t,registration:o,startX:i,startY:a},n.mouseDownTime=Date.now(),"mousedown"===e.type?(document.addEventListener("mousemove",n.onMonitorMove,{capture:!0}),document.addEventListener("mouseup",n.onMonitorEnd,{capture:!0})):(document.addEventListener("touchmove",n.onMonitorMove,{capture:!0,passive:!1}),document.addEventListener("touchend",n.onMonitorEnd,{capture:!0})),n.mouseDownTimeout=setTimeout(()=>{n.onMonitorMove({type:"timeout",...n.getEventCoordinates(e)})},n.delay)}onMonitorMove(e){let o=this,n=o.monitorDrag,{x:r,y:i}=o.getEventCoordinates(e),a=Date.now()-o.mouseDownTime,s=t.getDistance(n.startX,n.startY,r,i)||0;a>=o.delay&&s>=o.minDistance&&(o.onMonitorEnd(e),o.startDrag(n,r,i,e.type.startsWith("touch")?"touch":"mouse"))}onMonitorEnd(e){let t=this;clearTimeout(t.mouseDownTimeout),t.monitorDrag=null,document.removeEventListener("mousemove",t.onMonitorMove,{capture:!0}),document.removeEventListener("mouseup",t.onMonitorEnd,{capture:!0}),document.removeEventListener("touchmove",t.onMonitorMove,{capture:!0,passive:!1}),document.removeEventListener("touchend",t.onMonitorEnd,{capture:!0})}register({bodyId:e,containerId:t,id:o}){let n=this;n.registrations.has(o)&&n.unregister({id:o});let r=document.getElementById(e),i=document.getElementById(t);if(r){let e={bodyElement:r,containerElement:i,id:o};Neo.config.hasTouchEvents?r.addEventListener("touchstart",n.onDragStart,{capture:!0,passive:!1}):r.addEventListener("mousedown",n.onDragStart,{capture:!0}),n.registrations.set(o,e)}}startDrag(e,t,o,n){let r=this;r.activeDrag={id:e.id,registration:e.registration,history:[{time:Date.now(),x:t,y:o}],lastX:t,lastY:o,listeners:{move:r.onDragMove.bind(r),end:r.onDragEnd.bind(r)}},"mouse"===n?(document.body.style.setProperty("cursor","grabbing","important"),document.addEventListener("mousemove",r.activeDrag.listeners.move,{capture:!0}),document.addEventListener("mouseup",r.activeDrag.listeners.end,{capture:!0})):(document.addEventListener("touchmove",r.activeDrag.listeners.move,{capture:!0,passive:!1}),document.addEventListener("touchend",r.activeDrag.listeners.end,{capture:!0}))}unregister({id:e}){let t=this,o=t.registrations.get(e);o&&(o.bodyElement&&(Neo.config.hasTouchEvents?o.bodyElement.removeEventListener("touchstart",t.onDragStart,{capture:!0,passive:!1}):o.bodyElement.removeEventListener("mousedown",t.onDragStart,{capture:!0})),t.activeDrag?.id===e&&t.onDragEnd({type:Neo.config.hasTouchEvents?"touchend":"mouseup"}),t.registrations.delete(e))}});