import e from"./Base.mjs";import t from"../DomAccess.mjs";import o from"../DomEvents.mjs";import n from"../../util/Rectangle.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.main.addon.DragDrop",allowOverdrag:!1,alwaysFireDragMove:!1,bodyCursorStyle:null,boundaryContainerRect:null,clientX:0,clientY:0,dragElementRootId:null,dragProxyCls:"neo-dragproxy",dragProxyElement:null,dragProxyRect:null,dragZoneId:null,dropZoneIdentifier:null,initialScrollLeft:0,initialScrollTop:0,isWindowDragging:!1,moveHorizontal:!0,moveVertical:!0,offsetX:0,offsetY:0,popupName:null,remote:{app:["requestWindowManagementPermission","setConfigs","setDragProxyElement","startWindowDrag"]},scrollContainerElement:null,scrollContainerRect:null,scrollFactorLeft:1,scrollFactorTop:1};construct(e){super.construct(e);let t=this,n=[];o.on({mouseEnter:t.onMouseEnter,mouseLeave:t.onMouseLeave,scope:t}),t.addGlobalEventListeners(),Neo.config.hasMouseEvents&&n.push(import("../draggable/sensor/Mouse.mjs")),Neo.config.hasTouchEvents&&n.push(import("../draggable/sensor/Touch.mjs")),Promise.all(n).then(e=>{e.forEach(e=>{Neo.create({module:e.default})})})}addGlobalEventListeners(){let e=this;document.addEventListener("drag:end",e.onDragEnd.bind(e),!0),document.addEventListener("drag:move",e.onDragMove.bind(e),!0),document.addEventListener("drag:start",e.onDragStart.bind(e),!0)}getEventData(e){let t=e.path||e.composedPath(),n=e.detail,r={...o.getEventData(e.detail.originalEvent),clientX:n.clientX,clientY:n.clientY};return n.eventPath?r.targetPath=n.eventPath.map(e=>o.getTargetData(e)):r.targetPath=r.path,r.path=t.map(e=>o.getTargetData(e)),r}onDragEnd(e){let n=this,r=n.getEventData(e),l=n.pathIncludesDropZone(r.targetPath);n.bodyCursorStyle&&t.setStyle({id:"document.body",style:{cursor:null}}),o.sendMessageToApp({...r,dragZoneId:n.dragZoneId,isDrop:l,offsetX:n.offsetX,offsetY:n.offsetY,type:"drag:end"}),l&&o.sendMessageToApp({...o.getMouseEventData(e.detail.originalEvent),dragZoneId:n.dragZoneId,type:"drop"}),Object.assign(n,{alwaysFireDragMove:!1,bodyCursorStyle:null,boundaryContainerRect:null,dragElementRootId:null,dragElementRootRect:null,dragProxyCls:"neo-dragproxy",dragProxyElement:null,dragZoneId:null,dropZoneIdentifier:null,initialScrollLeft:0,initialScrollTop:0,isWindowDragging:!1,moveHorizontal:!0,moveVertical:!0,popupHeight:null,popupName:null,popupWidth:null,scrollContainerElement:null,scrollContainerRect:null,setScrollFactorLeft:1,scrollFactorTop:1,windowName:null})}onDragMove(e){let t,n,r,l=this,{originalEvent:a}=e.detail,i=l.dragProxyRect,s=l.boundaryContainerRect;if(l.isWindowDragging){const t=a.screenX-(l.offsetX||0),n=a.screenY-(l.offsetY||0);return Neo.Main.windowMoveTo({windowName:l.popupName,x:t,y:n}),void o.sendMessageToApp({...l.getEventData(e),dragZoneId:l.dragZoneId,offsetX:l.offsetX,offsetY:l.offsetY,proxyRect:new DOMRect(t-window.screenX,n-window.screenY,l.popupWidth,l.popupHeight),screenX:a.screenX,screenY:a.screenY,type:"drag:move"})}if(l.scrollContainerElement&&(t=l.scrollContainer({clientX:e.detail.clientX,clientY:e.detail.clientY}),e.detail.clientX=t.clientX,e.detail.clientY=t.clientY),l.dragProxyElement&&(n=e.detail.clientX-l.offsetX,r=e.detail.clientY-l.offsetY,s&&!l.allowOverdrag&&(n<s.left?n=s.left:n>s.right-i.width&&(n=s.right-i.width),r<s.top?r=s.top:r>s.bottom-i.height&&(r=s.bottom-i.height)),l.moveHorizontal&&(l.dragProxyElement.style.left=`${n}px`),l.moveVertical&&(l.dragProxyElement.style.top=`${r}px`)),!l.dragProxyElement||l.alwaysFireDragMove){let t=e.detail.originalEvent;if(i=null,l.dragProxyElement){const{height:e,width:t}=l.dragProxyElement.getBoundingClientRect();i=new DOMRect(n,r,t,e)}o.sendMessageToApp({...l.getEventData(e),dragZoneId:l.dragZoneId,offsetX:l.offsetX,offsetY:l.offsetY,proxyRect:i,screenX:t.screenX,screenY:t.screenY,type:"drag:move"})}}onDragStart(e){let t=e.target.getBoundingClientRect();Object.assign(this,{dragProxyRect:t,offsetX:e.detail.clientX-t.left,offsetY:e.detail.clientY-t.top}),o.sendMessageToApp({...this.getEventData(e),type:"drag:start"})}onMouseEnter(e){let t=this;t.pathIncludesDropZone(e.path)&&o.sendMessageToApp({...e,dragZoneId:t.dragZoneId,type:"drop:enter"})}onMouseLeave(e){let t=this;t.pathIncludesDropZone(e.path)&&o.sendMessageToApp({...e,dragZoneId:t.dragZoneId,type:"drop:leave"})}pathIncludesDropZone(e){let t,o,n=!0,r=this.dropZoneIdentifier;if(r){t=r.cls,o=r.ids;for(const r of e){if(t){n=!1;for(const e of r.cls)if(t.includes(e)){n=!0;break}}if(n&&o&&!o.includes(r.id)&&(n=!1),n)return!0}}return!1}async requestWindowManagementPermission(){if(!window.isSecureContext||!("getScreenDetails"in window))return{success:!1,error:"The Window Management API requires a secure context (HTTPS or localhost) and is not supported by this browser."};try{return await window.getScreenDetails(),{success:!0}}catch(e){return"PermissionDeniedError"===e.name?{success:!1,error:"Permission to manage windows was denied."}:{success:!1,error:`An unknown error occurred: ${e.message}`}}}scrollContainer(e){let t=this,o=e.clientX-t.clientX,n=e.clientY-t.clientY,r=t.scrollContainerElement,l=250,a=t.scrollContainerRect;return t.clientX=e.clientX,t.clientY=e.clientY,(o<0&&e.clientX<a.left+l||o>0&&e.clientX>a.right-l)&&(r.scrollLeft+=o*t.scrollFactorLeft),(n<0&&e.clientY<a.top+l||n>0&&e.clientY>a.bottom-l)&&(r.scrollTop+=n*t.scrollFactorTop),{clientX:t.clientX+r.scrollLeft-t.initialScrollLeft,clientY:t.clientY+r.scrollTop-t.initialScrollTop}}setConfigs(e){let o,r,l=this,{boundaryContainerId:a}=e;return delete e.appName,delete e.windowId,a&&(r=t.getBoundingClientRect({id:a}),Array.isArray(a)?l.boundaryContainerRect=n.getIntersection(...r):l.boundaryContainerRect=r),delete e.boundaryContainerId,e.scrollContainerId&&(o=t.getElementOrBody(e.scrollContainerId),Object.assign(l,{scrollContainerElement:o,scrollContainerRect:o.getBoundingClientRect(),initialScrollLeft:o.scrollLeft,initialScrollTop:o.scrollTop})),delete e.scrollContainerId,Object.entries(e).forEach(([e,t])=>{l.hasOwnProperty(e)?l[e]=t:console.error("unknown key passed inside setConfigs()",e)}),l.bodyCursorStyle&&t.setStyle({id:"document.body",style:{cursor:l.bodyCursorStyle}}),{boundaryContainerRect:l.boundaryContainerRect||null}}setDragProxyElement(e){this.dragProxyElement=document.getElementById(e.id)}startWindowDrag({popupHeight:e,popupName:t,popupWidth:o}){Object.assign(this,{isWindowDragging:!0,popupHeight:e,popupName:t,popupWidth:o})}});