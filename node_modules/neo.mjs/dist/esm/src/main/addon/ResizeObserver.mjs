import e from"./Base.mjs";import t from"../DomAccess.mjs";import n from"../DomEvents.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.main.addon.ResizeObserver",instance:null,registerAttempts:3,remote:{app:["register","unregister"]}};#e=new Map;#t=null;#n={};construct(e){super.construct(e);let t=this;t.instance=new ResizeObserver(t.onResize.bind(t))}onResize(e,t){let n=this;e.forEach(e=>{n.#e.set(e.target,e)}),n.#t||(n.#t=requestAnimationFrame(()=>{n.dispatchResizeEvents()}))}dispatchResizeEvents(){let e=this,t=Array.from(e.#e.values());e.#t=null,e.#e.clear(),t.forEach(t=>{let i=t.borderBoxSize[0],o=t.contentBoxSize[0],s=t.devicePixelContentBoxSize?.[0]||{},r=n.getPathFromElement(t.target).map(e=>n.getTargetData(e));Neo.worker.Manager.sendMessage("app",{action:"domEvent",eventName:"resize",data:{componentIds:e.#n[t.target.id]||[],contentRect:n.parseDomRect(t.contentRect),id:t.target.id,path:r,rect:r[0].rect,borderBoxSize:{blockSize:i.blockSize,inlineSize:i.inlineSize},contentBoxSize:{blockSize:o.blockSize,inlineSize:o.inlineSize},devicePixelContentBoxSize:{blockSize:s.blockSize,inlineSize:s.inlineSize}}})})}async register(e,n=0){let i=this,o=t.getElement(e.id);o?(i.#n[e.id]??=[],i.#n[e.id].includes(e.componentId)||i.#n[e.id].push(e.componentId),i.instance.observe(o)):n<i.registerAttempts&&(await i.timeout(100),n++,i.register(e,n))}unregister(e){let n=this,{id:i}=e,o=t.getElement(i),s=n.#n[i];s&&(n.#n[i]=s.filter(t=>t!==e.componentId),0===n.#n[i].length&&(delete n.#n[i],o&&n.instance.unobserve(o)))}});