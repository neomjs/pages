import e from"../core/Base.mjs";import t from"./DomAccess.mjs";import{voidAttributes as n}from"../vdom/domConstants.mjs";const o=Neo.config;export default Neo.setupClass(class extends e{static config={className:"Neo.main.DeltaUpdates",countDeltas:0,countDeltasPer250ms:0,countUpdates:0,renderCountDeltas_:!1,singleton:!0};logDeltasIntervalId=0;nativeMoveBefore=null;construct(e){super.construct(e);let{environment:t}=o;o.renderCountDeltas&&(this.renderCountDeltas=!0),"dist/development"!==t&&"dist/production"!==t||(__webpack_require__.p=o.basePath.substring(6))}afterSetRenderCountDeltas(e,t){let n,o=this,{logDeltasIntervalId:r}=o;e?0===r&&(o.logDeltasIntervalId=setInterval(()=>{n=document.getElementById("neo-delta-updates"),n&&(n.innerHTML=String(4*o.countDeltasPer250ms)),o.countDeltasPer250ms=0},250)):(r&&clearInterval(r),o.logDeltasInterval=0)}changeNodeName(e,t){let n,{attributes:o}=e,r=document.createElement(t),l=0,d=o.length;if(e){for(;l<d;l++)n=o.item(l),r.setAttribute(n.nodeName,n.nodeValue);for(;e.firstChild;)r.appendChild(e.firstChild);void 0!==e.value&&e.value!==r.value&&(r.value=e.value),void 0!==e.checked&&e.checked!==r.checked&&(r.checked=e.checked),void 0!==e.selectedIndex&&e.selectedIndex!==r.selectedIndex&&(r.selectedIndex=e.selectedIndex),e.scrollTop>0&&(r.scrollTop=e.scrollTop),e.scrollLeft>0&&(r.scrollLeft=e.scrollLeft),e.parentNode.replaceChild(r,e)}}checkRendererAvailability(){const{render:e}=Neo.main;if(o.useDomApiRenderer){if(!e?.DomApiRenderer)throw new Error("Neo.main.DeltaUpdates: DomApiRenderer is not loaded yet!")}else if(!e?.StringBasedRenderer)throw new Error("Neo.main.DeltaUpdates: StringBasedRenderer is not loaded yet!")}focusNode({id:e}){t.getElement(e)?.focus()}async importRenderer(){const{render:e}=Neo.main;o.useDomApiRenderer?e?.DomApiRenderer||await import("./render/DomApiRenderer.mjs"):e?.StringBasedRenderer||await import("./render/StringBasedRenderer.mjs")}async initAsync(){super.initAsync();let e=this;Neo.worker.Manager.on({neoConfigChange:e.onNeoConfigChange,scope:e}),await e.importRenderer()}getFragmentStart(e){const t=`//comment()[.=' ${e}-start ']`;return document.evaluate(t,document.body,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}getFragmentSibling(e,t,n){let o=e.nextSibling,r=0;for(;o&&r<t;)o!==n&&r++,o=o.nextSibling;return o}getFragmentNodes(e,t){if(!e)return null;const n=Node.COMMENT_NODE,o=` ${t}-start `;let r=Array.from(e.childNodes).find(e=>e.nodeType===n&&e.nodeValue===o);if(!r)return null;const l=` ${t}-end `,d=[];let s=r.nextSibling;for(;s;){if(s.nodeType===n&&s.nodeValue===l)return{startNode:r,endNode:s,nodes:d};d.push(s),s=s.nextSibling}return null}insertNode({hasLeadingTextChildren:e,index:n,outerHTML:r,parentId:l,postMountUpdates:d,vnode:s}){this.checkRendererAvailability();let a,{render:i}=Neo.main,c=t.getElement(l);if(c)a=c.childNodes[n];else{const e=this.getFragmentStart(l);e&&(c=e.parentNode,a=this.getFragmentSibling(e,n))}if(c){let e,n=[];o.useDomApiRenderer?e=i.DomApiRenderer.createDomTree({index:-1,isRoot:!0,parentNode:null,postMountUpdates:n,vnode:s}):(e=i.StringBasedRenderer.createNode({outerHTML:r}),d?.length>0&&n.push(...d)),e?(c.insertBefore(e,a||null),n.length>0&&n.forEach(e=>{if(e.node)e.vnode.scrollLeft&&(e.node.scrollLeft=e.vnode.scrollLeft),e.vnode.scrollTop&&(e.node.scrollTop=e.vnode.scrollTop);else{let n=t.getElement(e.id);n&&(e.scrollLeft&&(n.scrollLeft=e.scrollLeft),e.scrollTop&&(n.scrollTop=e.scrollTop))}})):console.error("insertNode: Failed to create newNode",{outerHTML:r,vnode:s})}else console.error("insertNode: Parent not found",{parentId:l,index:n})}insertNodeBatch(e){const n=e[0],r=n.parentId,l=n.index;let d,s=t.getElement(r);if(s)d=s.childNodes[l];else{const e=this.getFragmentStart(r);e&&(s=e.parentNode,d=this.getFragmentSibling(e,l))}if(s){const n=document.createDocumentFragment(),{render:r}=Neo.main,l=[];e.forEach(e=>{let t,d=e.postMountUpdates||[];t=o.useDomApiRenderer?r.DomApiRenderer.createDomTree({index:-1,isRoot:!0,parentNode:null,postMountUpdates:d,vnode:e.vnode}):r.StringBasedRenderer.createNode({outerHTML:e.outerHTML}),t?(n.appendChild(t),d.length>0&&l.push(...d)):console.error("insertNodeBatch: Failed to create node",e)}),s.insertBefore(n,d||null),l.length>0&&l.forEach(e=>{if(e.node)e.vnode.scrollLeft&&(e.node.scrollLeft=e.vnode.scrollLeft),e.vnode.scrollTop&&(e.node.scrollTop=e.vnode.scrollTop);else{let n=t.getElement(e.id);n&&(e.scrollLeft&&(n.scrollLeft=e.scrollLeft),e.scrollTop&&(n.scrollTop=e.scrollTop))}})}else console.error("insertNodeBatch: Parent not found",{parentId:r,index:l})}moveNode({id:e,index:n,parentId:o}){let r,l=t.getElement(e),d=t.getElement(o);if(d){if(l&&l.parentNode===d){const e=Array.prototype.indexOf.call(d.childNodes,l);e>-1&&e<n&&n++}r=n<d.childNodes.length?d.childNodes[n]:null}else{const e=this.getFragmentStart(o);e&&(d=e.parentNode,r=this.getFragmentSibling(e,n))}if(!l&&d){const t=`//comment()[.=' ${e}-start ']`,n=document.evaluate(t,document.body,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(n){const t=this.getFragmentNodes(n.parentNode,e);if(t){const e=document.createDocumentFragment();e.append(t.startNode,...t.nodes,t.endNode),l=e}}}if(l&&d&&l!==r)if(null===this.nativeMoveBefore&&(this.nativeMoveBefore="function"==typeof d.moveBefore),this.nativeMoveBefore)d.moveBefore(l,r||null);else{const e=document.activeElement,t=e&&(l===e||l.contains(e));1===l.nodeType&&r&&l===r.nextElementSibling&&l.replaceWith(r),d.insertBefore(l,r||null),t&&e.focus()}}async onNeoConfigChange(e){Object.hasOwn(e,"useDomApiRenderer")&&await this.importRenderer()}getFragmentNodes(e,t){if(!e)return null;const n=Node.COMMENT_NODE,o=` ${t}-start `;let r=Array.from(e.childNodes).find(e=>e.nodeType===n&&e.nodeValue===o);if(!r)return null;const l=` ${t}-end `,d=[];let s=r.nextSibling;for(;s;){if(s.nodeType===n&&s.nodeValue===l)return{startNode:r,endNode:s,nodes:d};d.push(s),s=s.nextSibling}return null}removeAll({parentId:e}){let n=t.getElement(e);n&&(n.innerHTML="")}removeNode({id:e,parentId:n}){const o=t.getElement(e);if(o)o.remove();else if(n){const o=t.getElementOrBody(n);if(o){const t=this.getFragmentNodes(o,e);if(t)return t.startNode.remove(),t.endNode.remove(),void t.nodes.forEach(e=>e.remove());const n=Node.COMMENT_NODE,r=Array.from(o.childNodes).find(t=>t.nodeType===n&&t.nodeValue.includes(` ${e} `));if(r){const e=r.nextSibling,t=e?.nextSibling?.nodeType===n?e.nextSibling:null;r.remove(),e?.remove(),t?.remove()}}}}replaceChild({fromId:e,parentId:n,toId:o}){let r=t.getElement(n);r?.replaceChild(t.getElement(o),t.getElement(e))}updateNode(e){let r=this,l=t.getElementOrBody(e.id);l&&Object.entries(e).forEach(([e,t])=>{switch(e){case"attributes":Object.entries(t).forEach(([e,t])=>{n.has(e)?l[e]="true"===t:null===t||""===t?"value"===e?l[e]="":l.removeAttribute(e):"id"===e?l[o.useDomIds?"id":"data-neo-id"]=t:"spellcheck"===e&&"false"===t?l[e]=!1:"value"===e?l[e]=t:l.setAttribute(e,t)});break;case"cls":t.add&&l.classList.add(...t.add),t.remove&&l.classList.remove(...t.remove);break;case"innerHTML":l.innerHTML=t||"";break;case"nodeName":r.changeNodeName(l,t);break;case"outerHTML":l.outerHTML=t||"";break;case"scrollLeft":case"scrollTop":l[e]=t;break;case"style":Neo.isObject(t)&&Object.entries(t).forEach(([e,t])=>{let n;Neo.isString(t)&&t.includes("!important")&&(t=t.replace("!important","").trim(),n="important"),l.style.setProperty(Neo.decamel(e),t,n)});break;case"textContent":l.textContent=t}})}updateVtext({id:e,parentId:n,value:o}){const r=t.getElement(n),l=Node.COMMENT_NODE,d=` ${e} `;if(r){const e=Array.from(r.childNodes).find(e=>e.nodeType===l&&e.nodeValue===d);e?.nextSibling&&(e.nextSibling.nodeValue=o)}}update(e){this.checkRendererAvailability();let t,n=this,{deltas:r}=e,l=0;for(r=Array.isArray(r)?r:[r],t=r.length,o.logDeltaUpdates&&t>0&&(n.countDeltas+=t,n.countUpdates++,console.log("update "+n.countUpdates,"total deltas ",n.countDeltas,Neo.clone(e,!0))),o.renderCountDeltas&&t>0&&(n.countDeltasPer250ms+=t);l<t;){const e=r[l];if("insertNode"===e.action&&l<t-1){let o=l+1,d=[e];for(;o<t;){const t=r[o],n=r[o-1];if("insertNode"!==t.action||t.parentId!==e.parentId||t.index!==n.index+1)break;d.push(t),o++}if(d.length>1){n.insertNodeBatch(d),l=o;continue}}n[e.action||"updateNode"](e),l++}}});