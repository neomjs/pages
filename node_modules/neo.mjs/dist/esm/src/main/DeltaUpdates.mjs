import e from"../core/Base.mjs";import t from"./DomAccess.mjs";import{voidAttributes as r}from"../vdom/domConstants.mjs";const n=Neo.config;export default Neo.setupClass(class extends e{static config={className:"Neo.main.DeltaUpdates",singleton:!0};#e=null;#t=null;construct(e){super.construct(e),this.#t=(async()=>{try{let e;e=n.useStringBasedMounting?await import("./render/StringBasedRenderer.mjs"):await import("./render/DomApiRenderer.mjs"),this.#e=e.default}catch(e){throw console.error("DeltaUpdates: Failed to load renderer module:",e),e}})()}changeNodeName(e,t){let r,{attributes:n}=e,o=document.createElement(t),d=0,s=n.length;if(e){for(;d<s;d++)r=n.item(d),o.setAttribute(r.nodeName,r.nodeValue);o.innerHTML=e.innerHTML,e.parentNode.replaceChild(o,e)}}focusNode({id:e}){t.getElement(e)?.focus()}insertNode({hasLeadingTextChildren:e,index:r,outerHTML:o,parentId:d,vnode:s}){if(!this.#e)return void console.error("DeltaUpdates renderer not ready during insertNode!");const a=t.getElementOrBody(d);a&&(n.useStringBasedMounting?this.#e.insertNodeAsString({hasLeadingTextChildren:e,index:r,outerHTML:o,parentNode:a}):this.#e.createDomTree({index:r,isRoot:!0,parentNode:a,vnode:s}))}moveNode({id:e,index:r,parentId:n}){let o=t.getElement(e),d=t.getElement(n);if(o&&d)if(r>=d.childNodes.length)d.appendChild(o);else{let e=d.childNodes[r];o!==e&&(1===o.nodeType&&o===e.nextElementSibling&&o.replaceWith(e),d.insertBefore(o,e))}}removeAll({parentId:e}){let r=t.getElement(e);r&&(r.innerHTML="")}removeNode({id:e,parentId:r}){const n=t.getElement(e);if(n)n.remove();else if(r){const n=t.getElementOrBody(r),o=Node.COMMENT_NODE;if(n){const t=Array.from(n.childNodes).find(t=>t.nodeType===o&&t.nodeValue.includes(` ${e} `));if(t){const e=t.nextSibling,r=e?.nextSibling?.nodeType===o?e.nextSibling:null;t.remove(),e?.remove(),r?.remove()}}}}replaceChild({fromId:e,parentId:r,toId:n}){let o=t.getElement(r);o?.replaceChild(t.getElement(n),t.getElement(e))}setTextContent({id:e,value:r}){let n=t.getElement(e);n&&(n.textContent=r)}updateNode(e){let o=this,d=t.getElementOrBody(e.id);d||console.log("node not found",e.id),d&&Object.entries(e).forEach(([e,t])=>{switch(e){case"attributes":Object.entries(t).forEach(([e,t])=>{r.has(e)?d[e]="true"===t:null===t||""===t?"value"===e?d[e]="":d.removeAttribute(e):"id"===e?d[n.useDomIds?"id":"data-neo-id"]=t:"spellcheck"===e&&"false"===t?d[e]=!1:"value"===e?d[e]=t:d.setAttribute(e,t)});break;case"cls":t.add&&d.classList.add(...t.add),t.remove&&d.classList.remove(...t.remove);break;case"innerHTML":d.innerHTML=t||"";break;case"nodeName":o.changeNodeName(d,t);break;case"outerHTML":d.outerHTML=t||"";break;case"style":Neo.isObject(t)&&Object.entries(t).forEach(([e,t])=>{let r;Neo.isString(t)&&t.includes("!important")&&(t=t.replace("!important","").trim(),r="important"),d.style.setProperty(Neo.decamel(e),t,r)})}})}updateVtext({id:e,parentId:r,value:n}){let o=t.getElement(r),d=o.innerHTML,s=new RegExp(`\x3c!-- ${e} --\x3e`+"[\\s\\S]*?\x3c!-- /neo-vtext --\x3e");o.innerHTML=d.replace(s,n)}update(e){if(!this.#e)return void console.error("DeltaUpdates renderer not ready during insertNode!");let t,r=this,{deltas:o}=e,d=0;for(o=Array.isArray(o)?o:[o],t=o.length,n.logDeltaUpdates&&t>0&&(r.countDeltas+=t,r.countUpdates++,console.log("update "+r.countUpdates,"total deltas ",r.countDeltas,Neo.clone(e,!0))),n.renderCountDeltas&&t>0&&(r.countDeltasPer250ms+=t);d<t;d++)r[o[d].action||"updateNode"](o[d]);Neo.worker.Manager.sendMessage(e.origin||"app",{action:"reply",replyId:e.id,success:!0})}});