import e from"../core/Base.mjs";import t from"./DomAccess.mjs";import{voidAttributes as r}from"../vdom/domConstants.mjs";const n=Neo.config;export default Neo.setupClass(class extends e{static config={className:"Neo.main.DeltaUpdates",countDeltas:0,countDeltasPer250ms:0,countUpdates:0,renderCountDeltas_:!1,singleton:!0};logDeltasIntervalId=0;#e=null;#t=null;construct(e){super.construct(e);let t=this,{environment:r}=n;n.renderCountDeltas&&(t.renderCountDeltas=!0),"dist/development"!==r&&"dist/production"!==r||(__webpack_require__.p=n.basePath.substring(6)),t.#t=(async()=>{try{let e;e=n.useDomApiRenderer?await import("./render/DomApiRenderer.mjs"):await import("./render/StringBasedRenderer.mjs"),t.#e=e.default}catch(e){throw console.error("DeltaUpdates: Failed to load renderer module:",e),e}})()}afterSetRenderCountDeltas(e,t){let r,n=this,{logDeltasIntervalId:o}=n;e?0===o&&(n.logDeltasIntervalId=setInterval(()=>{r=document.getElementById("neo-delta-updates"),r&&(r.innerHTML=String(4*n.countDeltasPer250ms)),n.countDeltasPer250ms=0},250)):(o&&clearInterval(o),n.logDeltasInterval=0)}changeNodeName(e,t){let r,{attributes:n}=e,o=document.createElement(t),a=0,d=n.length;if(e){for(;a<d;a++)r=n.item(a),o.setAttribute(r.nodeName,r.nodeValue);o.innerHTML=e.innerHTML,e.parentNode.replaceChild(o,e)}}focusNode({id:e}){t.getElement(e)?.focus()}insertNode({hasLeadingTextChildren:e,index:r,outerHTML:o,parentId:a,vnode:d}){let s=this;if(!s.#e)return void console.error("DeltaUpdates renderer not ready during insertNode!");const l=t.getElementOrBody(a);l&&(n.useDomApiRenderer?s.#e.createDomTree({index:r,isRoot:!0,parentNode:l,vnode:d}):s.#e.insertNodeAsString({hasLeadingTextChildren:e,index:r,outerHTML:o,parentNode:l}))}moveNode({id:e,index:r,parentId:n}){let o=t.getElement(e),a=t.getElement(n);if(o&&a)if(r>=a.childNodes.length)a.appendChild(o);else{let e=a.childNodes[r];o!==e&&(1===o.nodeType&&o===e.nextElementSibling&&o.replaceWith(e),a.insertBefore(o,e))}}removeAll({parentId:e}){let r=t.getElement(e);r&&(r.innerHTML="")}removeNode({id:e,parentId:r}){const n=t.getElement(e);if(n)n.remove();else if(r){const n=t.getElementOrBody(r),o=Node.COMMENT_NODE;if(n){const t=Array.from(n.childNodes).find(t=>t.nodeType===o&&t.nodeValue.includes(` ${e} `));if(t){const e=t.nextSibling,r=e?.nextSibling?.nodeType===o?e.nextSibling:null;t.remove(),e?.remove(),r?.remove()}}}}replaceChild({fromId:e,parentId:r,toId:n}){let o=t.getElement(r);o?.replaceChild(t.getElement(n),t.getElement(e))}setTextContent({id:e,value:r}){let n=t.getElement(e);n&&(n.textContent=r)}updateNode(e){let o=this,a=t.getElementOrBody(e.id);a||console.log("node not found",e.id),a&&Object.entries(e).forEach(([e,t])=>{switch(e){case"attributes":Object.entries(t).forEach(([e,t])=>{r.has(e)?a[e]="true"===t:null===t||""===t?"value"===e?a[e]="":a.removeAttribute(e):"id"===e?a[n.useDomIds?"id":"data-neo-id"]=t:"spellcheck"===e&&"false"===t?a[e]=!1:"value"===e?a[e]=t:a.setAttribute(e,t)});break;case"cls":t.add&&a.classList.add(...t.add),t.remove&&a.classList.remove(...t.remove);break;case"innerHTML":a.innerHTML=t||"";break;case"nodeName":o.changeNodeName(a,t);break;case"outerHTML":a.outerHTML=t||"";break;case"style":Neo.isObject(t)&&Object.entries(t).forEach(([e,t])=>{let r;Neo.isString(t)&&t.includes("!important")&&(t=t.replace("!important","").trim(),r="important"),a.style.setProperty(Neo.decamel(e),t,r)})}})}updateVtext({id:e,parentId:r,value:n}){let o=t.getElement(r),a=o.innerHTML,d=new RegExp(`\x3c!-- ${e} --\x3e`+"[\\s\\S]*?\x3c!-- /neo-vtext --\x3e");o.innerHTML=a.replace(d,n)}update(e){if(!this.#e)return void console.error("DeltaUpdates renderer not ready during insertNode!");let t,r=this,{deltas:o}=e,a=0;for(o=Array.isArray(o)?o:[o],t=o.length,n.logDeltaUpdates&&t>0&&(r.countDeltas+=t,r.countUpdates++,console.log("update "+r.countUpdates,"total deltas ",r.countDeltas,Neo.clone(e,!0))),n.renderCountDeltas&&t>0&&(r.countDeltasPer250ms+=t);a<t;a++)r[o[a].action||"updateNode"](o[a]);Neo.worker.Manager.sendMessage(e.origin||"app",{action:"reply",replyId:e.id,success:!0})}});