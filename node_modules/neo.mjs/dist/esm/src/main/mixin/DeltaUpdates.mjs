import e from"../../core/Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.main.mixin.DeltaUpdates"};du_changeNodeName(e,t){let n,{attributes:d}=e,r=document.createElement(t),o=0,i=d.length;if(e){for(;o<i;o++)n=d.item(o),r.setAttribute(n.nodeName,n.nodeValue);r.innerHTML=e.innerHTML,e.parentNode.replaceChild(r,e)}}du_focusNode(e){this.getElement(e.id)?.focus()}du_insertNode(e){let t,{index:n}=e,d=this.getElementOrBody(e.parentId),r=d?.childNodes.length,o=0,i=n,l=!1;if(d){if(r<=20&&"TBODY"!==d.nodeName)for(;o<r;o++)8===d.childNodes[o].nodeType&&(o<i&&i++,l=!0);if(l)t=this.htmlStringToElement(e.outerHTML),r>0&&r>i?d.insertBefore(t,d.childNodes[i]):d.appendChild(t);else{if(r=d.children.length,n>0&&n>=r)return void d.insertAdjacentHTML("beforeend",e.outerHTML);r>0&&r>n?d.children[n].insertAdjacentHTML("beforebegin",e.outerHTML):r>0?d.children[r-1].insertAdjacentHTML("afterend",e.outerHTML):d.insertAdjacentHTML("beforeend",e.outerHTML)}}}du_moveNode({id:e,index:t,parentId:n}){let d,r=this.getElement(e),o=this.getElement(n);r&&o&&(t>=o.children.length?o.appendChild(r):(d=o.children[t],r&&d.id!==e&&(r===d.nextElementSibling&&r.replaceWith(d),o.insertBefore(r,d))))}du_removeAll(e){let t=this.getElement(e.parentId);t&&(t.innerHTML="")}du_removeNode(e){let t,n,d=this.getElement(e.id);d?d.remove():(d=e.parentId&&this.getElementOrBody(e.parentId),d&&(n=`\x3c!-- ${e.id} --\x3e`,t=new RegExp(n+"[\\s\\S]*?\x3c!-- /neo-vtext --\x3e"),d.innerHTML=d.innerHTML.replace(t,"")))}du_replaceChild(e){let t=this,n=t.getElement(e.parentId);n?.replaceChild(t.getElement(e.toId),t.getElement(e.fromId))}du_setTextContent(e){let t=this.getElement(e.id);t&&(t.textContent=e.value)}du_updateNode(e){let t=this,n=t.getElementOrBody(e.id);n&&Object.entries(e).forEach((([e,d])=>{switch(e){case"attributes":Object.entries(d).forEach((([e,d])=>{t.voidAttributes.includes(e)?n[e]="true"===d:null===d||""===d?"value"===e?n[e]="":n.removeAttribute(e):"id"===e?n[Neo.config.useDomIds?"id":"data-neo-id"]=d:"spellcheck"===e&&"false"===d?n[e]=!1:"value"===e?n[e]=d:n.setAttribute(e,d)}));break;case"cls":d.add&&n.classList.add(...d.add),d.remove&&n.classList.remove(...d.remove);break;case"innerHTML":n.innerHTML=d||"";break;case"nodeName":t.du_changeNodeName(n,d);break;case"outerHTML":n.outerHTML=d||"";break;case"style":Neo.isObject(d)&&Object.entries(d).forEach((([e,t])=>{let d;Neo.isString(t)&&t.includes("!important")&&(t=t.replace("!important","").trim(),d="important"),n.style.setProperty(Neo.decamel(e),t,d)}))}}))}du_updateVtext(e){let t=this.getElement(e.parentId),n=t.innerHTML,d=`\x3c!-- ${e.id} --\x3e`,r=new RegExp(d+"[\\s\\S]*?\x3c!-- /neo-vtext --\x3e");t.innerHTML=n.replace(r,e.value)}htmlStringToElement(e){const t=document.createElement("template");return t.innerHTML=e,t.content}update(e){let t,n,d=this,{deltas:r}=e,o=0;for(r=Array.isArray(r)?r:[r],t=r.length,Neo.config.logDeltaUpdates&&t>0&&(d.countDeltas+=t,d.countUpdates++,console.log("update "+d.countUpdates,"total deltas ",d.countDeltas,Neo.clone(e,!0))),Neo.config.renderCountDeltas&&t>0&&(d.countDeltasPer250ms+=t),n={focusNode:d.du_focusNode,insertNode:d.du_insertNode,moveNode:d.du_moveNode,removeAll:d.du_removeAll,removeNode:d.du_removeNode,replaceChild:d.du_replaceChild,setTextContent:d.du_setTextContent,updateVtext:d.du_updateVtext,default:d.du_updateNode};o<t;o++)(n[r[o].action]||n.default).call(d,r[o]);Neo.worker.Manager.sendMessage(e.origin||"app",{action:"reply",replyId:e.id,success:!0})}});