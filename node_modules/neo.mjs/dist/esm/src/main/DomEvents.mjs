import e from"../core/Base.mjs";import t from"../core/Observable.mjs";import n from"../util/String.mjs";import a from"./mixin/TouchDomEvents.mjs";const o=[{name:"change",handler:"onChange"},{name:"click",handler:"onClick"},{name:"contextmenu",handler:"onContextMenu"},{name:"dblclick",handler:"onDoubleClick"},{name:"focusin",handler:"onFocusIn"},{name:"focusout",handler:"onFocusOut"},{name:"input",handler:"onChange"},{name:"keydown",handler:"onKeyDown"},{name:"keyup",handler:"onKeyUp"},{name:"mousedown",handler:"onMouseDown"},{name:"mouseenter",handler:"onMouseEnter",options:{capture:!0}},{name:"mouseleave",handler:"onMouseLeave",options:{capture:!0}},{name:"mouseup",handler:"onMouseUp"},{name:"scroll",handler:"onScroll",options:{capture:!0}},{name:"wheel",handler:"onWheel",options:{passive:!1}}],s=[{name:"touchcancel",handler:"onTouchCancel"},{name:"touchend",handler:"onTouchEnd"},{name:"touchenter",handler:"onTouchEnter"},{name:"touchleave",handler:"onTouchLeave"},{name:"touchmove",handler:"onTouchMove",options:{passive:!1}},{name:"touchstart",handler:"onTouchStart"}],l=["neo-c-m-scrollcontainer","neo-c-w-scrollcontainer","neo-calendar-yearcomponent","neo-circle-component","neo-dateselector","neo-gallery","neo-helix"],r={"neo-c-m-scrollcontainer":100,"neo-c-w-scrollcontainer":100,"neo-calendar-yearcomponent":300,"neo-dateselector":300},i=["neo-c-m-scrollcontainer","neo-c-w-scrollcontainer"],d={date:null,target:null},c={},h=[],u=[];export default Neo.setupClass(class extends e{static observable=!0;static config={className:"Neo.main.DomEvents",mixins:[a],singleton:!0,remote:{app:["addDomListener","registerDisabledInputChars","registerPreventDefaultTargets","unregisterDisabledInputChars"]}};lastTouch=null;construct(e){super.construct(e);let t=this;document.addEventListener("DOMContentLoaded",t.onDomContentLoaded.bind(t)),document.addEventListener("selectionchange",t.onSelectionChange.bind(t)),window.addEventListener("orientationchange",t.onOrientationChange.bind(t)),window.addEventListener("hashchange",t.onHashChange.bind(t)),Neo.config.useSharedWorkers&&window.addEventListener("beforeunload",t.onBeforeUnload.bind(t))}addDomListener(e){let t,n,a,o=this,s=0,l=e.events.length,r=null;for(;s<l;s++)t=e.events[s],o[t.handler]||(o[t.handler]=Neo.emptyFn),n=t.vnodeId||e.vnodeId,a="document.body"===n?document.body:Neo.config.useDomIds?document.getElementById(n):document.querySelector(`[data-neo-id='${n}']`),a?a.addEventListener(t.name,o[t.handler].bind(o)):r=n;r&&"development"===Neo.config.environment&&console.warn("DomEvents:addDomListener() => target node not found:",r),Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!r})}addGlobalDomListeners(){let e=this;[...o].concat(Neo.config.hasTouchEvents?s:[]).forEach((t=>{document.body.addEventListener(t.name,e[t.handler].bind(e),t.options)}))}domEventListener(e){let t=this,{target:n}=e,a={action:"domEvent",eventName:e.type,data:{...t.getEventData(e),id:n.id,value:n.value}};if("mousemove"===e.type)Object.assign(a.data,t.getMouseEventData(e));else e.preventDefault();Neo.worker.Manager.sendMessage("app",a)}geAriaAttributes(e){let t,n={},{attributes:a}=e,o=0,s=a?.length||0;for(;o<s;o++)t=a[o],t.name.startsWith("aria-")&&(n[t.name.substring(5)]=t.value);return n}getDistance(e,t,n,a){return Math.sqrt((n-e)**2+(a-t)**2)}getEventData(e){let t=e.composedPath();t.length<1&&(t=e.path);const n={path:t.map((e=>this.getTargetData(e))),target:this.getTargetData(e.target),timeStamp:e.timeStamp,type:e.type,data:{...e.target.dataset}};return e.relatedTarget&&(n.relatedTarget=this.getTargetData(e.relatedTarget)),n}getKeyboardEventData(e){let{altKey:t,code:n,ctrlKey:a,key:o,keyCode:s,metaKey:l,shiftKey:r}=e;return{...this.getEventData(e),altKey:t,code:n,ctrlKey:a,key:o,keyCode:s,metaKey:l,shiftKey:r}}getMouseEventData(e){let{altKey:t,clientX:n,clientY:a,ctrlKey:o,detail:s,metaKey:l,offsetX:r,offsetY:i,pageX:d,pageY:c,screenX:h,screenY:u,shiftKey:g}=e;return{...this.getEventData(e),altKey:t,clientX:n,clientY:a,ctrlKey:o,detail:s,metaKey:l,offsetX:r,offsetY:i,pageX:d,pageY:c,screenX:h,screenY:u,shiftKey:g}}getPathFromElement(e){let t=[];if(e)for(t.push(e);e.parentNode;)t.push(e.parentNode),e=e.parentNode;return t}getSelectionPath(e,t){return t.parentNode&&t.id.split("__").length>1&&(e=this.getSelectionPath(e,t.parentNode)),e.push(this.getTargetData(t)),e}getTargetData(e){let t=e.getBoundingClientRect?.(),n=t&&this.parseDomRect(t)||{};return{aria:this.geAriaAttributes(e),checked:e.checked,childElementCount:e.childElementCount,clientHeight:e.clientHeight,clientLeft:e.clientLeft,clientTop:e.clientTop,clientWidth:e.clientWidth,cls:e.classList?[...e.classList]:[],data:{...e.dataset},draggable:e.draggable,hidden:e.hidden,id:Neo.config.useDomIds?e.id:e.dataset?.neoId,inert:e.inert,isConnected:e.isConnected,isContentEditable:e.isContentEditable,nodeType:e.nodeType,offsetHeight:e.offsetHeight,offsetLeft:e.offsetLeft,offsetTop:e.offsetTop,offsetWidth:e.offsetWidth,rect:n,role:e.role,scrollHeight:e.scrollHeight,scrollLeft:e.scrollLeft,scrollTop:e.scrollTop,scrollWidth:e.scrollWidth,style:e.style?.cssText,tabIndex:e.getAttribute?.("tabindex")?e.tabIndex:null,tagName:e.tagName?.toLowerCase()}}getTouchCoords(e){let{touches:t,changedTouches:n}=e;return t?.[0]||n?.[0]}onBeforeUnload(e){let{Manager:t}=Neo.worker;t.appNames.forEach((e=>{t.broadcast({action:"disconnect",appName:e,windowId:t.windowId})}))}onChange(e){let{target:t}=e,n={...this.getEventData(e),valid:t.checkValidity?.(),value:t.value};t.files&&(n.files=t.files),this.sendMessageToApp(n)}onClick(e){let t=this;t.sendMessageToApp(t.getMouseEventData(e)),t.testPathInclusion(e,h)&&e.preventDefault()}onContextMenu(e){let t=this;t.sendMessageToApp(t.getMouseEventData(e)),(e.ctrlKey||t.testPathInclusion(e,u))&&e.preventDefault()}onDomContentLoaded(){this.addGlobalDomListeners(),this.fire("domContentLoaded")}onDoubleClick(e){let t=this;t.sendMessageToApp(t.getMouseEventData(e)),t.testPathInclusion(e,h)&&e.preventDefault()}onFocusIn(e){this.sendMessageToApp(this.getEventData(e))}onFocusOut(e){this.sendMessageToApp(this.getEventData(e))}onHashChange(){let{Manager:e}=Neo.worker,t=location.hash.substring(1);e.sendMessage("app",{action:"hashChange",data:{appNames:e.appNames,hash:this.parseHash(t),hashString:t,windowId:e.windowId}})}onKeyDown(e){let t=this,{target:n}=e,{tagName:a}=n,o="INPUT"===a||"TEXTAREA"===a;o&&c[n.id]?.includes(e.key)?e.preventDefault():(t.sendMessageToApp(t.getKeyboardEventData(e)),o&&"Tab"===e.key&&t.testPathInclusion(e,["neo-grid-editor","neo-table-editor"],!0)&&e.preventDefault(),!o&&["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(e.key)&&t.testPathInclusion(e,["neo-selection"],!0)&&e.preventDefault())}onKeyUp(e){this.sendMessageToApp(this.getKeyboardEventData(e))}onMouseDown(e){this.sendMessageToApp(this.getMouseEventData(e))}onMouseEnter(e){let t=this,n={...t.getMouseEventData(e),fromElementId:e.fromElement?.id||null,toElementId:e.toElement?.id||null};t.sendMessageToApp(n),t.fire("mouseEnter",n)}onMouseLeave(e){let t=this,n={...t.getMouseEventData(e),fromElementId:e.fromElement?.id||null,toElementId:e.toElement?.id||null};t.sendMessageToApp(n),t.fire("mouseLeave",n)}onMouseUp(e){this.sendMessageToApp(this.getMouseEventData(e))}onOrientationChange(e){let{orientation:t}=screen,{angle:n,type:a}=t,o=0===n||180===n?"portrait":"landscape";Neo.worker.Manager.sendMessage("app",{action:"orientationChange",data:{angle:n,layout:o,type:a}})}onScroll(e){let t,n=this,{firstTouch:a,lastTouch:o}=n,{clientHeight:s,clientWidth:l,scrollLeft:r,scrollTop:i}=e.target;e.preventDefault(),t={...n.getEventData(e),clientHeight:s,clientWidth:l,scrollLeft:r,scrollTop:i},a&&(t.touches={firstTouch:{clientX:a.clientX,clientY:a.clientY},lastTouch:{clientX:o.clientX,clientY:o.clientY}}),n.sendMessageToApp(t)}onSelectionChange(e){let t,n,a=this,{target:o}=e,s=o.type?o:o.activeElement;"BODY"!==o.tagName&&(t=a.getSelectionPath([],s),n=a.getTargetData(s),a.sendMessageToApp({path:t,selection:{direction:s.selectionDirection,end:s.selectionEnd,start:s.selectionStart},target:n,timeStamp:e.timeStamp,type:"selectionchange"}))}onWheel(e){let t,n=this.testPathInclusion(e,l),a=!1;if(n){if(t=n.cls,r[n.cls]){let e=new Date;d.date&&d.target===t&&e-d.date<r[t]?a=!0:Object.assign(d,{date:e,target:t})}if(!a){let{deltaX:t,deltaY:a,deltaZ:o}=e;this.sendMessageToApp({...this.getEventData(e),clientHeight:n.node.clientHeight,clientWidth:n.node.clientWidth,deltaX:t,deltaY:a,deltaZ:o,scrollLeft:n.node.scrollLeft,scrollTop:n.node.scrollTop})}i.includes(t)||e.preventDefault()}}parseDomRect(e){let{bottom:t,height:n,left:a,right:o,top:s,width:l,x:r,y:i}=e;return{bottom:t,height:n,left:a,right:o,top:s,width:l,x:r,y:i}}parseHash(e){if(""===e)return{};let t,n,a,o,s=e.split("&"),l={};for(t=0;t<s.length;t++)a=s[t].split("="),a.length<2&&a.push(""),n=decodeURIComponent(a[0]),o=decodeURIComponent(a[1]),-1!==n.indexOf("[]")?(n=n.substring(0,n.indexOf("[]")),void 0===l[n]&&(l[n]=[]),l[n].push(this.parseValue(o))):l[n]=this.parseValue(o);return l}parseValue(e){return e==parseInt(e)?e=parseInt(e):"false"===e?e=!1:"true"===e&&(e=!0),e}registerDisabledInputChars(e){c[e.id]=e.chars}registerPreventDefaultTargets(e){let t;switch(Array.isArray(e.cls)||(e.cls=[e.cls]),e.name){case"click":t=h;break;case"contextmenu":t=u}e.cls.forEach((e=>{!t.includes(e)&&t.push(e)}))}sendMessageToApp(e){Neo.worker.Manager.sendMessage("app",{action:"domEvent",eventName:e.type,data:e})}stripHtml(e){return(new DOMParser).parseFromString(e,"text/html").body.textContent||""}testPathInclusion(e,t,n=!1){let a,o,s=t.length,l=e.path||e.composedPath(),r=0,i=l.length;for(;r<i;r++)for(o=l[r],a=0;a<s;a++)if(n&&o.classList?.value?.includes(t[a])||o.classList?.contains(t[a]))return{cls:t[a],node:o};return!1}unregisterDisabledInputChars(e){delete c[e.id]}});