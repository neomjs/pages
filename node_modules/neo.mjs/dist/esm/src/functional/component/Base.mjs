import e from"../../component/Abstract.mjs";import t from"../../core/Effect.mjs";import o from"../../util/Array.mjs";import{isHtmlTemplate as n}from"../util/html.mjs";const s=Symbol.for("activeDomListeners"),i=Symbol.for("hookIndex"),d=Symbol.for("hooks"),l=Symbol.for("pendingDomEvents"),r=Symbol("vdomToApply");export default Neo.setupClass(class extends e{static config={className:"Neo.functional.component.Base",enableHtmlTemplates_:!1,ntype:"functional-component",vdom:{}};childComponents=null;htmlTemplateProcessor=Neo.ns("Neo.functional.util.HtmlTemplateProcessor");#e=null;construct(e){super.construct(e);let o=this,n={configurable:!0,enumerable:!1,writable:!0};"development"!==Neo.config.environment&&(o.enableHtmlTemplates=!1),Object.defineProperties(o,{[s]:{...n,value:[]},[i]:{...n,value:0},[d]:{...n,value:[]},[l]:{...n,value:[]},[r]:{...n,value:null}}),o.vdomEffect=new t({fn:()=>{o[i]=0,o[l]=[],o[r]=o.createVdom(o)},componentId:o.id,subscriber:{id:o.id,fn:o.onEffectRunStateChange,scope:o}})}afterSetIsReady(e,t){super.afterSetIsReady(e,t);const o=this;e&&o.missedReadyState&&(o.vdomEffect.run(),delete o.missedReadyState)}afterSetMounted(e,t){super.afterSetMounted(e,t),e&&void 0!==t&&this.applyPendingDomListeners()}afterSetWindowId(e,t){super.afterSetWindowId(e,t),this.childComponents?.forEach(t=>{t.instance.windowId=e})}applyPendingDomListeners(){const e=this,t=e[s],o=e[l];o.length>0&&(Neo.isEqual(t,o)||(t?.length>0&&e.removeDomListeners(e[s]),e.addDomListeners([...o]),e[s]=[...o]),e[l]=[])}beforeUpdate(){}continueUpdateWithVdom(e){const t=this;t.#e=new Map;const n=t.processVdomForComponents(e,t.id);t.childComponents?.size>0&&[...t.childComponents].forEach(([e,o])=>{t.#e.has(e)||(t.childComponents.delete(e),o.instance.destroy())});const s=t.childComponents?new Set(t.childComponents.keys()):new Set;let i=!1;for(const e of t.#e.keys())if(!s.has(e)){i=!0;break}i&&(t.updateDepth=-1),t.childComponents=t.#e;for(const e in t.vdom)delete t.vdom[e];Object.assign(t.vdom,n),t[r]=null;const d=t.getVdomRoot();t.cls&&(d.cls=o.union(t.cls,d.cls)),t.id&&(d.id=t.id),t.syncVdomIds(),!1!==t.beforeUpdate()&&t.updateVdom(),t.mounted&&t.applyPendingDomListeners()}createVdom(e){const t=this;return t.enableHtmlTemplates&&"function"==typeof t.render?t.render(e):{}}destroy(e=!1,t=!1){const o=this;o.vdomEffect?.destroy(),o.childComponents?.forEach(e=>{e.instance.destroy(!1,!0)}),o.childComponents?.clear(),o[l]=null,super.destroy(e,t)}diffAndSet(e,t,o){const n={};for(const s in t){const i=t[s],d=o[s];Neo.isEqual(i,d)||("Object"===Neo.typeOf(i)&&"NeoInstance"===Neo.typeOf(e[s])?this.diffAndSet(e[s],i,d||{}):n[s]=i)}Object.keys(n).length>0&&e.set(n)}async initAsync(){if(await super.initAsync(),this.enableHtmlTemplates&&"development"===Neo.config.environment&&!Neo.ns("Neo.functional.util.HtmlTemplateProcessor")){const e=await import("../util/HtmlTemplateProcessor.mjs");this.htmlTemplateProcessor=e.default}}onEffectRunStateChange(e,t){if(!1===e){const e=this,t=e[r];if(t){if(t[n])return void(e.htmlTemplateProcessor?e.htmlTemplateProcessor.process(t,e):(e.missedReadyState=!0,e.continueUpdateWithVdom({})));e.continueUpdateWithVdom(t)}}}processVdomForComponents(e,t,o){if(!e)return e;if(e.componentId)return e;const n=this;if(e.className||e.module||e.ntype){const s=e.id;s||console.error(['Component definition in functional component VDOM is missing an "id". For stable reconciliation, ','especially in dynamic lists, provide a unique "id" property.'].join(""),e);let i,d=n.childComponents?.get(s),l={...e};return delete l.className,delete l.id,delete l.module,delete l.ntype,d?(i=d.instance,this.diffAndSet(i,l,d.lastConfig)):(n.childComponents??=new Map,i=Neo[e.className||e.module?"create":"ntype"]({...e,parentId:t,parentIndex:o,windowId:n.windowId})),n.#e.set(s,{instance:i,lastConfig:l}),i.createVdomReference()}return e.cn&&Array.isArray(e.cn)&&(e.cn=e.cn.map((e,o)=>n.processVdomForComponents(e,t,o))),e}});