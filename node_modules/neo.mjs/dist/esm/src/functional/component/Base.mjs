import e from"../../component/Abstract.mjs";import t from"../../core/Effect.mjs";import o from"../../util/Array.mjs";import n from"../../util/VDom.mjs";import{isHtmlTemplate as s}from"../util/html.mjs";const i=Symbol.for("activeDomListeners"),d=Symbol.for("hookIndex"),l=Symbol.for("hooks"),r=Symbol.for("pendingDomEvents"),c=Symbol("vdomToApply");export default Neo.setupClass(class extends e{static config={className:"Neo.functional.component.Base",enableHtmlTemplates_:!1,ntype:"functional-component",vdom:{}};childComponents=null;htmlTemplateProcessor=Neo.ns("Neo.functional.util.HtmlTemplateProcessor");#e=null;construct(e){super.construct(e);let o=this,n={configurable:!0,enumerable:!1,writable:!0};"development"!==Neo.config.environment&&(o.enableHtmlTemplates=!1),Object.defineProperties(o,{[i]:{...n,value:[]},[d]:{...n,value:0},[l]:{...n,value:[]},[r]:{...n,value:[]},[c]:{...n,value:null}}),o.vdomEffect=new t({fn:()=>{o[d]=0,o[r]=[],o[c]=o.createVdom(o)},componentId:o.id,subscriber:{id:o.id,fn:o.onEffectRunStateChange,scope:o}})}afterSetIsReady(e,t){super.afterSetIsReady(e,t);const o=this;e&&o.missedReadyState&&(o.vdomEffect.run(),delete o.missedReadyState)}afterSetMounted(e,t){super.afterSetMounted(e,t),e&&void 0!==t&&this.applyPendingDomListeners()}afterSetWindowId(e,t){super.afterSetWindowId(e,t),this.childComponents?.forEach(t=>{t.instance.windowId=e})}applyPendingDomListeners(){const e=this,t=e[i],o=e[r];o.length>0&&(Neo.isEqual(t,o)||(t?.length>0&&e.removeDomListeners(e[i]),e.addDomListeners([...o]),e[i]=[...o]),e[r]=[])}beforeUpdate(){}continueUpdateWithVdom(e){const t=this;for(const e in t.vdom)delete t.vdom[e];Object.assign(t.vdom,e);const n=t.getVdomRoot();t.id&&(n.id=t.id),t.generateIds(n);const s=new Map;if(t.vnode){const e=t=>{t.id&&s.set(t.id,t),t.childNodes?.forEach(e)};e(t.vnode)}t.#e=new Map;const i=t.processVdomForComponents(n,t.id,void 0,s);if(i!==n){for(const e in t.vdom)delete t.vdom[e];Object.assign(t.vdom,i)}t.childComponents?.size>0&&[...t.childComponents].forEach(([e,o])=>{t.#e.has(e)||(t.childComponents.delete(e),o.instance.destroy())});const d=t.childComponents?new Set(t.childComponents.keys()):new Set;let l=!1;for(const e of t.#e.keys())if(!d.has(e)){l=!0;break}l&&(t.updateDepth=-1),t.childComponents=t.#e,t.cls&&(n.cls=o.union(t.cls,n.cls)),t[c]=null,!1!==t.beforeUpdate()&&t.updateVdom(),t.mounted&&t.applyPendingDomListeners()}createVdom(e){const t=this;return t.enableHtmlTemplates&&"function"==typeof t.render?t.render(e):{}}destroy(e=!1,t=!1){const o=this;o.vdomEffect?.destroy(),o.childComponents?.forEach(e=>{e.instance.destroy(!1,!0)}),o.childComponents?.clear(),o[r]=null,super.destroy(e,t)}diffAndSet(e,t,o){const n={};for(const s in t){const i=t[s],d=o[s];Neo.isEqual(i,d)||("Object"===Neo.typeOf(i)&&"NeoInstance"===Neo.typeOf(e[s])?this.diffAndSet(e[s],i,d||{}):n[s]=i)}Object.keys(n).length>0&&e.set(n)}async initAsync(){if(await super.initAsync(),this.enableHtmlTemplates&&"development"===Neo.config.environment&&!Neo.ns("Neo.functional.util.HtmlTemplateProcessor")){const e=await import("../util/HtmlTemplateProcessor.mjs");this.htmlTemplateProcessor=e.default}}generateIds(e,t=this.id,o=new Map){if(e){if(e.id)t=e.id;else{let n=o.get(t)||0;e.id=t+"__"+n,o.set(t,n+1)}e.cn?.forEach(e=>this.generateIds(e,t,o))}}onEffectRunStateChange(e,t){if(!1===e){const e=this,t=e[c];if(t){if(t[s])return void(e.htmlTemplateProcessor?e.htmlTemplateProcessor.process(t,e):(e.missedReadyState=!0,e.continueUpdateWithVdom({})));e.continueUpdateWithVdom(t)}}}processVdomForComponents(e,t,o,n){if(!e)return e;if(e.componentId)return e;const s=this;if(e.className||e.module||e.ntype){const n=e.id;n||console.error(['Component definition in functional component VDOM is missing an "id". For stable reconciliation, ','especially in dynamic lists, provide a unique "id" property.'].join(""),e);let i,d=s.childComponents?.get(n),l={...e};return delete l.className,delete l.id,delete l.module,delete l.ntype,d?(i=d.instance,this.diffAndSet(i,l,d.lastConfig)):(s.childComponents??=new Map,i=Neo[e.className||e.module?"create":"ntype"]({...e,parentId:t,parentIndex:o,windowId:s.windowId})),s.#e.set(n,{instance:i,lastConfig:l}),i.createVdomReference()}if(e.cn&&Array.isArray(e.cn)&&(e.cn=e.cn.map((e,o)=>s.processVdomForComponents(e,t,o,n))),e.id&&n){const t=n.get(e.id);t&&(Neo.isNumber(t.scrollTop)&&(e.scrollTop=t.scrollTop),Neo.isNumber(t.scrollLeft)&&(e.scrollLeft=t.scrollLeft))}return e}});