import e from"../container/Base.mjs";import t from"../form/field/Base.mjs";import a from"../manager/Component.mjs";import s from"../util/Array.mjs";class i extends e{static config={className:"Neo.form.Container",ntype:"form-container",baseCls:["neo-form-container"],vdom:{tag:"form",cn:[],onsubmit:"return false;"}};static adjustTreeLeaves(e={},t,a,s=""){let i,o,r;Object.entries(e).forEach(([n,l])=>{i=!0,o=""===s?n:`${s}.${n}`,r=Neo.typeOf(l),"Array"!==r&&"Object"!==r||(i=a.includes(o),"Array"===r?l.forEach((e,s)=>{"Object"===Neo.typeOf(e)&&this.adjustTreeLeaves(e,t,a,`${o}[${s}]`)}):"Object"===r&&this.adjustTreeLeaves(l,t,a,o)),i&&(e[n]=n===t?l:{[t]:l})})}findNotLoadedModules(e=this,t=[]){return e.items.forEach(a=>{"Function"!==Neo.typeOf(a.module)||a.isLoading?a.items&&this.findNotLoadedModules(a,t):t.push({item:a,parent:e})}),t}async getField(e){await this.loadModules();let s,i=a.getChildComponents(this);for(s of i)if(s instanceof t&&(s.name===e||s.id===e))return s;return null}getFieldPath(e){let t=e.formGroup?e.formGroup.split("."):[];return t.push(e.name||e.id),t.join(".")}async getFields(){let e=[];return await this.loadModules(),a.getChildComponents(this).forEach(a=>{a instanceof t&&e.push(a)}),e}async getFormState(){let e,t,a,s=await this.getFields(),i=0,o=!1,r=!1,n=!1,l=!1,d=!1,u=s.length;for(;i<u;i++){if(e=s[i],t=e.clean,a=e.isValid(),t||a)a?d=!0:a||(e.isEmptyAndRequired?.()?r=!0:n=!0);else{if(!e.isEmptyAndRequired?.())return"invalid";r=!0}t?o=!0:l=!0}return r||n?r||!o||l?"inProgress":"clean":"valid"}async getSubmitValues(){let e,t,a,s,i,o=await this.getFields(),r=Neo.form.field.Radio,n={};return o.forEach(o=>{i=o.getSubmitValue(),o.name?(e=o.name,o.formGroup&&(e=o.formGroup+"."+e),s=e.split("."),t=s.pop(),a=Neo.nsWithArrays(s,!0,n)):(t=o.id,a=n),r&&o instanceof r?Object.hasOwn(a,t)?i!==o.uncheckedValue&&(a[t]=i):a[t]=i:Object.hasOwn(a,t)&&void 0!==i?(a[t]===o.uncheckedValue?a[t]=[]:Array.isArray(a[t])||(a[t]=[a[t]]),i!==o.uncheckedValue&&a[t].unshift(i)):void 0!==i&&(a[t]=i)}),n}async getValues(){return this.getSubmitValues()}async isValid(){let e=await this.getFields(),t=0,a=e.length;for(;t<a;t++)if(!e[t].isValid())return!1;return!0}async loadModules(){let e=this.findNotLoadedModules(),t=[];return e.forEach(e=>{t.push(e.parent.layout.loadModule(e.item))}),e=await Promise.all(t),e}async reset(e={}){let t,a,s=this;(await s.getFields()).forEach(i=>{t=s.getFieldPath(i),a=Neo.nsWithArrays(t,!1,e),i.reset(t?a:null)})}async setConfigs(e={},t=!1){let a,s,i,o,r,n=this;(await n.getFields()).forEach(l=>{o=n.getFieldPath(l),a=Neo.nsWithArrays(o,!1,e),a&&(t&&(l.suspendEvents=!0),s=Neo.form.field?.CheckBox&&l instanceof Neo.form.field.CheckBox,i=Neo.form.field?.Radio&&l instanceof Neo.form.field.Radio,r=a.value,(s||i)&&Object.hasOwn(a,"value")&&(a=Neo.clone(a,!0),i?a.checked=l.value===r:s&&("Array"===Neo.typeOf(r)?r.includes(l.value)&&(a.checked=!0):a.checked=l.value===r),delete a.value),l.set(a),t&&delete l.suspendEvents)})}async setValues(e={},t=!1){let a,o=await this.getFields(),r=[];o.map(e=>{a=e.getPath(),a&&s.add(r,a)}),e=Neo.clone(e,!0),i.adjustTreeLeaves(e,"value",r),await this.setConfigs(e,t)}async validate(){let e,t=!0;return(await this.getFields()).forEach(a=>{e=a.validate?.(!1),!1===e&&(t=!1)}),t}}export default Neo.setupClass(i);