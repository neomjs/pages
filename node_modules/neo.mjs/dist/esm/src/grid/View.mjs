import e from"../util/ClassSystem.mjs";import t from"../collection/Base.mjs";import o from"../component/Base.mjs";import l from"../util/Array.mjs";import i from"../selection/grid/RowModel.mjs";import r from"../util/VDom.mjs";export default Neo.setupClass(class extends o{static config={className:"Neo.grid.View",ntype:"grid-view",animatedRowSorting_:!1,availableHeight_:0,availableRows_:0,availableWidth_:0,baseCls:["neo-grid-view"],bufferColumnRange_:0,bufferRowRange_:3,colspanField:"colspan",containerWidth_:0,columnPositions_:null,highlightModifiedCells_:!1,isScrolling_:!1,keys:{},mountedColumns_:[0,0],mountedRows:[0,0],pluginAnimateRowsConfig:null,role:"rowgroup",rowHeight_:0,scrollLeft_:0,scrollTop_:0,selectionModel_:null,selectedRecordField:"annotations.selected",startIndex_:0,store_:null,visibleColumns:[0,0],visibleRows:[0,0],wrapperCls:["neo-grid-view-wrapper"],_vdom:{tabIndex:"-1",cn:[{cn:[]}]}};get selectedCells(){let{selectionModel:e}=this;return e.ntype?.includes("cell")?e.items:[]}get selectedRows(){let{selectionModel:e}=this;return e.ntype?.includes("row")?e.selectedRows:[]}construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onCellClick,dblclick:t.onCellDoubleClick,delegate:".neo-grid-cell",scope:t},{click:t.onRowClick,dblclick:t.onRowDoubleClick,delegate:".neo-grid-row",scope:t}])}afterSetAnimatedRowSorting(e,t){e&&!this.getPlugin("grid-animate-rows")&&import("./plugin/AnimateRows.mjs").then((e=>{let t=this,o=t.plugins||[];o.push({module:e.default,...t.pluginAnimateRowsConfig}),t.plugins=o}))}afterSetAvailableHeight(e,t){e>0&&(this.availableRows=Math.ceil(e/this.rowHeight)-1)}afterSetAvailableRows(e,t){e>0&&this.createViewData()}afterSetAvailableWidth(e,t){if(e>0){let t=this;t.vdom.width=e+"px",t.vdom.cn[0].width=e+"px",t.update()}}afterSetBufferColumnRange(e,t){void 0!==t&&this.createViewData()}afterSetBufferRowRange(e,t){void 0!==t&&this.createViewData()}afterSetContainerWidth(e,t){e>0&&this.updateMountedAndVisibleColumns()}afterSetId(e,t){this.vdom.id=e+"__wrapper",super.afterSetId(e,t)}afterSetIsScrolling(e,t){this.toggleCls("neo-is-scrolling",e)}afterSetMountedColumns(e,t){t&&this.createViewData()}afterSetRowHeight(e,t){e>0&&this.updateScrollHeight()}afterSetScrollLeft(e,t){this.updateMountedAndVisibleColumns()}afterSetScrollTop(e,t){let o=this,{bufferRowRange:l}=o,i=Math.floor(e/o.rowHeight);Math.abs(o.startIndex-i)>=l?o.startIndex=i:(o.visibleRows[0]=i,o.visibleRows[1]=i+o.availableRows)}afterSetSelectionModel(e,t){this.rendered&&e.register(this)}afterSetStartIndex(e,t){void 0!==t&&this.createViewData()}afterSetStore(e,t){let o=this,l={filter:o.onStoreFilter,load:o.onStoreLoad,recordChange:o.onStoreRecordChange,scope:o};t?.un(l),e?.on(l)}applyRendererOutput(e){let t,o,{cellId:i,column:r,columnIndex:n,record:s,rowIndex:d}=e,a=this,c=a.parent,{selectedCells:u,store:m}=a,h=["neo-grid-cell"],g=s[a.colspanField],{dataField:w}=r,{model:p}=m,f=s[w];if(!p.getField(w)){let e=w.split("."),t=e.pop();f=Neo.ns(e,!1,s[Symbol.for("data")])?.[t]}switch(null==f&&(f=""),"me"!==r.rendererScope&&"this"!==r.rendererScope||(r.rendererScope=r),a.bindCallback(r.renderer,"renderer",r.rendererScope||a,r),o=r.renderer.call(r.rendererScope||a,{column:r,columnIndex:n,dataField:w,gridContainer:c,record:s,rowIndex:d,store:m,value:f}),Neo.typeOf(o)){case"Object":o.html?o.cls&&h.push(...o.cls):o=[o];break;case"Date":case"Number":case"String":o={cls:h,html:o?.toString()}}return null==o&&(o=""),"left"!==r.cellAlign&&h.push("neo-"+r.cellAlign),a.highlightModifiedCells&&s.isModifiedField(w)&&h.push("neo-is-modified"),i||(i=a.getCellId(d,r.dataField)),u.includes(i)&&h.push("neo-selected"),a.selectionModel?.selectedColumns?.includes(w)&&l.add(h,a.selectionModel.selectedColumnCellCls||"neo-selected"),t={"aria-colindex":n+1,id:i,cls:h,role:"gridcell",style:o.style||{}},r.width&&(t.style.minWidth=`${r.width}px`),g&&Object.keys(g).includes(w)&&(t.colspan=g[w]),"Object"===Neo.typeOf(o)?t.innerHTML=o.html||"":t.cn=o,t}beforeGetColumnPositions(e){return e||(this._columnPositions=e=Neo.create({module:t,keyProperty:"dataField"})),e}beforeSetSelectionModel(t,o){return o?.destroy(),e.beforeSetInstance(t,i)}createRow({record:e,rowIndex:t}){Neo.isNumber(t)||(t=this.store.indexOf(e));let o,i,r,n,s,d=this,{mountedColumns:a,selectedRows:c}=d,u=d.parent,{columns:m}=u,h=d.getRowId(t),g=e[d.store.getKeyProperty()],w=d.getRowClass(e,t);for(t%2!=0&&w.push("neo-even"),c&&e[d.selectedRecordField]&&l.add(c,g),n={id:h,"aria-rowindex":t+2,cls:w,cn:[],data:{recordId:g},role:"row",style:{height:d.rowHeight+"px",transform:`translate(0px, ${t*d.rowHeight}px)`}},c?.includes(g)&&(w.push("neo-selected"),n["aria-selected"]=!0,u.fire("select",{record:e})),s=a[0];s<=a[1];s++)i=m.getAt(s),o=d.applyRendererOutput({column:i,columnIndex:s,record:e,rowIndex:t}),i.dock&&(o.cls=["neo-locked",...o.cls||[]]),r=d.columnPositions.get(i.dataField),o.style={...o.style,left:r.x+"px",width:r.width+"px"},r.hidden&&(o.style.visibility="hidden"),n.cn.push(o);return n}createViewData(e=!1){let t,o=this,{mountedRows:l,store:i}=o,r=[];if(!(i.isLoading||o.availableRows<1||o._containerWidth<1||o.columnPositions.getCount()<1||o.mountedColumns[1]<1)){for(o.updateMountedAndVisibleRows(),t=l[0];t<l[1];t++)r.push(o.createRow({record:i.items[t],rowIndex:t}));o.getVdomRoot().cn=r,o.parent.isLoading=!1,o.updateScrollHeight(!0),!e&&o.update()}}destroy(...e){this.store=null,super.destroy(...e)}fireCellEvent(e,t){let o=this,l=e.currentTarget,i=o.getCellDataField(l),r=o.getRecord(l);o.parent.fire(t,{data:e,dataField:i,record:r,view:o})}fireRowEvent(e,t){let o=this,l=e.currentTarget,i=o.getRecord(l);o.parent.fire(t,{data:e,record:i,view:o})}getCellDataField(e){return e.split("__")[2]}getCellId(e,t){return this.getRowId(e)+"__"+t}getColumn(e,t=!1){let{columns:o}=this.parent,l=o.get(e);return l?t?o.indexOf(l):l:null}getColumnCells(e){let t,o=this,l=[],i=-1,r=o.getVdomRoot(),n=r.cn[0],s=0,d=n.cn.length;for(;s<d;s++)if(e===o.getDataField(n.cn[s].id)){i=s;break}return i>-1&&r.cn.forEach((e=>{t=e.cn[i],t&&l.push(t)})),l}getDataField(e){return e.split("__")[2]}getRecord(e){let t,o,l=this,i=l.getRecordByRowId(e);if(i)return i;for(t of(o=r.getParentNodes(l.vdom,e),o||[]))if(i=l.getRecordByRowId(t.id),i)return i;return null}getRecordByRowId(e){let t=this,o=t.getVdomChild(e)["aria-rowindex"];return Neo.isNumber(o)?(o-=2,t.store.getAt(o)):null}getRowClass(e,t){return["neo-grid-row"]}getRowId(e){let t=this;return`${t.id}__row-${e%(t.availableRows+2*t.bufferRowRange)}`}getVdomRoot(){return this.vdom.cn[0]}getVdomItemsRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}onCellClick(e){this.fireCellEvent(e,"cellClick")}onCellDoubleClick(e){this.fireCellEvent(e,"cellDoubleClick")}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onRowClick(e){this.fireRowEvent(e,"rowClick")}onRowDoubleClick(e){this.fireRowEvent(e,"rowDoubleClick")}onStoreFilter(){this.onStoreLoad()}onStoreLoad(e){let t=this;t.createViewData(),t.mounted&&t.timeout(50).then((()=>{Neo.main.DomAccess.scrollTo({direction:"top",id:t.vdom.id,value:0})}))}onStoreRecordChange({fields:e,record:t}){let o,l,i,r=this,n=e.map((e=>e.name)),s=!1,d=r.store.indexOf(t),{selectionModel:a}=r;if(n.includes(r.colspanField))r.vdom.cn[d]=r.createRow({record:t,rowIndex:d}),r.update();else{for(o of r.parent.columns.items)o instanceof Neo.grid.column.Component&&Neo.typeOf("Function"===o.component)&&!n.includes(o.dataField)&&(l=r.updateCellNode(t,o.dataField),s=s||l);e.forEach((e=>{e.name===r.selectedRecordField?"selection-grid-rowmodel"===a.ntype&&(i=t[r.store.getKeyProperty()],a[e.value?"selectRow":"deselectRow"](i)):(l=r.updateCellNode(t,e.name),s=s||l)}))}s&&r.update()}scrollByRows(e,t){let o,l,i,r,n=this,{mountedRows:s,visibleRows:d}=n,a=n.store.getCount(),c=e+t;for(c>=a&&(c%=a,t=c-e);c<0;)c+=a,t+=a;l=c>=s[0]&&c<=s[1],r=c>d[0]&&c<d[1],r||(l&&(d[0]+=t,d[1]+=t),t<0?i=c*n.rowHeight:(o=n.rowHeight-n.availableHeight%n.rowHeight,i=(c-n.availableRows)*n.rowHeight+o),Neo.main.DomAccess.scrollTo({id:n.vdom.id,value:i,windowId:n.windowId}))}updateCellNode(e,t){let o,l,i,n,s=this,d=s.store.indexOf(e),a=s.getCellId(d,t),c=r.find(s.vdom,a),u=!1;return c?.vdom&&(o=c.vdom.style,i=s.getColumn(t),n=c.index,l=s.applyRendererOutput({cellId:a,column:i,columnIndex:n,record:e,rowIndex:d}),u=!0,Object.assign(l.style,{left:o.left,width:o.width}),c.parentNode.cn[n]=l),u}updateMountedAndVisibleColumns(){let e,t,o=this,{bufferColumnRange:l,columnPositions:i,mountedColumns:r,visibleColumns:n}=o,s=0,d=i.getCount(),a=d-1,c=o.scrollLeft;if(!(d<1)){for(;s<d;s++)if(e=i.getAt(s),c>=e.x&&c<=e.x+e.width&&(t=s),o.containerWidth+c<e.x){a=s-1;break}n[0]=t,n[1]=a,(n[0]<=r[0]||n[1]>=r[1])&&(t=Math.max(0,n[0]-l),a=Math.min(d-1,n[1]+l),o.mountedColumns=[t,a])}}updateMountedAndVisibleRows(){let e=this,{bufferRowRange:t,startIndex:o,store:l}=e,i=l.getCount(),r=Math.min(i,o+e.availableRows);e.visibleRows[0]=o,e.visibleRows[1]=r,o=Math.max(0,o-t),r=Math.min(i,r+t),e.mountedRows[0]=o,e.mountedRows[1]=r}updateScrollHeight(e=!1){let t=this,o=t.store.getCount(),{rowHeight:l}=t;o>0&&l>0&&(t.vdom.cn[0].height=(o+1)*l+"px",!e&&t.update())}});