import e from"../util/ClassSystem.mjs";import t from"../component/Base.mjs";import o from"../collection/Base.mjs";import i from"./Row.mjs";import l from"../selection/grid/RowModel.mjs";import r from"../util/VDom.mjs";export default Neo.setupClass(class extends t{static config={className:"Neo.grid.Body",ntype:"grid-body",animatedRowSorting_:!1,availableHeight_:0,availableRows_:0,availableWidth_:0,baseCls:["neo-grid-body"],bufferColumnRange_:0,bufferRowRange_:3,cellPoolSize_:20,colspanField:"colspan",containerWidth_:0,columnPositions_:null,highlightModifiedCells_:!1,isScrolling_:!1,keys:{},mountedColumns_:[0,0],mountedRows:[0,0],pluginAnimateRowsConfig:null,role:"rowgroup",rowHeight_:0,scrollLeft_:0,scrollTop_:0,selectionModel_:null,selectedRecordField:"annotations.selected",startIndex_:0,store_:null,visibleColumns:[0,0],visibleRows:[0,0],wrapperCls:["neo-grid-body-wrapper"],useRowRecordIds:!0,useInternalId:!0,_vdom:{tabIndex:"-1",cn:[{cn:[]}]}};#e=0;#t=0;#o=null;items=[];get selectedCells(){let{selectionModel:e}=this;return e.ntype?.includes("cell")?e.items:[]}get selectedRows(){let{selectionModel:e}=this;return e.ntype?.includes("row")?e.selectedRows:[]}construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onCellClick,dblclick:t.onCellDoubleClick,delegate:".neo-grid-cell",scope:t},{click:t.onRowClick,dblclick:t.onRowDoubleClick,delegate:".neo-grid-row",scope:t}])}afterSetAnimatedRowSorting(e,t){e&&!this.getPlugin("grid-animate-rows")&&import("./plugin/AnimateRows.mjs").then(e=>{let t=this,o=t.plugins||[];o.push({module:e.default,...t.pluginAnimateRowsConfig}),t.plugins=o})}afterSetAppName(e,t){let o=this;if(super.afterSetAppName(e,t),e)for(let t=0,i=o.items.length;t<i;t++)o.items[t].appName=e}afterSetAvailableHeight(e,t){e>0&&(this.availableRows=Math.ceil(e/this.rowHeight)-1)}afterSetAvailableRows(e,t){e>0&&this.createViewData()}afterSetAvailableWidth(e,t){if(e>0){let t=this;t.vdom.width=e+"px",t.vdom.cn[0].width=e+"px",t.update()}}afterSetBufferColumnRange(e,t){void 0!==t&&(this.skipCreateViewData=!0,this.updateMountedAndVisibleColumns(!0),this.skipCreateViewData=!1,this.createViewData())}afterSetBufferRowRange(e,t){if(void 0!==t){let t=Math.floor(this.scrollTop/this.rowHeight);Math.abs(this.startIndex-t)>=e&&(this.skipCreateViewData=!0,this.startIndex=t,this.skipCreateViewData=!1),this.createViewData(!1,!0)}}afterSetContainerWidth(e,t){e>0&&this.updateMountedAndVisibleColumns()}afterSetIsScrolling(e,t){this.toggleCls("neo-is-scrolling",e),this.fire("isScrollingChange",{value:e})}afterSetMounted(e,t){if(super.afterSetMounted(e,t),void 0!==t){let t,o=0,i=this.items.length;for(;o<i;o++)t=this.items[o],t.vdom.removeDom||(t.mounted=e)}}afterSetMountedColumns(e,t){t&&this.createViewData()}afterSetRowHeight(e,t){e>0&&this.updateScrollHeight()}afterSetScrollLeft(e,t){this.updateMountedAndVisibleColumns()}afterSetScrollTop(e,t){let o=this,{bufferRowRange:i}=o,l=Math.floor(e/o.rowHeight);Math.abs(o.startIndex-l)>=i?o.startIndex=l:(o.visibleRows[0]=l,o.visibleRows[1]=l+o.availableRows)}afterSetSelectionModel(e,t){this.vnodeInitialized&&e.register(this)}afterSetStartIndex(e,t){void 0!==t&&this.createViewData()}afterSetStore(e,t){let o=this,i={filter:o.onStoreFilter,load:o.onStoreLoad,recordChange:o.onStoreRecordChange,scope:o};t?.un(i),e?.on(i)}afterSetTheme(e,t){let o=this;if(super.afterSetTheme(e,t),e)for(let t=0,i=o.items.length;t<i;t++)o.items[t].theme=e}afterSetWindowId(e,t){let o=this;if(super.afterSetWindowId(e,t),e)for(let t=0,i=o.items.length;t<i;t++)o.items[t].windowId=e}beforeGetColumnPositions(e){return e||(this._columnPositions=e=Neo.create({module:o,keyProperty:"dataField"})),e}beforeSetSelectionModel(t,o){return o?.destroy(),e.beforeSetInstance(t,l)}createRowPool(){let e,t,o=this,l=o.availableRows+2*o.bufferRowRange,r=o.items.length,n=l-r,s=[];if(n>0){for(t=0;t<n;t++)e={module:i,appName:o.appName,gridContainer:o.parent,id:o.getRowId(r+t),parentId:o.id,record:null,rowIndex:-1,theme:o.theme,windowId:o.windowId},s.push(Neo.create(e));o.items.push(...s)}else if(n<0)for(t=r-1;t>=l;t--)o.items[t].destroy(),o.items.pop();o.getVdomRoot().cn=o.items.map(e=>e.createVdomReference())}createViewData(e=!1,t=!1){let o=this;if(o.skipCreateViewData)return;let i,l,r,n,s,a,{mountedRows:d,store:u}=o,c=!0;if(u.isLoading||o.availableRows<1||o._containerWidth<1||o.columnPositions.getCount()<1||o.mountedColumns[1]<1)return;if(o.isVdomUpdating)return void Neo.manager.VDomUpdate.registerPreUpdate(o.id,()=>{o.createViewData(e,t)});t||Neo.isEqual(o.mountedColumns,o.#o)?t&&(c=!1):t=!0,o.#o=[...o.mountedColumns],o.#e>0?(i=o.#e,a=i):(o.updateMountedAndVisibleRows(),i=d[1]),o.createRowPool(),s=o.items.length;let m=new Array(s).fill(!1);for(l=d[0];l<i;l++)n=l%s,r=o.items[n],m[n]=!0,r.updateContent({force:t,record:u.getAt(l),recycle:c,rowIndex:l,silent:!0});for(l=0;l<s;l++)m[l]||(r=o.items[l],r.record&&r.updateContent({record:null,rowIndex:-1,silent:!0}));o.parent.isLoading=!1,o.updateScrollHeight(!0,a),e||(o.updateDepth=-1,o.update())}destroy(...e){let t=this;for(let e=0,o=t.items.length;e<o;e++)t.items[e].destroy();t.store=null,super.destroy(...e)}fireCellEvent(e,t){let o,i,l,r,n=this,s=e.currentTarget;for(r of e.path)if(r.data?.field){o=r.data.field,l=r.data.recordId,i=n.getRecord(l);break}o||(o=n.getCellDataField(s),i=n.getRecord(s)),n.parent.fire(t,{body:n,data:e,dataField:o,record:i})}fireRowEvent(e,t){let o,i,l,r=this,n=e.currentTarget;for(l of e.path)if(l.cls?.includes("neo-grid-row")&&l.data?.recordId){i=l.data.recordId,o=r.getRecord(i);break}o||(o=r.getRecord(n)),r.parent.fire(t,{body:r,data:e,record:o})}getCellDataField(e){return this.getDataField(e)}getCellId(e,t){let o=this,i=o.getColumn(t),l=o.getColumn(t,!0),r=o.getRowId(e);return"removeDom"===i.hideMode?`${r}__cell-${l%o.cellPoolSize}`:`${r}__${t}`}getLogicalCellId(e,t){return`${this.getRecordId(e)}__${t}`}getColumn(e,t=!1){let{columns:o}=this.parent,i=o.get(e);return i?t?o.indexOf(i):i:null}getColumnCells(e){let t,o=this,i=[],l=-1,r=o.items[0].vdom,n=0,s=r.cn.length;for(;n<s;n++)if(e===o.getDataField(r.cn[n].id)){l=n;break}if(l>-1)for(n=0,s=o.items.length;n<s;n++)t=o.items[n].vdom.cn[l],t&&i.push(t);return i}getDataField(e){if(e.includes("__cell-")){let t,o=this,i=parseInt(e.split("__cell-")[1]),l=o.parent.columns,{cellPoolSize:r,mountedColumns:n}=o,s=n[0],a=n[1];for(;s<=a;s++)if(s%r===i&&(t=l.getAt(s),t&&"removeDom"===t.hideMode))return t.dataField}return e.split("__").pop()}getRecord(e){let t,o,i=this,l=i.getRecordByRowId(e);if(l)return l;if(l=i.store.get(e),l)return l;for(t of(o=r.getParentNodes(i.vdom,e),o||[]))if(l=i.getRecordByRowId(t.componentId||t.id),l)return l;return null}getRecordId(e){return this.useInternalId?this.store.getInternalId(e):this.store.getKey(e)}getRecordFromLogicalId(e){let t=this,o=t.getDataField(e),i=e.substring(0,e.length-o.length-2),l=t.getRecord(i);return l||(l=t.store.get(parseInt(i))),l}getRecordByRowId(e){let t=this,o=Neo.getComponent(e)?.vdom,i=o?.["aria-rowindex"];return Neo.isNumber(i)?(i-=2,t.store.getAt(i)):null}getRow(e){let t,o=this,i=o.store.indexOf(e);return i>-1&&i>=o.mountedRows[0]&&i<=o.mountedRows[1]?(t=i%o.items.length,o.items[t]):null}getRowClass(e,t){return["neo-grid-row"]}getRowId(e){let t=this;return t.#e>0?`${t.id}__row-${e}`:`${t.id}__row-${e%(t.availableRows+2*t.bufferRowRange)}`}getVdomRoot(){return this.vdom.cn[0]}getVdomItemsRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}onCellClick(e){this.fireCellEvent(e,"cellClick")}onCellDoubleClick(e){this.fireCellEvent(e,"cellDoubleClick")}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onRowClick(e){this.focus(this.vdom.id,!1,!0),this.fireRowEvent(e,"rowClick")}onRowDoubleClick(e){this.fireRowEvent(e,"rowDoubleClick")}onScrollCapture(e){super.onScrollCapture(e),this.parent.scrollManager.onBodyScroll(e)}onStoreFilter(){this.onStoreLoad({items:this.store.items})}onStoreLoad({items:e,postChunkLoad:t,total:o}){let i=this,{windowId:l}=i;o&&e.length<o?(i.#e=e.length,i.#t=o,i.createViewData(),i.#e=0,i.#t=0):i.createViewData(),i.mounted&&!t&&i.timeout(50).then(()=>{Neo.main.DomAccess.scrollTo({direction:"top",id:i.vdom.id,value:0,windowId:l})})}onStoreRecordChange({fields:e,record:t}){let o,i,l,r=this,n=e.map(e=>e.name),s=r.store.indexOf(t),{mountedRows:a,selectionModel:d}=r,u=r.items.length;if(n.includes(r.colspanField))r.createViewData();else if(s>=a[0]&&s<=a[1]){o=s%u,l=r.items[o],l&&l.createVdom();for(let o=0,l=e.length;o<l;o++){let l=e[o];l.name===r.selectedRecordField&&"selection-grid-rowmodel"===d.ntype&&(i=r.getRecordId(t),d[l.value?"selectRow":"deselectRow"](i))}}}scrollByRows(e,t){let o,i,l,r,n=this,{mountedRows:s,visibleRows:a}=n,d=n.store.getCount(),u=e+t;for(u>=d&&(u%=d,t=u-e);u<0;)u+=d,t+=d;i=u>=s[0]&&u<=s[1],r=u>a[0]&&u<a[1],r||(i&&(a[0]+=t,a[1]+=t),t<0?l=u*n.rowHeight:(o=n.rowHeight-n.availableHeight%n.rowHeight,l=(u-n.availableRows)*n.rowHeight+o),Neo.main.DomAccess.scrollTo({id:n.vdom.id,value:l,windowId:n.windowId}))}updateMountedAndVisibleColumns(e=!1){let t,o,i=this,{bufferColumnRange:l,cellPoolSize:r,columnPositions:n,mountedColumns:s,visibleColumns:a}=i,d=0,u=n.getCount(),c=u-1,m=i.scrollLeft,h=0;if(!(u<1)){for(;d<u;d++)if(t=n.getAt(d),m>=t.x&&m<=t.x+t.width&&(h=d),i.containerWidth+m<t.x){c=d-1;break}a[0]=h,a[1]=c,(e||a[0]<=s[0]||a[1]>=s[1])&&(h=Math.max(0,a[0]-l),c=Math.min(u-1,a[1]+l),c-h>=r&&(o=c-h+5),i.set({cellPoolSize:o||r,mountedColumns:[h,c]}))}}updateMountedAndVisibleRows(){let e=this,{bufferRowRange:t,availableRows:o,startIndex:i,store:l}=e,r=l.getCount(),n=o+2*t,s=Math.min(r,i+o),a=i-t,d=s+t;if(e.visibleRows[0]=i,e.visibleRows[1]=s,a<0&&(d+=Math.abs(a),a=0),d=Math.min(r,d),d-a<n){let e=n-(d-a);a=Math.max(0,a-e)}e.mountedRows[0]=a,e.mountedRows[1]=d}updateScrollHeight(e=!1){let t=this,o=t.#t||t.store?.count||0,{rowHeight:i}=t;o>0&&i>0&&(t.vdom.cn[0].height=(o+1)*i+"px",!e&&t.update())}toJSON(){let e=this;return{...super.toJSON(),animatedRowSorting:e.animatedRowSorting,bufferColumnRange:e.bufferColumnRange,bufferRowRange:e.bufferRowRange,colspanField:e.colspanField,highlightModifiedCells:e.highlightModifiedCells,rowHeight:e.rowHeight,selectedRecordField:e.selectedRecordField,selectionModel:e.selectionModel?.toJSON()}}});