import e from"../util/ClassSystem.mjs";import t from"../collection/Base.mjs";import o from"../component/Base.mjs";import l from"../util/Array.mjs";import i from"../selection/grid/RowModel.mjs";import n from"../util/VDom.mjs";export default Neo.setupClass(class extends o{static config={className:"Neo.grid.Body",ntype:"grid-body",animatedRowSorting_:!1,availableHeight_:0,availableRows_:0,availableWidth_:0,baseCls:["neo-grid-body"],bufferColumnRange_:0,bufferRowRange_:3,colspanField:"colspan",containerWidth_:0,columnPositions_:null,highlightModifiedCells_:!1,isScrolling_:!1,keys:{},mountedColumns_:[0,0],mountedRows:[0,0],pluginAnimateRowsConfig:null,role:"rowgroup",rowHeight_:0,scrollLeft_:0,scrollTop_:0,selectionModel_:null,selectedRecordField:"annotations.selected",startIndex_:0,store_:null,visibleColumns:[0,0],visibleRows:[0,0],wrapperCls:["neo-grid-body-wrapper"],_vdom:{tabIndex:"-1",cn:[{cn:[]}]}};#e=0;#t=0;get selectedCells(){let{selectionModel:e}=this;return e.ntype?.includes("cell")?e.items:[]}get selectedRows(){let{selectionModel:e}=this;return e.ntype?.includes("row")?e.selectedRows:[]}construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onCellClick,dblclick:t.onCellDoubleClick,delegate:".neo-grid-cell",scope:t},{click:t.onRowClick,dblclick:t.onRowDoubleClick,delegate:".neo-grid-row",scope:t}])}afterSetAnimatedRowSorting(e,t){e&&!this.getPlugin("grid-animate-rows")&&import("./plugin/AnimateRows.mjs").then(e=>{let t=this,o=t.plugins||[];o.push({module:e.default,...t.pluginAnimateRowsConfig}),t.plugins=o})}afterSetAvailableHeight(e,t){e>0&&(this.availableRows=Math.ceil(e/this.rowHeight)-1)}afterSetAvailableRows(e,t){e>0&&this.createViewData()}afterSetAvailableWidth(e,t){if(e>0){let t=this;t.vdom.width=e+"px",t.vdom.cn[0].width=e+"px",t.update()}}afterSetBufferColumnRange(e,t){void 0!==t&&this.createViewData()}afterSetBufferRowRange(e,t){void 0!==t&&this.createViewData()}afterSetContainerWidth(e,t){e>0&&this.updateMountedAndVisibleColumns()}afterSetId(e,t){this.vdom.id=e+"__wrapper",super.afterSetId(e,t)}afterSetIsScrolling(e,t){this.toggleCls("neo-is-scrolling",e)}afterSetMountedColumns(e,t){t&&this.createViewData()}afterSetRowHeight(e,t){e>0&&this.updateScrollHeight()}afterSetScrollLeft(e,t){this.updateMountedAndVisibleColumns()}afterSetScrollTop(e,t){let o=this,{bufferRowRange:l}=o,i=Math.floor(e/o.rowHeight);Math.abs(o.startIndex-i)>=l?o.startIndex=i:(o.visibleRows[0]=i,o.visibleRows[1]=i+o.availableRows)}afterSetSelectionModel(e,t){this.vnodeInitialized&&e.register(this)}afterSetStartIndex(e,t){void 0!==t&&this.createViewData()}afterSetStore(e,t){let o=this,l={filter:o.onStoreFilter,load:o.onStoreLoad,recordChange:o.onStoreRecordChange,scope:o};t?.un(l),e?.on(l),t&&o.clearComponentColumnMaps()}applyRendererOutput({cellId:e,column:t,columnIndex:o,record:i,rowIndex:n}){let r,s,d=this,a=d.parent,{selectedCells:c,store:u}=d,m=["neo-grid-cell"],h=i[d.colspanField],{dataField:p}=t,{model:g}=u,w=i[p];if(!g.getField(p)){let e=p.split("."),t=e.pop();w=Neo.ns(e,!1,i[Symbol.for("data")])?.[t]}switch(null==w&&(w=""),"me"!==t.rendererScope&&"this"!==t.rendererScope||(t.rendererScope=t),d.bindCallback(t.renderer,"renderer",t.rendererScope||d,t),s=t.renderer.call(t.rendererScope||d,{column:t,columnIndex:o,dataField:p,gridContainer:a,record:i,rowIndex:n,store:u,value:w}),Neo.typeOf(s)){case"Object":s.html||s.text?s.cls&&m.push(...s.cls):s=[s];break;case"Date":case"Number":case"String":s={cls:m,html:s?.toString()}}return null==s&&(s=""),"left"!==t.cellAlign&&m.push("neo-"+t.cellAlign),d.highlightModifiedCells&&i.isModifiedField(p)&&m.push("neo-is-modified"),e||(e=d.getCellId(n,t.dataField)),c.includes(e)&&m.push("neo-selected"),d.selectionModel?.selectedColumns?.includes(p)&&l.add(m,d.selectionModel.selectedColumnCellCls||"neo-selected"),r={"aria-colindex":o+1,id:e,cls:m,role:"gridcell",style:s.style||{}},t.width&&(r.style.minWidth=`${t.width}px`),h&&Object.keys(h).includes(p)&&(r.colspan=h[p]),"Object"===Neo.typeOf(s)?Object.hasOwn(s,"html")?r.html=s.html||"":r.text=s.text||"":r.cn=s,r}beforeGetColumnPositions(e){return e||(this._columnPositions=e=Neo.create({module:t,keyProperty:"dataField"})),e}beforeSetSelectionModel(t,o){return o?.destroy(),e.beforeSetInstance(t,i)}clearComponentColumnMaps(){this.parent.columns.items.forEach(e=>{e instanceof Neo.grid.column.Component&&(e.map.forEach(e=>{e.destroy()}),e.map.clear())})}cleanupComponentInstances(){let e=this;e.parent.columns.items.forEach(t=>{t instanceof Neo.grid.column.Component&&t.map.forEach((o,l)=>{const i=parseInt(l.split("-").pop());(i<e.mountedRows[0]||i>e.mountedRows[1])&&(o.destroy(),t.map.delete(l))})})}createRow({record:e,rowIndex:t}){Neo.isNumber(t)||(t=this.store.indexOf(e));let o,i,n,r,s,d=this,{mountedColumns:a,selectedRows:c}=d,u=d.parent,{columns:m}=u,h=d.getRowId(t),p=e[d.store.getKeyProperty()],g=d.getRowClass(e,t);for(t%2!=0&&g.push("neo-even"),c&&e[d.selectedRecordField]&&l.add(c,p),r={id:h,"aria-rowindex":t+2,cls:g,cn:[],data:{recordId:p},role:"row",style:{height:d.rowHeight+"px",transform:`translate3d(0px, ${t*d.rowHeight}px, 0px)`}},c?.includes(p)&&(g.push("neo-selected"),r["aria-selected"]=!0,u.fire("select",{record:e})),s=a[0];s<=a[1];s++)i=m.getAt(s),o=d.applyRendererOutput({column:i,columnIndex:s,record:e,rowIndex:t}),i.dock&&(o.cls=["neo-locked",...o.cls||[]]),n=d.columnPositions.get(i.dataField),o.style={...o.style,left:n.x+"px",width:n.width+"px"},n.hidden&&(o.style.visibility="hidden"),r.cn.push(o);return r}createViewData(e=!1){let t,o,l,i=this,{mountedRows:n,store:r}=i,s=[];if(!(r.isLoading||i.availableRows<1||i._containerWidth<1||i.columnPositions.getCount()<1||i.mountedColumns[1]<1)){for(i.#e>0?(t=i.#e,l=t):(i.updateMountedAndVisibleRows(),t=n[1]),o=n[0];o<t;o++)s.push(i.createRow({record:r.getAt(o),rowIndex:o}));i.getVdomRoot().cn=s,i.parent.isLoading=!1,i.updateScrollHeight(!0,l),!e&&i.update()}}destroy(...e){this.store=null,this.clearComponentColumnMaps(),super.destroy(...e)}fireCellEvent(e,t){let o=this,l=e.currentTarget,i=o.getCellDataField(l),n=o.getRecord(l);o.parent.fire(t,{body:o,data:e,dataField:i,record:n})}fireRowEvent(e,t){let o=this,l=e.currentTarget,i=o.getRecord(l);o.parent.fire(t,{body:o,data:e,record:i})}getCellDataField(e){return e.split("__")[2]}getCellId(e,t){return this.getRowId(e)+"__"+t}getColumn(e,t=!1){let{columns:o}=this.parent,l=o.get(e);return l?t?o.indexOf(l):l:null}getColumnCells(e){let t,o=this,l=[],i=-1,n=o.getVdomRoot(),r=n.cn[0],s=0,d=r.cn.length;for(;s<d;s++)if(e===o.getDataField(r.cn[s].id)){i=s;break}return i>-1&&n.cn.forEach(e=>{t=e.cn[i],t&&l.push(t)}),l}getDataField(e){return e.split("__")[2]}getRecord(e){let t,o,l=this,i=l.getRecordByRowId(e);if(i)return i;for(t of(o=n.getParentNodes(l.vdom,e),o||[]))if(i=l.getRecordByRowId(t.id),i)return i;return null}getRecordByRowId(e){let t=this,o=t.getVdomChild(e)["aria-rowindex"];return Neo.isNumber(o)?(o-=2,t.store.getAt(o)):null}getRowClass(e,t){return["neo-grid-row"]}getRowId(e){let t=this;return t.#e>0?`${t.id}__row-${e}`:`${t.id}__row-${e%(t.availableRows+2*t.bufferRowRange)}`}getVdomRoot(){return this.vdom.cn[0]}getVdomItemsRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}onCellClick(e){this.fireCellEvent(e,"cellClick")}onCellDoubleClick(e){this.fireCellEvent(e,"cellDoubleClick")}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onRowClick(e){this.fireRowEvent(e,"rowClick")}onRowDoubleClick(e){this.fireRowEvent(e,"rowDoubleClick")}onStoreFilter(){this.onStoreLoad()}onStoreLoad({items:e,postChunkLoad:t,total:o}){let l=this;if(e?.length<1){const e=l.getVdomRoot();if(e.cn.length<1)return;return e.cn=[],l.getVnodeRoot().childNodes=[],void Neo.applyDeltas(l.appName,{id:e.id,textContent:""})}o&&e.length<o?(l.#e=e.length,l.#t=o,l.createViewData(),l.#e=0,l.#t=0):l.createViewData(),l.mounted&&!t&&l.timeout(50).then(()=>{Neo.main.DomAccess.scrollTo({direction:"top",id:l.vdom.id,value:0})}),t&&l.cleanupComponentInstances()}onStoreRecordChange({fields:e,record:t}){let o,l,i,n=this,r=e.map(e=>e.name),s=!1,d=n.store.indexOf(t),{mountedRows:a,selectionModel:c}=n;if(r.includes(n.colspanField))n.vdom.cn[d]=n.createRow({record:t,rowIndex:d}),n.update();else if(d>=a[0]&&d<=a[1]){for(o of n.parent.columns.items)o instanceof Neo.grid.column.Component&&Neo.typeOf("Function"===o.component)&&!r.includes(o.dataField)&&(l=n.updateCellNode(t,o.dataField),s=s||l);e.forEach(e=>{e.name===n.selectedRecordField?"selection-grid-rowmodel"===c.ntype&&(i=t[n.store.getKeyProperty()],c[e.value?"selectRow":"deselectRow"](i)):(l=n.updateCellNode(t,e.name),s=s||l)})}s&&n.update()}scrollByRows(e,t){let o,l,i,n,r=this,{mountedRows:s,visibleRows:d}=r,a=r.store.getCount(),c=e+t;for(c>=a&&(c%=a,t=c-e);c<0;)c+=a,t+=a;l=c>=s[0]&&c<=s[1],n=c>d[0]&&c<d[1],n||(l&&(d[0]+=t,d[1]+=t),t<0?i=c*r.rowHeight:(o=r.rowHeight-r.availableHeight%r.rowHeight,i=(c-r.availableRows)*r.rowHeight+o),Neo.main.DomAccess.scrollTo({id:r.vdom.id,value:i,windowId:r.windowId}))}updateCellNode(e,t){let o,l,i,r,s=this,d=s.store.indexOf(e),a=s.getCellId(d,t),c=n.find(s.vdom,a),u=!1;return c?.vdom&&(o=c.vdom.style,i=s.getColumn(t),r=c.index,l=s.applyRendererOutput({cellId:a,column:i,columnIndex:r,record:e,rowIndex:d}),u=!0,Object.assign(l.style,{left:o.left,width:o.width}),c.parentNode.cn[r]=l),u}updateMountedAndVisibleColumns(){let e,t,o=this,{bufferColumnRange:l,columnPositions:i,mountedColumns:n,visibleColumns:r}=o,s=0,d=i.getCount(),a=d-1,c=o.scrollLeft;if(!(d<1)){for(;s<d;s++)if(e=i.getAt(s),c>=e.x&&c<=e.x+e.width&&(t=s),o.containerWidth+c<e.x){a=s-1;break}r[0]=t,r[1]=a,(r[0]<=n[0]||r[1]>=n[1])&&(t=Math.max(0,r[0]-l),a=Math.min(d-1,r[1]+l),o.mountedColumns=[t,a])}}updateMountedAndVisibleRows(){let e=this,{bufferRowRange:t,startIndex:o,store:l}=e,i=l.getCount(),n=Math.min(i,o+e.availableRows);e.visibleRows[0]=o,e.visibleRows[1]=n,o=Math.max(0,o-t),n=Math.min(i,n+t),e.mountedRows[0]=o,e.mountedRows[1]=n}updateScrollHeight(e=!1){let t=this,o=t.#t||t.store?.count||0,{rowHeight:l}=t;o>0&&l>0&&(t.vdom.cn[0].height=(o+1)*l+"px",!e&&t.update())}});