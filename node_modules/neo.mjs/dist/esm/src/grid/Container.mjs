import e from"../container/Base.mjs";import o from"../util/ClassSystem.mjs";import t from"../collection/Base.mjs";import r from"./Body.mjs";import i from"./ScrollManager.mjs";import s from"../data/Store.mjs";import a from"./VerticalScrollbar.mjs";import*as n from"./column/_export.mjs";import*as d from"./header/_export.mjs";class l extends e{static columnTypes={animatedChange:n.AnimatedChange,animatedCurrency:n.AnimatedCurrency,column:n.Base,component:n.Component,currency:n.Currency,index:n.Index,progress:n.Progress};static delayable={onResize:{type:"buffer",timer:300}};static config={className:"Neo.grid.Container",ntype:"grid-container",baseCls:["neo-grid-container"],bodyConfig:null,bodyId_:null,cellEditing_:!1,columnDefaults:null,columns_:[],headerToolbarConfig:null,headerToolbarId_:null,layout:"base",role:"grid",rowHeight_:32,scrollbar:null,showHeaderFilters_:!1,sortable_:!0,store_:null,items:null,_vdom:{cls:["neo-grid-wrapper"],cn:[{"aria-rowcount":1,cn:[]}]}};initialResizeEvent=!0;scrollManager=null;get body(){return Neo.getComponent(this.bodyId)||Neo.get(this.bodyId)}get headerToolbar(){return Neo.getComponent(this.headerToolbarId)||Neo.get(this.headerToolbarId)}construct(e){super.construct(e);let o=this,{appName:t,rowHeight:i,store:s,windowId:n}=o;o.bodyId=Neo.getId("grid-body"),o.headerToolbarId=Neo.getId("grid-header-toolbar"),o.items=[{module:d.Toolbar,id:o.headerToolbarId,showHeaderFilters:o.showHeaderFilters,sortable:o.sortable,...o.headerToolbarConfig},{module:r,flex:1,gridContainer:o,id:o.bodyId,rowHeight:i,store:s,...o.bodyConfig}],o.scrollbar=Neo.create({module:a,appName:t,parentId:o.id,rowHeight:i,store:s,windowId:n}),o.vdom.cn.push(o.scrollbar.createVdomReference()),o.vdom.id=o.getWrapperId(),o._columns=o.createColumns(o.columns),o.addDomListeners({resize:o.onResize,scope:o})}async addResizeObserver(e){let o=this,{windowId:t}=o,r=await Neo.currentWorker.getAddon("ResizeObserver",t),i={id:o.id,windowId:t};e?(r.register(i),await o.passSizeToBody()):(o.initialResizeEvent=!0,r.unregister(i))}afterSetCellEditing(e,o){e&&import("./plugin/CellEditing.mjs").then(e=>{let o=this,{appName:t}=o,r=o.plugins||[];r.push({module:e.default,appName:t}),o.plugins=r})}async afterSetColumns(e,o){if(o?.getCount?.()>0){let e=this;e.headerToolbar?.createItems(),await e.timeout(50),await e.passSizeToBody(),e.body?.createViewData()}}afterSetMounted(e,o){super.afterSetMounted(e,o),void 0!==o&&this.addResizeObserver(e)}afterSetRowHeight(e,o){if(e>0){let{body:o,scrollbar:t}=this;t&&(t.rowHeight=e),o&&(o.rowHeight=e)}}afterSetShowHeaderFilters(e,o){void 0!==o&&(this.headerToolbar.showHeaderFilters=e)}afterSetSortable(e,o){void 0!==o&&(this.headerToolbar.sortable=e)}afterSetStore(e,o){let t=this,r={filter:t.onStoreFilter,load:t.onStoreLoad,scope:t};e?.on(r),o?.un(r),t.body&&(t.body.store=e)}beforeSetBodyId(e,o){return e||o}beforeSetColumns(e,o){return this.configsApplied?this.createColumns(e):e}beforeSetHeaderToolbarId(e,o){return e||o}beforeSetStore(e,t){return e&&(e=o.beforeSetInstance(e,s)),e}bulkUpdateRecords(e){let{body:o,store:t}=this,{keyProperty:r}=t;o&&(o.silentVdomUpdate=!0,e.forEach(e=>{t.get(e[r])?.set(e)}),o.silentVdomUpdate=!1,o.update())}createColumns(e){let o,r,i=this,{columnDefaults:s}=i,a=[],n=i.store?.sorters;return e?.forEach((t,d)=>{r=t.renderer,s&&Neo.assignDefaults(t,s),r&&Neo.isString(r)&&i[r]&&(t.renderer=i[r]),n?.[0]&&t.dataField===n[0].property&&(t.isSorted=n[0].direction),t.listeners={sort:i.onSortColumn,scope:i},a.push(t),t.component&&!t.type&&(t.type="component"),o=i.constructor.columnTypes[t.type||"column"],delete t.type,e[d]=Neo.create(o,{parent:i,windowId:i.windowId,...t})}),i.items[0].items=a,"NeoInstance"===Neo.typeOf(i._columns)?(i._columns.clear(),i._columns.add(e),i._columns):Neo.create(t,{keyProperty:"dataField",items:e})}destroy(...e){let o=this;o.store=null,o.scrollManager.destroy(),o.mounted&&Neo.main.addon.ResizeObserver.unregister({id:o.id,windowId:o.windowId}),super.destroy(...e)}getVdomRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}getWrapperId(){return`${this.id}__wrapper`}onConstructed(){super.onConstructed();let e=this;e.scrollManager=Neo.create({gridBody:e.body,module:i,gridContainer:e})}async onResize(e){let o=this;o.initialResizeEvent?o.initialResizeEvent=!1:(await o.passSizeToBody(!0),o.body.updateMountedAndVisibleColumns(),await o.headerToolbar.passSizeToBody())}onSortColumn(e){let o=this;o.store.sort(e),o.removeSortingCss(e.property),e.direction&&o.body.onStoreLoad()}onStoreFilter(){this.updateRowCount()}onStoreLoad(e){let o=this;o.updateRowCount(),o.store.sorters?.length<1&&o.removeSortingCss()}async passSizeToBody(e=!1){let o=this,[t,r]=await o.getDomRect([o.id,o.headerToolbarId]);t.height===r.height?(await o.timeout(100),await o.passSizeToBody(e)):o.body[e?"setSilent":"set"]({availableHeight:t.height-r.height,containerWidth:t.width})}removeSortingCss(e){this.headerToolbar?.items.forEach(o=>{o.dataField!==e&&o.removeSortingCss()})}scrollByColumns(e,o){let t,r,i,s,a=this,{body:n}=a,{columnPositions:d,containerWidth:l,mountedColumns:m,visibleColumns:u}=n,c=d.getCount(),h=e+o;for(h>=c&&(h%=c,o=h-e);h<0;)h+=c,o+=c;r=h>=m[0]&&h<=m[1],s=h>u[0]&&h<u[1],s||(r&&(u[0]+=o,u[1]+=o),t=d.getAt(h),i=o<0?t.x:t.x-l+t.width,Neo.main.DomAccess.scrollTo({direction:"left",id:a.id,value:i,windowId:a.windowId}))}updateRowCount(e=!1){this.getVdomRoot()["aria-rowcount"]=this.store.getCount()+2,!e&&this.update()}}export default Neo.setupClass(l);