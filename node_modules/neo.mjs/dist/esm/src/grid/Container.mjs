import e from"../container/Base.mjs";import t from"../util/ClassSystem.mjs";import o from"../collection/Base.mjs";import r from"./View.mjs";import i from"./ScrollManager.mjs";import s from"../data/Store.mjs";import a from"./VerticalScrollbar.mjs";import*as n from"./column/_export.mjs";import*as d from"./header/_export.mjs";class l extends e{static columnTypes={animatedChange:n.AnimatedChange,animatedCurrency:n.AnimatedCurrency,column:n.Base,component:n.Component,currency:n.Currency,index:n.Index,progress:n.Progress};static delayable={onResize:{type:"buffer",timer:300}};static config={className:"Neo.grid.Container",ntype:"grid-container",baseCls:["neo-grid-container"],cellEditing_:!1,columnDefaults:null,columns_:[],headerToolbarConfig:null,headerToolbarId_:null,layout:"base",role:"grid",rowHeight_:32,scrollbar:null,showHeaderFilters_:!1,sortable_:!0,store_:null,viewConfig:null,viewId_:null,items:null,_vdom:{cls:["neo-grid-wrapper"],cn:[{"aria-rowcount":1,cn:[]}]}};initialResizeEvent=!0;scrollManager=null;get headerToolbar(){return Neo.getComponent(this.headerToolbarId)||Neo.get(this.headerToolbarId)}get view(){return Neo.getComponent(this.viewId)||Neo.get(this.viewId)}construct(e){super.construct(e);let t=this,{appName:o,rowHeight:i,store:s,windowId:n}=t;t.headerToolbarId=Neo.getId("grid-header-toolbar"),t.viewId=Neo.getId("grid-view"),t.items=[{module:d.Toolbar,id:t.headerToolbarId,showHeaderFilters:t.showHeaderFilters,sortable:t.sortable,...t.headerToolbarConfig},{module:r,flex:1,gridContainer:t,id:t.viewId,rowHeight:i,store:s,...t.viewConfig}],t.scrollbar=Neo.create({module:a,appName:o,parentId:t.id,rowHeight:i,store:s,windowId:n}),t.vdom.cn.push(t.scrollbar.createVdomReference()),t.vdom.id=t.getWrapperId(),t._columns=t.createColumns(t.columns),t.addDomListeners({resize:t.onResize,scope:t})}async addResizeObserver(e){let t=this,{windowId:o}=t,r=await Neo.currentWorker.getAddon("ResizeObserver",o),i={id:t.id,windowId:o};e?(r.register(i),await t.passSizeToView()):(t.initialResizeEvent=!0,r.unregister(i))}afterSetCellEditing(e,t){e&&import("./plugin/CellEditing.mjs").then(e=>{let t=this,{appName:o}=t,r=t.plugins||[];r.push({module:e.default,appName:o}),t.plugins=r})}async afterSetColumns(e,t){if(t?.getCount?.()>0){let e=this;e.headerToolbar?.createItems(),await e.timeout(50),await e.passSizeToView(),e.view?.createViewData()}}afterSetMounted(e,t){super.afterSetMounted(e,t),void 0!==t&&this.addResizeObserver(e)}afterSetRowHeight(e,t){if(e>0){let{scrollbar:t,view:o}=this;t&&(t.rowHeight=e),o&&(o.rowHeight=e)}}afterSetShowHeaderFilters(e,t){void 0!==t&&(this.headerToolbar.showHeaderFilters=e)}afterSetSortable(e,t){void 0!==t&&(this.headerToolbar.sortable=e)}afterSetStore(e,t){let o=this,r={filter:o.onStoreFilter,load:o.onStoreLoad,scope:o};e?.on(r),t?.un(r),o.view&&(o.view.store=e)}beforeSetColumns(e,t){return this.configsApplied?this.createColumns(e):e}beforeSetHeaderToolbarId(e,t){return e||t}beforeSetStore(e,o){return e&&(e=t.beforeSetInstance(e,s)),e}beforeSetViewId(e,t){return e||t}bulkUpdateRecords(e){let{store:t,view:o}=this,{keyProperty:r}=t;o&&(o.silentVdomUpdate=!0,e.forEach(e=>{t.get(e[r])?.set(e)}),o.silentVdomUpdate=!1,o.update())}createColumns(e){let t,r,i=this,{columnDefaults:s}=i,a=[],n=i.store?.sorters;return e?.forEach((o,d)=>{r=o.renderer,s&&Neo.assignDefaults(o,s),r&&Neo.isString(r)&&i[r]&&(o.renderer=i[r]),n?.[0]&&o.dataField===n[0].property&&(o.isSorted=n[0].direction),o.listeners={sort:i.onSortColumn,scope:i},a.push(o),o.component&&!o.type&&(o.type="component"),t=i.constructor.columnTypes[o.type||"column"],delete o.type,e[d]=Neo.create(t,{parent:i,windowId:i.windowId,...o})}),i.items[0].items=a,"NeoInstance"===Neo.typeOf(i._columns)?(i._columns.clear(),i._columns.add(e),i._columns):Neo.create(o,{keyProperty:"dataField",items:e})}destroy(...e){let t=this;t.store=null,t.scrollManager.destroy(),t.mounted&&Neo.main.addon.ResizeObserver.unregister({id:t.id,windowId:t.windowId}),super.destroy(...e)}getVdomRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}getWrapperId(){return`${this.id}__wrapper`}onConstructed(){super.onConstructed();let e=this;e.scrollManager=Neo.create({module:i,gridContainer:e,gridView:e.view})}async onResize(e){let t=this;t.initialResizeEvent?t.initialResizeEvent=!1:(await t.passSizeToView(!0),t.view.updateMountedAndVisibleColumns(),await t.headerToolbar.passSizeToView())}onSortColumn(e){let t=this;t.store.sort(e),t.removeSortingCss(e.property),e.direction&&t.view.onStoreLoad()}onStoreFilter(){this.updateRowCount()}onStoreLoad(e){let t=this;t.updateRowCount(),t.store.sorters?.length<1&&t.removeSortingCss()}async passSizeToView(e=!1){let t=this,[o,r]=await t.getDomRect([t.id,t.headerToolbarId]);o.height===r.height?(await t.timeout(100),await t.passSizeToView(e)):t.view[e?"setSilent":"set"]({availableHeight:o.height-r.height,containerWidth:o.width})}removeSortingCss(e){this.headerToolbar?.items.forEach(t=>{t.dataField!==e&&t.removeSortingCss()})}scrollByColumns(e,t){let o,r,i,s,a=this,{view:n}=a,{columnPositions:d,containerWidth:l,mountedColumns:m,visibleColumns:u}=n,c=d.getCount(),h=e+t;for(h>=c&&(h%=c,t=h-e);h<0;)h+=c,t+=c;r=h>=m[0]&&h<=m[1],s=h>u[0]&&h<u[1],s||(r&&(u[0]+=t,u[1]+=t),o=d.getAt(h),i=t<0?o.x:o.x-l+o.width,Neo.main.DomAccess.scrollTo({direction:"left",id:a.id,value:i,windowId:a.windowId}))}updateRowCount(e=!1){this.getVdomRoot()["aria-rowcount"]=this.store.getCount()+2,!e&&this.update()}}export default Neo.setupClass(l);