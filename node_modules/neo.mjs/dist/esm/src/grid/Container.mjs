import e from"../container/Base.mjs";import t from"../util/ClassSystem.mjs";import o from"../collection/Base.mjs";import r from"./Body.mjs";import s from"./ScrollManager.mjs";import i from"../data/Store.mjs";import n from"./VerticalScrollbar.mjs";import a from"./footer/Toolbar.mjs";import*as l from"./column/_export.mjs";import*as d from"./header/_export.mjs";import{isDescriptor as u}from"../core/ConfigSymbols.mjs";class c extends e{static columnTypes={animatedChange:l.AnimatedChange,animatedCurrency:l.AnimatedCurrency,column:l.Base,component:l.Component,countryFlag:l.CountryFlag,currency:l.Currency,githubOrgs:l.GitHubOrgs,githubUser:l.GitHubUser,icon:l.Icon,iconLink:l.IconLink,index:l.Index,linkedin:l.LinkedIn,progress:l.Progress,sparkline:l.Sparkline};static delayable={onResize:{type:"buffer",timer:300}};static config={className:"Neo.grid.Container",ntype:"grid-container",baseCls:["neo-grid-container"],body_:{[u]:!0,merge:"deep",value:null},cellEditing_:!1,columnDefaults:null,columns_:[],footerToolbar_:{[u]:!0,merge:"deep",value:null},headerToolbar_:{[u]:!0,merge:"deep",value:null},layout:{ntype:"vbox",align:"stretch"},role:"grid",rowHeight_:32,scrollbar:null,showHeaderFilters_:!1,sortable_:!0,useInternalId_:!0,useTriStateSorting_:!1,store_:null,items:null,_vdom:{cls:["neo-grid-wrapper"],cn:[{"aria-colcount":0,"aria-rowcount":1,cn:[]}]}};initialResizeEvent=!0;scrollManager=null;construct(e){super.construct(e);let t=this,{appName:o,rowHeight:r,store:s,windowId:i}=t;t.items=[t.headerToolbar,t.body],t.footerToolbar&&t.items.push(t.footerToolbar),t.scrollbar=Neo.create({module:n,appName:o,parentId:t.id,rowHeight:r,store:s,theme:t.theme,windowId:i}),t.vdom.cn.push(t.scrollbar.createVdomReference()),t.vdom.id=t.getWrapperId(),t._columns=t.createColumns(t.columns),t.updateColCount(),t.addDomListeners({resize:t.onResize,scope:t})}async addResizeObserver(e){let t=this,{windowId:o}=t,r=await Neo.currentWorker.getAddon("ResizeObserver",o),s={id:t.id,windowId:o};e?(r.register(s),await t.passSizeToBody()):(t.initialResizeEvent=!0,r.unregister(s))}afterSetCellEditing(e,t){e&&import("./plugin/CellEditing.mjs").then(e=>{let t=this,{appName:o}=t,r=t.plugins||[];r.push({module:e.default,appName:o}),t.plugins=r})}async afterSetColumns(e,t){let o=this,{headerToolbar:r}=o;(t?.count||e?.count&&r?.isConstructed)&&(r?.createItems(),await o.timeout(50),await o.passSizeToBody(),o.body?.createViewData()),o.configsApplied&&o.updateColCount()}afterSetFooterToolbar(e,t){let o=this;e&&o.store&&e.store!==o.store&&(e.store=o.store)}afterSetMounted(e,t){super.afterSetMounted(e,t),void 0!==t&&this.addResizeObserver(e);let{scrollManager:o}=this;o&&(o.mounted=e)}afterSetRowHeight(e,t){if(e>0){let{body:t,scrollbar:o}=this;o&&(o.rowHeight=e),t&&(t.rowHeight=e)}}afterSetShowHeaderFilters(e,t){void 0!==t&&(this.headerToolbar.showHeaderFilters=e)}afterSetSortable(e,t){void 0!==t&&(this.headerToolbar.sortable=e)}afterSetUseTriStateSorting(e,t){void 0!==t&&(this.headerToolbar.useTriStateSorting=e)}afterSetStore(e,t){let o=this,r={filter:o.onStoreFilter,load:o.onStoreLoad,scope:o};e?.on(r),t?.un(r),o.body&&(o.body.store=e),o.footerToolbar&&o.footerToolbar.store!==e&&(o.footerToolbar.store=e)}afterSetUseInternalId(e,t){void 0!==t&&this.body&&(this.body.useInternalId=e)}beforeSetBody(e,o){const s=this;return t.beforeSetInstance(e,r,{flex:1,gridContainer:s,parentId:s.id,store:s.store,theme:s.theme,useInternalId:s.useInternalId})}beforeSetColumns(e,t){return this.configsApplied?this.createColumns(e):e}beforeSetFooterToolbar(e,o){if(!e)return null;return t.beforeSetInstance(e,a,{flex:"none",parentId:this.id,theme:this.theme})}beforeSetHeaderToolbar(e,o){const r=this;return t.beforeSetInstance(e,d.Toolbar,{flex:"none",parentId:r.id,showHeaderFilters:r.showHeaderFilters,sortable:r.sortable,theme:r.theme,useTriStateSorting:r.useTriStateSorting})}beforeSetStore(e,o){return e&&(e=t.beforeSetInstance(e,i)),e}bulkUpdateRecords(e){let{body:t,store:o}=this,{keyProperty:r}=o;if(t){t.silentVdomUpdate=!0;for(let t=0,s=e.length;t<s;t++)o.get(e[t][r])?.set(e[t]);t.silentVdomUpdate=!1,t.update()}}createColumns(e){let t,r,s=this,{columnDefaults:i}=s,n=[],a=s.store?.sorters;if(e)for(let o=0,l=e.length;o<l;o++){let l=e[o];r=l.renderer,i&&Neo.assignDefaults(l,i),r&&Neo.isString(r)&&s[r]&&(l.renderer=s[r]),a?.[0]&&l.dataField===a[0].property&&(l.isSorted=a[0].direction),l.listeners={sort:s.onSortColumn,scope:s},n.push(l),l.component&&!l.type&&(l.type="component"),t=s.constructor.columnTypes[l.type||"column"],delete l.type,e[o]=Neo.create(t,{parent:s,windowId:s.windowId,...l})}return s.headerToolbar.items=n,s.headerToolbar.createItems(),"NeoInstance"===Neo.typeOf(s._columns)?(s._columns.clear(),s._columns.add(e),s._columns):Neo.create(o,{keyProperty:"dataField",items:e,listeners:{mutate:s.onColumnsMutate,scope:s}})}destroy(...e){let t=this;t.store=null,t.scrollManager.destroy(),t.mounted&&Neo.main.addon.ResizeObserver.unregister({id:t.id,windowId:t.windowId}),super.destroy(...e)}getVdomRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}getWrapperId(){return`${this.id}__wrapper`}onColumnsMutate(e){this.updateColCount()}onConstructed(){super.onConstructed();let e=this;e.scrollManager=Neo.create({gridBody:e.body,module:s,gridContainer:e})}async onResize(e){let t=this;t.initialResizeEvent?t.initialResizeEvent=!1:(await t.passSizeToBody(!0),t.body.updateMountedAndVisibleColumns(),await t.headerToolbar.passSizeToBody())}onScrollCapture(e){super.onScrollCapture(e),this.scrollManager.onContainerScroll(e)}onSortColumn(e){this.store.sort(e),this.removeSortingCss(e.property)}onStoreFilter(){this.updateRowCount()}onStoreLoad(e){let t=this,o=e.total?e.total:this.store.count;t.updateRowCount(o),t.store.sorters?.length<1&&t.removeSortingCss()}async passSizeToBody(e=!1){let t,o,r,s=this,{footerToolbar:i,headerToolbar:n}=s,a=[s.id,n.id];i&&a.push(i.id),[t,r,o]=await s.getDomRect(a),t.height===r.height?(await s.timeout(100),await s.passSizeToBody(e)):s.body[e?"setSilent":"set"]({availableHeight:t.height-r.height-(o?.height||0),containerWidth:t.width})}removeSortingCss(e){let t=this.headerToolbar?.items;if(t)for(let o=0,r=t.length;o<r;o++)t[o].dataField!==e&&t[o].removeSortingCss()}scrollByColumns(e,t){let o,r,s,i,n=this,{body:a}=n,{columnPositions:l,containerWidth:d,mountedColumns:u,visibleColumns:c}=a,m=l.getCount(),h=e+t;for(h>=m&&(h%=m,t=h-e);h<0;)h+=m,t+=m;r=h>=u[0]&&h<=u[1],i=h>c[0]&&h<c[1],i||(r&&(c[0]+=t,c[1]+=t),o=l.getAt(h),s=t<0?o.x:o.x-d+o.width,Neo.main.DomAccess.scrollTo({direction:"left",id:n.getVdomRoot().id,value:s,windowId:n.windowId}))}toJSON(){let e=this;return{...super.toJSON(),body:e.body?.toJSON(),cellEditing:e.cellEditing,columns:e.columns?.items.map(e=>e.toJSON()),footerToolbar:e.footerToolbar?.toJSON(),headerToolbar:e.headerToolbar?.toJSON(),rowHeight:e.rowHeight,scrollbar:e.scrollbar?.toJSON(),scrollManager:e.scrollManager?.toJSON(),showHeaderFilters:e.showHeaderFilters,sortable:e.sortable,store:e.store?.toJSON(),useTriStateSorting:e.useTriStateSorting}}updateColCount(e=!1){let t=this;t.getVdomRoot()["aria-colcount"]=t.columns.count,!e&&t.update()}updateRowCount(e,t=!1){let o=this,r=e||o.store.count;o.getVdomRoot()["aria-rowcount"]=r+1,!t&&o.update()}}export default Neo.setupClass(c);