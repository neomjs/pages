import e from"../container/Base.mjs";import t from"../util/ClassSystem.mjs";import o from"../collection/Base.mjs";import r from"./Body.mjs";import s from"./ScrollManager.mjs";import i from"../data/Store.mjs";import a from"./VerticalScrollbar.mjs";import*as n from"./column/_export.mjs";import*as d from"./header/_export.mjs";import{isDescriptor as l}from"../core/ConfigSymbols.mjs";class c extends e{static columnTypes={animatedChange:n.AnimatedChange,animatedCurrency:n.AnimatedCurrency,column:n.Base,component:n.Component,currency:n.Currency,index:n.Index,progress:n.Progress};static delayable={onResize:{type:"buffer",timer:300}};static config={className:"Neo.grid.Container",ntype:"grid-container",baseCls:["neo-grid-container"],body_:{[l]:!0,merge:"deep",value:null},cellEditing_:!1,columnDefaults:null,columns_:[],headerToolbar_:{[l]:!0,merge:"deep",value:null},layout:"base",role:"grid",rowHeight_:32,scrollbar:null,showHeaderFilters_:!1,sortable_:!0,store_:null,items:null,_vdom:{cls:["neo-grid-wrapper"],cn:[{"aria-rowcount":1,cn:[]}]}};initialResizeEvent=!0;scrollManager=null;construct(e){super.construct(e);let t=this,{appName:o,rowHeight:r,store:s,windowId:i}=t;t.items=[t.headerToolbar,t.body],t.scrollbar=Neo.create({module:a,appName:o,parentId:t.id,rowHeight:r,store:s,windowId:i}),t.vdom.cn.push(t.scrollbar.createVdomReference()),t.vdom.id=t.getWrapperId(),t._columns=t.createColumns(t.columns),t.addDomListeners({resize:t.onResize,scope:t})}async addResizeObserver(e){let t=this,{windowId:o}=t,r=await Neo.currentWorker.getAddon("ResizeObserver",o),s={id:t.id,windowId:o};e?(r.register(s),await t.passSizeToBody()):(t.initialResizeEvent=!0,r.unregister(s))}afterSetCellEditing(e,t){e&&import("./plugin/CellEditing.mjs").then(e=>{let t=this,{appName:o}=t,r=t.plugins||[];r.push({module:e.default,appName:o}),t.plugins=r})}async afterSetColumns(e,t){let o=this,{headerToolbar:r}=o;(t?.count||e?.count&&r?.isConstructed)&&(r?.createItems(),await o.timeout(50),await o.passSizeToBody(),o.body?.createViewData())}afterSetMounted(e,t){super.afterSetMounted(e,t),void 0!==t&&this.addResizeObserver(e)}afterSetRowHeight(e,t){if(e>0){let{body:t,scrollbar:o}=this;o&&(o.rowHeight=e),t&&(t.rowHeight=e)}}afterSetShowHeaderFilters(e,t){void 0!==t&&(this.headerToolbar.showHeaderFilters=e)}afterSetSortable(e,t){void 0!==t&&(this.headerToolbar.sortable=e)}afterSetStore(e,t){let o=this,r={filter:o.onStoreFilter,load:o.onStoreLoad,scope:o};e?.on(r),t?.un(r),o.body&&(o.body.store=e)}beforeSetBody(e,o){const s=this;return t.beforeSetInstance(e,r,{flex:1,gridContainer:s,parentId:s.id,store:s.store})}beforeSetColumns(e,t){return this.configsApplied?this.createColumns(e):e}beforeSetHeaderToolbar(e,o){const r=this;return t.beforeSetInstance(e,d.Toolbar,{parentId:r.id,showHeaderFilters:r.showHeaderFilters,sortable:r.sortable})}beforeSetStore(e,o){return e&&(e=t.beforeSetInstance(e,i)),e}bulkUpdateRecords(e){let{body:t,store:o}=this,{keyProperty:r}=o;t&&(t.silentVdomUpdate=!0,e.forEach(e=>{o.get(e[r])?.set(e)}),t.silentVdomUpdate=!1,t.update())}createColumns(e){let t,r,s=this,{columnDefaults:i}=s,a=[],n=s.store?.sorters;return e?.forEach((o,d)=>{r=o.renderer,i&&Neo.assignDefaults(o,i),r&&Neo.isString(r)&&s[r]&&(o.renderer=s[r]),n?.[0]&&o.dataField===n[0].property&&(o.isSorted=n[0].direction),o.listeners={sort:s.onSortColumn,scope:s},a.push(o),o.component&&!o.type&&(o.type="component"),t=s.constructor.columnTypes[o.type||"column"],delete o.type,e[d]=Neo.create(t,{parent:s,windowId:s.windowId,...o})}),s.headerToolbar.items=a,s.headerToolbar.createItems(),"NeoInstance"===Neo.typeOf(s._columns)?(s._columns.clear(),s._columns.add(e),s._columns):Neo.create(o,{keyProperty:"dataField",items:e})}destroy(...e){let t=this;t.store=null,t.scrollManager.destroy(),t.mounted&&Neo.main.addon.ResizeObserver.unregister({id:t.id,windowId:t.windowId}),super.destroy(...e)}getVdomRoot(){return this.vdom.cn[0]}getVnodeRoot(){return this.vnode.childNodes[0]}getWrapperId(){return`${this.id}__wrapper`}onConstructed(){super.onConstructed();let e=this;e.scrollManager=Neo.create({gridBody:e.body,module:s,gridContainer:e})}async onResize(e){let t=this;t.initialResizeEvent?t.initialResizeEvent=!1:(await t.passSizeToBody(!0),t.body.updateMountedAndVisibleColumns(),await t.headerToolbar.passSizeToBody())}onSortColumn(e){let t=this;t.store.sort(e),t.removeSortingCss(e.property),e.direction&&t.body.onStoreLoad({items:t.store.items})}onStoreFilter(){this.updateRowCount()}onStoreLoad(e){let t=this,o=e.total?e.total:this.store.count;t.updateRowCount(o),t.store.sorters?.length<1&&t.removeSortingCss()}async passSizeToBody(e=!1){let t=this,[o,r]=await t.getDomRect([t.id,t.headerToolbar.id]);o.height===r.height?(await t.timeout(100),await t.passSizeToBody(e)):t.body[e?"setSilent":"set"]({availableHeight:o.height-r.height,containerWidth:o.width})}removeSortingCss(e){this.headerToolbar?.items.forEach(e=>{e.dataField})}scrollByColumns(e,t){let o,r,s,i,a=this,{body:n}=a,{columnPositions:d,containerWidth:l,mountedColumns:c,visibleColumns:m}=n,u=d.getCount(),p=e+t;for(p>=u&&(p%=u,t=p-e);p<0;)p+=u,t+=u;r=p>=c[0]&&p<=c[1],i=p>m[0]&&p<m[1],i||(r&&(m[0]+=t,m[1]+=t),o=d.getAt(p),s=t<0?o.x:o.x-l+o.width,Neo.main.DomAccess.scrollTo({direction:"left",id:a.id,value:s,windowId:a.windowId}))}updateRowCount(e,t=!1){let o=this,r=e||o.store.count;o.getVdomRoot()["aria-rowcount"]=r+2,!t&&o.update()}}export default Neo.setupClass(c);