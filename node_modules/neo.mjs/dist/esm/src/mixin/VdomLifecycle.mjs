import e from"../core/Base.mjs";import t from"../manager/Component.mjs";import d from"../util/vdom/TreeBuilder.mjs";import o from"../util/VDom.mjs";import n from"../manager/VDomUpdate.mjs";import i from"../util/VNode.mjs";import{isDescriptor as a}from"../core/ConfigSymbols.mjs";const{currentWorker:r}=Neo;export default Neo.setupClass(class extends e{static config={className:"Neo.mixin.VdomLifecycle",autoInitVnode:!1,autoMount:!1,isVdomUpdating_:!1,isVnodeInitializing_:!1,mounted_:!1,needsVdomUpdate_:!1,silentVdomUpdate_:!1,updateDepth_:1,vnode_:{[a]:!0,clone:"none",cloneOnGet:"none",isEqual:(e,t)=>e===t,value:null},vnodeInitialized_:!1};afterSetVdom(e,t){this.updateVdom()}afterSetVnode(e,t){e&&this.syncVnodeTree()}afterSetVnodeInitialized(e,t){let d=this;e&&(d.fire("vnodeInitialized",d.id),d.needsVdomUpdate&&d.update())}createVdomReference(){let e=this,t={componentId:e.id},d=e.vdom.id;return d&&e.id!==d&&(t.id=d),t}async executeVdomUpdate(e,t){let o=this;e&&n.addPromiseCallback(o.id,e),o.isVdomUpdating=!0,n.registerInFlightUpdate(o.id,o.updateDepth);try{const{vdom:e,vnode:t}=o,i=n.getMergedChildIds(o.id),a={vdom:d.getVdomTree(e,o.updateDepth,i),vnode:d.getVnodeTree(t,o.updateDepth,i)};r?.isSharedWorker&&(a.appName=o.appName,a.windowId=o.windowId),o._needsVdomUpdate=!1,o.afterSetNeedsVdomUpdate?.(!1,!0),o._updateDepth=o.constructor.config.updateDepth;const s=await Promise.resolve(Neo.vdom.Helper.update(a));o.id&&(o.vnode=s.vnode,!Neo.config.useVdomWorker&&s.deltas?.length>0&&await Neo.applyDeltas(o.windowId,s.deltas),o.resolveVdomUpdate(s))}catch(e){o.isVdomUpdating=!1,n.unregisterInFlightUpdate(o.id),t?.(e)}}getMountedParentId(){let e=this.parentId,t=Neo.getComponent(e),d=t?.getVdomItemsRoot?.();return d?d.id:e}getMountedParentIndex(){let e,t=this.parent,d=t?.items||[],o=0,n=0,i=d.length;for(;o<i;o++){if(e=d[o],e===this)return n;e.hidden||"removeDom"!==e.hideMode||n++}}getVdomChild(e,t=this.vdom){return o.find(t,e)?.vdom}getVdomRoot(){return this.vdom}getVnodeRoot(){return this.vnode}hasUpdateCollision(e,t){return-1===e||t<e}async initVnode(e){let t=this,o=e||t.autoMount,{app:i}=t,{allowVdomUpdatesInTests:a,unitTestMode:s,useVdomWorker:m}=Neo.config;if(!s||a)if(s||!o||0===r.countLoadingThemeFiles){if(t.isVnodeInitializing=!0,i.vnodeInitialized||(i.isVnodeInitializing=!0),t.vdom){t.isVdomUpdating=!0,n.registerInFlightUpdate(t.id,-1),delete t.vdom.removeDom,t._needsVdomUpdate=!1,t.afterSetNeedsVdomUpdate?.(!1,!0);const e=await Promise.resolve(Neo.vdom.Helper.create({appName:t.appName,autoMount:o,parentId:o?t.getMountedParentId():void 0,parentIndex:o?t.getMountedParentIndex():void 0,vdom:d.getVdomTree(t.vdom,-1),windowId:t.windowId}));return t.onInitVnode(e.vnode,!!m&&o),o&&!m&&(await Neo.applyDeltas(t.windowId,[{action:"insertNode",id:t.id,index:t.getMountedParentIndex(),outerHTML:e.outerHTML,parentId:t.getMountedParentId(),vnode:e.vnode}]),t.mounted=!0),t.resolveVdomUpdate(),e}}else r.on("themeFilesLoaded",function(){!t.mounted&&t.initVnode(e)},t,{once:!0})}isParentUpdating(e=this.parentId,t,d=1){if("document.body"!==e){let o=this,i=Neo.getComponent(e);if(i){if(i.isVdomUpdating){const e=n.getInFlightUpdateDepth(i.id);return!!o.hasUpdateCollision(e,d)&&(Neo.config.logVdomUpdateCollisions&&console.warn("vdom parent update conflict with:",i,"for:",o),n.registerPostUpdate(i.id,o.id,t),!0)}return o.isParentUpdating(i.parentId,t,d+1)}}return!1}mergeIntoParentUpdate(e=this.parentId,t=1){if("document.body"!==e){let d=this,o=Neo.getComponent(e);if(o)return o.needsVdomUpdate&&d.hasUpdateCollision(o.updateDepth,t)?(n.registerMerged(o.id,d.id,d.updateDepth,t),!0):d.mergeIntoParentUpdate(o.parentId,t+1)}return!1}onInitVnode(e,d){let o=this,{app:n}=o;if(o.isVnodeInitializing=!1,n){n.vnodeInitialized||(n.isVnodeInitializing=!1,n.vnodeInitialized=!0,n.fire("vnodeInitialized")),o.vnode=e;let i,a=t.getChildIds(e),r=0,s=a.length;for(;r<s;r++)i=Neo.getComponent(a[r]),i&&(i.vnodeInitialized=!0);o.vnodeInitialized=!0,d&&(o.mounted=!0,n.mounted||(n.mounted=!0,n.fire("mounted")))}}promiseUpdate(){return new Promise((e,t)=>{this.updateVdom(e,t)})}resolveVdomUpdate(e){let t=this;t.isVdomUpdating=!1,n.executeCallbacks(t.id,e),n.unregisterInFlightUpdate(t.id),n.triggerPostUpdates(t.id),t.needsVdomUpdate&&t.update()}syncVdomState(e=this.vnode,t=this.vdom,d=!1){o.syncVdomState(e,t,d)}syncVnodeTree(e=this.vnode){let d,o=this,n=t.getChildren(o),a=!1,r={};o.syncVdomState(),e&&o.id!==e.id&&t.registerWrapperNode(e.id,o),n.forEach(e=>{d=i.find(o.vnode,e.vdom.id)?.vnode,d&&(r[e.id]=d,e.id!==d.id&&t.registerWrapperNode(d.id,e))}),n.forEach(e=>{d=r[e.id],d?(e._vnode=t.addVnodeComponentReferences(d,e.id),e.vnodeInitialized=!0,e.mounted=!0):console.warn("syncVnodeTree: Could not replace the child vnode for",e.id)}),o._vnode=e?t.addVnodeComponentReferences(e,o.id):null}update(){this.afterSetVdom(this.vdom,null)}updateVdom(e,t){if(!this.isConstructed)return void e?.();let d=this,{mounted:o,parentId:i,vnode:a}=d,{config:s}=Neo;if(!s.unitTestMode||s.allowVdomUpdatesInTests)if(d.isVdomUpdating||!d.vnodeInitialized||d.silentVdomUpdate)e&&n.addPromiseCallback(d.id,e),d.needsVdomUpdate=!0;else if(e&&n.addPromiseCallback(d.id,e),o){if(!d.mergeIntoParentUpdate(i)&&!d.isParentUpdating(i,e)&&o&&a){let o=n.getAdjustedUpdateDepth(d.id);null!==o&&(d.updateDepth=o),s.isMiddleware||s.unitTestMode||0===r.countLoadingThemeFiles?d.executeVdomUpdate(null,t):r.on("themeFilesLoaded",function(){d.updateVdom(e,t)},d,{once:!0})}}else d.isAwaitingMount||(d.isAwaitingMount=!0,d.mountedPromise.then(()=>{d.isAwaitingMount=!1,d.vnode&&d.update()}));else t?.()}});