import e from"../container/Base.mjs";import o from"../draggable/DragProxyContainer.mjs";class n extends e{static config={className:"Neo.dashboard.Container",ntype:"dashboard",baseCls:["neo-dashboard","neo-container"],detachedItems:new Map,detachToNewWindow:!0,dragProxyExtraCls:[],dragResortable:!0,popupConfig:null,popupUrl:null,sortGroup:null};#e=!1;#o=!1;construct(e){super.construct(e);let o=this;o.detachedItems=new Map,Neo.currentWorker.on({connect:o.onWindowConnect,disconnect:o.onWindowDisconnect,scope:o})}createSortZone(e){let n=this;Neo.merge(e,{allowOverdrag:!0,dragProxyConfig:{module:o,...n.dragProxyConfig},dragProxyExtraCls:n.dragProxyExtraCls,enableProxyToPopup:n.detachToNewWindow,listeners:{dragBoundaryEntry:e=>n.onDragBoundaryEntry(e),dragBoundaryExit:e=>n.onDragBoundaryExit(e),dragEnd:e=>n.fire("dragEnd",e)},sortGroup:n.sortGroup}),super.createSortZone(e)}getPopupUrl(e){let o=e.popupUrl||this.popupUrl;return Neo.isFunction(o)?o(e):o}loadSortZoneModule(){return import("../draggable/dashboard/SortZone.mjs")}async onDragBoundaryEntry(e){let o=this,{windowId:n}=o,{sortZone:i}=e,t=e.draggedItem,d=t.reference||t.id;o.#e=!0,console.log("onDragBoundaryEntry",o.id,t),i.dragProxy.add(t,!0),o.detachedItems.delete(d),await Neo.Main.windowClose({names:d,windowId:n}),o.#e=!1,o.#o=!1,i.isWindowDragging=!1,i.dragProxy.style={opacity:1},Neo.main.addon.DragDrop.setConfigs({isWindowDragging:!1,windowId:n}),o.fire("dragBoundaryEntry",e)}async onDragBoundaryExit(e){let o,n=this,{draggedItem:i,proxyRect:t,sortZone:d}=e;n.#o=!0,t.height+=50,o=await n.openWidgetInPopup(i,t),d.startWindowDrag({dragData:e,...o}),n.fire("dragBoundaryExit",e)}async openWidgetInPopup(e,o){let n=this,{windowId:i}=n,{windowConfigs:t}=Neo,d=Object.keys(t)[0],{basePath:a}=t[d],r=e.reference||e.id,s=n.getPopupUrl(e);if(!s)return void console.error("No popupUrl defined for dashboard item",e);s.startsWith("http")||(s=a+s),s+=`${s.includes("?")?"&":"?"}name=${r}&dashboardId=${n.id}`;let g=await Neo.Main.getWindowData({windowId:i}),{height:w,width:p,x:l,y:c}=o,u=w-50,h=l+g.screenLeft,m=c+(g.outerHeight-g.innerHeight+g.screenTop),y=r;return n.detachedItems.set(r,{index:n.items.indexOf(e),widget:e}),await Neo.Main.windowOpen({url:s,windowId:i,windowFeatures:`height=${u},left=${h},top=${m},width=${p}`,windowName:y}),{popupHeight:u,popupLeft:h,popupTop:m,popupWidth:p,windowName:y}}async onWindowConnect(e){let o=this,n=Neo.apps[e.windowId].mainView,{windowId:i}=e,t=await Neo.Main.getByPath({path:"document.URL",windowId:i}),d=new URL(t).searchParams,a=d.get("dashboardId"),r=d.get("name");if(a===o.id){let e=o.detachedItems.get(r);e&&(e.windowId=i,e.widget.wrapperStyle={},n.add(e.widget,!1,!o.#o))}}async onWindowDisconnect(e){let o=this;if(o.#o||o.#e)return void(o.#o=!1);let{windowId:n}=e;for(const[e,i]of o.detachedItems.entries())if(i.windowId===n){console.log("onWindowDisconnect: Re-integrating widget",o.id,e);let{index:n,widget:t}=i;o.insert(n,t),o.detachedItems.delete(e);break}}async resumeWindowDrag(e,o){let n,i=this,t=i.detachedItems.get(e);t&&(i.#o=!0,n=await i.openWidgetInPopup(t.widget,o),Neo.main.addon.DragDrop.startWindowDrag({popupHeight:n.popupHeight,popupName:n.windowName,popupWidth:n.popupWidth,windowId:i.windowId}))}async suspendWindowDrag(e){let o=this;o.#o=!0;let n=o.detachedItems.get(e);console.log("suspendWindowDrag",o.id,e,n),n?.widget&&(n.widget.parentId=null),await Neo.Main.windowClose({names:[e],windowId:o.windowId}),Neo.main.addon.DragDrop.setConfigs({isWindowDragging:!1,windowId:o.windowId})}}export default Neo.setupClass(n);