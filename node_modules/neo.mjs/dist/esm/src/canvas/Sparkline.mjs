import e from"../../src/core/Base.mjs";const t="function"==typeof requestAnimationFrame;export default Neo.setupClass(class extends e{static colors={dark:{fillStart:"rgba(62, 99, 221, 0.4)",fillEnd:"rgba(62, 99, 221, 0.0)",line:"#3E63DD",marker:"#3E63DD",pulseRGB:"255, 255, 255",scanner:"#FFFFFF",textYear:"#AAAAAA",textValue:"#FFFFFF"},light:{fillStart:"rgba(62, 99, 221, 0.4)",fillEnd:"rgba(62, 99, 221, 0.0)",line:"#3E63DD",marker:"#3E63DD",pulseRGB:"62, 99, 221",scanner:"#000000",textYear:"#666666",textValue:"#000000"}};static config={className:"Neo.canvas.Sparkline",remote:{app:["onMouseLeave","onMouseMove","register","unregister","updateConfig","updateData","updateSize"]},maxConcurrentTransitions:30,singleton:!0};activeItems=new Set;avgFrameTime=16;items=new Map;lastFrameTime=0;lastPulseSpawn=0;stressLevel=0;onMouseLeave(e){let t=this.items.get(e.canvasId);t&&(t.mouseActive=!1,this.draw(t))}onMouseMove(e){let t=this.items.get(e.canvasId);t&&(t.mouseActive=!0,t.mouseX=e.x,this.draw(t))}register(e){let t=this,{canvasId:a}=e,i=Neo.worker.Canvas.map[a];i&&(t.items.set(a,{canvas:i,ctx:i.getContext("2d"),devicePixelRatio:e.devicePixelRatio||1,height:i.height,id:a,mouseActive:!1,mouseX:0,pulseProgress:0,theme:e.theme||"light",usePulse:!1!==e.usePulse,useTransition:!1!==e.useTransition,width:i.width}),t.animationId||t.renderLoop())}unregister(e){let t=this,a=t.items.get(e.canvasId);a&&(t.activeItems.delete(a),t.items.delete(e.canvasId))}renderLoop(){let e=this,a=performance.now();if(e.lastFrameTime>0){let t=a-e.lastFrameTime;t<500&&(e.avgFrameTime=.95*e.avgFrameTime+.05*t,e.stressLevel=e.avgFrameTime/16)}if(e.lastFrameTime=a,a-e.lastPulseSpawn>1e3*Math.random()+200){let t=Array.from(e.items.values()).filter(t=>!e.activeItems.has(t)&&t.usePulse);if(t.length>0){let i=t[Math.floor(Math.random()*t.length)];i.pulseProgress=0,e.activeItems.add(i),e.lastPulseSpawn=a}}e.activeItems.size>0&&e.activeItems.forEach(t=>{let i=!1;if(t.isTransitioning){let e=(a-t.transitionStartTime)/t.transitionDuration;e>=1?(t.values=t.targetValues,t.isTransitioning=!1,e=1):(e=1-Math.pow(1-e,3),t.values=t.startValues.map((a,i)=>a+(t.targetValues[i]-a)*e)),t.points=null,i=!0}if(!t.usePulse&&!t.isTransitioning)return e.activeItems.delete(t),void e.draw(t);if(t.usePulse&&!t.mouseActive)if(t.pulseProgress+=.015,t.pulseProgress>=1){if(t.pulseProgress=0,!t.isTransitioning)return e.activeItems.delete(t),void e.draw(t)}else i=!0;i&&e.draw(t,{pulseProgress:t.usePulse?t.pulseProgress:void 0})}),e.animationId=t?requestAnimationFrame(e.renderLoop.bind(e)):setTimeout(e.renderLoop.bind(e),16)}updateConfig(e){let t=this,a=t.items.get(e.canvasId);a&&(void 0!==e.theme&&(a.theme=e.theme,t.draw(a)),void 0!==e.usePulse&&(a.usePulse=e.usePulse),void 0!==e.useTransition&&(a.useTransition=e.useTransition))}updateData(e){let t=this,a=t.items.get(e.canvasId);if(a){let i=t.stressLevel>1.1,s=t.activeItems.size>=t.maxConcurrentTransitions;a.useTransition&&!i&&!s&&a.values&&Array.isArray(e.values)&&a.values.length===e.values.length?(a.targetValues=e.values,a.startValues=[...a.values],a.transitionStartTime=performance.now(),a.transitionDuration=300,a.isTransitioning||(a.isTransitioning=!0,t.activeItems.add(a),t.animationId||t.renderLoop())):(a.values=e.values,a.points=null,t.draw(a))}}updateSize(e){let t=this,a=t.items.get(e.canvasId);a&&(a.devicePixelRatio=e.devicePixelRatio||a.devicePixelRatio||1,a.height=e.height,a.width=e.width,a.points=null,t.draw(a))}draw(e,t){let{ctx:a,devicePixelRatio:i,height:s,values:l,width:r,theme:n}=e,o=this.constructor.colors[n]||this.constructor.colors.light,u=t?.pulseProgress;if(void 0===u){let t=r*i,l=s*i;e.canvas.width!==t||e.canvas.height!==l?(e.canvas.width=t,e.canvas.height=l,a.scale(i,i)):a.clearRect(0,0,r,s)}else a.clearRect(0,0,r,s);if(!Array.isArray(l)||l.length<2)return;let d=l.length,m=Math.max(...l),c=Math.min(...l),h=m-c||1,g=s-12,v=(r-8)/(d-1);e.points||(e.points=[],e.totalLength=0,l.forEach((t,a)=>{let i=4+a*v,l=s-6-(t-c)/h*g,r={x:i,y:l,val:t,year:2010+a,dist:0,accumDist:0};if(a>0){let t=e.points[a-1],s=i-t.x,n=l-t.y;r.dist=Math.sqrt(s*s+n*n),e.totalLength+=r.dist,r.accumDist=e.totalLength,r.color=l<t.y?"#3E63DD":l>t.y?"#FF4444":"#3E63DD"}e.points.push(r)}),e.points.forEach(t=>{t.normalizedPos=t.accumDist/(e.totalLength||1)}));let f=e.points,p=a.createLinearGradient(0,0,0,s);p.addColorStop(0,o.fillStart),p.addColorStop(1,o.fillEnd),a.beginPath(),a.moveTo(f[0].x,s),a.lineTo(f[0].x,f[0].y);for(let e=0;e<d-1;e++){let t=f[e],i=f[e+1],s=(t.x+i.x)/2,l=(t.y+i.y)/2;e===d-2?a.quadraticCurveTo(t.x,t.y,i.x,i.y):a.quadraticCurveTo(t.x,t.y,s,l)}a.lineTo(f[d-1].x,s),a.closePath(),a.fillStyle=p,a.fill(),a.beginPath(),a.moveTo(f[0].x,f[0].y);for(let e=0;e<d-1;e++){let t=f[e],i=f[e+1],s=(t.x+i.x)/2,l=(t.y+i.y)/2;e===d-2?a.quadraticCurveTo(t.x,t.y,i.x,i.y):a.quadraticCurveTo(t.x,t.y,s,l)}if(a.strokeStyle=o.line,a.lineWidth=1,a.lineCap="round",a.lineJoin="round",a.stroke(),e.mouseActive){let t=1/0,i=null;if(f.forEach(a=>{let s=Math.abs(a.x-e.mouseX);s<t&&(t=s,i=a)}),i){a.beginPath(),a.moveTo(i.x,0),a.lineTo(i.x,s),a.strokeStyle=o.scanner,a.lineWidth=1,a.setLineDash([2,2]),a.stroke(),a.setLineDash([]),a.beginPath(),a.arc(i.x,i.y,3,0,2*Math.PI),a.fillStyle=o.scanner,a.fill(),a.beginPath(),a.arc(i.x,i.y,1.5,0,2*Math.PI),a.fillStyle=o.line,a.fill(),a.font="bold 10px sans-serif";let e=10,t=i.x;t>r-50?(a.textAlign="right",t-=6):(a.textAlign="left",t+=6),a.fillStyle=o.textYear,a.fillText(String(i.year),t,e);let l=(new Intl.NumberFormat).format(i.val);a.fillStyle=o.textValue,a.fillText(l,t,e+12)}}else if(void 0!==u){let e=0;for(let t=1;t<f.length;t++)if(u<=f[t].normalizedPos){e=t-1;break}let t=f[e],i=f[e+1];i||(t=f[f.length-2],i=f[f.length-1]);let s=i.normalizedPos-t.normalizedPos,l=0===s?0:(u-t.normalizedPos)/s,r=t.x+(i.x-t.x)*l,n=t.y+(i.y-t.y)*l,d=i.color||"#FFFFFF";if(t.val===m||i.val===m){let e=t.val===m?t:i,s=r-e.x,l=n-e.y,u=Math.sqrt(s*s+l*l);if(u<10){let t=1-u/10;a.beginPath(),a.arc(e.x,e.y,10,0,2*Math.PI),a.fillStyle=`rgba(${o.pulseRGB}, ${.5*t})`,a.fill()}}let c=a.createRadialGradient(r,n,0,r,n,6);c.addColorStop(0,`rgba(${o.pulseRGB}, 1)`),c.addColorStop(.4,`rgba(${o.pulseRGB}, 0.4)`),c.addColorStop(1,`rgba(${o.pulseRGB}, 0)`),a.beginPath(),a.arc(r,n,6,0,2*Math.PI),a.fillStyle=c,a.fill(),a.beginPath(),a.arc(r,n,1.5,0,2*Math.PI),a.fillStyle=d,a.fill()}}});