import e from"../Neo.mjs";import s from"./Base.mjs";import t from"../controller/Application.mjs";import a from"../manager/Instance.mjs";import n from"../manager/DomEvent.mjs";import o from"../util/HashHistory.mjs";export default e.setupClass(class extends s{static config={className:"Neo.worker.App",countLoadingThemeFiles_:0,remote:{main:["createNeoInstance","destroyNeoInstance","fireEvent","getConfigs","loadModule","setConfigs","setGlobalConfig"]},singleton:!0};themeFilesCache=[];workerId="app";construct(s){super.construct(s);let t=this;e.applyDeltas=t.applyDeltas.bind(t),e.setCssVariable=t.setCssVariable.bind(t)}afterSetCountLoadingThemeFiles(e,s){0===e&&void 0!==s&&this.fire("themeFilesLoaded")}applyDeltas(e,s){return this.promiseMessage("main",{action:"updateDom",deltas:s,windowId:e})}async createNeoInstance(s){try{s.importPath&&(await import(s.importPath),delete s.importPath);let t,a,n,o=Object.values(e.apps)[0]?.name,i=e.container?.Base;return(s={appName:o,...s}).parentId?(n=e.getComponent(s.parentId),i&&n&&n instanceof i&&(t=s.parentIndex,delete s.parentId,delete s.parentIndex,a=e.isNumber(t)?n.insert(t,s):n.add(s))):(s.autoInitVnode=!0,s.autoMount=!0,a=e[s.ntype?"ntype":"create"](s)),{success:!0,id:a.id}}catch(e){return console.error("Error in createNeoInstance:",e),{success:!1,error:{className:e.name,message:e.message,stack:e.stack}}}}createThemeMap(s){e.ns("Neo.cssMap.fileInfo",!0),e.cssMap.fileInfo=s;let{config:t}=e;t.useSSR&&t.cssMap&&(Object.assign(e.cssMap,t.cssMap),delete t.cssMap),this.resolveThemeFilesCache()}destroyNeoInstance(s){try{let t,a=e.get(s);return a?a.parentId&&(t=e.getComponent(a.parentId),t)?(t.remove(a),{success:!0}):(a.destroy(!0,!0),{success:!0}):{success:!1,error:{message:`Instance with id ${s} not found`}}}catch(e){return console.error(`Error in destroyNeoInstance for id: ${s}`,e),{success:!1,error:{className:e.name,message:e.message,stack:e.stack}}}}fireEvent(s){let t,a=e.get(s.id);return!!a&&(t=s.name,delete s.id,delete s.name,a.fire(t,s),!0)}fireMainViewsEvent(s,t){this.ports.forEach(a=>{a.windowId&&e.apps[a.windowId]&&e.apps[a.windowId].mainView.fire(s,t)})}async getAddon(s,t){let a=e.main?.addon?.[s];return a||(await e.Main.importAddon({name:s,windowId:t}),a=e.main.addon[s]),a}getConfigs(s){let t=e.get(s.id),{keys:a}=s,n=[];return!!t&&(Array.isArray(a)?(a.forEach(e=>{n.push(t[e])}),n):t[a])}importApp(e){return e.endsWith(".mjs")&&(e=e.slice(0,-4)),import(`../../${e}.mjs`)}insertThemeFiles(s,t,a){if(e.config.themes.length>0){a=a||t.className;let n,o,i,r,d,c,m,p=this,l=e.cssMap,h=t?.__proto__;l?(a.startsWith("Neo.")||(o=(a=a.split(".")).shift(),r=o.toLowerCase(),"view"===a[0]&&a.shift(),d=`apps.${e.apps[o]?.appThemeFolder||r}.${a.join(".")}`,a=`apps.${r}.${a.join(".")}`),h&&h!==e.core.Base.prototype&&(e.ns(`${s}.${h.className}`,!1,l)||p.insertThemeFiles(s,h)),m=e.ns(d||a,!1,l.fileInfo),m&&!e.ns(`${s}.${a}`,!1,l)&&(n=a.split("."),i=n.pop(),n=n.join("."),c=e.ns(`${s}.${n}`,!0,l),c[i]=!0,p.countLoadingThemeFiles++,e.main.addon.Stylesheet.addThemeFiles({className:d||a,folders:m,windowId:s}).then(()=>{p.countLoadingThemeFiles--}))):p.themeFilesCache.push([s,t])}}async loadModule({path:e}){try{return await import(e),{success:!0,path:e}}catch(s){return console.error(`Failed to load module via RMA: ${e}`,s),{success:!1,path:e,error:s}}}onDomEvent(e){n.fire(e)}onHashChange(e){o.push(e.data)}onLoadApplication(s){let t=this,{config:a}=e,{appPath:n}=a;"development"!==a.environment&&(n=n.startsWith("/")?n.substring(1):n),t.importApp(n).then(e=>{e.onStart(),a.hash&&t.timeout(5).then(()=>{o.push(a.hash),delete a.hash})})}onOrientationChange(s){Object.values(e.apps).forEach(e=>{e.fire("orientationchange",s.data)})}onRegisterNeoConfig(s){super.onRegisterNeoConfig(s);let{config:t}=e,{data:a}=s,n="resources/theme-map.json";e.windowConfigs=e.windowConfigs||{},e.windowConfigs[a.windowId]=a,"development"!==t.environment&&"dist/esm"!==t.environment||(n=`../../${n}`),t.workerBasePath?.includes("node_modules")&&(n=`../../${n}`),"."!==n[0]&&(n=`./${n}`),fetch(n).then(e=>e.json()).then(e=>{this.createThemeMap(e)}),t.remotesApiUrl&&import("../remotes/Api.mjs").then(e=>e.default.load()),!t.useVdomWorker&&import("../vdom/Helper.mjs")}onRegisterPort(e){let s=this,t=e.transfer;t.onmessage=s.onMessage.bind(s),s.channelPorts[e.origin]=t}onVisibilityChange(s){Object.values(e.apps).forEach(e=>{e.windowId===s.data.windowId&&e.fire("visibilitychange",s.data)})}onWindowPositionChange(e){this.fireMainViewsEvent("windowPositionChange",e.data)}registerApp(e){this.onRegisterApp({appName:e}),this.sendMessage("main",{action:"registerAppName",appName:e})}removeAppFromThemeMap(s){delete e.cssMap[s.toLowerCase()]}resolveThemeFilesCache(){let e=this;e.themeFilesCache.forEach(s=>{e.insertThemeFiles(...s)}),e.themeFilesCache=[]}setConfigs(s){try{let t=e.get(s.id);return t?(delete s.id,t.set(s),{success:!0}):{success:!1,error:{message:`Instance with id ${s.id} not found`}}}catch(e){return console.error(`Error in setConfigs for id: ${s.id}`,e),{success:!1,error:{className:e.name,message:e.message,stack:e.stack}}}}async setCssVariable(s){let t=await this.getAddon("Stylesheet",s.windowId),a=s.theme||e.config.themes?.[0];return a.startsWith("neo-")&&(a=a.substring(4)),t.setCssVariable({theme:a,...s})}});