import e from"../Neo.mjs";import t from"./Base.mjs";import s from"../controller/Application.mjs";import n from"../manager/Instance.mjs";import o from"../manager/DomEvent.mjs";import a from"../util/HashHistory.mjs";class i extends t{static config={className:"Neo.worker.App",countLoadingThemeFiles_:0,id:crypto.randomUUID(),remote:{main:["createNeoInstance","destroyNeoInstance","fireEvent","getConfigs","loadModule","setConfigs","setGlobalConfig"]},singleton:!0};themeFilesCache=[];workerId="app";construct(t){super.construct(t);let s=this;e.apps??={},e.appsByName??={},e.applyDeltas=s.applyDeltas.bind(s),e.setCssVariable=s.setCssVariable.bind(s),s.interceptConsole()}afterSetCountLoadingThemeFiles(e,t){0===e&&void 0!==t&&this.fire("themeFilesLoaded")}applyDeltas(e,t){return Array.isArray(t)||(t=[t]),this.promiseMessage(e,{action:"updateVdom",deltas:t})}async createNeoInstance(t){try{t.importPath&&(await import(t.importPath),delete t.importPath);let s,n,o,a=Object.values(e.apps)[0]?.name,i=e.container?.Base;return(t={appName:a,...t}).parentId?(o=e.getComponent(t.parentId),i&&o&&o instanceof i&&(s=t.parentIndex,delete t.parentId,delete t.parentIndex,n=e.isNumber(s)?o.insert(s,t):o.add(t))):(t.autoInitVnode=!0,t.autoMount=!0,n=e[t.ntype?"ntype":"create"](t)),{success:!0,id:n.id}}catch(e){return console.error("Error in createNeoInstance:",e),{success:!1,error:{className:e.name,message:e.message,stack:e.stack}}}}createThemeMap(t){e.ns("Neo.cssMap.fileInfo",!0),e.cssMap.fileInfo=t;let{config:s}=e;s.useSSR&&s.cssMap&&(Object.assign(e.cssMap,s.cssMap),delete s.cssMap),this.resolveThemeFilesCache()}destroyNeoInstance(t){try{let s,n=e.get(t);return n?n.parentId&&(s=e.getComponent(n.parentId),s)?(s.remove(n),{success:!0}):(n.destroy(!0,!0),{success:!0}):{success:!1,error:{message:`Instance with id ${t} not found`}}}catch(e){return console.error(`Error in destroyNeoInstance for id: ${t}`,e),{success:!1,error:{className:e.name,message:e.message,stack:e.stack}}}}fireEvent(t){let s,n=e.get(t.id);return!!n&&(s=t.name,delete t.id,delete t.name,n.fire(s,t),!0)}fireMainViewsEvent(t,s){this.ports.forEach(n=>{n.windowId&&e.apps[n.windowId]&&e.apps[n.windowId].mainView.fire(t,s)})}async getAddon(t,s){let n=e.main?.addon?.[t];return n||(await e.Main.importAddon({name:t,windowId:s}),e.main.addon[t])}getConfigs(t){let s=e.get(t.id),{keys:n}=t,o=[];return!!s&&(Array.isArray(n)?(n.forEach(e=>{o.push(s[e])}),o):s[n])}importApp(e){return e.endsWith(".mjs")&&(e=e.slice(0,-4)),import(`../../${e}.mjs`)}interceptConsole(){["log","warn","error","info"].forEach(t=>{const s=console[t];console[t]=(...n)=>{s.apply(console,n);const o=e.ai?.Client;if(o)try{const e=n.map(e=>{if(e instanceof Error)return e.message+"\n"+e.stack;if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}).join(" "),s={type:t,message:e,timestamp:Date.now(),stack:"error"===t?(new Error).stack:void 0};o.isConnected?o.sendNotification("console_log",s):o.logs.push(s)}catch(e){}}});const t=globalThis.onerror;globalThis.onerror=(s,n,o,a,i)=>{const r=e.ai?.Client;if(r){const e={type:"error",message:s,timestamp:Date.now(),stack:i?.stack};r.isConnected?r.sendNotification("console_log",e):r.logs.push(e)}return!!t&&t(s,n,o,a,i)}}insertThemeFiles(t,s,n){if(e.config.themes.length>0){n=n||s.className;let o,a,i,r,c,d,p,m=this,l=e.cssMap,h=s?.__proto__;l?(n.startsWith("Neo.")||(a=(n=n.split(".")).shift(),r=a.toLowerCase(),"view"===n[0]&&n.shift(),c=`apps.${e.apps[a]?.appThemeFolder||r}.${n.join(".")}`,n=`apps.${r}.${n.join(".")}`),s?.additionalThemeFiles?.forEach(e=>{m.insertThemeFiles(t,null,e)}),h&&h!==e.core.Base.prototype&&(e.ns(`${t}.${h.className}`,!1,l)||m.insertThemeFiles(t,h)),p=e.ns(c||n,!1,l.fileInfo),p&&!e.ns(`${t}.${n}`,!1,l)&&(o=n.split("."),i=o.pop(),o=o.join("."),d=e.ns(`${t}.${o}`,!0,l),d[i]=!0,m.countLoadingThemeFiles++,e.main.addon.Stylesheet.addThemeFiles({className:c||n,folders:p,windowId:t}).then(()=>{m.countLoadingThemeFiles--}))):m.themeFilesCache.push([t,s,n])}}async loadModule({path:e}){try{return await import(e),{success:!0,path:e}}catch(t){return console.error(`Failed to load module via RMA: ${e}`,t),{success:!1,path:e,error:t}}}async onConnect(t){this.aiClientPromise&&await this.aiClientPromise,await this.timeout(10);let s,{appName:n,windowId:o}=t;try{s=await e.Main.getWindowData({windowId:o})}catch(e){console.error("onConnect: getWindowData failed",e)}this.fire("connect",{appName:n,windowData:s,windowId:o})}onDomEvent(e){o.fire(e)}onHashChange(e){a.push(e.data)}onLoadApplication(t){let s=this,{config:n}=e,{appPath:o}=n;"development"!==n.environment&&(o=o.startsWith("/")?o.substring(1):o),s.importApp(o).then(e=>{e.onStart(),n.hash&&s.timeout(5).then(()=>{a.push(n.hash),delete n.hash})})}onOrientationChange(t){e.apps[t.windowId]?.fire("orientationchange",t.data)}onRegisterNeoConfig(t){super.onRegisterNeoConfig(t),e.config.useSharedWorkers&&import("../manager/Window.mjs");let{config:s}=e,{data:n}=t,o="resources/theme-map.json";if(e.windowConfigs=e.windowConfigs||{},e.windowConfigs[n.windowId]=e.clone(n,!0),"development"!==s.environment&&"dist/esm"!==s.environment||(o=`../../${o}`),s.workerBasePath?.includes("node_modules")&&(o=`../../${o}`),"."!==o[0]&&(o=`./${o}`),fetch(o).then(e=>e.json()).then(e=>{this.createThemeMap(e)}),s.remotesApiUrl&&import("../remotes/Api.mjs").then(e=>e.default.load()),s.useAiClient&&!s.isGitHubPages){let{environment:e,useAiClient:t}=s,n=!0===t;n||(Array.isArray(t)?n=t.includes(e):"string"==typeof t&&(n=t===e)),n&&(this.aiClientPromise=import("../ai/Client.mjs"))}!s.useVdomWorker&&import("../vdom/Helper.mjs")}onRegisterPort(e){let t=this,s=e.transfer;s.onmessage=t.onMessage.bind(t),t.channelPorts[e.origin]=s}onVisibilityChange(t){e.apps[t.data.windowId]?.fire("visibilitychange",t.data)}onWindowPositionChange({data:t}){e.manager.Window?.onWindowPositionChange(t),this.fireMainViewsEvent("windowPositionChange",t)}registerApp(e,t){this.onRegisterApp({appName:e}),this.sendMessage(t,{action:"registerAppName",appName:e})}removeAppFromThemeMap(t){delete e.cssMap[t.toLowerCase()]}resolveThemeFilesCache(){let e=this;e.themeFilesCache.forEach(t=>{e.insertThemeFiles(...t)}),e.themeFilesCache=[]}setConfigs(t){try{let s=e.get(t.id);return s?(delete t.id,s.set(t),{success:!0}):{success:!1,error:{message:`Instance with id ${t.id} not found`}}}catch(e){return console.error(`Error in setConfigs for id: ${t.id}`,e),{success:!1,error:{className:e.name,message:e.message,stack:e.stack}}}}async setCssVariable(t){let s=await this.getAddon("Stylesheet",t.windowId),n=t.theme||e.config.themes?.[0];return n.startsWith("neo-")&&(n=n.substring(4)),s.setCssVariable({theme:n,...t})}}export default e.setupClass(i);