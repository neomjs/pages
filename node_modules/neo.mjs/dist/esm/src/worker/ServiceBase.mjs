import e from"../core/Base.mjs";import s from"./Message.mjs";import t from"./mixin/RemoteMethodAccess.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.worker.ServiceBase",cacheName_:"neo-runtime",mixins:[t],reloadOn404:!0,remote:{app:["clearCache","clearCaches","preloadAssets","removeAssets"]}};cachePaths=["raw.githubusercontent.com/","/dist/esm/","/dist/production/","/fontawesome","/node_modules","/resources/"];channelPorts=null;lastClient=null;lastReload=null;networkFirstPaths=["DefaultConfig.mjs","neo-config.json"];promises=[];remotes=[];remotesToRegister=[];workerId=null;construct(e){super.construct(e);let s=this,t=e=>s[e].bind(s);s.channelPorts=[],Object.assign(globalThis,{onactivate:t("onActivate"),onfetch:t("onFetch"),oninstall:t("onInstall"),onmessage:t("onMessage")}),Neo.currentWorker=s,Neo.workerId=s.workerId}beforeGetCacheName(e){return e+"-"+this.version}async cleanUpCaches(){let e,s=this,t=await caches.keys();for(e of t)e.startsWith(s._cacheName)&&e!==s.cacheName&&(console.log("Deleting old cache:",e),await s.clearCache(e))}async clearCache(e=this.cacheName){return await caches.delete(e),{success:!0}}async clearCaches(){let e=await caches.keys();return await Promise.all(e.map(e=>caches.delete(e))),{success:!0}}createMessageChannel(e){let s=this,t=new MessageChannel,{port1:a,port2:o}=t;a.onmessage=s.onMessage.bind(s),s.remotesToRegister.forEach(e=>{a.postMessage({action:"registerRemote",className:e.className,methods:e.methods})}),s.sendMessage("app",{action:"registerPort",transfer:o},[o]),s.channelPorts.push({clientId:e.id,destination:"app",port:a})}getPort(e,s=this.lastClient?.id){for(let t of this.channelPorts)if(s===t.clientId&&e===t.destination)return t.port;return null}hasWorker(e){return!!this.getPort(e)||!!this.lastClient}initRemote(){let e=this,s=e.lastClient?.id;s&&!e.remotes.includes(s)&&(e.remotes.push(s),super.initRemote())}async on404(e){let s=this;if(s.reloadOn404){let t=e.request.url;if(t.includes("/dist/production/")||t.includes("/dist/esm/")||t.includes("/src/")){let a=Date.now();if(!s.lastReload||a-s.lastReload>5e3){s.lastReload=a;let o=await clients.get(e.clientId);o&&(console.warn("Neo: 404 on guarded asset. Reloading.",t),o.postMessage({action:"remoteMethod",data:{force:!0},remoteClassName:"Neo.Main",remoteMethod:"reloadWindow"}))}}}}onActivate(e){console.log("Neo ServiceWorker activated:",this.version),e.waitUntil(globalThis.clients.claim()),this.cleanUpCaches()}async onConnect(e){this.createMessageChannel(e),this.initRemote()}onFetch(e){let s,t=this,a=!1,o=!1,{request:n}=e;for(s of t.networkFirstPaths)if(n.url.includes(s)){o=!0;break}if(o&&"GET"===n.method)e.respondWith(fetch(n,{cache:"reload"}).then(e=>{if(e.ok){const s=e.clone();caches.open(t.cacheName).then(e=>{e.put(n,s).catch(()=>{})})}return e}).catch(()=>caches.match(n)));else{for(s of t.cachePaths)if(n.url.includes(s)){a=!0;break}a&&"GET"===n.method&&e.respondWith(caches.open(t.cacheName).then(s=>s.match(n).then(a=>a||fetch(n).then(a=>{if(a.ok||0===a.status){const e=a.clone();s.put(n,e).catch(()=>{})}else 404===a.status&&t.on404(e);return a}))))}}onGetVersion(e,s){this.resolve({version:this.version},e)}onInstall(e){console.log("Neo ServiceWorker installed:",this.version),e.waitUntil(globalThis.skipWaiting())}onMessage(e){let s,t=this,{data:a}=e,{action:o,replyId:n}=a;if(e.source&&(t.lastClient=e.source),!o)throw new Error("Message action is missing: "+a.id);if("reply"!==o){const s=t["on"+Neo.capitalize(o)];if(s){const o=s.call(t,a,e);o instanceof Promise&&e.waitUntil&&e.waitUntil(o)}}else(s="reply"===o&&t.promises[n])&&(s[a.reject?"reject":"resolve"](a.data),delete t.promises[n])}onPing(e,s){this.resolve(e,{originMsg:e})}async onRegisterNeoConfig(e,s){this.onConnect(s.source)}async onSkipWaiting(e,s){await globalThis.skipWaiting()}onUnregisterPort(e,s){for(let[e,t]of this.channelPorts.entries())if(t.clientId===s.source.id){this.channelPorts.splice(e,1);break}}async preloadAssets(e){let s,t,a,o=e.cacheName||this.cacheName,n=await caches.open(o),{files:i}=e,r=[],c=[];for(a of(Array.isArray(i)||(i=[i]),i))t=!1,e.forceReload||(s=await n.match(a),t=!!s),!t&&c.push(a);return c.length>0&&await Promise.all(c.map(e=>fetch(e).then(s=>{if(s.ok||0===s.status)return n.put(e,s);r.push(e)}).catch(()=>{r.push(e)}))),{failed:r,ratio:i.length>0?(i.length-r.length)/i.length:1,success:0===r.length}}promiseMessage(e,s,t){let a=this;return new Promise(function(o,n){let i=a.sendMessage(e,s,t).id;a.promises[i]={reject:n,resolve:o}})}async removeAssets(e){Neo.isObject(e)||(e={assets:e});let{assets:s,options:t={}}=e,a=e.cacheName||this.cacheName,o=await caches.open(a),n=[];return Array.isArray(s)||(s=[s]),s.forEach(e=>{n.push(o.delete(e,t))}),await Promise.all(n),{success:!0}}sendMessage(e,t,a){t.destination=e;let o=new s(t);return(this.getPort(e)||this.lastClient).postMessage(o,a),o}});