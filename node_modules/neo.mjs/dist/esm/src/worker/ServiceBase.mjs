import e from"../core/Base.mjs";import s from"./Message.mjs";import t from"./mixin/RemoteMethodAccess.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.worker.ServiceBase",cacheName_:"neo-runtime",mixins:[t],remote:{app:["clearCache","clearCaches","preloadAssets","removeAssets"]}};cachePaths=["raw.githubusercontent.com/","/dist/esm/","/dist/production/","/fontawesome","/node_modules","/resources/"];channelPorts=null;lastClient=null;promises=[];remotes=[];remotesToRegister=[];workerId=null;construct(e){super.construct(e);let s=this,t=e=>s[e].bind(s);s.channelPorts=[],Object.assign(globalThis,{onactivate:t("onActivate"),onfetch:t("onFetch"),oninstall:t("onInstall"),onmessage:t("onMessage")}),Neo.currentWorker=s,Neo.workerId=s.workerId}beforeGetCacheName(e){return e+"-"+this.version}async clearCache(e=this.cacheName){return await caches.delete(e),{success:!0}}async clearCaches(){let e=await caches.keys();return await Promise.all(e.map(e=>caches.delete(e))),{success:!0}}createMessageChannel(e){let s=this,t=new MessageChannel,{port1:a,port2:o}=t;a.onmessage=s.onMessage.bind(s),s.remotesToRegister.forEach(e=>{a.postMessage({action:"registerRemote",className:e.className,methods:e.methods})}),s.sendMessage("app",{action:"registerPort",transfer:o},[o]),s.channelPorts.push({clientId:e.id,destination:"app",port:a})}getPort(e,s=this.lastClient?.id){for(let t of this.channelPorts)if(s===t.clientId&&e===t.destination)return t.port;return null}hasWorker(e){return!!this.getPort(e)||!!this.lastClient}initRemote(){let e=this,s=e.lastClient?.id;s&&!e.remotes.includes(s)&&(e.remotes.push(s),super.initRemote())}onActivate(e){e.waitUntil((async()=>{await globalThis.clients.claim(),console.log("Neo ServiceWorker activated:",this.version);let e,s=this,t=await caches.keys();for(e of t)e.startsWith(s._cacheName)&&e!==s.cacheName&&await s.clearCache(e)})())}async onConnect(e){this.createMessageChannel(e),this.initRemote()}onFetch(e){let s,t=!1,{request:a}=e;for(s of this.cachePaths)if(a.url.includes(s)){t=!0;break}t&&"GET"===a.method&&e.respondWith(caches.open(this.cacheName).then(e=>e.match(a).then(s=>s||fetch(a).then(s=>((s.ok||0===s.status)&&e.put(a,s.clone()),s)))))}onInstall(e){console.log("Neo ServiceWorker installed:",this.version),e.waitUntil(globalThis.skipWaiting())}onMessage(e){let s,t=this,{data:a}=e,{action:o,replyId:i}=a;if(e.source&&(t.lastClient=e.source),!o)throw new Error("Message action is missing: "+a.id);if("reply"!==o){const s=t["on"+Neo.capitalize(o)];if(s){const o=s.call(t,a,e);o instanceof Promise&&e.waitUntil&&e.waitUntil(o)}}else(s="reply"===o&&t.promises[i])&&(s[a.reject?"reject":"resolve"](a.data),delete t.promises[i])}onPing(e,s){this.resolve(e,{originMsg:e})}async onRegisterNeoConfig(e,s){this.onConnect(s.source)}async onSkipWaiting(e,s){await globalThis.skipWaiting()}onUnregisterPort(e,s){for(let[e,t]of this.channelPorts.entries())if(t.clientId===s.source.id){this.channelPorts.splice(e,1);break}}async preloadAssets(e){let s,t,a,o=e.cacheName||this.cacheName,i=await caches.open(o),{files:n}=e,r=[],c=[];for(a of(Array.isArray(n)||(n=[n]),n))t=!1,e.forceReload||(s=await i.match(a),t=!!s),!t&&c.push(a);return c.length>0&&await Promise.all(c.map(e=>fetch(e).then(s=>{if(s.ok||0===s.status)return i.put(e,s);r.push(e)}).catch(()=>{r.push(e)}))),{failed:r,ratio:n.length>0?(n.length-r.length)/n.length:1,success:0===r.length}}promiseMessage(e,s,t){let a=this;return new Promise(function(o,i){let n=a.sendMessage(e,s,t).id;a.promises[n]={reject:i,resolve:o}})}async removeAssets(e){Neo.isObject(e)||(e={assets:e});let{assets:s,options:t={}}=e,a=e.cacheName||this.cacheName,o=await caches.open(a),i=[];return Array.isArray(s)||(s=[s]),s.forEach(e=>{i.push(o.delete(e,t))}),await Promise.all(i),{success:!0}}sendMessage(e,t,a){t.destination=e;let o=new s(t);return(this.getPort(e)||this.lastClient).postMessage(o,a),o}});