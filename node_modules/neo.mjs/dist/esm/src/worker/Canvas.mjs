import e from"../Neo.mjs";import a from"./Base.mjs";export default e.setupClass(class extends a{static config={className:"Neo.worker.Canvas",canvasWindowMap:{},map:{},remote:{app:["loadModule","registerCanvas","retrieveCanvas","unregisterCanvas"]},singleton:!0};workerId="canvas";afterConnect(){let e=this,a=new MessageChannel,{port1:n,port2:s}=a;n.onmessage=e.onMessage.bind(e),e.sendMessage("app",{action:"registerPort",transfer:s},[s]),e.channelPorts.app=n}async loadModule({path:e}){try{return await import(`../../${e}`),{success:!0,path:e}}catch(a){return console.error(`Canvas Worker: Failed to load module ${e}`,a),{success:!1,path:e,error:a.message}}}registerCanvas(e){let a=this;return e.windowId&&(a.canvasWindowMap[e.nodeId]??={},a.canvasWindowMap[e.nodeId][e.windowId]=e.node),a.map[e.nodeId]=e.node,!0}retrieveCanvas(e){let a=this,n=a.canvasWindowMap[e.nodeId]?.[e.windowId];return n&&(a.map[e.nodeId]=n),{hasCanvas:!!n}}unregisterCanvas(e){let a=this;delete a.map[e.nodeId],a.canvasWindowMap[e.nodeId]&&delete a.canvasWindowMap[e.nodeId]}onRegisterNeoConfig(a){if(super.onRegisterNeoConfig(a),e.config.useCanvasWorkerStartingPoint){let a=e.config.appPath;a.endsWith(".mjs")&&(a=a.slice(0,-8)),import(`../../${a}/canvas.mjs`).then(e=>{e.onStart()})}}});