import e from"../util/ClassSystem.mjs";import t from"./Base.mjs";import n from"../selection/DateSelectorModel.mjs";import a from"../util/Date.mjs";import o from"../util/Array.mjs";import r from"../util/VDom.mjs";const l=new Date,c=l.getDate(),s=l.getMonth(),i=l.getFullYear();class d extends t{static config={className:"Neo.component.DateSelector",ntype:"dateselector",baseCls:["neo-dateselector"],cachedUpdate:null,currentDate_:null,dateFormat:"Y-m-d",dayNameFormat_:"short",intlFormat_day:null,isUpdating_:!1,keys:{},locale_:Neo.config.locale,maxValue_:null,minValue_:null,mouseWheelDelta:1,scrollNewYearFromTop:!1,selectionModel_:null,showCellBorders_:!1,showDisabledDays_:!0,showWeekends_:!0,useAnimations:!0,value_:a.convertToyyyymmdd(l),weekStartDay_:0,_vdom:{tabIndex:-1,cn:[{cls:["neo-dateselector-header"],cn:[{cls:["neo-nav-button","neo-prev-button"]},{cls:["neo-center-region"],cn:[{cls:["neo-month-text"]},{cls:["neo-year-text"]}]},{cls:["neo-nav-button","neo-next-button"]}]},{cls:["neo-dateselector-content"],cn:[]}]}};construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onComponentClick,scope:t},{wheel:t.onComponentWheel,scope:t}])}afterSetCurrentDate(e,t){let n,o,r,l,c,s=this,{id:i,windowId:d}=s;s.mounted?(n=e.getDate()-t.getDate(),l=e.getMonth()-t.getMonth(),c=e.getFullYear()-t.getFullYear(),0!==l?(o="changeMonth",r=[l,c]):0!==c?(o="changeYear",r=[c]):0!==n&&s.selectionModel.select(i+"__"+a.convertToyyyymmdd(e)),o&&(s.containsFocus?Neo.main.DomAccess.focus({id:i,windowId:d}).then((e=>{s[o](...r)})):s[o](...r))):e&&(s.updateHeaderMonth(0,0,!0),s.updateHeaderYear(0,!0),s.recreateDayViewContent(!1,!1)),void 0!==t&&s.fire("dateChange",{component:s,oldValue:t,value:e})}afterSetDayNameFormat(e,t){this.updateHeaderDays(e,t)}afterSetIsUpdating(e,t){if(!1===e){let e=this;e.cachedUpdate&&e.cachedUpdate!==new Date(`${e.value}T12:00:00.000Z`)&&e.afterSetValue(e.value,a.convertToyyyymmdd(e.cachedUpdate)),e.cachedUpdate=null}}afterSetLocale(e,t){if(void 0!==t){let e=this,t=new Intl.DateTimeFormat(e.locale,{month:"short"});e.updateHeaderDays(e.dayNameFormat,"",!0),e.getHeaderMonthEl().html=t.format(e.currentDate),e.update()}}afterSetMaxValue(e,t){void 0!==t&&this.recreateDayViewContent()}afterSetMinValue(e,t){void 0!==t&&this.recreateDayViewContent()}afterSetShowCellBorders(e,t){let{cls:n}=this;o.toggle(n,"neo-hide-inner-borders",!e),this.cls=n}afterSetShowDisabledDays(e,t){void 0!==t&&this.recreateDayViewContent()}afterSetShowWeekends(e,t){if(void 0!==t){let t,n,a=this,o=7;a.getCenterContentEl().cn.forEach(((a,r)=>{if(r>0)for(t=0;t<o;t++)n=a.cn[t],n.cls.includes("neo-weekend")&&(e?delete n.removeDom:n.removeDom=!0)})),a.updateHeaderDays(a.dayNameFormat,"")}}afterSetSelectionModel(e,t){void 0!==t&&e.register(this)}afterSetValue(e,t){let n=this;e&&(n.isUpdating?n.cacheUpdate():(n.currentDate=new Date(`${e}T12:00:00.000Z`),n.fire("change",{component:n,oldValue:t,value:e})))}afterSetWeekStartDay(e,t){void 0!==t&&this.recreateDayViewContent(!1,!1)}beforeSetDayNameFormat(e,t){return this.beforeSetEnumValue(e,t,"dayNameFormat",a.prototype.dayNameFormats)}beforeSetSelectionModel(t,a){return a&&a.destroy(),e.beforeSetInstance(t,n)}beforeSetValue(e,t){return"Date"===Neo.typeOf(e)?a.convertToyyyymmdd(e):e}beforeSetWeekStartDay(e,t){return this.beforeSetEnumValue(e,t,"weekStartDay",a.prototype.weekStartDays)}cacheUpdate(e=this.currentDate){this.cachedUpdate=e}changeMonth(e,t){let n,a,o,r=this,l=t>0?"right":t<0||e<0?"left":"right";r.useAnimations?r.isUpdating?r.cacheUpdate():(r.isUpdating=!0,r.getDomRect([r.getCenterContentEl().id,r.getHeaderMonthEl().id]).then((c=>{a=r.vdom,o="right"===l?0:-c[0].width,a.cn.push({cls:["neo-relative"],cn:[{cls:["neo-animation-wrapper"],style:{height:`${c[0].height}px`,transform:`translateX(${o}px)`,width:2*c[0].width+"px"},cn:[{cls:["neo-dateselector-content"],cn:[]}]}]}),n=r.updateHeaderMonth(e,t,!0,c[1]),0!==t&&r.updateHeaderYear(e,!0),r.createDayViewContent(!0,a.cn[2].cn[0].cn[0]),a.cn[2].cn[0].cn["right"===l?"unshift":"push"](a.cn[1]),a.cn.splice(1,1),r.promiseUpdate().then((()=>{r.changeMonthTransitionCallback({data:c[0],slideDirection:l}),r.updateHeaderMonthTransitionCallback(n),r.update(),r.timeout(300).then((()=>{r.changeMonthWrapperCallback(l),r.updateHeaderMonthWrapperCallback(n),r.triggerVdomUpdate()}))}))}))):r.recreateContent(e,t)}changeMonthTransitionCallback(e){let t,{data:n,slideDirection:a}=e;t="right"===a?-n.width:0,this.vdom.cn[1].cn[0].style.transform=`translateX(${t}px)`}changeMonthWrapperCallback(e){let{vdom:t}=this;t.cn[1]=t.cn[1].cn[0].cn["right"===e?1:0]}changeYear(e){let t,n,a,o,r=this;r.useAnimations?r.isUpdating?r.cacheUpdate():(r.isUpdating=!0,r.getDomRect(r.getCenterContentEl().id).then((l=>{t=r.scrollNewYearFromTop&&e<0||!r.scrollNewYearFromTop&&e>0,a=r.vdom,o=t?0:-l.height,n={flexDirection:"column",height:2*l.height+"px",transform:`translateY(${o}px)`,width:`${l.width}px`},a.cn.push({cls:["neo-relative"],cn:[{cls:["neo-animation-wrapper"],style:n,cn:[{cls:["neo-dateselector-content"],cn:[]}]}]}),r.updateHeaderYear(e,!0),r.createDayViewContent(!0,a.cn[2].cn[0].cn[0]),a.cn[2].cn[0].cn[t?"unshift":"push"](a.cn[1]),a.cn.splice(1,1),r.promiseUpdate().then((()=>{o=t?-l.height:0,a.cn[1].cn[0].style.transform=`translateY(${o}px)`,r.update(),r.timeout(300).then((()=>{a.cn[1]=a.cn[1].cn[0].cn[t?1:0],r.triggerVdomUpdate()}))}))}))):r.recreateContent(0,e)}createDayNamesRow(){let e,t,n=this,o=a.clone(n.currentDate),r=0,l={cls:["neo-row","neo-header-row"],cn:[]};for(o.setDate(n.currentDate.getDate()-n.currentDate.getDay()+n.weekStartDay);r<7;r++)e={cls:["neo-cell"],cn:[{cls:["neo-cell-content"],html:n.intlFormat_day.format(o)}]},t=o.getDay(),n.showWeekends||0!==t&&6!==t||(e.removeDom=!0),l.cn.push(e),o.setDate(o.getDate()+1);return l}createDayViewContent(e=!1,t){let n,r,l,d,h,m,u,p,D=this,{currentDate:g}=D,y=g.getDate(),f=g.getMonth(),w=g.getFullYear(),C=D.currentDate,v=D.maxValue&&new Date(`${D.maxValue}T12:00:00.000Z`),M=D.minValue&&new Date(`${D.minValue}T12:00:00.000Z`),S=new Date(`${D.value}T12:00:00.000Z`),b=S.getMonth(),V=S.getFullYear(),k=a.getDaysInMonth(g),x=a.getFirstDayOfMonth(g)-D.weekStartDay,F=t||D.getCenterContentEl(),U=0;for(x=x<0?x+7:x,p=(k+x)/7>5?6:5,d=1-x,C.setDate(d),F.cn.push(D.createDayNamesRow());U<p;U++){for(u={cls:["neo-row"],cn:[]},m=0;m<7;m++)h=d>0&&d<=k,n=D.getCellId(w,f+1,d),l=C.getDay(),r={id:n,cls:h?["neo-cell"]:["neo-cell","neo-disabled"],tabIndex:h?-1:null,cn:[{cls:["neo-cell-content"],html:h?d:D.showDisabledDays?C.getDate():""}]},0!==l&&6!==l||(D.showWeekends||(r.removeDom=!0),r.cls.push("neo-weekend")),(v&&C>v||M&&C<M)&&o.add(r.cls,"neo-disabled"),i===w&&s===f&&c===d&&r.cn[0].cls.push("neo-today"),V===w&&b===f&&d===y&&(r.cls.push("neo-selected"),D.selectionModel.items=[n]),u.cn.push(r),C.setDate(C.getDate()+1),d++;F.cn.push(u)}!e&&D.update()}focusCurrentItem(){this.focus(this.selectionModel.items[0])}getCellId(e,t,n){return(n=n.toString()).length<2&&(n="0"+n),(t=t.toString()).length<2&&(t="0"+t),this.id+"__"+e+"-"+t+"-"+n}getCenterContentEl(){return this.vdom.cn[1]}getHeaderMonthEl(){return this.vdom.cn[0].cn[1].cn[0]}getHeaderYearEl(){return this.vdom.cn[0].cn[1].cn[1]}onCellClick(e){let t=this,n=r.find(t.vdom,e.path[0].id),o=t.currentDate;o.setDate(parseInt(n.vdom.cn[0].html)),o=a.convertToyyyymmdd(o),t._value=o,t.afterSetValue(o,null)}onComponentClick(e){let t,n,o=this,r=e.path[0].cls;r.includes("neo-cell")?o.onCellClick(e):r.includes("neo-next-button")?n=1:r.includes("neo-prev-button")&&(n=-1),n&&(t=o.currentDate,t.setMonth(t.getMonth()+n),o.value=a.convertToyyyymmdd(t))}onComponentWheel(e){let t,n,o,r=this,{deltaX:l,deltaY:c}=e,s=r.mouseWheelDelta;Math.abs(c)>=Math.abs(l)?c>=s?o=1:c<=-s&&(o=-1):l>=s?n=1:l<=-s&&(n=-1),n?(t=r.currentDate,t.setMonth(t.getMonth()+n),r.value=a.convertToyyyymmdd(t)):o&&(t=r.currentDate,t.setFullYear(t.getFullYear()+o),r.value=a.convertToyyyymmdd(t))}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onSelect(e){this.value=e[0].split("__")[1]}recreateContent(e,t,n=!1){let a=this;a.recreateDayViewContent(!0),0!==e&&a.updateHeaderMonth(e,t,!0),0!==t&&a.updateHeaderYear(t,!0),a.triggerVdomUpdate(n)}recreateDayViewContent(e=!1,t=!0){let n=this;n.getCenterContentEl().cn=[],n.createDayViewContent(!0),t&&n.syncVdomIds(n.vnode,n.vdom,!0),!e&&n.update()}triggerVdomUpdate(e=!1){if(!e){let e=this;e.isUpdating=!0,e.promiseUpdate().then((()=>{e.isUpdating=!1}))}}updateHeaderDays(e,t,n=!1){let a=this;if(a.intlFormat_day=new Intl.DateTimeFormat(a.locale,{weekday:e}),void 0!==t){let e,t,o=a.getCenterContentEl().cn[0],r=a.currentDate,l=0;for(r.setDate(a.currentDate.getDate()-a.currentDate.getDay()+a.weekStartDay);l<7;l++)t=o.cn[l],t.cn[0].html=a.intlFormat_day.format(r),e=r.getDay(),a.showWeekends||0!==e&&6!==e?delete t.removeDom:t.removeDom=!0,r.setDate(r.getDate()+1);!n&&a.update()}}updateHeaderMonth(e,t,n=!1,a){let o,r,l=this,c=new Intl.DateTimeFormat(l.locale,{month:"short"}).format(l.currentDate),s=l.getHeaderMonthEl(),i=t>0?"bottom":t<0||e<0?"top":"bottom",{vdom:d}=l;return l.mounted&&l.useAnimations?(r="top"===i?0:-a.height,d.cn[0].cn[1].cn.unshift({cls:["neo-relative-header"],style:{height:a.height+"px",width:a.width+"px"},cn:[{cls:["neo-animation-wrapper-header"],cn:[],style:{height:2*a.height+"px",transform:`translateY(${r}px)`,width:a.width+"px"}}]}),o=d.cn[0].cn[1],o.cn[0].cn[0].cn.push({cls:["neo-month-text"],html:c}),o.cn[0].cn[0].cn["top"===i?"unshift":"push"](o.cn[1]),o.cn.splice(1,1),!n&&l.update(),{data:a,headerCenterEl:o,increment:e,yearIncrement:t}):(s.html=c,!n&&l.update(),null)}updateHeaderMonthTransitionCallback(e){let t,{data:n,headerCenterEl:a,increment:o,yearIncrement:r}=e;t="top"===(r>0?"bottom":r<0||o<0?"top":"bottom")?-n.height:0,a.cn[0].cn[0].style.transform=`translateY(${t}px)`}updateHeaderMonthWrapperCallback(e){let{headerCenterEl:t,increment:n,yearIncrement:a}=e,o=a>0?"bottom":a<0||n<0?"top":"bottom";t.cn[0]=t.cn[0].cn[0].cn["top"===o?1:0]}updateHeaderYear(e,t=!1){let n=this;n.getHeaderYearEl().html=n.currentDate.getFullYear(),!t&&n.update()}}export default Neo.setupClass(d);