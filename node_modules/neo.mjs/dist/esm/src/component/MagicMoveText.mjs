import e from"../component/Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.component.MagicMoveText",ntype:"magic-move-text",autoCycle_:!0,autoCycleInterval_:2e3,cacheClearInterval_:10,baseCls:["neo-magic-move-text"],colorMove:null,colorFadeIn:null,colorFadeOut:null,cycleTexts:null,fontFamily_:"Helvetica Neue",transitionTime_:500,_vdom:{style:{},cn:[{cls:["neo-content"],cn:[]},{cls:["neo-measure-element-wrapper"],removeDom:!0,cn:[{cls:["neo-measure-element"],cn:[]}]}]}};chars=[];charsVdom=[];contentHeight=0;contentWidth=0;cycleCount=0;currentIndex=0;initialResizeEvent=!0;intervalId=null;isRetrying=!1;isTransitioning=!1;measureCache={};previousChars=[];get measureElement(){return this.measureWrapper.cn[0]}get measureWrapper(){return this.vdom.cn[1]}construct(e){super.construct(e);let t=this;t.addDomListeners({resize:t.onResize,scope:t}),t.app?.on("visibilitychange",t.onVisibilityChange,t)}async addResizeObserver(e){let{id:t,windowId:a}=this;(await Neo.currentWorker.getAddon("ResizeObserver",a))[e?"register":"unregister"]({id:t,windowId:a}),e&&(this.initialResizeEvent=!0)}afterSetAutoCycle(e,t){this.mounted&&this.startAutoCycle(e)}afterSetAutoCycleInterval(e,t){let a=this;t&&a.mounted&&(a.startAutoCycle(!1),a.startAutoCycle())}afterSetFontFamily(e,t){let a=this;a.measureCache={},a.vdom.style.fontFamily=e,a.update()}afterSetMounted(e,t){super.afterSetMounted(e,t);let a=this;e?a.getDomRect().then(e=>{a.contentHeight=e.height,a.contentWidth=e.width}):(a.measureCache={},a.previousChars=[]),void 0!==t&&(a.addResizeObserver(e),a.autoCycle&&a.startAutoCycle(e))}async afterSetText(e,t){let a=this,{measureElement:s}=a;if(t&&(a.previousChars=a.chars),e){a.cacheClearInterval>0&&(a.cycleCount++,a.cycleCount>=a.cacheClearInterval&&(a.measureCache={},a.cycleCount=0));try{a.chars=[],s.cn=[],e?.split("").forEach(e=>{a.chars.push({name:e}),s.cn.push({tag:"span",text:e})}),a.mounted&&await a.measureChars(),await a.updateChars()}catch(s){a.isRetrying||(a.isRetrying=!0,a.measureCache={},a.previousChars=[],a.vdom.cn[0].cn.length=0,await a.afterSetText(e,t))}a.isRetrying=!1}}afterSetTransitionTime(e,t){this.vdom.style["--neo-transition-time"]=e+"ms",this.update()}createCharsVdom(e){let t,a=this,{chars:s}=a,i=[];return e.forEach((e,r)=>{null!==e&&(t=s[r],i.push({cls:["neo-char"],style:{color:a.colorFadeIn,left:t.left,opacity:0,top:t.top},text:t.name}))}),i}cycleText(){let e=this;e.text=e.cycleTexts[e.currentIndex],e.currentIndex=(e.currentIndex+1)%e.cycleTexts.length}async measureChars(){let e,t,a,s=this,{measureCache:i,measureElement:r,measureWrapper:n,text:o}=s;if(i[o]&&i[o].width===s.contentWidth&&i[o].height===s.contentHeight)t=[...i[o].rects],e=t.shift();else{if(n.style={height:s.contentHeight+"px",width:s.contentWidth+"px"},delete n.removeDom,await s.promiseUpdate(),await s.timeout(20),t=await s.getDomRect([s.id,n.id,...r.cn.map(e=>e.id)]),a=t.shift(),e=t.shift(),a.width>0&&(Math.abs(a.width-s.contentWidth)>2||Math.abs(a.height-s.contentHeight)>2))return s.contentWidth=a.width,s.contentHeight=a.height,s.measureChars();i[o]={height:s.contentHeight,rects:[e,...t],width:s.contentWidth}}t.forEach((t,a)=>{s.chars[a].left=t.left-e.left+"px",s.chars[a].top=t.top-e.top+"px"}),await s.promiseUpdate()}async onResize({rect:e}){let t=this;t.contentHeight=e.height,t.contentWidth=e.width,t.measureCache={},t.initialResizeEvent?t.initialResizeEvent=!1:t.isTransitioning||(await t.measureChars(),t.charsVdom=t.createCharsVdom(t.chars.map(e=>e.name)))}onVisibilityChange(e){let t=this;t.autoCycle&&(e.hidden?t.startAutoCycle(!1):(t.isRetrying=!1,t.measureCache={},t.previousChars=[],t.startAutoCycle()))}sortCharacters(e,t){let a=parseFloat(e.style.top)-parseFloat(t.style.top);return 0!==a?a:parseFloat(e.style.left)-parseFloat(t.style.left)}startAutoCycle(e=!0){let t=this;e?(t.intervalId=setInterval(t.cycleText.bind(t),t.autoCycleInterval),t.timeout(20).then(()=>{t.cycleText()})):clearInterval(t.intervalId)}async updateChars(){let e,t,a=this,{chars:s,previousChars:i}=a,r=a.vdom.cn[0],n=s.map(e=>e.name);for(a.isTransitioning=!0,a.charsVdom.length>1&&(r.cn=a.charsVdom,await a.promiseUpdate()),i.forEach((i,o)=>{t=n.indexOf(i.name),t>-1?(e=r.cn[o],Object.assign(e.style,{color:a.colorMove,left:s[t].left,top:s[t].top}),n[t]=null):(e=r.cn[o],e.flag="remove")}),r.cn.push(...a.createCharsVdom(n)),await a.promiseUpdate(),r.cn.forEach(e=>{"remove"===e.flag?(e.style.color=a.colorFadeOut,e.style.opacity=0):delete e.style.opacity}),await a.promiseUpdate(),await a.timeout(a.transitionTime),r.cn.sort(a.sortCharacters),t=r.cn.length-1;t>=0;t--)e=r.cn[t],delete e.flag,delete e.style.color,0===e.style.opacity&&r.cn.splice(t,1);await a.promiseUpdate(),await a.timeout(200),a.charsVdom=[...r.cn],r.cn.length=0,r.cn.push({text:a.text}),await a.promiseUpdate(),a.isTransitioning=!1}});