import e from"./Base.mjs";import t from"../util/HighlightJs.mjs";import r from"../core/IdGenerator.mjs";import{marked as s}from"../../node_modules/marked/lib/marked.esm.js";const n=/^---\r?\n([\s\S]*?)\r?\n---\r?\n/,a=/<!--\s*\/lab\s*-->/g,o=/<!--\s*lab\s*-->/g,i=/(?<!\\)```(javascript|html|css|json)\s+live-preview\s*\n([\s\S]*?)\n\s*```/g,l=/(?<!\\)```mermaid\s*\n([\s\S]*?)\n\s*```/g,c=/(?<!\\)```json\s+neo-component\s*\n([\s\S]*?)\n\s*```/g,d=/^\n+|\n+$/g,p=/(?<!\\)(`{3,})(\w*)(?:[^\n]*)?\n([\s\S]*?)\n\s*\1/g,m=/`([^`]+)`/g,u=/(^|[\s(])#(\d+)\b/g;export default Neo.setupClass(class extends e{static config={className:"Neo.component.Markdown",ntype:"markdown",baseCls:["neo-markdown-component"],issuesUrl:"https://github.com/neomjs/neo/issues/",renderFrontmatter:!0,replaceTicketIds:!1,useFrontmatterDetails:!0,value_:null,windowUrl:null};activeComponents=[];afterSetMounted(e,t){super.afterSetMounted(e,t),this.updateComponentState(e)}afterSetTheme(e,t){super.afterSetTheme(e,t),this.activeComponents.forEach(t=>t.theme=e)}async afterSetValue(e,t){if(e){let t=this;e=t.modifyMarkdown(e),t.destroyComponents(),await t.render({code:e})}}async afterSetWindowId(e,t){super.afterSetWindowId(e,t),this.activeComponents.forEach(t=>t.windowId=e)}beforeSetValue(e,t){if(e){let r=e.trim().toLowerCase();if(r.startsWith("<!doctype html>")||r.startsWith("<html"))return console.error("Markdown component received an HTML document instead of markdown content. This usually indicates a 404 or server error.",this.id),t}return e}destroy(...e){this.destroyComponents(),super.destroy(...e)}destroyComponents(){this.activeComponents.forEach(e=>e.destroy()),this.activeComponents=[]}insertLabDivs(e){return e=(e=e.replace(o,'<div class="lab">')).replace(a,"</div>")}formatFrontMatterValue(e){if(Array.isArray(e))return e.join(", ");if("boolean"==typeof e)return`<i class="fa-solid fa-${e?"check":"xmark"}"></i>`;if("string"==typeof e){if(/^\d{4}-\d{2}-\d{2}T/.test(e))return new Date(e).toLocaleString();if(/^https?:\/\//.test(e))return`<a href="${e}" target="_blank">${e}</a>`}return e}frontMatterToHtml(e){let t=this,r='<table class="neo-frontmatter-table"><tbody>';return Object.entries(e).forEach(([e,s])=>{r+=`<tr><td>${e}</td><td>${t.formatFrontMatterValue(s)}</td></tr>`}),r+="</tbody></table>",t.useFrontmatterDetails?`<details><summary>Frontmatter</summary>${r}</details>`:r}modifyMarkdown(e){let t=this;if(n.test(e)&&(e=e.replace(n,(e,r)=>{if(!t.renderFrontmatter)return"";try{return t.frontMatterToHtml(t.parseFrontMatter(r))+"\n"}catch(t){return console.error("Error parsing FrontMatter",t),e}})),t.replaceTicketIds){const r=[];let s=0;e=(e=(e=e.replace(p,e=>{const t=`__NEO_CODE_BLOCK_${s++}__`;return r.push({token:t,value:e}),t})).replace(m,e=>{const t=`__NEO_INLINE_CODE_${s++}__`;return r.push({token:t,value:e}),t})).replace(u,(e,r,s)=>{const n=t.issuesUrl.startsWith("#");return`${r}<a href="${t.issuesUrl+s}"${n?"":' target="_blank"'}>#${s}</a>`}),r.forEach(t=>{e=e.replace(t.token,t.value)})}let r,s,a=e.split("\n"),o=0,i=a.length,l=1;for(;o<i;o++)r=a[o],s=null,r.startsWith("#")&&"#"!==r.charAt(1)?(r=r.substring(1).trim(),s="h1"):r.startsWith("##")&&"#"!==r.charAt(2)?(r=r.substring(2).trim(),s="h2"):r.startsWith("###")&&"#"!==r.charAt(3)&&(r=r.substring(3).trim(),s="h3"),s&&(a[o]=t.onHeadline(s,r,l),l++,a[o+1]&&""!==a[o+1]&&(a.splice(o+1,0,""),i++,o++));return a.join("\n")}onHeadline(e,t,r){return`<${e} class="neo-${e}">${s.parseInline(t)}</${e}>`}parseFrontMatter(e){let t,r={};return e.trim().split("\n").forEach(e=>{let s=e.trim();if(!s||s.startsWith("#"))return;if(s.startsWith("- "))return void(t&&(Array.isArray(r[t])||(r[t]=[]),r[t].push(this.parseValue(s.substring(2)))));let n=s.match(/^([\w\d_-]+):\s*(.*)$/);n&&(t=n[1],r[t]=this.parseValue(n[2]))}),r}parseValue(e){return"true"===(e=e.trim())||"false"!==e&&("null"===e?null:isNaN(Number(e))||""===e?e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e:Number(e))}processLivePreviewBlocks(e,t){return e.replace(i,(e,s,n)=>{const a=r.getId("pre-live-preview");return t[a]={code:n,language:s},`<div id="${a}"></div>`})}processMermaidBlocks(e,t){return e.replace(l,(e,s)=>{const n=r.getId("mermaid");return t[n]=s,`<div class="neo-mermaid" id="${n}"></div>`})}processNeoComponentsBlocks(e,t){return e.replace(c,(e,s)=>{try{const e=r.getId("learn-content-component");return t[e]=JSON.parse(s),`<div id="${e}"></div>`}catch(t){return console.warn("Failed to parse neo-component block, returning original code.",t),e}})}async processReadonlyCodeBlocks(e,s){let n,a=[],o=0,i=e.replace(p,(e,n,i,l)=>{const c=`__NEO-READONLY-TOKEN-${++o}__`,p=i&&""!==i.trim()&&"text"!==i?i:"plaintext";return l=l.replace(/\\```/g,"```"),a.push(t.highlight(l,p,s).catch(e=>(console.warn(`Highlighting failed for language '${p}', falling back to plaintext.`,e),t.highlight(l,"plaintext",s))).then(e=>({after:`<pre data-${p} class="hljs" id="pre-readonly-${r.getId()}">${e.replace(d,"")}</pre>`,token:c}))),c});return n=await Promise.all(a),n.forEach(e=>{i=i.replace(e.token,e.after)}),i}async render({code:e}){let t,r,n=this,{windowId:a}=n,o=e,i={},l={},c={},d={appName:n.appName,autoInitVnode:!0,autoMount:!0,parentComponent:n.parentComponent,theme:n.theme,windowId:a};if(i={},l={},o=n.processNeoComponentsBlocks(o,i),o=n.processLivePreviewBlocks(o,l),o=n.processMermaidBlocks(o,c),o=await n.processReadonlyCodeBlocks(o,d.windowId),o=o.replace(/\\```/g,"```"),t=s.parse(o),t=t.replace(/<img([^>]*)>/g,'<div class="neo-markdown-image-wrapper"><img$1></div>'),await n.set({html:n.insertLabDivs(t)}),await n.timeout(10),Object.keys(i).length>0&&Object.keys(i).forEach(e=>{r=Neo.create({...d,className:"Neo.component.Base",parentId:e,...i[e]}),n.activeComponents.push(r)}),Object.keys(l).length>0){const e=(await import("../code/LivePreview.mjs")).default;Object.keys(l).forEach(t=>{const s={...d,module:e,parentId:t,value:l[t].code};n.windowUrl&&(s.windowUrl=n.windowUrl),r=Neo.create(s),n.activeComponents.push(r)})}if(Object.keys(c).length>0){const e=(await import("./wrapper/Mermaid.mjs")).default;Object.keys(c).forEach(t=>{r=Neo.create({...d,module:e,parentId:t,theme:n.theme,value:c[t]}),n.activeComponents.push(r)})}return{}}updateComponentState(e){this.activeComponents.forEach(t=>{e?t.initVnode(!0):t.mounted=!1})}});