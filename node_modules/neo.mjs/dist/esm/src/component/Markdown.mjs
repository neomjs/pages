import e from"./Base.mjs";import t from"../util/HighlightJs.mjs";import r from"../core/IdGenerator.mjs";import{marked as s}from"../../node_modules/marked/lib/marked.esm.js";const n=/^---\n([\s\S]*?)\n---\n/,o=/<!--\s*\/lab\s*-->/g,a=/<!--\s*lab\s*-->/g,i=/```(javascript|html|css|json)\s+live-preview\s*\n([\s\S]*?)\n\s*```/g,l=/```mermaid\s*\n([\s\S]*?)\n\s*```/g,d=/```json\s+neo-component\s*\n([\s\S]*?)\n\s*```/g,c=/^\n+|\n+$/g,m=/```(\w*)(?:[^\n]*)?\n([\s\S]*?)\n\s*```/g,p=/(^|[\s(])#(\d+)\b/g;export default Neo.setupClass(class extends e{static config={className:"Neo.component.Markdown",ntype:"markdown",baseCls:["neo-markdown-component"],issuesUrl:"https://github.com/neomjs/neo/issues/",renderFrontmatter:!0,replaceTicketIds:!1,useFrontmatterDetails:!0,value_:null,windowUrl:null};activeComponents=[];static regexInlineCode=/`([^`]+)`/g;afterSetMounted(e,t){super.afterSetMounted(e,t),this.updateComponentState(e)}async afterSetValue(e,t){if(e){let t=this;e=t.modifyMarkdown(e),t.destroyComponents(),await t.render({code:e})}}async afterSetWindowId(e,t){super.afterSetWindowId(e,t),this.activeComponents.forEach(t=>t.windowId=e)}beforeSetValue(e,t){if(e){let r=e.trim().toLowerCase();if(r.startsWith("<!doctype html>")||r.startsWith("<html"))return console.error("Markdown component received an HTML document instead of markdown content. This usually indicates a 404 or server error.",this.id),t}return e}destroy(...e){this.destroyComponents(),super.destroy(...e)}destroyComponents(){this.activeComponents.forEach(e=>e.destroy()),this.activeComponents=[]}insertLabDivs(e){return e=(e=e.replace(a,'<div class="lab">')).replace(o,"</div>")}formatFrontMatterValue(e){if(Array.isArray(e))return e.join(", ");if("boolean"==typeof e)return`<i class="fa-solid fa-${e?"check":"xmark"}"></i>`;if("string"==typeof e){if(/^\d{4}-\d{2}-\d{2}T/.test(e))return new Date(e).toLocaleString();if(/^https?:\/\//.test(e))return`<a href="${e}" target="_blank">${e}</a>`}return e}frontMatterToHtml(e){let t=this,r='<table class="neo-frontmatter-table"><tbody>';return Object.entries(e).forEach(([e,s])=>{r+=`<tr><td>${e}</td><td>${t.formatFrontMatterValue(s)}</td></tr>`}),r+="</tbody></table>",t.useFrontmatterDetails?`<details><summary>Frontmatter</summary>${r}</details>`:r}modifyMarkdown(e){let t=this;n.test(e)&&(e=e.replace(n,(e,r)=>{if(!t.renderFrontmatter)return"";try{return t.frontMatterToHtml(t.parseFrontMatter(r))+"\n"}catch(t){return console.error("Error parsing FrontMatter",t),e}})),t.replaceTicketIds&&(e=e.replace(p,`$1<a href="${t.issuesUrl}$2" target="_blank">#$2</a>`));let r,s,o=e.split("\n"),a=0,i=o.length,l=1;for(;a<i;a++)r=o[a],s=null,r.startsWith("#")&&"#"!==r.charAt(1)?(r=r.substring(1).trim(),s="h1"):r.startsWith("##")&&"#"!==r.charAt(2)?(r=r.substring(2).trim(),s="h2"):r.startsWith("###")&&"#"!==r.charAt(3)&&(r=r.substring(3).trim(),s="h3"),s&&(o[a]=t.onHeadline(s,r,l),l++,o[a+1]&&""!==o[a+1]&&(o.splice(a+1,0,""),i++,a++));return o.join("\n")}onHeadline(e,t,r){return`<${e} class="neo-${e}">${t=t.replace(this.constructor.regexInlineCode,"<code>$1</code>")}</${e}>`}parseFrontMatter(e){let t,r={};return e.trim().split("\n").forEach(e=>{let s=e.trim();if(!s||s.startsWith("#"))return;if(s.startsWith("- "))return void(t&&(Array.isArray(r[t])||(r[t]=[]),r[t].push(this.parseValue(s.substring(2)))));let n=s.match(/^([\w\d_-]+):\s*(.*)$/);n&&(t=n[1],r[t]=this.parseValue(n[2]))}),r}parseValue(e){return"true"===(e=e.trim())||"false"!==e&&("null"===e?null:isNaN(Number(e))||""===e?e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e:Number(e))}processLivePreviewBlocks(e,t){return e.replace(i,(e,s,n)=>{const o=r.getId("pre-live-preview");return t[o]={code:n,language:s},`<div id="${o}"></div>`})}processMermaidBlocks(e,t){return e.replace(l,(e,s)=>{const n=r.getId("mermaid");return t[n]=s,`<div class="neo-mermaid" id="${n}"></div>`})}processNeoComponentsBlocks(e,t){return e.replace(d,(e,s)=>{const n=r.getId("learn-content-component");return t[n]=JSON.parse(s),`<div id="${n}"></div>`})}async processReadonlyCodeBlocks(e,s){let n,o=[],a=0,i=e.replace(m,(e,n,i)=>{const l=`__NEO-READONLY-TOKEN-${++a}__`,d=n&&""!==n.trim()&&"text"!==n?n:"plaintext";return o.push(t.highlight(i,d,s).catch(e=>(console.warn(`Highlighting failed for language '${d}', falling back to plaintext.`,e),t.highlight(i,"plaintext",s))).then(e=>({after:`<pre data-${d} class="hljs" id="pre-readonly-${r.getId()}">${e.replace(c,"")}</pre>`,token:l}))),l});return n=await Promise.all(o),n.forEach(e=>{i=i.replace(e.token,e.after)}),i}async render({code:e}){let t,r,n=this,{windowId:o}=n,a=e,i={},l={},d={},c={appName:n.appName,autoInitVnode:!0,autoMount:!0,parentComponent:n.parentComponent,windowId:o};if(i={},l={},a=n.processNeoComponentsBlocks(a,i),a=n.processLivePreviewBlocks(a,l),a=n.processMermaidBlocks(a,d),a=await n.processReadonlyCodeBlocks(a,c.windowId),t=s.parse(a),t=t.replace(/<img([^>]*)>/g,'<div class="neo-markdown-image-wrapper"><img$1></div>'),await n.set({html:n.insertLabDivs(t)}),await n.timeout(10),Object.keys(i).length>0&&Object.keys(i).forEach(e=>{r=Neo.create({...c,className:"Neo.component.Base",parentId:e,...i[e]}),n.activeComponents.push(r)}),Object.keys(l).length>0){const e=(await import("../code/LivePreview.mjs")).default;Object.keys(l).forEach(t=>{const s={...c,module:e,parentId:t,value:l[t].code};n.windowUrl&&(s.windowUrl=n.windowUrl),r=Neo.create(s),n.activeComponents.push(r)})}if(Object.keys(d).length>0){const e=await Neo.currentWorker.getAddon("Mermaid",o);Object.keys(d).forEach(t=>{e.render({code:d[t],id:t,windowId:o})})}return{}}updateComponentState(e){this.activeComponents.forEach(t=>{e?t.initVnode(!0):t.mounted=!1})}});