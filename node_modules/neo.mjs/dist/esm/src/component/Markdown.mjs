import e from"./Base.mjs";import t from"../util/HighlightJs.mjs";import o from"../core/IdGenerator.mjs";import{marked as s}from"../../node_modules/marked/lib/marked.esm.js";const n=/<!--\s*\/lab\s*-->/g,r=/<!--\s*lab\s*-->/g,a=/```(javascript|html|css|json)\s+live-preview\s*\n([\s\S]*?)\n\s*```/g,i=/```json\s+neo-component\s*\n([\s\S]*?)\n\s*```/g,c=/```(bash|javascript|html|css|json|scss|xml|markdown|yaml)\s+readonly\s*\n([\s\S]*?)\n\s*```/g;export default Neo.setupClass(class extends e{static config={className:"Neo.component.Markdown",ntype:"markdown",baseCls:["neo-markdown-component"],value_:null,windowUrl:null};activeComponents=[];static regexInlineCode=/`([^`]+)`/g;afterSetMounted(e,t){super.afterSetMounted(e,t),this.updateComponentState(e)}async afterSetValue(e,t){if(e){let t=this;e=t.modifyMarkdown(e),t.destroyComponents(),await t.render({code:e})}}async afterSetWindowId(e,t){super.afterSetWindowId(e,t),this.activeComponents.forEach(t=>t.windowId=e)}destroy(...e){this.destroyComponents(),super.destroy(...e)}destroyComponents(){this.activeComponents.forEach(e=>e.destroy()),this.activeComponents=[]}insertLabDivs(e){return e=(e=e.replace(r,'<div class="lab">')).replace(n,"</div>")}modifyMarkdown(e){let t,o,s=this,n=e.split("\n"),r=0,a=n.length,i=1;for(;r<a;r++)t=n[r],o=null,t.startsWith("#")&&"#"!==t.charAt(1)?(t=t.substring(1).trim(),o="h1"):t.startsWith("##")&&"#"!==t.charAt(2)?(t=t.substring(2).trim(),o="h2"):t.startsWith("###")&&"#"!==t.charAt(3)&&(t=t.substring(3).trim(),o="h3"),o&&(n[r]=s.onHeadline(o,t,i),i++);return n.join("\n")}onHeadline(e,t,o){return`<${e} class="neo-${e}">${t=t.replace(this.constructor.regexInlineCode,"<code>$1</code>")}</${e}>`}processLivePreviewBlocks(e,t){return e.replace(a,(e,s,n)=>{const r=o.getId("pre-live-preview");return t[r]={code:n,language:s},`<div id="${r}"></div>`})}processNeoComponentsBlocks(e,t){return e.replace(i,(e,s)=>{const n=o.getId("learn-content-component");return t[n]=JSON.parse(s),`<div id="${n}"></div>`})}async processReadonlyCodeBlocks(e,s){let n,r=[],a=0,i=e.replace(c,(e,n,i)=>{const c=`__NEO-READONLY-TOKEN-${++a}__`;return r.push(t.highlightAuto(i,s).then(e=>({after:`<pre data-${n} class="hljs" id="pre-readonly-${o.getId()}">${e.trim()}</pre>`,token:c}))),c});return n=await Promise.all(r),n.forEach(e=>{i=i.replace(e.token,e.after)}),i}async render({code:e}){let t,o,n=this,r=e,a={},i={},c={appName:n.appName,autoInitVnode:!0,autoMount:!0,parentComponent:n.parentComponent,windowId:n.windowId};if(a={},i={},r=n.processNeoComponentsBlocks(r,a),r=n.processLivePreviewBlocks(r,i),r=await n.processReadonlyCodeBlocks(r,c.windowId),t=s.parse(r),await n.set({html:n.insertLabDivs(t)}),await n.timeout(10),Object.keys(a).length>0&&Object.keys(a).forEach(e=>{o=Neo.create({...c,className:"Neo.component.Base",parentId:e,...a[e]}),n.activeComponents.push(o)}),Object.keys(i).length>0){const e=(await import("../code/LivePreview.mjs")).default;Object.keys(i).forEach(t=>{const s={...c,module:e,parentId:t,value:i[t].code};n.windowUrl&&(s.windowUrl=n.windowUrl),o=Neo.create(s),n.activeComponents.push(o)})}return{}}updateComponentState(e){this.activeComponents.forEach(t=>{e?t.initVnode(!0):t.mounted=!1})}});