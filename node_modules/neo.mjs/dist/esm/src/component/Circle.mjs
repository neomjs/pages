import e from"../util/ClassSystem.mjs";import t from"../selection/CircleModel.mjs";import i from"../collection/Base.mjs";import o from"./Base.mjs";import a from"../util/Array.mjs";import n from"../util/VDom.mjs";let l;export default Neo.setupClass(class extends o{static config={className:"Neo.component.Circle",ntype:"circle",backsideIconPath:null,baseCls:["neo-circle-component"],circleCenterHasTransitionCls:!0,collapsed:!0,draggable_:!0,keys:{},innerRadius_:100,isFlipped:!1,itemImagePath:null,itemSize_:60,maxItems_:12,outerRadiusDelta_:10,rotateX_:0,rotateY_:0,rotateZ_:0,rotationIndex_:0,selectionModel_:null,store_:null,title_:"Circle 1",url_:"../../resources/examples/data/circles/group1.json",_vdom:{tabIndex:-1,cn:[{cls:["neo-circle-center"],style:{},cn:[{cls:["neo-circle-front"],cn:[{cls:["neo-circle"],style:{},cn:[{cls:["neo-count-items"]},{cls:["neo-circle-name"]}]},{cls:["neo-outer-circle"],style:{}}]},{cls:["neo-circle-back"],cn:[]}]}]}};construct(e){super.construct(e);let t=this,{resourcesPath:o}=Neo.config;Neo.main.DomEvents.registerPreventDefaultTargets({name:"contextmenu",cls:["neo-circle","neo-circle-back"],windowId:t.windowId}),t.backsideIconPath||(t.backsideIconPath=o+"images/circle/"),t.itemImagePath||(t.itemImagePath=o+"examples/"),t.addDomListeners([{mouseenter:t.expand,mouseleave:t.collapse,scope:t},{contextmenu:t.onContextMenu,delegate:"neo-circle-back",scope:t},{click:t.onBacksideIconClick,delegate:"neo-backside-icon",scope:t},{mouseenter:t.expandItem,mouseleave:t.collapseItem,delegate:"neo-circle-item",scope:t},{contextmenu:t.onContextMenu,wheel:t.onMouseWheel,delegate:"neo-circle",scope:t}]),t.store=Neo.create(i,{keyProperty:"id"}),t.createBacksideItems(!0),t.updateInnerCircle(!0),t.updateOuterCircle(!0),t.updateTitle(!0),t.update()}afterSetDraggable(e,t){let i=this,o=[];e&&import("../draggable/DragZone.mjs").then(e=>{l=e.default,i.dragListenersAdded||(o.push({"drag:end":i.onDragEnd,scope:i,delegate:"neo-circle-item"},{"drag:start":i.onDragStart,scope:i,delegate:"neo-circle-item"}),i.addDomListeners(o),i.dragListenersAdded=!0)})}afterSetInnerRadius(e,t){if(t){let e=this;e.updateItemPositions(!0),e.updateInnerCircle(!0),e.updateOuterCircle(!1)}}afterSetMaxItems(e,t){if(t&&this.vnodeInitialized){let i=this,o=i.getFrontEl();e<t?(i.collapsed?o.cn.splice(e+2):(i.updateItemOpacity(0,!0,e),i.timeout(300).then(()=>{o.cn.splice(e+2),i.update()})),i.updateItemPositions(!0),i.update()):(i.createItems(t,!0),i.updateItemPositions(!0),i.promiseUpdate().then(()=>{i.collapsed||(i.updateItemOpacity(1,!0,t),i.update())}))}}afterSetItemSize(e,t){let i=this;t&&i.vnodeInitialized&&(!i.collapsed&&i.updateOuterCircle(!0),i.updateItemPositions())}afterSetRotateX(e,t){t&&this.vnodeInitialized&&this.rotate()}afterSetRotateY(e,t){t&&this.vnodeInitialized&&this.rotate()}afterSetRotateZ(e,t){t&&this.vnodeInitialized&&this.rotate()}afterSetRotationIndex(e,t){Neo.isNumber(t)&&console.log("afterSetRotationIndex",e)}afterSetSelectionModel(e,t){this.vnodeInitialized&&e.register(this)}afterSetTitle(e,t){t&&this.updateTitle()}beforeSetSelectionModel(i,o){return o&&o.destroy(),e.beforeSetInstance(i,t)}calculateItemPositions(){let e,t=this,i=360/t.maxItems,o=[],{itemSize:a}=t,n=t.innerRadius+a/2+4,l=0,r=t.maxItems;for(;l<r;l++)e=(i*l+180)*Math.PI/180,o.push({left:-Math.round(n*Math.sin(e))-a/2,top:Math.round(n*Math.cos(e))-a/2});return o}collapse(){let e=this;e.collapsed||(e.collapsed=!0,e.updateOuterCircle(!0),e.updateItemOpacity(0,!1))}collapseItem(e){let t=this,i=t.getItemEl(e.path[0].id).cn[0].style;delete i.marginLeft,delete i.marginTop,delete i.zIndex,i.height=t.itemSize+"px",i.width=t.itemSize+"px",t.update()}createBacksideItems(e=!1){let t=this,i=t.getBackEl(),o=["neo-flip","neo-pencil","neo-trash"],a=["flip.png","pencil.png","trash.png"],n=0;for(i.cn.push({cls:["neo-count-items"]},{cls:["neo-circle-name"]});n<3;n++)i.cn.push({tag:"img",cls:["neo-backside-icon",o[n]],src:t.backsideIconPath+a[n]});!e&&t.update()}createItems(e=0,t=!1){let i=this,o=i.getFrontEl(),a=["neo-circle-item"],n=i.calculateItemPositions(),{itemSize:l}=i,r=Math.min(i.store.getCount(),i.maxItems),s=e;for(i.draggable&&a.push("neo-draggable");s<r;s++)o.cn.push({id:i.getItemId(s),cls:a,tabIndex:-1,style:{height:l+"px",left:n[s].left+"px",top:n[s].top+"px",width:l+"px"},cn:[{tag:"img",cls:["neo-circle-item-image"],src:i.itemImagePath+i.store.getAt(s).image,style:{height:l+"px",width:l+"px"}}]});!t&&i.update()}expand(e){let t=this;t.collapsed&&(t.collapsed=!1,t.updateOuterCircle(!0),t.updateItemOpacity(1,!1))}expandItem(e){let t=this;t.getItemEl(e.path[0].id).cn[0].style={height:t.itemSize+20+"px",marginLeft:"-10px",marginTop:"-10px",width:t.itemSize+20+"px",zIndex:40},t.update()}flipCircle(){let e=this;a[e.isFlipped?"remove":"add"](e.vdom.cn[0].cls,"neo-flipped"),e.isFlipped=!e.isFlipped,e.update()}getBackEl(){return this.vdom.cn[0].cn[1]}getFrontEl(){return this.vdom.cn[0].cn[0]}getInnerCircle(){return this.vdom.cn[0].cn[0].cn[0]}getItemEl(e){return n.find(this.getFrontEl(),e)?.vdom}getItemId(e){let{store:t}=this;return this.id+"__"+t.getAt(e)[t.keyProperty]}getItemRecordId(e){let t=e.split("__").pop(),i=this.store.model,o=i?.getField(i.keyProperty);return"number"===o?.type.toLowerCase()&&(t=parseInt(t)),t}getOuterCircle(){return this.vdom.cn[0].cn[0].cn[1]}loadData(){let e=this;Neo.Xhr.promiseJson({insideNeo:!0,url:e.url}).then(t=>{e.store.items=t.json.data,e.timeout(100).then(()=>{e.updateTitle(),e.createItems()})}).catch(t=>{console.log("Error for Neo.Xhr.request",t,e.id)})}onBacksideIconClick(e){let t=this,i=e.path[0].cls;i.includes("neo-flip")?t.flipCircle():i.includes("neo-pencil")?console.log("edit circle"):i.includes("neo-trash")&&console.log("delete circle")}onConstructed(){super.onConstructed();let e=this;e.selectionModel?.register(e),e.loadData()}onContextMenu(e){this.flipCircle()}onDragEnd(e){console.log("onDragEnd",e)}onDragStart(e){console.log("onDragStart",e);let t=this,i=t.wrapperStyle||{};t.isDragging=!0,t.dragZone||(t.dragZone=Neo.create({module:l,appName:t.appName,bodyCursorStyle:"move !important",dragElement:t.vdom,dragProxyConfig:{vdom:t.getProxyVdom()},owner:t,useProxyWrapper:!1,windowId:t.windowId,...t.dragZoneConfig})),t.dragZone.dragStart(e),i.opacity=.7,t.wrapperStyle=i}onMouseWheel(e){let t=this,i=e.deltaY,o=360/t.maxItems,a=Math.max(0,(t.store.getCount()-t.maxItems)*o),n=t.rotateZ;(i>1||i<-1)&&(n+=i),n<0?n=0:n>a&&(n=a),0===t.rotateZ&&0===n||t.rotateZ===a&&n===a||(t.rotateZ=n,t.rotationIndex=Math.floor(n/o),t.rotate())}rotate(){let e=this,t=e.vdom.cn[0],i=[`rotateX(${e.rotateX}deg)`,`rotateY(${e.rotateY}deg)`,`rotateZ(${e.rotateZ}deg)`].join(" ");e.circleCenterHasTransitionCls?(a.add(t.cls,"no-transition"),e.circleCenterHasTransitionCls=!1,e.promiseUpdate().then(()=>{e.updateItemAngle(!0),t.style.transform=i,e.update()})):(e.updateItemAngle(!0),t.style.transform=i,e.update())}updateInnerCircle(e=!1){let t=this,i=t.getInnerCircle(),{innerRadius:o}=t,a=2*o;Object.assign(i.style,{height:a+"px",left:"-"+o+"px",top:"-"+o+"px",width:a+"px"}),!e&&t.update()}updateItemAngle(e=!1){let t=this,i=t.getFrontEl(),o=2,a=i.cn.length;for(;o<a;o++)i.cn[o].style.transform="rotateZ("+-t.rotateZ+"deg)";!e&&t.update()}updateItemOpacity(e,t=!1,i=0){let o=i+2,a=this.getFrontEl(),n=a.cn.length;for(;o<n;o++)a.cn[o].style.opacity=e;!t&&this.update()}updateItemPositions(e=!1){let t=this,i=t.getFrontEl(),o=t.calculateItemPositions(),{itemSize:a}=t,n=2,l=Math.min(i.cn.length,o.length+2);for(;n<l;n++)Object.assign(i.cn[n].style,{height:a+"px",left:o[n-2].left+"px",top:o[n-2].top+"px",width:a+"px"}),Object.assign(i.cn[n].cn[0].style,{height:a+"px",width:a+"px"});!e&&t.update()}updateOuterCircle(e=!1){let t,i=this,{itemSize:o}=i,a=i.getOuterCircle(),n=i.innerRadius+i.outerRadiusDelta,l=i.collapsed?2*n:2*(n+o);t=i.collapsed?{height:l+"px",left:"-"+n+"px",top:"-"+n+"px",width:l+"px"}:{height:l+"px",left:"-"+(n+o)+"px",top:"-"+(n+o)+"px",width:l+"px"},Object.assign(a.style,t),!e&&i.update()}updateTitle(e=!1){let t=this,i=t.getInnerCircle();i.cn[0].text=t.store?.getCount()||0,i.cn[1].text=t.title,!e&&t.update()}});