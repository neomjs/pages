import e from"./Abstract.mjs";import t from"../util/ClassSystem.mjs";import o from"../manager/Component.mjs";import i from"../util/KeyNavigation.mjs";import n from"../util/Logger.mjs";import r from"../util/Array.mjs";import s from"../util/Rectangle.mjs";import d from"../util/Style.mjs";import a from"../util/VDom.mjs";import l from"../util/VNode.mjs";import{isDescriptor as m}from"../core/ConfigSymbols.mjs";const h=e=>null==e||isNaN(e)?e:`${e}px`,u=Symbol.for("closestController"),{currentWorker:p}=Neo,c=/^\d+\w+$/;export default Neo.setupClass(class extends e{static hideModes=["removeDom","visibility"];static config={className:"Neo.component.Base",ntype:"component",align_:{[m]:!0,merge:"deep",value:{edgeAlign:"t-b",constrainTo:"document.body"}},baseCls:[],containsFocus_:!1,controller_:null,droppable_:!1,dropZone:null,dropZoneConfig:null,floating:!1,hasBeenMounted:!1,height_:null,hidden_:!1,hideMode_:"removeDom",html_:null,isLoading_:!1,keys_:null,loadingSpinnerCls_:["fa","fa-spinner","fa-spin"],maxHeight_:null,maxWidth_:null,minHeight_:null,minWidth_:null,plugins_:null,reference_:null,responsive_:null,role_:null,scrollable_:!1,style_:{[m]:!0,merge:"shallow",value:null},theme_:null,tag_:null,text_:null,tooltip_:null,ui_:null,width_:null,wrapperCls_:null,wrapperStyle_:{[m]:!0,merge:"shallow",value:null},_vdom:{}};get isVisible(){return this.mounted&&!this.hidden&&(!this.parent||this.parent.isVisible)}get rendered(){return this._rendered||!1}set rendered(e){let t=this;t._rendered=e,!0===e&&t.fire("rendered",t.id)}get vdom(){return this._vdom}set vdom(e){this.afterSetVdom(e,e)}addCls(e){let{cls:t}=this;r.add(t,e),this.cls=t}addStyle(e){return Neo.isString(e)&&(e=Neo.createStyleObject(e)),this.style=Object.assign(this.style,e)}addWrapperCls(e){let{wrapperCls:t}=this;r.add(t,e),this.wrapperCls=t}afterSetAppName(e,t){}afterSetCls(e,t){t=t||[];let o,i=this,n=i.vdom,s=i.getVdomRoot();n!==s?s.cls=[...e]:(o=r.union(i.wrapperCls,e),r.remove(o,r.difference(t,e)),n.cls=o),i.update()}afterSetDisabled(e,t){let o=this.cls;r[e?"add":"remove"](o,"neo-disabled"),this.cls=o}afterSetDroppable(e,t){let o=this;e&&!o.dropZone&&import("../draggable/DropZone.mjs").then(e=>{o.dropZone=Neo.create({module:e.default,appName:o.appName,owner:o,windowId:o.windowId,...o.dropZoneConfig})})}afterSetHeight(e,t){this.configuredHeight=h(e),this.changeVdomRootKey("height",e)}afterSetHidden(e,t){let o=this,i=e?"hide":"show";e&&void 0===t&&"removeDom"===o.hideMode?o.vdom.removeDom=!0:(e||void 0!==t)&&o[i](),e||o.revertFocus(),o.fire(i,{id:o.id}),o.fire("hiddenChange",{id:o.id,oldValue:t,value:e})}afterSetHtml(e,t){this.changeVdomRootKey("html",e)}afterSetId(e,t){super.afterSetId(e,t),this.changeVdomRootKey("id",e)}afterSetIsLoading(e,t){if(e||void 0!==t){let o,i=this,{wrapperCls:n,vdom:s}=i;void 0!==t&&s.cn&&(o=s.cn.findLastIndex(e=>e.cls?.includes("neo-load-mask")),-1!==o&&s.cn.splice(o,1)),e&&(s.cn||(s.cn=[]),s.cn.push(i.createLoadingMask(e))),r.toggle(n,"neo-masked",e),i.set({vdom:s,wrapperCls:n})}}afterSetMaxHeight(e,t){this.configuredMaxHeight=h(e),this.changeVdomRootKey("maxHeight",e)}afterSetMaxWidth(e,t){this.configuredMaxWidth=h(e),this.changeVdomRootKey("maxWidth",e)}afterSetMinHeight(e,t){this.configuredMinHeight=h(e),this.changeVdomRootKey("minHeight",e)}afterSetMinWidth(e,t){this.configuredMinWidth=h(e),this.changeVdomRootKey("minWidth",e)}afterSetMounted(e,t){if(super.afterSetMounted(e,t),void 0!==t){let t=this;e?(t.hasBeenMounted=!0,t.floating&&(t.alignTo(),t.focus(t.id,!0)),t.fire("mounted",t.id)):t.revertFocus()}}afterSetReference(e,t){e&&this.changeVdomRootKey("data-ref",e)}async afterSetResponsive(e,t){if(e&&!this.getPlugin("responsive")){let t=this,o=await import("../../src/plugin/Responsive.mjs"),i=t.plugins||[];i.push({module:o.default,appName:t.appName,value:e}),t.plugins=i}}afterSetRole(e,t){this.changeVdomRootKey("role",e)}afterSetScrollable(e,t){if(void 0===t&&!e)return;let o=this;if(t){let e="overflow";Neo.isBoolean(t)||(e+=Neo.capitalize(t)),o.removeStyle([e])}if(!Neo.isEmpty(e)){let t="overflow";e&&!Neo.isBoolean(e)&&(t+=Neo.capitalize(e)),e?(o.addStyle(t+":auto"),o.addCls("neo-scrollable")):o.removeCls("neo-scrollable")}}afterSetStyle(e,t){(e||void 0!==t)&&this.updateStyle()}afterSetTag(e,t){e&&this.changeVdomRootKey("tag",e)}afterSetTheme(e,t){if(e||void 0!==t){let o=this,{cls:i}=o,n=!1;t&&i.includes(t)&&(r.remove(i,t),n=!0),e!==o.parent?.theme&&(e&&r.add(i,e),n=!0),n&&(o.cls=i)}}afterSetText(e,t){this.changeVdomRootKey("text",e)}afterSetTooltip(e,t){t?.destroy?.(),e&&(Neo.ns("Neo.tooltip.Base")?this.createTooltip(e):import("../tooltip/Base.mjs").then(()=>{this.createTooltip(e)}))}afterSetUi(e,t){let o=this,i=o.cls;t&&r.remove(i,`neo-${o.ntype}-${t}`),e&&""!==e&&r.add(i,`neo-${o.ntype}-${e}`),o.cls=i}afterSetWidth(e,t){this.configuredWidth=h(e),this.changeVdomRootKey("width",e)}afterSetWindowId(e,t){super.afterSetWindowId(e,t);let o=this.controller;o&&(o.windowId=e)}afterSetWrapperCls(e,t){t=t||[],e=e||[];let o=this,{vdom:i}=o,n=o.getVdomRoot(),s=i.cls||[];i===n?(s=r.union(s,e),r.remove(s,r.difference(t,e)),i.cls=s):(e=e||[],t&&r.remove(s,t),r.add(s,e),i.cls=s),o.update()}afterSetWrapperStyle(e,t){(e||void 0!==t)&&this.updateStyle()}async alignTo(e={}){const t=this,o={...t.align,...e,id:t.id,configuredFlex:t.configuredFlex,configuredWidth:t.configuredWidth,configuredHeight:t.configuredHeight,configuredMinWidth:t.configuredMinWidth,configuredMinHeight:t.configuredMinHeight,configuredMaxWidth:t.configuredMaxWidth,configuredMaxHeight:t.configuredMaxHeight};o.target&&await Neo.main.DomAccess.align(o)}beforeGetCls(e){return e?[...e]:[]}beforeGetStyle(e){return{...e}}beforeGetWrapperCls(e){return e?[...e]:[]}beforeGetWrapperStyle(e){return{...Object.assign(this.vdom.style||{},e)}}beforeSetAlign(e,t){return"string"==typeof e&&(e={edgeAlign:e}),e}beforeSetCls(e,t){return r.union(e||[],this.baseCls,this.getBaseClass())}beforeSetController(e,o){return o?.destroy(),e?t.beforeSetInstance(e,"Neo.controller.Component",{component:this,windowId:this.windowId}):e}beforeSetDomListeners(e,t){return Neo.isObject(e)&&(e=[e]),e||[]}beforeSetHideMode(e,t){return this.beforeSetEnumValue(e,t,"hideMode")}beforeSetKeys(e,o){return o?.destroy(),e&&(e=t.beforeSetInstance(e,i,{keyDownEventBubble:!0,keys:e})),e}beforeSetPlugins(e,o){return Array.isArray(e)&&e.forEach((o,i)=>{e[i]=t.beforeSetInstance(o,null,{owner:this})}),e}beforeSetSilentVdomUpdate(e,t){return!0===e?Neo.isNumber(t)?t+1:1:Neo.isNumber(t)&&t>0?t-1:0}beforeSetUpdateDepth(e,t){return void 0===t?e:-1===t||-1===e?-1:Math.max(e,t)}changeVdomRootKey(e,t){let o=this.getVdomRoot();t?o[e]=t:delete o[e],this.update()}createLoadingMask(e){return{cls:["neo-load-mask"],cn:[{cls:["neo-load-mask-body"],cn:[{cls:this.loadingSpinnerCls},{cls:["neo-loading-message"],removeDom:!Neo.isString(e),text:e}]}]}}createTooltip(e){"string"==typeof e&&(e={text:e});let t=this;e.ownInstance?t._tooltip=Neo.create("Neo.tooltip.Base",{...e,appName:t.appName,componentId:t.id,windowId:t.windowId}):(t._tooltip=e,Neo.tooltip.Base.createSingleton(t.app),t.addCls("neo-uses-shared-tooltip"),t.update())}destroy(e=!1,t=!1){let o,i=this,{parent:n,parentId:r}=i;i.revertFocus(),i.controller=null,i.reference&&i.getController()?.removeReference(i),i.plugins?.forEach(e=>{e.destroy()}),e&&r&&("document.body"===r?Neo.applyDeltas(i.appName,{action:"removeNode",id:i.vdom.id}):(o=n.vdom,a.removeVdomChild(o,i.vdom.id),n[t?"_vdom":"vdom"]=o)),super.destroy(),i.onFocusLeave=Neo.emptyFn,i.unmount=Neo.emptyFn}down(e,t=!0){return o.down(this,e,t)}focus(e=this.id,t=!1){Neo.main.DomAccess.focus({children:t,id:e,windowId:this.windowId})}getBaseClass(){const e=[];return this.floating&&e.push("neo-floating"),e}getController(e){let t,o=this;return!e&&(t=o[u],t)||(t=o.getConfigInstanceByNtype("controller",e),e||(o[u]=t)),t}async getDomRect(e=this.id,t=this.appName){let o=await Neo.main.DomAccess.getBoundingClientRect({appName:t,id:e,windowId:this.windowId});return Array.isArray(o)?o.map(e=>s.clone(e)):s.clone(o)}getParents(){return o.getParents(this)}getPlugin(e){Neo.isString(e)&&(e.startsWith("plugin-")||(e="plugin-"+e),e={ntype:e});let t,o=this;for(const i of o.plugins||[]){t=!0;for(const o in e)if(i[o]!==e[o]){t=!1;break}if(t)return i}return null}getReference(e){return this.down({reference:e})}getTheme(){let e,t,o=this,i="neo-theme-";for(const e of o.cls||[])if(e.startsWith(i))return e;if(e=o.app?.mainView,e){t=a.getParentNodes(e.vdom,o.id);for(const e of t||[])for(const t of e.cls||[])if(t.startsWith(i))return t}return Neo.config.themes?.[0]}hide(e){let t=this;if("visibility"!==t.hideMode){let o=function(){"document.body"!==t.parentId?(t.vdom.removeDom=!0,t.parent.updateDepth=2,t.parent.update()):t.unmount()};e?t.timeout(e).then(o):o()}else{let e=t.style;e.visibility="hidden",t.style=e}t._hidden=!0}init(){this.autoRender&&this.render()}isFloating(){let e=this;return!!e.floating||!!e.parent&&e.parent.floating}async measure(e){if(null!=e)if(e.endsWith("px"))e=parseFloat(e);else if(c.test(e)){let{id:t,windowId:o}=this;e=await Neo.main.DomAccess.measure({id:t,value:e,windowId:o})}else isNaN(e)||(e=parseFloat(e));return e}mergeConfig(...e){let t=super.mergeConfig(...e),o=t.vdom||t._vdom||{};return this._vdom=Neo.clone({...o,...this._vdom||{}},!0),delete t._vdom,delete t.vdom,t}async mount(){let e,t,i=this;if(!i.vnode)throw new Error("Component vnode must be generated before mounting, use Component.render()");i.hasUnmountedVdomChanges?(i.hasUnmountedVdomChanges=!1,t=o.getChildIds(i.vnode),t.forEach(t=>{e=Neo.getComponent(t),e&&(e._hasUnmountedVdomChanges=!1)}),i.render(!0)):(await p.promiseMessage("main",{action:"mountDom",appName:i.appName,id:i.id,html:i.vnode.outerHTML,parentId:i.getMountedParentId(),parentIndex:i.getMountedParentIndex()}),delete i.vdom.removeDom,await i.timeout(30),i.mounted=!0)}onConstructed(){super.onConstructed();this.keys?.register(this)}onFocusEnter(e){this.focusEnterData=e}onFocusLeave(e){this.focusEnterData=null}removeCls(e){let t=this.cls;r.remove(t,e),this.cls=t}removeStyle(e){Array.isArray(e)||(e=[e]);let{style:t}=this,o=!1;return Object.keys(t).forEach(i=>{e.indexOf(i)>-1&&(delete t[i],o=!0)}),o&&(this.style=t),t}revertFocus(){let e=this.focusEnterData?.relatedTarget;this.containsFocus&&e&&Neo.getComponent(e.id)?.focus()}show(){let e=this;if("visibility"!==e.hideMode)delete e.vdom.removeDom,e.silentVdomUpdate?e.needsVdomUpdate=!0:"document.body"!==e.parentId?(e.parent.updateDepth=2,e.parent.update()):!e.mounted&&e.render(!0);else{let t=e.style;delete t.visibility,e.style=t}e._hidden=!1}toggleCls(e,t){let o=this.cls;r.toggle(o,e,t),this.cls=o}unmount(){let e=this;e.vdom.removeDom=!0,e._hidden=!0,e.mounted=!1,Neo.applyDeltas(e.appName,{action:"removeNode",id:e.vdom.id})}up(e){return o.up(this.id,e)}updateStyle(){let e=this,{vdom:t}=e,o=e.getVdomRoot();t!==o?(t.style=e.wrapperStyle,o.style=e.style):t.style={...e.wrapperStyle,...e.style},e.update()}async waitForDomRect({appName:e=this.appName,attempts:t=10,delay:o=50,id:i=this.id}){let n=this,r=await n.getDomRect(i,e),s=!1;return Array.isArray(r)?r.forEach(e=>{(e.height<1||e.width<1)&&(s=!0)}):(r.height<1||r.width<1)&&(s=!0),s&&t>0?(await n.timeout(o),await n.waitForDomRect({appName:e,attempts:t-1,delay:o,id:i})):r}});