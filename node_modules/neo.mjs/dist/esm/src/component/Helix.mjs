import e from"../util/ClassSystem.mjs";import t from"./Base.mjs";import o from"../selection/HelixModel.mjs";import s from"../util/Matrix.mjs";import n from"../util/Array.mjs";import i from"../data/Store.mjs";const a=Symbol.for("itemsMounted"),r=Symbol.for("lockWheel");class l extends t{static config={className:"Neo.component.Helix",ntype:"helix",backgroundColor_:"#000000",backgroundImage_:"",baseCls:["neo-helix"],clonedItems:[],deltaY_:1.5,dimmed_:!1,dimmedMaxOpacity_:.3,dimmedMinOpacity_:.2,disableSelection:!1,flipped_:!1,followSelection_:!1,imageField:"image",imageSource_:null,itemAngle_:8,itemTpl_:{cls:["surface","neo-helix-item"],style:{},tabIndex:"-1",cn:[{tag:"img",cls:["contact-item"]}]},keyProperty:"id",keys:{Enter:"onKeyDownEnter",Space:"onKeyDownSpace"},matrix:null,maxItems_:300,maxOpacity_:.8,minOpacity_:.3,mouseWheelDeltaX:5,mouseWheelDeltaY:50,mouseWheelEnabled_:!0,offsetHeight:null,offsetWidth:null,perspective_:800,radius_:1500,rotationAngle_:780,rotationMatrix:null,showCloneInfo:!0,selectedItemCls:"neo-selected",selectionModel_:null,store_:null,transitionTimeouts:[],translateX_:400,translateY_:-350,translateZ_:-5e3,url_:"../../resources/examples/data/ai_contacts.json",_vdom:{style:{},tabIndex:"-1",cn:[{cls:["container"],style:{},cn:[{cls:["group"],cn:[],style:{opacity:1,transform:"matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 461, 452.5, -100700, 1)"}}]}]}};construct(e){super.construct(e);let t=this;t[a]=!1,t[r]=!0,t.addDomListeners({click:t.onClick,resize:t.onResize,scope:t,touchmove:t.onTouchMove,wheel:{bubble:!1,fn:t.onMouseWheel,local:!0,passive:!1}})}async addResizeObserver(e){let{id:t,windowId:o}=this;(await Neo.currentWorker.getAddon("ResizeObserver",o))[e?"register":"unregister"]({id:t,windowId:o})}afterSetFollowSelection(e,t){let{cls:o}=this;n[e?"add":"remove"](o,"neo-follow-selection"),this.cls=o}afterSetFlipped(e,t){this.applyItemTransitions(this.refresh,1e3)}afterSetImageSource(e,t){let o=this;t&&(o.getItemsRoot().cn=[],o.createItems())}afterSetMaxItems(e,t){let o=this;e&&o.vnodeInitialized&&(t>e?o.destroyItems(e,t-e):o.createItems(t))}afterSetMounted(e,t){super.afterSetMounted(e,t),void 0!==t&&this.addResizeObserver(e)}afterSetPerspective(e,t){let o=this;o.mounted&&(Neo.applyDeltas(o.windowId,{id:o.vdom.id,style:{perspective:e+"px"}}),o.updateCloneTranslate())}afterSetSelectionModel(e,t){this.vnodeInitialized&&e.register(this)}afterSetUrl(e,t){let o=this;o.vnodeInitialized&&(o.destroyItems(),o.loadData())}afterSetWindowId(e,t){super.afterSetWindowId(e,t),e&&(this.imageSource=Neo.config.resourcesPath+"examples/")}applyItemTransitions(e,t,o){let s,i=this,{id:a}=i,r="neo-transition-"+t;i.transitionTimeouts.forEach(e=>{clearTimeout(e)}),i.transitionTimeouts.splice(0,i.transitionTimeouts.length),i.mounted&&Neo.applyDeltas(i.windowId,{id:a,cls:{add:[r],remove:[]}}).then(()=>{e.apply(i,[o]),s=setTimeout(()=>{n.remove(i.transitionTimeouts,s),Neo.applyDeltas(i.windowId,{id:a,cls:{add:[],remove:[r]}})},t+200),i.transitionTimeouts.push(s)})}beforeGetItemTpl(){return Neo.clone(this._itemTpl,!0)}beforeSetSelectionModel(t,s){return s?.destroy(),e.beforeSetInstance(t,o,{listeners:{selectionChange:this.onSelectionChange,scope:this}})}beforeSetStore(t,o){let s=this;return o?.destroy(),e.beforeSetInstance(t,i,{listeners:{load:s.onStoreLoad,sort:s.onSort,scope:s}})}calculateOpacity(e){let t,o,s,{maxOpacity:n,minOpacity:i}=this,a=n-i;if(0===a)o=n;else{for(t=e.rotationAngle%360;t<0;)t+=360;for(;t>180;)t=360-t;s=1-Math.sin(t*Math.PI/360),o=i+a*s}return o}createItem(e,t,o){let s=this;return e.id=s.getItemVnodeId(t[s.keyProperty]),e.cn[0].id=s.getItemVnodeId(t[s.keyProperty])+"_img",e.cn[0].src=s.imageSource+Neo.ns(s.imageField,!1,t),e}createItems(e){let t,o,n,i,l,d,m,c,p,h,u=this,{deltaY:f,itemAngle:I,matrix:y,radius:g,rotationAngle:S,translateX:w,translateY:x,translateZ:M,vdom:_}=u,T=u.getItemsRoot(),v=e||0,N=Math.min(u.maxItems,u.store.count);if(u.mounted){for(;v<N;v++)o=u.store.getAt(v),t=v*I-S,m=Math.sin(t*Math.PI/180),d=Math.cos(t*Math.PI/180),c=g*m-300+w,p=t*f-400+x,h=99800+g*d+M,n=[[d,0,-m,0],[0,1,0,0],[m,0,d,0],[c,p,h,1]],y?y.items=n:u.matrix=y=Neo.create(s,{items:n}),i=y.getTransformStyle(),l=u.createItem(u.itemTpl,o,v),o.rotationAngle=t,o.transformStyle=i,l.style=l.style||{},l.style.opacity=u.calculateOpacity(o),l.style.transform=i,T.cn.push(l);u[r]=!0,u.promiseUpdate().then(()=>{u[a]=!0,u.fire("itemsMounted"),u.timeout(200).then(()=>{u[r]=!1})})}else u.on("mounted",()=>{u.timeout(100).then(()=>{u.createItems(e)})},u,{once:!0})}destroyClones(){let e,t,o=this,{store:s}=o,n=[],i=[];o.clonedItems.length>0&&(o.clonedItems.forEach(a=>{e=o.getItemId(a.id),t=s.get(e),t.expanded=!1,n.push({id:a.id,style:{opacity:t.opacity,transform:t.transformStyle}}),i.push({id:a.id,action:"removeNode"})}),o.clonedItems=[],Neo.applyDeltas(o.windowId,n).then(e=>{o.timeout(650).then(()=>{Neo.applyDeltas(o.windowId,i)})}))}destroyItems(e,t){let o=this;o.getItemsRoot().cn.splice(e||0,t||o.store.getCount()),o.update()}expandItem(e){let t=this,{appName:o,store:s}=t,i=s.get(e),a=s.indexOf(e),r=!!i.expanded,l=t.getItemsRoot(),d=Neo.clone(l.cn[a],!0);t.destroyClones(),!0!==r&&(i.expanded=!0,d.id=d.id+"__clone",d.style.transform=i.transformStyle,n.add(d.cls,"neo-transition-600"),delete d.tabIndex,d.cn[0].id=d.cn[0].id+"__clone",t.showCloneInfo&&d.cn.push({cls:["contact-name"],text:i.firstname+" "+i.lastname}),Neo.vdom.Helper.create({appName:o,autoMount:!0,parentId:l.id,parentIndex:s.getCount(),vdom:d,windowId:t.windowId}).then(e=>{t.clonedItems.push(d),t.timeout(50).then(()=>{Neo.applyDeltas(t.windowId,{id:d.id,style:{opacity:1,transform:t.getCloneTransform()}})})}))}getCloneTransform(){let e=this;return`matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,${(e.offsetWidth-1350)/3},${(e.offsetHeight-1320)/3},${100700+e.perspective/1.5},1`}getItemId(e){return parseInt(e.split("__")[1])}getItemsRoot(){return this.vdom.cn[0].cn[0]}getItemVnodeId(e){return this.id+"__"+e}async loadData(){let e,t=this;try{e=await t.trap(Neo.Xhr.promiseJson({insideNeo:!0,url:t.url})),t.store.items=e.json.data,t.createItems()}catch(e){e!==Neo.isDestroyed&&console.log("Error for Neo.Xhr.request",e,t.id)}}moveToSelectedItem(e){let t=this;t.rotationAngle=t.store.get(e).rotationAngle+t.rotationAngle}onClick(e){this.fire(e.id===this.id?"containerClick":"itemClick",e)}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onKeyDownEnter(e){let t=this.selectionModel.items[0];t&&this.expandItem(t)}onKeyDownSpace(e){this.applyItemTransitions(this.moveToSelectedItem,1e3,this.selectionModel.items[0]||0)}onMouseWheel(e){let t=this;t.mouseWheelEnabled&&!t[r]&&(t._rotationAngle=t.rotationAngle+e.deltaX*t.mouseWheelDeltaX,t._translateZ=t.translateZ+e.deltaY*t.mouseWheelDeltaY,t.refresh(),t.fire("changeRotation",t._rotationAngle),t.fire("changeTranslateZ",t._translateZ))}async onResize(e){let t,o=this,{appName:s,clonedItems:n}=o;o.offsetHeight=e.rect.height,o.offsetWidth=e.rect.width,n.length>0&&(t=n[0].id,await Neo.applyDeltas(o.windowId,{id:t,cls:{remove:["neo-transition-600"]},style:{transform:o.getCloneTransform()}}),await o.timeout(10),await Neo.applyDeltas(o.windowId,{id:t,cls:{add:["neo-transition-600"]}}))}onSelectionChange(e,t){let o=this;o.followSelection&&e?.[0]&&o.applyItemTransitions(o.moveToSelectedItem,100,e[0])}onSort(){let e=this;!0===e[a]&&e.applyItemTransitions(e.sortItems,1e3)}onStoreLoad(e){this.getItemsRoot().cn=[],this.createItems()}onTouchMove(e){e.deltaX*=1.5,e.deltaY*=3,this.onMouseWheel(e)}refresh(){let e,t,o,n,i,a,r,l,d,m,c,p=this,h=[],{deltaY:u,flipped:f,itemAngle:I,matrix:y,radius:g,rotationAngle:S,rotationMatrix:w,translateX:x,translateY:M,translateZ:_,vdom:T}=p,v=0,N=Math.min(p.maxItems,p.store.getCount());for(f&&(n=s.rotateY(180*Math.PI/180),w?w.items=n:p.rotationMatrix=w=Neo.create(s,{items:n}));v<N;v++)t=p.store.getAt(v),a=T.cn[0].cn[0].cn[v],e=v*I-S,l=Math.sin(e*Math.PI/180),r=Math.cos(e*Math.PI/180),d=g*l-300+x,m=e*u-400+M,c=99800+g*r+_,y.items=[[r,0,-l,0],[0,1,0,0],[l,0,r,0],[d,m,c,1]],f&&(y=w.x(y)),i=y.getTransformStyle(),y.destroy(),Object.assign(t,{rotationAngle:e,transformStyle:i}),o=p.calculateOpacity(t),t.opacity=o,Object.assign(t,{opacity:o,rotationAngle:e,transformStyle:i}),h.push({id:p.getItemVnodeId(t[p.keyProperty]),style:{opacity:o,transform:i}});Neo.applyDeltas(p.windowId,h)}refreshIfMounted(){this.mounted&&this.refresh()}sortItems(){let e=this,t=[],o=e.vdom.cn[0].cn[0].id,s=0,n=Math.min(e.maxItems,e.store.getCount());for(;s<n;s++)t.push({action:"moveNode",id:e.getItemVnodeId(e.store.getAt(s)[e.keyProperty]),index:s,parentId:o});Neo.applyDeltas(e.windowId,t).then(()=>{e.refresh()})}updateCloneTranslate(){let e,t,o=this,s=[],i=[];o.clonedItems.length>0&&(t=o.getCloneTransform(!0),o.transitionTimeouts.forEach(e=>{clearTimeout(e)}),o.clonedItems.forEach(e=>{i.push({id:e.id,cls:{add:[],remove:["neo-transition-600"]},style:{transform:t}}),s.push({id:e.id,cls:{add:["neo-transition-600"],remove:[]}})}),Neo.applyDeltas(o.windowId,i).then(()=>{e=setTimeout(()=>{n.remove(o.transitionTimeouts,e),Neo.applyDeltas(o.windowId,s)},200),o.transitionTimeouts.push(e)}))}}const d={enumerable:!1,value:l.prototype.refreshIfMounted};Object.defineProperties(l.prototype,{afterSetDeltaY:d,afterSetItemAngle:d,afterSetMaxOpacity:d,afterSetMinOpacity:d,afterSetRadius:d,afterSetRotationAngle:d,afterSetTranslateX:d,afterSetTranslateY:d,afterSetTranslateZ:d});export default Neo.setupClass(l);