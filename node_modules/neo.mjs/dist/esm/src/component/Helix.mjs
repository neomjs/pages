import e from"../util/ClassSystem.mjs";import t from"./Base.mjs";import o from"../selection/HelixModel.mjs";import s from"../util/Matrix.mjs";import a from"../util/Array.mjs";import n from"../data/Store.mjs";const i=Symbol.for("itemsMounted"),r=Symbol.for("lockWheel");class l extends t{static config={className:"Neo.component.Helix",ntype:"helix",backgroundColor_:"#000000",backgroundImage_:"",baseCls:["neo-helix"],clonedItems:[],deltaY_:1.5,dimmed_:!1,dimmedMaxOpacity_:.3,dimmedMinOpacity_:.2,disableSelection:!1,flipped_:!1,followSelection_:!1,imageField:"image",imageSource_:null,itemAngle_:8,itemTpl_:{cls:["surface","neo-helix-item"],style:{},tabIndex:"-1",cn:[{tag:"img",cls:["contact-item"]}]},keyProperty:"id",keys:{Enter:"onKeyDownEnter",Space:"onKeyDownSpace"},matrix:null,maxItems_:300,maxOpacity_:.8,minOpacity_:.3,mouseWheelDeltaX:5,mouseWheelDeltaY:50,mouseWheelEnabled_:!0,offsetHeight:null,offsetWidth:null,perspective_:800,radius_:1500,rotationAngle_:780,rotationMatrix:null,showCloneInfo:!0,selectedItemCls:"neo-selected",selectionModel_:null,store_:null,transitionTimeouts:[],translateX_:400,translateY_:-350,translateZ_:-5e3,url_:"../../resources/examples/data/ai_contacts.json",_vdom:{style:{},tabIndex:"-1",cn:[{cls:["container"],style:{},cn:[{cls:["group"],cn:[],style:{opacity:1,transform:"matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 461, 452.5, -100700, 1)"}}]}]}};construct(e){super.construct(e);let t=this;t[i]=!1,t[r]=!0,t.addDomListeners({click:t.onClick,resize:t.onResize,touchmove:t.onTouchMove,wheel:t.onMouseWheel,scope:t})}async addResizeObserver(e){let{id:t,windowId:o}=this;(await Neo.currentWorker.getAddon("ResizeObserver",o))[e?"register":"unregister"]({id:t,windowId:o})}afterSetFollowSelection(e,t){let{cls:o}=this;a[e?"add":"remove"](o,"neo-follow-selection"),this.cls=o}afterSetFlipped(e,t){this.applyItemTransitions(this.refresh,1e3)}afterSetImageSource(e,t){let o=this;t&&(o.getItemsRoot().cn=[],o.createItems())}afterSetMaxItems(e,t){let o=this;e&&o.rendered&&(t>e?o.destroyItems(e,t-e):o.createItems(t))}afterSetMounted(e,t){super.afterSetMounted(e,t),void 0!==t&&this.addResizeObserver(e)}afterSetPerspective(e,t){let o=this;o.mounted&&(Neo.applyDeltas(o.appName,{id:o.vdom.id,style:{perspective:e+"px"}}),o.updateCloneTranslate())}afterSetSelectionModel(e,t){this.rendered&&e.register(this)}afterSetUrl(e,t){let o=this;o.rendered&&(o.destroyItems(),o.loadData())}afterSetWindowId(e,t){super.afterSetWindowId(e,t),e&&(this.imageSource=Neo.config.resourcesPath+"examples/")}applyItemTransitions(e,t,o){let s,n=this,{id:i}=n,r="neo-transition-"+t;n.transitionTimeouts.forEach((e=>{clearTimeout(e)})),n.transitionTimeouts.splice(0,n.transitionTimeouts.length),n.mounted&&Neo.applyDeltas(n.appName,{id:i,cls:{add:[r],remove:[]}}).then((()=>{e.apply(n,[o]),s=setTimeout((()=>{a.remove(n.transitionTimeouts,s),Neo.applyDeltas(n.appName,{id:i,cls:{add:[],remove:[r]}})}),t+200),n.transitionTimeouts.push(s)}))}beforeGetItemTpl(){return Neo.clone(this._itemTpl,!0)}beforeSetSelectionModel(t,s){return s?.destroy(),e.beforeSetInstance(t,o,{listeners:{selectionChange:this.onSelectionChange,scope:this}})}beforeSetStore(t,o){let s=this;return o?.destroy(),e.beforeSetInstance(t,n,{listeners:{load:s.onStoreLoad,sort:s.onSort,scope:s}})}calculateOpacity(e){let t,o,s,{maxOpacity:a,minOpacity:n}=this,i=a-n;if(0===i)o=a;else{for(t=e.rotationAngle%360;t<0;)t+=360;for(;t>180;)t=360-t;s=1-Math.sin(t*Math.PI/360),o=n+i*s}return o}createItem(e,t,o){let s=this;return e.id=s.getItemVnodeId(t[s.keyProperty]),e.cn[0].id=s.getItemVnodeId(t[s.keyProperty])+"_img",e.cn[0].src=s.imageSource+Neo.ns(s.imageField,!1,t),e}createItems(e){let t,o,a,n,l,m,d,c,p,h,u=this,{deltaY:f,itemAngle:y,matrix:I,radius:g,rotationAngle:S,translateX:M,translateY:x,translateZ:N,vdom:T}=u,_=u.getItemsRoot(),v=e||0,C=Math.min(u.maxItems,u.store.items.length);if(u.mounted){for(;v<C;v++)o=u.store.items[v],t=v*y-S,d=Math.sin(t*Math.PI/180),m=Math.cos(t*Math.PI/180),c=g*d-300+M,p=t*f-400+x,h=99800+g*m+N,a=[[m,0,-d,0],[0,1,0,0],[d,0,m,0],[c,p,h,1]],I?I.items=a:u.matrix=I=Neo.create(s,{items:a}),n=I.getTransformStyle(),l=u.createItem(u.itemTpl,o,v),o.rotationAngle=t,o.transformStyle=n,l.style=l.style||{},l.style.opacity=u.calculateOpacity(o),l.style.transform=n,_.cn.push(l);u[r]=!0,u.promiseUpdate().then((()=>{u[i]=!0,u.fire("itemsMounted"),u.timeout(200).then((()=>{u[r]=!1}))}))}else u.on("mounted",(()=>{u.timeout(100).then((()=>{u.createItems(e)}))}),u,{once:!0})}destroyClones(){let e,t,o=this,{store:s}=o,a=[],n=[];o.clonedItems.length>0&&(o.clonedItems.forEach((i=>{e=o.getItemId(i.id),t=s.get(e),t.expanded=!1,a.push({id:i.id,style:{opacity:t.opacity,transform:t.transformStyle}}),n.push({id:i.id,action:"removeNode"})})),o.clonedItems=[],Neo.applyDeltas(o.appName,a).then((e=>{o.timeout(650).then((()=>{Neo.applyDeltas(o.appName,n)}))})))}destroyItems(e,t){let o=this;o.getItemsRoot().cn.splice(e||0,t||o.store.getCount()),o.update()}expandItem(e){let t=this,{appName:o,store:s}=t,n=s.get(e),i=s.indexOf(e),r=!!n.expanded,l=t.getItemsRoot(),m=Neo.clone(l.cn[i],!0);t.destroyClones(),!0!==r&&(n.expanded=!0,m.id=m.id+"__clone",m.style.transform=n.transformStyle,a.add(m.cls,"neo-transition-600"),delete m.tabIndex,m.cn[0].id=m.cn[0].id+"__clone",t.showCloneInfo&&m.cn.push({cls:["contact-name"],innerHTML:n.firstname+" "+n.lastname}),Neo.vdom.Helper.create({appName:o,autoMount:!0,parentId:l.id,parentIndex:s.getCount(),...m}).then((e=>{t.clonedItems.push(m),t.timeout(50).then((()=>{Neo.applyDeltas(o,{id:m.id,style:{opacity:1,transform:t.getCloneTransform()}})}))})))}getCloneTransform(){let e=this;return`matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,${(e.offsetWidth-1350)/3},${(e.offsetHeight-1320)/3},${100700+e.perspective/1.5},1`}getItemId(e){return parseInt(e.split("__")[1])}getItemsRoot(){return this.vdom.cn[0].cn[0]}getItemVnodeId(e){return this.id+"__"+e}loadData(){let e=this;Neo.Xhr.promiseJson({insideNeo:!0,url:e.url}).catch((t=>{console.log("Error for Neo.Xhr.request",t,e.id)})).then((t=>{e.store.items=t.json.data,e.createItems()}))}moveToSelectedItem(e){let t=this;t.rotationAngle=t.store.get(e).rotationAngle+t.rotationAngle}onClick(e){this.fire(e.id===this.id?"containerClick":"itemClick",e)}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}onKeyDownEnter(e){let t=this.selectionModel.items[0];t&&this.expandItem(t)}onKeyDownSpace(e){this.applyItemTransitions(this.moveToSelectedItem,1e3,this.selectionModel.items[0]||0)}onMouseWheel(e){let t=this;t.mouseWheelEnabled&&!t[r]&&(t._rotationAngle=t.rotationAngle+e.deltaX*t.mouseWheelDeltaX,t._translateZ=t.translateZ+e.deltaY*t.mouseWheelDeltaY,t.refresh(),t.fire("changeRotation",t._rotationAngle),t.fire("changeTranslateZ",t._translateZ))}async onResize(e){let t,o=this,{appName:s,clonedItems:a}=o;o.offsetHeight=e.rect.height,o.offsetWidth=e.rect.width,a.length>0&&(t=a[0].id,await Neo.applyDeltas(s,{id:t,cls:{remove:["neo-transition-600"]},style:{transform:o.getCloneTransform()}}),await o.timeout(10),await Neo.applyDeltas(s,{id:t,cls:{add:["neo-transition-600"]}}))}onSelectionChange(e,t){let o=this;o.followSelection&&e?.[0]&&o.applyItemTransitions(o.moveToSelectedItem,100,e[0])}onSort(){let e=this;!0===e[i]&&e.applyItemTransitions(e.sortItems,1e3)}onStoreLoad(e){this.getItemsRoot().cn=[],this.createItems()}onTouchMove(e){e.deltaX*=1.5,e.deltaY*=3,this.onMouseWheel(e)}refresh(){let e,t,o,a,n,i,r,l,m,d,c,p=this,h=[],{deltaY:u,flipped:f,itemAngle:y,matrix:I,radius:g,rotationAngle:S,rotationMatrix:M,translateX:x,translateY:N,translateZ:T,vdom:_}=p,v=0,C=Math.min(p.maxItems,p.store.getCount());for(f&&(a=s.rotateY(180*Math.PI/180),M?M.items=a:p.rotationMatrix=M=Neo.create(s,{items:a}));v<C;v++)t=p.store.items[v],i=_.cn[0].cn[0].cn[v],e=v*y-S,l=Math.sin(e*Math.PI/180),r=Math.cos(e*Math.PI/180),m=g*l-300+x,d=e*u-400+N,c=99800+g*r+T,I.items=[[r,0,-l,0],[0,1,0,0],[l,0,r,0],[m,d,c,1]],f&&(I=M.x(I)),n=I.getTransformStyle(),I.destroy(),Object.assign(t,{rotationAngle:e,transformStyle:n}),o=p.calculateOpacity(t),t.opacity=o,Object.assign(t,{opacity:o,rotationAngle:e,transformStyle:n}),h.push({id:p.getItemVnodeId(t[p.keyProperty]),style:{opacity:o,transform:n}});Neo.applyDeltas(p.appName,h)}refreshIfMounted(){this.mounted&&this.refresh()}sortItems(){let e=this,t=[],o=e.vdom.cn[0].cn[0].id,s=0,a=Math.min(e.maxItems,e.store.getCount());for(;s<a;s++)t.push({action:"moveNode",id:e.getItemVnodeId(e.store.items[s][e.keyProperty]),index:s,parentId:o});Neo.applyDeltas(e.appName,t).then((()=>{e.refresh()}))}updateCloneTranslate(){let e,t,o=this,s=[],n=[];o.clonedItems.length>0&&(t=o.getCloneTransform(!0),o.transitionTimeouts.forEach((e=>{clearTimeout(e)})),o.clonedItems.forEach((e=>{n.push({id:e.id,cls:{add:[],remove:["neo-transition-600"]},style:{transform:t}}),s.push({id:e.id,cls:{add:["neo-transition-600"],remove:[]}})})),Neo.applyDeltas(o.appName,n).then((()=>{e=setTimeout((()=>{a.remove(o.transitionTimeouts,e),Neo.applyDeltas(o.appName,s)}),200),o.transitionTimeouts.push(e)})))}}const m={enumerable:!1,value:l.prototype.refreshIfMounted};Object.defineProperties(l.prototype,{afterSetDeltaY:m,afterSetItemAngle:m,afterSetMaxOpacity:m,afterSetMinOpacity:m,afterSetRadius:m,afterSetRotationAngle:m,afterSetTranslateX:m,afterSetTranslateY:m,afterSetTranslateZ:m});export default Neo.setupClass(l);