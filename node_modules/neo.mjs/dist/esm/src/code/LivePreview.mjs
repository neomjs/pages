import e from"../container/Base.mjs";import t from"../component/wrapper/MonacoEditor.mjs";import n from"../tab/Container.mjs";const i=/className\s*:\s*['\"]([^'\"]+)['\"]/g,o=/export\s+(?:default\s+)?(?:const|let|var|class|function|async\s+function|generator\s+function|async\s+generator\s+function|(\{[\s\S]*?\}))/g,a=/import\s+(?:([\w-]+)|\{([^}]+)\})\s+from\s+['\"]([^'\"]+)['\"]/;export default Neo.setupClass(class extends e{static activeViews=["preview","source"];static config={className:"Neo.code.LivePreview",ntype:"live-preview",activeView_:"source",baseCls:["neo-code-live-preview"],disableRunSource:!1,enableFullscreen:!0,layout:"fit",items:[{module:n,cls:["live-preview-container"],reference:"tab-container",removeInactiveCards:!1,items:[{module:t,header:{text:"Source"},hideLabel:!0,listeners:{editorChange:"up.onEditorChange"},style:{height:"100%"},reference:"editor"},{module:e,header:{text:"Preview"},reference:"preview"}]}],value_:null};previewContainer=null;get tabContainer(){return this.getItem("tab-container")}afterSetActiveView(e,t){this.tabContainer.activeIndex="source"===e?0:1}afterSetValue(e,t){e&&(this.getItem("editor").value=e?.trim())}beforeSetActiveView(e,t){return this.beforeSetEnumValue(e,t,"activeView")}async collapseExpand(e){let t,n=this,i=e.component,o="fas fa-compress"===i.iconCls,{vdom:a}=n;o?(i.iconCls="fas fa-expand",t=n.collapseRect,delete n.collapseRect,Object.assign(a.style,{height:t.height+"px",left:t.x+"px",top:t.y+"px",width:t.width+"px"}),n.update(),await n.timeout(300),Object.assign(a.style,{position:null,zIndex:null})):(i.iconCls="fas fa-compress",t=await n.getDomRect(),n.collapseRect=t,a.style=a.style||{},Object.assign(a.style,{height:t.height+"px",left:t.x+"px",position:"fixed",top:t.y+"px",width:t.width+"px",zIndex:103}),n.update(),await n.timeout(50),Object.assign(a.style,{height:"100%",left:0,top:0,width:"100%"})),n.update()}async createPopupWindow(){let e=this,t=await Neo.Main.getWindowData(),n=await e.getDomRect(e.getReference("preview").id),{height:i,left:o,top:a,width:r}=n;i-=50,o+=t.screenLeft,a+=t.outerHeight-t.innerHeight+t.screenTop,Neo.Main.windowOpen({url:`./childapps/preview/index.html?id=${e.id}`,windowFeatures:`height=${i},left=${o},top=${a},width=${r}`,windowName:e.id})}doRunSource(){if(this.disableRunSource)return;let e,t,n=this,{environment:i}=Neo.config,r=n.getPreviewContainer(),s=n.editorValue||n.value,l=n.findMainClassName(s),c=[],d=[],p=[],u=[];s.split("\n").forEach(e=>{let t=e.match(a);if(t){let e,n=t[1],o=t[2]?.split(",").map(e=>e.trim()),a=t[3];"dist/development"===i?(e=a.lastIndexOf("../"),a=0===e?"../../../../src/"+a.slice(e+3):a.slice(0,e)+"../../../"+a.slice(e+3)):"dist/production"===i&&(e=a.lastIndexOf("../"),a=0===e?"../../../esm/src/"+a.slice(e+3):a.slice(0,e)+"../../esm/"+a.slice(e+3)),d.push({defaultImport:n,namedImports:o,path:a})}else e.match(o)||c.push(`    ${e}`)}),t=d.map((e,t)=>{let n=`Module${t}`;return p.push(n),e.defaultImport&&u.push(`    const ${e.defaultImport} = ${n}.default;`),e.namedImports&&u.push(`    const {${e.namedImports.join(", ")}} = ${n};`),`import('${e.path}')`}),e=["Promise.all([",`    ${t.join(",\n")}`,`]).then(([${p.join(", ")}]) => {`,`${u.join("\n")}`,`    ${c.join("\n")}`,"",`    module = Neo.ns('${l}');`,"","    if (module && (","        Neo.component.Base.isPrototypeOf(module) ||","        Neo.functional.component.Base.isPrototypeOf(module)","    )) {","        container.add({module})","    }","})",".catch(error => {",'    console.warn("LivePreview Error:", error);',"    container.add({ntype:'component', html:error.message});","})"].join("\n"),r.removeAll(),n.findClassNames(e).forEach(e=>{let t=e.split("."),n=t.pop(),i=Neo.ns(t);i&&delete i[n]});try{new Function("container","module",e)(r,undefined)}catch(e){r.add({ntype:"component",html:e.message})}}findClassNames(e){let t,n=[];for(;null!==(t=i.exec(e));)n.push(t[1]);return n}findMainClassName(e){let t=this.findClassNames(e),n=null,i=["MainContainer","MainComponent","MainView","Main"];if(t.length>0){for(const e of i)if(n=t.find(t=>t.endsWith(e)),n)break;n||(n=t[t.length-1])}return n}getPreviewContainer(){let e=this;return e.previewContainer?e.previewContainer:e.getReference("preview")}onActiveIndexChange(e){let t=this,n=1===e.value;"preview"===e.item.reference?t.doRunSource():n||t.previewContainer||t.getReference("preview").removeAll(),t.getReference("popout-window-button").hidden=!n,t.disableRunSource=!1}onConstructed(){super.onConstructed();let e=this,t=[],{tabContainer:n}=e;e.enableFullscreen&&t.push({handler:e.collapseExpand.bind(e),iconCls:"fas fa-expand",ui:"ghost"}),t.push({handler:e.popoutPreview.bind(e),hidden:1!==n.activeIndex,iconCls:"far fa-window-maximize",reference:"popout-window-button",ui:"ghost"}),t.unshift("->"),n.getTabBar().add(t),n.getTabBar().update(),n.on("activeIndexChange",e.onActiveIndexChange,e),"preview"===e.activeView&&e.doRunSource()}onEditorChange(e){let t=this;t.editorValue=e.value,t.previewContainer&&t.doRunSource()}async popoutPreview(e){let t=this;e.component.disabled=!0,await t.createPopupWindow(),t.getController("viewport-controller")?.connectedApps.push(t.id)}});