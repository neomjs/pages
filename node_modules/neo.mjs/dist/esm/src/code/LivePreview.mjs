import e from"../container/Base.mjs";import t from"../component/wrapper/MonacoEditor.mjs";import n from"../tab/Container.mjs";const o=Symbol.for("configSymbol");export default Neo.setupClass(class extends e{static activeViews=["preview","source"];static languages=["markdown","neomjs"];static config={className:"Neo.code.LivePreview",ntype:"live-preview",activeView_:"source",baseCls:["neo-code-live-preview"],disableRunSource:!1,enableFullscreen:!0,language_:"neomjs",layout:"fit",items:[{module:n,cls:["live-preview-container"],reference:"tab-container",removeInactiveCards:!1,items:[{module:t,header:{text:"Source"},hideLabel:!0,listeners:{editorChange:"up.onEditorChange"},style:{height:"100%"},reference:"editor"},{module:e,header:{text:"Preview"},reference:"preview"}]}],value_:null,windowUrl_:"./childapps/preview/index.html"};connectedWindowId=null;markdownComponent=null;markdownComponentClass=null;neoExecutor=null;previewContainer=null;get tabContainer(){return this.getItem("tab-container")}afterSetActiveView(e,t){this.tabContainer.activeIndex="source"===e?0:1}afterSetLanguage(e,t){let n=this;"markdown"!==e&&(n.markdownComponent=null),n.getItem("editor").language="neomjs"===e?"javascript":e,t&&!Object.hasOwn(n[o],"value")&&n.doRunSource()}afterSetValue(e,t){e&&(this.getItem("editor").value=e?.trim())}beforeSetActiveView(e,t){return this.beforeSetEnumValue(e,t,"activeView")}beforeSetLanguage(e,t){return this.beforeSetEnumValue(e,t,"language")}beforeSetWindowUrl(e,t){if(e.startsWith("./")){let t=Neo.config.appPath.split("/");return t.pop(),new URL(Neo.config.basePath+t.join("/")+e.substring(1),location.href).href}return e}async collapseExpand(e){let t,n=this,o=e.component,i="fas fa-compress"===o.iconCls,{vdom:a}=n;i?(o.iconCls="fas fa-expand",t=n.collapseRect,delete n.collapseRect,Object.assign(a.style,{height:t.height+"px",left:t.x+"px",top:t.y+"px",width:t.width+"px"}),n.update(),await n.timeout(300),Object.assign(a.style,{position:null,zIndex:null})):(o.iconCls="fas fa-compress",t=await n.getDomRect(),n.collapseRect=t,a.style=a.style||{},Object.assign(a.style,{height:t.height+"px",left:t.x+"px",position:"fixed",top:t.y+"px",width:t.width+"px",zIndex:103}),n.update(),await n.timeout(50),Object.assign(a.style,{height:"100%",left:0,top:0,width:"100%"})),n.update()}async createPopupWindow(){let e=this,{windowId:t}=e,n=await Neo.Main.getWindowData({windowId:t}),o=await e.getDomRect(e.getReference("preview").id),{height:i,left:a,top:r,width:d}=o;a+=n.screenLeft,r+=n.outerHeight-n.innerHeight+n.screenTop,Neo.Main.windowOpen({url:`${e.windowUrl}?id=${e.id}`,windowFeatures:`height=${i},left=${a},top=${r},width=${d}`,windowId:t,windowName:e.id})}destroy(...e){this.connectedWindowId&&Neo.Main.windowClose({names:[this.id],windowId:this.windowId}),super.destroy(...e)}async doRunSource(){if(this.disableRunSource)return;let e=this,t=e.getPreviewContainer(),n=e.editorValue||e.value;if(n)if("markdown"===e.language){if(!e.markdownComponentClass){const t=await import("../component/Markdown.mjs");e.markdownComponentClass=t.default}e.markdownComponent&&!e.markdownComponent.isDestroyed?e.markdownComponent.value=n:(t.removeAll(!0,!0),e.markdownComponent=t.add({module:e.markdownComponentClass,style:{height:"100%",overflow:"auto"},value:n,windowUrl:e.windowUrl}))}else{if(!e.neoExecutor){const t=await import("./executor/Neo.mjs");e.neoExecutor=Neo.create(t.default)}await e.neoExecutor.execute({code:n,container:t})}}getPreviewContainer(){let e=this;return e.previewContainer?e.previewContainer:e.getReference("preview")}onActiveIndexChange(e){let t=this,n=1===e.value;"preview"===e.item.reference?t.doRunSource():n||t.previewContainer||t.getReference("preview").removeAll(),t.getReference("popout-window-button").hidden=!n,t.disableRunSource=!1}onConstructed(){super.onConstructed();let e=this,t=[],{tabContainer:n}=e;e.editor,e.enableFullscreen&&t.push({handler:e.collapseExpand.bind(e),iconCls:"fas fa-expand",ui:"ghost"}),Neo.config.useSharedWorkers&&(t.push({handler:e.popoutPreview.bind(e),hidden:1!==n.activeIndex,iconCls:"far fa-window-maximize",reference:"popout-window-button",ui:"ghost"}),Neo.currentWorker.on({connect:e.onWindowConnect,disconnect:e.onWindowDisconnect,scope:e})),t.unshift("->"),n.getTabBar().add(t),n.getTabBar().update(),n.on("activeIndexChange",e.onActiveIndexChange,e),"preview"===e.activeView&&e.doRunSource()}onEditorChange({value:e}){let t=this;t._value=e,t.editorValue=e,t.fire("editorChange",{value:e}),t.doRunSource()}async onWindowConnect(e){let t=this,n=await Neo.Main.getByPath({path:"location.search",windowId:e.windowId});if(new URLSearchParams(n).get("id")===t.id){t.connectedWindowId=e.windowId;let n=Neo.apps[e.windowId].mainView,o=t.getReference("preview"),{tabContainer:i}=t,a=o.removeAt(0,!1);t.previewContainer=n,n.add(a),i.activeIndex=0,i.getTabAtIndex(1).disabled=!0}}async onWindowDisconnect(e){let t=this;if(e.windowId===t.connectedWindowId){let n=Neo.apps[e.windowId].mainView,o=t.getReference("preview"),{tabContainer:i}=t,a=n.removeAt(0,!1);t.previewContainer=null,o.add(a),t.disableRunSource=!0,i.activeIndex=1,t.getReference("popout-window-button").disabled=!1,i.getTabAtIndex(1).disabled=!1,t.connectedWindowId=null}}async popoutPreview(e){e.component.disabled=!0,await this.createPopupWindow()}});