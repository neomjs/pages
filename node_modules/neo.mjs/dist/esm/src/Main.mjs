import e from"./Neo.mjs";import*as o from"./core/_export.mjs";import t from"./manager/ClassHierarchy.mjs";import n from"./main/DomAccess.mjs";import i from"./main/DeltaUpdates.mjs";import a from"./main/DomEvents.mjs";import r from"./core/Observable.mjs";import s from"./worker/Manager.mjs";class d extends o.Base{static observable=!0;static config={className:"Neo.Main",mode:"read",openWindows:{},readQueue:[],remote:{app:["alert","editRoute","getByPath","getWindowData","importAddon","log","redirectTo","reloadWindow","setNeoConfig","setRoute","windowClose","windowCloseAll","windowMoveTo","windowOpen","windowResizeTo"]},running:!1,showFps:!1,singleton:!0,timeLimit:15,totalFrameCount:0,updateQueue:[],writeQueue:[]};construct(e){super.construct(e);let o=this;s.on({automount:o.onRender,"message:mountDom":o.onMountDom,"message:updateDom":o.onUpdateDom,updateVdom:o.onUpdateVdom,scope:o}),a.on("domContentLoaded",o.onDomContentLoaded,o),"loading"!==document.readyState&&a.onDomContentLoaded()}alert(e){alert(e.message)}editRoute(e){let o=a.parseHash(window.location.hash.substr(1)),t=[];"string"==typeof e&&(e=a.parseHash(e)),Object.assign(o,e),Object.entries(o).forEach(([e,o])=>{null!==o&&t.push(encodeURIComponent(e)+"="+encodeURIComponent(o))}),window.location.hash=t.join("&")}getByPath({params:o=[],path:t}){let n=e.nsWithArrays(t);return e.isFunction(n)?n(...o):n}getWindowData(){let e=window,{screen:o}=e;return{innerHeight:e.innerHeight,innerWidth:e.innerWidth,outerHeight:e.outerHeight,outerWidth:e.outerWidth,screen:{availHeight:o.availHeight,availLeft:o.availLeft,availTop:o.availTop,availWidth:o.availWidth,colorDepth:o.colorDepth,height:o.height,orientation:{angle:o.orientation?.angle,type:o.orientation?.type},pixelDepth:o.pixelDepth,width:o.width},screenLeft:e.screenLeft,screenTop:e.screenTop}}async importAddon(e){let o,{name:t}=e;return o=t.startsWith("WS/")?await import(`../../../src/main/addon/${t.substring(3)}.mjs`):await import(`./main/addon/${t}.mjs`),this.registerAddon(o.default),await this.timeout(20),!0}log(e){return console[e.method||"log"](e.value),!0}async onDomContentLoaded(){let o,t=this,{config:i}=e,a=[],{environment:r,mainThreadAddons:d,useServiceWorker:u}=i;if(t.addon={},window.__NEO_SSR__){i.useSSR=!0;let e=await import("./main/addon/ServerSideRendering.mjs");t.registerAddon(e.default)}n.onDomContentLoaded(),i.useGoogleAnalytics&&!d.includes("AnalyticsByGoogle")&&d.push("AnalyticsByGoogle"),!0!==u&&u!==r&&("dist/production"!==u||"dist/esm"!==r)||d.includes("ServiceWorker")||d.push("ServiceWorker"),d.forEach(e=>{e.startsWith("WS/")?a.push(import(`../../../src/main/addon/${e.substring(3)}.mjs`)):a.push(import(`./main/addon/${e}.mjs`))}),o=await Promise.all(a);const m=o.map(e=>t.registerAddon(e.default));await Promise.all(m.map(e=>e.ready())),s.onWorkerConstructed({origin:"main"})}onMountDom(e){this.queueWrite(e),s.sendMessage(e.origin||"app",{action:"reply",replyId:e.id,success:!0})}onRender(e){e.data.replyId=e.replyId,this.queueWrite(e.data)}onUpdateDom(e){e.windowId&&e.windowId!==s.windowId||this.queueUpdate(e)}onUpdateVdom(e){e.data.replyId=e.replyId,this.queueUpdate(e.data)}processQueue(e,o){let t,a=this,{mode:r}=a,d=a.timeLimit;for(;t=e.shift();){if(new Date-o>d)return e.unshift(t),requestAnimationFrame(a.renderFrame.bind(a));"read"===r?n.read(t):"write"===r?i.insertNode(t):i.update(t),s.resolveDomOperationPromise(t.replyId)}}queueRead(e){let o=this;o.readQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}queueUpdate(e){let o=this;o.updateQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}queueWrite(e){let o=this;o.writeQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}redirectTo(e){window.location.href=e.url}registerAddon(o){return"NeoClass"===e.typeOf(o)&&("NeoInstance"!==e.typeOf(e.ns(o.prototype.className))&&(o=e.create(o)),e.applyToGlobalNs(o)),this.addon[o.constructor.name]=o,o}reloadWindow(e){location.reload()}renderFrame(){let o=this,t=o.readQueue,n=o.updateQueue,i=o.writeQueue,a="read"===o.mode,r=new Date;e.config.logDeltaUpdates&&(o.totalFrameCount++,console.log("Total Frames: "+o.totalFrameCount)),(!a&&i.length||(o.mode="read",!o.processQueue(t,r)))&&(n.length&&(o.mode="update",o.processQueue(n,r))||i.length&&(o.mode="write",o.processQueue(i,r))||(o.running=!1))}setNeoConfig(o){let{key:t,value:n}=o;e.config[t]=o.value,"renderCountDeltas"===t&&i.set({[t]:n})}setRoute(e){window.location.hash=e.value}windowClose(e){Array.isArray(e.names)||(e.names=[e.names]),e.names.forEach(e=>{this.openWindows[e]?.close(),delete this.openWindows[e]})}windowCloseAll(e){Object.values(this.openWindows).forEach(e=>{console.log(e),e.close()}),this.openWindows={}}windowMoveTo(e){this.openWindows[e.windowName]?.moveTo(e.x,e.y)}windowOpen(e){let o=window.open(e.url,e.windowName,e.windowFeatures),t=!!o;return t&&(this.openWindows[e.windowName]=o),t}windowResizeTo(e){let o=this.openWindows[e.windowName],t=e.height||o.outerHeight,n=e.width||o.outerWidth;o.resizeTo(n,t)}}export default e.setupClass(d);