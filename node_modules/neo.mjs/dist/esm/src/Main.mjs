import e from"./Neo.mjs";import*as t from"./core/_export.mjs";import o from"./manager/ClassHierarchy.mjs";import n from"./main/DomAccess.mjs";import i from"./main/DeltaUpdates.mjs";import r from"./main/DomEvents.mjs";import a from"./core/Observable.mjs";import s from"./worker/Manager.mjs";class d extends t.Base{static observable=!0;static config={className:"Neo.Main",mode:"read",openWindows:{},readQueue:[],remote:{app:["alert","editRoute","getByPath","getWindowData","importAddon","log","redirectTo","reloadWindow","setNeoConfig","setRoute","windowClose","windowCloseAll","windowMoveTo","windowOpen","windowResizeTo"]},running:!1,showFps:!1,singleton:!0,timeLimit:15,totalFrameCount:0,writeQueue:[]};construct(e){super.construct(e);let t=this;s.on({automount:t.onRender,updateVdom:t.onUpdateVdom,scope:t}),r.on("domContentLoaded",t.onDomContentLoaded,t),"loading"!==document.readyState&&r.onDomContentLoaded()}alert(e){alert(e.message)}editRoute(e){let t=r.parseHash(window.location.hash.substr(1)),o=[];"string"==typeof e&&(e=r.parseHash(e)),Object.assign(t,e),Object.entries(t).forEach(([e,t])=>{null!==t&&o.push(encodeURIComponent(e)+"="+encodeURIComponent(t))}),window.location.hash=o.join("&")}getByPath({params:t=[],path:o}){let n=e.nsWithArrays(o);return e.isFunction(n)?n(...t):n}getWindowData(){let e=window,{screen:t}=e;return{innerHeight:e.innerHeight,innerWidth:e.innerWidth,outerHeight:e.outerHeight,outerWidth:e.outerWidth,screen:{availHeight:t.availHeight,availLeft:t.availLeft,availTop:t.availTop,availWidth:t.availWidth,colorDepth:t.colorDepth,height:t.height,orientation:{angle:t.orientation?.angle,type:t.orientation?.type},pixelDepth:t.pixelDepth,width:t.width},screenLeft:e.screenLeft,screenTop:e.screenTop}}async importAddon(e){let t,{name:o}=e;return t=o.startsWith("WS/")?await import(`../../../src/main/addon/${o.substring(3)}.mjs`):await import(`./main/addon/${o}.mjs`),this.registerAddon(t.default),await this.timeout(20),!0}log(e){return console[e.method||"log"](e.value),!0}async onDomContentLoaded(){let t,o=this,{config:i}=e,r=[],{environment:a,mainThreadAddons:d,useServiceWorker:m}=i;if(o.addon={},window.__NEO_SSR__){i.useSSR=!0;let e=await import("./main/addon/ServerSideRendering.mjs");o.registerAddon(e.default)}n.onDomContentLoaded(),i.useGoogleAnalytics&&!d.includes("AnalyticsByGoogle")&&d.push("AnalyticsByGoogle"),!0!==m&&m!==a&&("dist/production"!==m||"dist/esm"!==a)||d.includes("ServiceWorker")||d.push("ServiceWorker"),d.forEach(e=>{e.startsWith("WS/")?r.push(import(`../../../src/main/addon/${e.substring(3)}.mjs`)):r.push(import(`./main/addon/${e}.mjs`))}),t=await Promise.all(r);const l=t.map(e=>o.registerAddon(e.default));await Promise.all(l.map(e=>e.remotesReady())),await o.remotesReady(),s.onWorkerConstructed({origin:"main"})}onRender(e){e.data.replyId=e.replyId,this.queueWrite(e.data)}onUpdateVdom(e){e.data.replyId=e.replyId,this.queueWrite(e.data)}processQueue(e,t){let o,r=this,{mode:a}=r,d=r.timeLimit;for(;o=e.shift();){if(new Date-t>d)return e.unshift(o),requestAnimationFrame(r.renderFrame.bind(r));"read"===a?n.read(o):i.update(o),s.resolveDomOperationPromise(o.replyId)}}queueRead(e){let t=this;t.readQueue.push(e),t.running||(t.running=!0,requestAnimationFrame(t.renderFrame.bind(t)))}queueWrite(e){let t=this;t.writeQueue.push(e),t.running||(t.running=!0,requestAnimationFrame(t.renderFrame.bind(t)))}redirectTo(e){window.location.href=e.url}registerAddon(t){return"NeoClass"===e.typeOf(t)&&"NeoInstance"!==e.typeOf(e.ns(t.prototype.className))&&(t=e.create(t),e.applyToGlobalNs(t)),this.addon[t.constructor.name]=t,t}reloadWindow(e){location.reload()}renderFrame(){let t=this,o=t.readQueue,n=t.writeQueue,i="read"===t.mode,r=new Date;e.config.logDeltaUpdates&&(t.totalFrameCount++,console.log("Total Frames: "+t.totalFrameCount)),(!i&&n.length||(t.mode="read",!t.processQueue(o,r)))&&(n.length&&(t.mode="write",t.processQueue(n,r))||(t.running=!1))}setNeoConfig(t){let{key:o,value:n}=t;e.config[o]=t.value,"renderCountDeltas"===o&&i.set({[o]:n})}setRoute(e){window.location.hash=e.value}windowClose(e){Array.isArray(e.names)||(e.names=[e.names]),e.names.forEach(e=>{this.openWindows[e]?.win.close(),delete this.openWindows[e]})}windowCloseAll(e){Object.values(this.openWindows).forEach(e=>{e.win.close()}),this.openWindows={}}windowMoveTo(e){this.openWindows[e.windowName]?.win.moveTo(e.x,e.y)}windowOpen({url:e,useTotalHeight:t=!0,windowFeatures:o,windowName:n}){let i,r=this.openWindows[n];i=r&&!r.win.closed?r.targetName:crypto.randomUUID();let a=window.open(e,i,o),s=!!a;return s&&(t&&a.resizeTo(a.outerWidth,a.innerHeight),this.openWindows[n]={targetName:i,win:a}),s}windowResizeTo(e){let t=this.openWindows[e.windowName]?.win,o=e.height||t.outerHeight,n=e.width||t.outerWidth;t.resizeTo(n,o)}}export default e.setupClass(d);