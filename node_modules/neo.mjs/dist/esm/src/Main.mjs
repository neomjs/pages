import e from"./Neo.mjs";import*as o from"./core/_export.mjs";import t from"./main/DomAccess.mjs";import n from"./main/DomEvents.mjs";import i from"./core/Observable.mjs";import r from"./worker/Manager.mjs";class a extends o.Base{static observable=!0;static config={className:"Neo.Main",mode:"read",openWindows:{},readQueue:[],remote:{app:["alert","editRoute","getByPath","getWindowData","importAddon","log","redirectTo","reloadWindow","setNeoConfig","setRoute","windowClose","windowCloseAll","windowMoveTo","windowOpen","windowResizeTo"]},running:!1,showFps:!1,singleton:!0,timeLimit:15,totalFrameCount:0,updateQueue:[],writeQueue:[]};construct(e){super.construct(e);let o=this;r.on({automount:o.onRender,"message:mountDom":o.onMountDom,"message:updateDom":o.onUpdateDom,updateVdom:o.onUpdateVdom,scope:o}),n.on("domContentLoaded",o.onDomContentLoaded,o),"loading"!==document.readyState&&n.onDomContentLoaded()}alert(e){alert(e.message)}editRoute(e){let o=n.parseHash(window.location.hash.substr(1)),t=[];"string"==typeof e&&(e=n.parseHash(e)),Object.assign(o,e),Object.entries(o).forEach((([e,o])=>{null!==o&&t.push(encodeURIComponent(e)+"="+encodeURIComponent(o))})),window.location.hash=t.join("&")}getByPath({params:o=[],path:t}){let n=e.nsWithArrays(t);return e.isFunction(n)?n(...o):n}getWindowData(){let e=window,{screen:o}=e;return{innerHeight:e.innerHeight,innerWidth:e.innerWidth,outerHeight:e.outerHeight,outerWidth:e.outerWidth,screen:{availHeight:o.availHeight,availLeft:o.availLeft,availTop:o.availTop,availWidth:o.availWidth,colorDepth:o.colorDepth,height:o.height,orientation:{angle:o.orientation?.angle,type:o.orientation?.type},pixelDepth:o.pixelDepth,width:o.width},screenLeft:e.screenLeft,screenTop:e.screenTop}}async importAddon(e){let o,{name:t}=e;return o=t.startsWith("WS/")?await import(`../../../src/main/addon/${t.substring(3)}.mjs`):await import(`./main/addon/${t}.mjs`),this.registerAddon(o.default),await this.timeout(20),!0}log(e){return console[e.method||"log"](e.value),!0}async onDomContentLoaded(){let o,n=this,{config:i}=e,a=[],{environment:s,mainThreadAddons:d,useServiceWorker:u}=i;t.onDomContentLoaded(),"dist/development"!==s&&"dist/production"!==s||(__webpack_require__.p=i.basePath.substring(6)),i.useGoogleAnalytics&&!d.includes("AnalyticsByGoogle")&&d.push("AnalyticsByGoogle"),!0!==u&&u!==s&&("dist/production"!==u||"dist/esm"!==s)||d.includes("ServiceWorker")||d.push("ServiceWorker"),d.forEach((e=>{e.startsWith("WS/")?a.push(import(`../../../src/main/addon/${e.substring(3)}.mjs`)):a.push(import(`./main/addon/${e}.mjs`))})),o=await Promise.all(a),n.addon={},o.forEach((e=>{n.registerAddon(e.default)})),r.onWorkerConstructed({origin:"main"})}onMountDom(e){this.queueWrite(e),r.sendMessage(e.origin||"app",{action:"reply",replyId:e.id,success:!0})}onRender(e){e.data.replyId=e.replyId,this.queueWrite(e.data)}onUpdateDom(e){this.queueUpdate(e)}onUpdateVdom(e){e.data.replyId=e.replyId,this.queueUpdate(e.data)}processQueue(e,o){let n,i=this,a=i.timeLimit;for(;n=e.shift();){if(new Date-o>a)return e.unshift(n),requestAnimationFrame(i.renderFrame.bind(i));t[i.mode](n),r.resolveDomOperationPromise(n.replyId)}}queueRead(e){let o=this;o.readQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}queueUpdate(e){let o=this;o.updateQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}queueWrite(e){let o=this;o.writeQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}redirectTo(e){window.location.href=e.url}registerAddon(o){"NeoClass"===e.typeOf(o)&&("NeoInstance"!==e.typeOf(e.ns(o.prototype.className))&&(o=e.create(o)),e.applyToGlobalNs(o)),this.addon[o.constructor.name]=o}reloadWindow(e){location.reload()}renderFrame(){let o=this,t=o.readQueue,n=o.updateQueue,i=o.writeQueue,r="read"===o.mode,a=new Date;e.config.logDeltaUpdates&&(o.totalFrameCount++,console.log("Total Frames: "+o.totalFrameCount)),(!r&&i.length||(o.mode="read",!o.processQueue(t,a)))&&(n.length&&(o.mode="update",o.processQueue(n,a))||i.length&&(o.mode="write",o.processQueue(i,a))||(o.running=!1))}setNeoConfig(o){let{key:n,value:i}=o;e.config[n]=o.value,"renderCountDeltas"===n&&t.set({[n]:i})}setRoute(e){window.location.hash=e.value}windowClose(e){Array.isArray(e.names)||(e.names=[e.names]),e.names.forEach((e=>{this.openWindows[e]?.close(),delete this.openWindows[e]}))}windowCloseAll(e){Object.values(this.openWindows).forEach((e=>{console.log(e),e.close()})),this.openWindows={}}windowMoveTo(e){this.openWindows[e.windowName]?.moveTo(e.x,e.y)}windowOpen(e){let o=window.open(e.url,e.windowName,e.windowFeatures),t=!!o;return t&&(this.openWindows[e.windowName]=o),t}windowResizeTo(e){let o=this.openWindows[e.windowName],t=e.height||o.outerHeight,n=e.width||o.outerWidth;o.resizeTo(n,t)}}export default e.setupClass(a);