import e from"./Neo.mjs";import*as o from"./core/_export.mjs";import t from"./manager/ClassHierarchy.mjs";import n from"./main/DomAccess.mjs";import i from"./main/DeltaUpdates.mjs";import r from"./main/DomEvents.mjs";import a from"./core/Observable.mjs";import s from"./worker/Manager.mjs";class d extends o.Base{static observable=!0;static config={className:"Neo.Main",mode:"read",openWindows:{},readQueue:[],remote:{app:["alert","editRoute","getByPath","getWindowData","importAddon","log","redirectTo","reloadWindow","setNeoConfig","setRoute","windowClose","windowCloseAll","windowMoveTo","windowOpen","windowResizeTo"]},running:!1,showFps:!1,singleton:!0,timeLimit:15,totalFrameCount:0,writeQueue:[]};construct(e){super.construct(e);let o=this;s.on({automount:o.onRender,updateVdom:o.onUpdateVdom,scope:o}),r.on("domContentLoaded",o.onDomContentLoaded,o),"loading"!==document.readyState&&r.onDomContentLoaded()}alert(e){alert(e.message)}editRoute(e){let o=r.parseHash(window.location.hash.substr(1)),t=[];"string"==typeof e&&(e=r.parseHash(e)),Object.assign(o,e),Object.entries(o).forEach(([e,o])=>{null!==o&&t.push(encodeURIComponent(e)+"="+encodeURIComponent(o))}),window.location.hash=t.join("&")}getByPath({params:o=[],path:t}){let n=e.nsWithArrays(t);return e.isFunction(n)?n(...o):n}getWindowData(){let e=window,{screen:o}=e;return{innerHeight:e.innerHeight,innerWidth:e.innerWidth,mozInnerScreenX:e.mozInnerScreenX,mozInnerScreenY:e.mozInnerScreenY,outerHeight:e.outerHeight,outerWidth:e.outerWidth,screen:{availHeight:o.availHeight,availLeft:o.availLeft,availTop:o.availTop,availWidth:o.availWidth,colorDepth:o.colorDepth,height:o.height,orientation:{angle:o.orientation?.angle,type:o.orientation?.type},pixelDepth:o.pixelDepth,width:o.width},screenLeft:e.screenLeft,screenTop:e.screenTop}}async importAddon(e){let o,{name:t}=e;return o=t.startsWith("WS/")?await import(`../../../src/main/addon/${t.substring(3)}.mjs`):await import(`./main/addon/${t}.mjs`),this.registerAddon(o.default),await this.timeout(20),!0}log(e){return console[e.method||"log"](e.value),!0}async onDomContentLoaded(){let o,t=this,{config:i}=e,r=[],{environment:a,mainThreadAddons:d,useServiceWorker:m}=i;if(t.addon={},window.__NEO_SSR__){i.useSSR=!0;let e=await import("./main/addon/ServerSideRendering.mjs");t.registerAddon(e.default)}n.onDomContentLoaded(),i.useGoogleAnalytics&&!d.includes("AnalyticsByGoogle")&&d.push("AnalyticsByGoogle"),!0!==m&&m!==a&&("dist/production"!==m||"dist/esm"!==a)||d.includes("ServiceWorker")||d.push("ServiceWorker"),d.forEach(e=>{e.startsWith("WS/")?r.push(import(`../../../src/main/addon/${e.substring(3)}.mjs`)):r.push(import(`./main/addon/${e}.mjs`))}),o=await Promise.all(r);const l=o.map(e=>t.registerAddon(e.default));await Promise.all(l.map(e=>e.remotesReady())),await t.remotesReady(),s.onWorkerConstructed({origin:"main"})}onRender(e){e.data.replyId=e.replyId,this.queueWrite(e.data)}onUpdateVdom(e){e.data.replyId=e.replyId,this.queueWrite(e.data)}processQueue(e,o){let t,r=this,{mode:a}=r,d=r.timeLimit;for(;t=e.shift();){if(new Date-o>d)return e.unshift(t),requestAnimationFrame(r.renderFrame.bind(r));"read"===a?n.read(t):i.update(t),s.resolveDomOperationPromise(t.replyId)}}queueRead(e){let o=this;o.readQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}queueWrite(e){let o=this;o.writeQueue.push(e),o.running||(o.running=!0,requestAnimationFrame(o.renderFrame.bind(o)))}redirectTo(e){window.location.href=e.url}registerAddon(o){return"NeoClass"===e.typeOf(o)&&"NeoInstance"!==e.typeOf(e.ns(o.prototype.className))&&(o=e.create(o),e.applyToGlobalNs(o)),this.addon[o.constructor.name]=o,o}reloadWindow(e){location.reload(e?.force)}renderFrame(){let o=this,t=o.readQueue,n=o.writeQueue,i="read"===o.mode,r=new Date;e.config.logDeltaUpdates&&(o.totalFrameCount++,console.log("Total Frames: "+o.totalFrameCount)),(!i&&n.length||(o.mode="read",!o.processQueue(t,r)))&&(n.length&&(o.mode="write",o.processQueue(n,r))||(o.running=!1))}setNeoConfig(o){let{key:t,value:n}=o;e.config[t]=o.value,"renderCountDeltas"===t&&i.set({[t]:n})}setRoute(e){window.location.hash=e.value}windowClose(e){Array.isArray(e.names)||(e.names=[e.names]),e.names.forEach(e=>{this.openWindows[e]?.win.close(),delete this.openWindows[e]})}windowCloseAll(e){Object.values(this.openWindows).forEach(e=>{e.win.close()}),this.openWindows={}}windowMoveTo(e){this.openWindows[e.windowName]?.win.moveTo(e.x,e.y)}windowOpen({url:e,useTotalHeight:o=!0,windowFeatures:t,windowName:n}){let i,r=this.openWindows[n];i=r&&!r.win.closed?r.targetName:crypto.randomUUID();let a=window.open(e,i,t),s=!!a;return s&&(o&&a.resizeTo(a.outerWidth,a.innerHeight),this.openWindows[n]={targetName:i,win:a}),s}windowResizeTo(e){let o=this.openWindows[e.windowName]?.win,t=e.height||o.outerHeight,n=e.width||o.outerWidth;o.resizeTo(n,t)}}export default e.setupClass(d);