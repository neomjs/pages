import e from"../core/Base.mjs";import t from"../util/Array.mjs";import o from"../util/Style.mjs";import{rawDimensionTags as d}from"./domConstants.mjs";import n from"./VNode.mjs";const a=Neo.config;export default Neo.setupClass(class extends e{static config={className:"Neo.vdom.Helper",remote:{app:["create","update","updateBatch"]},singleton:!0};compareAttributes({deltas:e,oldVnode:d,vnode:n,vnodeMap:a}){if(n.componentId||d.componentId)return e;if("fragment"===n.nodeName)return e;let r,i,s,l,c,p,m={};return"text"===n.vtype&&n.textContent!==d.textContent?e.default.push({action:"updateVtext",id:n.id,parentId:a.get(n.id).parentNode.id,value:n.textContent}):(s=Object.keys(n),Object.keys(d).forEach(e=>{Object.hasOwn(n,e)?"attributes"===e&&Object.keys(d[e]).forEach(t=>{Object.hasOwn(n[e],t)||(n[e][t]=null)}):s.push(e)}),s.forEach(e=>{switch(i=n[e],e){case"attributes":r={},Object.entries(i).forEach(([e,t])=>{const o=d.attributes[e];Object.hasOwn(d.attributes,e)&&o===t||null!==t&&!Neo.isString(t)&&Neo.isEmpty(t)||(r[e]=t)}),Object.keys(r).length>0&&(m.attributes=r,Object.entries(r).forEach(([e,t])=>{null!==t&&""!==t||delete n.attributes[e]}));break;case"nodeName":case"innerHTML":case"scrollLeft":case"scrollTop":case"textContent":i!==d[e]&&(m[e]=i);break;case"style":l=o.compareStyles(i,d.style),l&&(m.style=l);break;case"className":d.className?(c=t.difference(i,d.className),p=t.difference(d.className,i)):(c=i,p=[]),(c.length>0||p.length>0)&&(m.cls={},c.length>0&&(m.cls.add=c),p.length>0&&(m.cls.remove=p))}}),Object.keys(m).length>0&&(m.id=n.id,e.default.push(m))),e}create(e){let t,o,{util:d}=Neo.vdom,n=[];if(o=this.createVnode(e.vdom),t={...e,vnode:o},delete t.vdom,!a.useDomApiRenderer){if(!d.StringFromVnode)throw new Error("VDom Helper render utilities are not loaded yet!");t.outerHTML=d.StringFromVnode.create(o,null,n),n.length>0&&(t.postMountUpdates=n)}return t}createDeltas(e){let{deltas:t={default:[],remove:[]},oldVnode:o,vnode:d}=e,n=d?.id;if(!d&&(o?.id||o?.componentId))return t.remove.push({action:"removeNode",id:o.id||o.componentId}),t;if(d.static)return t;if(d.id!==o.id||d.componentId!==o.componentId)throw new Error(`createDeltas() must be called for the same node. new: {id: ${d.id}, cId: ${d.componentId}}, old: {id: ${o.id}, cId: ${o.componentId}}`);let a,r,i,s,l=this,c=e.oldVnodeMap||l.createVnodeMap({vnode:o}),p=e.vnodeMap||l.createVnodeMap({vnode:d}),m=d.childNodes||[],u=o.childNodes||[],h=0,v=0,f=0,N=Math.max(m.length,u.length);if(l.compareAttributes({deltas:t,oldVnode:o,vnode:d,vnodeMap:p}),0===m.length&&u.length>1)return t.remove.push({action:"removeAll",parentId:n}),t;for(;h<N&&(a=m[h],i=u[h+v],a||i);h++)if(a&&i&&(!a.componentId&&!i.componentId&&a.id===i.id||a.componentId&&a.componentId===i.componentId)){if(a.neoIgnore){delete a.neoIgnore;continue}l.createDeltas({deltas:t,oldVnode:i,oldVnodeMap:c,vnode:a,vnodeMap:p})}else{if(i){if(s=i.id||i.componentId,r=p.get(s),!r){l.removeNode({deltas:t,oldVnode:i,oldVnodeMap:c}),h--,f++;continue}if(a&&n!==r.parentNode.id){h--,v++;continue}}if(a){if(l.isMovedNode(a,c))l.moveNode({deltas:t,insertDelta:f,oldVnodeMap:c,vnode:a,vnodeMap:p});else{if(a.neoIgnore){delete a.neoIgnore;continue}l.insertNode({deltas:t,index:h+f,oldVnodeMap:c,vnode:a,vnodeMap:p})}i&&n===p.get(s)?.parentNode.id&&N++}}return t}createVnode(e){if(e.componentId)return e.childNodes??=[],e.id??=e.componentId,e;if(!0===e.removeDom)return null;let t,o=this,a={attributes:{},style:{}};return Object.entries(e).forEach(([e,n])=>{if(null!=n&&"flag"!==e&&"removeDom"!==e){let r,i,s;switch(e){case"tag":a.nodeName=n;break;case"cls":a.className=n;break;case"html":a.innerHTML=n.toString();break;case"text":a.textContent=n;break;case"cn":Array.isArray(n)||(n=[n]),i=[],n.filter(Boolean).forEach(e=>{!0!==e.removeDom&&(delete e.removeDom,t=o.createVnode(e),t&&i.push(t))}),a.childNodes=i;break;case"data":n&&"Object"===Neo.typeOf(n)&&Object.entries(n).forEach(([e,t])=>{a.attributes[`data-${Neo.decamel(e)}`]=t});break;case"height":case"maxHeight":case"maxWidth":case"minHeight":case"minWidth":case"width":d.has(a.nodeName)?a.attributes[e]=n+"":(r=n!=parseInt(n),a.style[e]=n+(r?"":"px"));break;case"componentId":case"id":case"scrollLeft":case"scrollTop":case"static":case"vtype":a[e]=n;break;case"style":s=a.style,Neo.isString(n)?a.style=Object.assign(s,Neo.core.Util.createStyleObject(n)):a.style=Object.assign(s,n);break;default:a.attributes[e]=n+""}}}),Object.keys(a.attributes).length<1&&delete a.attributes,Object.keys(a.style).length<1&&delete a.style,new n(a)}createVnodeMap({index:e=0,map:t=new Map,parentNode:o=null,vnode:d}){if(d){let n=d.id||d.componentId;t.set(n,{id:n,index:e,parentNode:o,vnode:d}),d.childNodes?.forEach((e,o)=>{this.createVnodeMap({index:o,map:t,parentNode:d,vnode:e})})}return t}findMovedNodes({movedNodes:e=new Map,oldVnodeMap:t,vnode:o,vnodeMap:d}){let n=o?.id;return n&&(this.isMovedNode(o,t)?e.set(n,d.get(n)):o.childNodes?.forEach(o=>{"text"!==o.vtype&&this.findMovedNodes({movedNodes:e,oldVnodeMap:t,vnode:o,vnodeMap:d})})),e}getFragmentPhysicalCount(e){let t=2;return e.childNodes?.forEach(e=>{"text"===e.vtype?t+=3:"fragment"===e.nodeName?t+=this.getFragmentPhysicalCount(e):t+=1}),t}getPhysicalIndex(e,t){let o,d=t,n=0;for(;n<t;n++)o=e.childNodes[n],o&&("text"===o.vtype?d+=2:"fragment"===o.nodeName&&(d+=this.getFragmentPhysicalCount(o)-1));return d}async importUtil(){const{util:e}=Neo.vdom;a.useDomApiRenderer?e?.DomApiVnodeCreator||await import("./util/DomApiVnodeCreator.mjs"):e?.StringFromVnode||await import("./util/StringFromVnode.mjs")}async initAsync(){super.initAsync();let e=this;Neo.currentWorker?.on({neoConfigChange:e.onNeoConfigChange,scope:e}),await e.importUtil()}insertNode({deltas:e,index:t,oldVnodeMap:o,vnode:d,vnodeMap:n}){let r=n.get(d.id),{parentNode:i}=r,s=i.id,l=this,c=l.findMovedNodes({oldVnodeMap:o,vnode:d,vnodeMap:n}),p={action:"insertNode",parentId:s};if(p.index=l.getPhysicalIndex(i,t),a.useDomApiRenderer)p.vnode=Neo.vdom.util.DomApiVnodeCreator.create(d,c);else{let e=[];p.outerHTML=Neo.vdom.util.StringFromVnode.create(d,c,e),e.length>0&&(p.postMountUpdates=e)}e.default.push(p),o.get(s).vnode.childNodes.splice(t,0,d),c.forEach(t=>{let{id:d}=t,a=t.parentNode.id;e.default.push({action:"moveNode",id:d,index:t.index,parentId:a}),l.createDeltas({deltas:e,oldVnode:o.get(d).vnode,oldVnodeMap:o,vnode:t.vnode,vnodeMap:n})})}isMovedNode(e,t){let o=t.get(e.id);return o&&(!o.vnode.componentId||e.componentId===o.vnode.componentId)}moveNode({deltas:e,insertDelta:o,oldVnodeMap:d,vnode:n,vnodeMap:a}){let r=a.get(n.id),{index:i,parentNode:s}=r,l=s.id,c=d.get(n.id),p=c.parentNode,{childNodes:m}=p,u={action:"moveNode",id:n.id,parentId:l},h=this.getPhysicalIndex(s,i);if(Object.assign(u,{index:h+o}),e.default.push(u),l!==p.id){t.remove(m,c.vnode);let e=d.get(l);e&&(c.parentNode=e.vnode,m=c.parentNode.childNodes)}t.insert(m,i,c.vnode),this.createDeltas({deltas:e,oldVnode:c.vnode,oldVnodeMap:d,vnode:n,vnodeMap:a})}async onNeoConfigChange(e){Object.hasOwn(e,"useDomApiRenderer")&&await this.importUtil()}removeNode({deltas:e,oldVnode:o,oldVnodeMap:d}){o.componentId&&(o.id??=o.componentId);let n={action:"removeNode",id:o.id},{parentNode:a}=d.get(o.id);"text"!==o.vtype&&"fragment"!==o.nodeName||(n.parentId=a.id),e.remove.push(n),t.remove(a.childNodes,o)}update(e){let t,o,{util:d}=Neo.vdom;if(a.useDomApiRenderer){if(!d.DomApiVnodeCreator)throw new Error("Neo.vdom.Helper: DomApiVnodeCreator is not loaded yet for updates!")}else if(!d.StringFromVnode)throw new Error("Neo.vdom.Helper: StringFromVnode is not loaded yet for updates!");return o=this.createVnode(e.vdom),t=this.createDeltas({oldVnode:e.vnode,vnode:o}),t=t.default.concat(t.remove),{deltas:t,updateVdom:!0,vnode:o}}updateBatch(e){let t,o=this,d=[],n={};return Object.entries(e.updates).forEach(([e,a])=>{t=o.update(a),d.push(...t.deltas),n[e]=t.vnode}),{deltas:d,updateVdom:!0,vnodes:n}}});