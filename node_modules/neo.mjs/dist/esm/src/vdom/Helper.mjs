import e from"../core/Base.mjs";import t from"../util/Array.mjs";import d from"../util/String.mjs";import o from"../util/Style.mjs";import n from"./VNode.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.vdom.Helper",remote:{app:["create","update"]},singleton:!0};rawDimensionTags=new Set(["circle","clipPath","ellipse","filter","foreignObject","image","marker","mask","pattern","rect","svg","use"]);returnChildNodeOuterHtml=!1;voidAttributes=new Set(["checked","defer","disabled","ismap","multiple","nohref","noresize","noshade","nowrap","open","readonly","required","reversed","selected"]);voidElements=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]);create(e){let t,d=!0===e.autoMount,{appName:o,parentId:n,parentIndex:a,windowId:r}=e;return delete e.appName,delete e.autoMount,delete e.parentId,delete e.parentIndex,delete e.windowId,t=this.createVnode(e),t.outerHTML=this.createStringFromVnode(t),d&&Object.assign(t,{appName:o,autoMount:!0,parentId:n,parentIndex:a,windowId:r}),Neo.config.useVdomWorker?t:Promise.resolve(t)}createCloseTag(e){return this.voidElements.has(e.nodeName)?"":"</"+e.nodeName+">"}compareAttributes(e){let d,n,a,r,i,s,l,{deltas:c,oldVnode:p,vnode:m,vnodeMap:u}=e;return!p.componentId||p.id!==m.id&&p.componentId!==m.id?("text"===m.vtype&&m.innerHTML!==p.innerHTML?c.default.push({action:"updateVtext",id:m.id,parentId:u.get(m.id).parentNode.id,value:m.innerHTML}):(r=Object.keys(m),Object.keys(p).forEach((e=>{m.hasOwnProperty(e)?"attributes"===e&&Object.keys(p[e]).forEach((t=>{m[e].hasOwnProperty(t)||(m[e][t]=null)})):r.push(e)})),r.forEach((e=>{switch(n={},a=m[e],e){case"attributes":d={},Object.entries(a).forEach((([e,t])=>{p.attributes.hasOwnProperty(e)&&p.attributes[e]===t||null!==t&&!Neo.isString(t)&&Neo.isEmpty(t)||(d[e]=t)})),Object.keys(d).length>0&&(n.attributes=d,Object.entries(d).forEach((([e,t])=>{null!==t&&""!==t||delete m.attributes[e]})));break;case"nodeName":case"innerHTML":a!==p[e]&&(n[e]=a);break;case"style":i=o.compareStyles(a,p.style),i&&(n.style=i);break;case"className":p.className?(s=t.difference(a,p.className),l=t.difference(p.className,a)):(s=a,l=[]),(s.length>0||l.length>0)&&(n.cls={},s.length>0&&(n.cls.add=s),l.length>0&&(n.cls.remove=l))}Object.keys(n).length>0&&(n.id=m.id,c.default.push(n))}))),c):c}createDeltas(e){let{deltas:t={default:[],remove:[]},oldVnode:d,vnode:o}=e,n=d?.id||d?.componentId,a=o?.id;if(!o&&n)return t.remove.push({action:"removeNode",id:n}),t;if(o.static)return t;if(a!==n&&o.componentId!==d.componentId)throw new Error(`createDeltas() must get called for the same node. ${a}, ${n}`);let r,i,s,l,c=this,p=e.oldVnodeMap||c.createVnodeMap({vnode:d}),m=e.vnodeMap||c.createVnodeMap({vnode:o}),u=o.childNodes||[],h=d.childNodes||[],v=0,N=0,g=0,f=Math.max(u.length,h.length);if(c.compareAttributes({deltas:t,oldVnode:d,vnode:o,vnodeMap:m}),0===u.length&&h.length>1)return t.remove.push({action:"removeAll",parentId:a}),t;for(;v<f&&(r=u[v],s=h[v+N],r||s);v++)if(r&&s&&(r.id===s.id||r.componentId&&r.componentId===s.componentId))c.createDeltas({deltas:t,oldVnode:s,oldVnodeMap:p,vnode:r,vnodeMap:m});else{if(s){if(l=s.id||s.componentId,i=m.get(l),!i){c.removeNode({deltas:t,oldVnode:s,oldVnodeMap:p}),v--,g++;continue}if(r&&a!==i.parentNode.id){v--,N++;continue}}r&&(c.isMovedNode(r,p)?c.moveNode({deltas:t,insertDelta:g,oldVnodeMap:p,vnode:r,vnodeMap:m}):c.insertNode({deltas:t,index:v+g,oldVnodeMap:p,vnode:r,vnodeMap:m}),s&&a===m.get(l)?.parentNode.id&&f++)}return t}createOpenTag(e){let t,o="<"+e.nodeName,{attributes:n}=e,a=e.className;return e.style&&(t=Neo.createStyles(e.style),""!==t&&(o+=` style="${t}"`)),a&&(Array.isArray(a)&&(a=a.join(" ")),""!==a&&(o+=` class="${a}"`)),e.id&&(Neo.config.useDomIds?o+=` id="${e.id}"`:o+=` data-neo-id="${e.id}"`),Object.entries(n).forEach((([e,t])=>{this.voidAttributes.has(e)?"true"===t&&(o+=` ${e}`):"removeDom"!==e&&("value"===e&&(t=d.escapeHtml(t)),o+=` ${e}="${t?.replaceAll?.('"',"&quot;")??t}"`)})),o+">"}createStringFromVnode(e,t){let d=this,o=e?.id;if(o&&t?.get(o))return"";switch(e.vtype){case"root":return d.createStringFromVnode(e.childNodes[0],t);case"text":return void 0===e.innerHTML?"":String(e.innerHTML);case"vnode":return d.createOpenTag(e)+d.createTagContent(e,t)+d.createCloseTag(e);default:return""}}createTagContent(e,t){if(e.innerHTML)return e.innerHTML;let d,o,n="",a=e.childNodes?e.childNodes.length:0,r=0;for(;r<a;r++)d=e.childNodes[r],o=this.createStringFromVnode(d,t),d.innerHTML!==o&&this.returnChildNodeOuterHtml&&(d.outerHTML=o),n+=o;return n}createVnode(e){if(e.componentId)return e.id||(e.id=e.componentId),e;if(!0===e.removeDom)return null;if("text"===e.vtype)return e.id||(e.id=Neo.getId("vtext")),e.innerHTML=`\x3c!-- ${e.id} --\x3e${e.html||""}\x3c!-- /neo-vtext --\x3e`,delete e.html,e;let t,d=this,o={attributes:{},childNodes:[],style:{}};return e.tag||(e.tag="div"),Object.entries(e).forEach((([e,n])=>{let a,r,i;if(null!=n&&"flag"!==e)switch(e){case"tag":case"nodeName":o.nodeName=n;break;case"html":case"innerHTML":o.innerHTML=n.toString();break;case"children":case"childNodes":case"cn":Array.isArray(n)||(n=[n]),r=[],n.forEach((e=>{!0!==e.removeDom&&(delete e.removeDom,t=d.createVnode(e),t&&r.push(t))})),o.childNodes=r;break;case"cls":n&&!Array.isArray(n)?o.className=[n]:Array.isArray(n)&&n.length<1||(o.className=n);break;case"data":n&&"Object"===Neo.typeOf(n)&&Object.entries(n).forEach((([e,t])=>{o.attributes[`data-${Neo.decamel(e)}`]=t}));break;case"height":case"maxHeight":case"maxWidth":case"minHeight":case"minWidth":case"width":d.rawDimensionTags.has(o.nodeName)?o.attributes[e]=n+"":(a=n!=parseInt(n),o.style[e]=n+(a?"":"px"));break;case"componentId":case"id":case"static":o[e]=n;break;case"style":i=o.style,Neo.isString(n)?o.style=Object.assign(i,Neo.core.Util.createStyleObject(n)):o.style=Object.assign(i,n);break;default:"removeDom"!==e&&(o.attributes[e]=n+"")}})),new n(o)}createVnodeMap(e){let t,{vnode:d,parentNode:o=null,index:n=0,map:a=new Map}=e;return d&&(t=d.id||d.componentId,a.set(t,{id:t,index:n,parentNode:o,vnode:d}),d.childNodes?.forEach(((e,t)=>{this.createVnodeMap({vnode:e,parentNode:d,index:t,map:a})}))),a}findMovedNodes(e){let{movedNodes:t=new Map,oldVnodeMap:d,vnode:o,vnodeMap:n}=e,a=o?.id;return a&&(this.isMovedNode(o,d)?t.set(a,n.get(a)):o.childNodes?.forEach((e=>{"text"!==e.vtype&&this.findMovedNodes({movedNodes:t,oldVnodeMap:d,vnode:e,vnodeMap:n})}))),t}insertNode(e){let{deltas:t,index:d,oldVnodeMap:o,vnode:n,vnodeMap:a}=e,r=a.get(n.id).parentNode.id,i=this,s=i.findMovedNodes({oldVnodeMap:o,vnode:n,vnodeMap:a}),l=i.createStringFromVnode(n,s);t.default.push({action:"insertNode",index:d,outerHTML:l,parentId:r}),o.get(r).vnode.childNodes.splice(d,0,n),s.forEach((e=>{let{id:d}=e,n=e.parentNode.id;t.default.push({action:"moveNode",id:d,index:e.index,parentId:n}),i.createDeltas({deltas:t,oldVnode:o.get(d).vnode,oldVnodeMap:o,vnode:e.vnode,vnodeMap:a})}))}isMovedNode(e,t){let d=t.get(e.id);return d&&(!d.vnode.componentId||e.componentId===d.vnode.componentId)}moveNode(e){let{deltas:d,insertDelta:o,oldVnodeMap:n,vnode:a,vnodeMap:r}=e,i=r.get(a.id),{index:s,parentNode:l}=i,c=l.id,p=n.get(a.id),m=p.parentNode,{childNodes:u}=m;if(c!==m.id){t.remove(u,p.vnode);let e=n.get(c);e&&(p.parentNode=e.vnode,u=p.parentNode.childNodes)}d.default.push({action:"moveNode",id:a.id,index:s+o,parentId:c}),t.insert(u,s,p.vnode),this.createDeltas({deltas:d,oldVnode:p.vnode,oldVnodeMap:n,vnode:a,vnodeMap:r})}removeNode({deltas:e,oldVnode:d,oldVnodeMap:o}){d.componentId&&!d.id&&(d.id=d.componentId);let n={action:"removeNode",id:d.id},{parentNode:a}=o.get(d.id);"text"===d.vtype&&(n.parentId=a.id),e.remove.push(n),t.remove(a.childNodes,d)}update(e){let t=this.createVnode(e.vdom),d=this.createDeltas({oldVnode:e.vnode,vnode:t});d=d.default.concat(d.remove);let o={deltas:d,updateVdom:!0,vnode:t};return Neo.config.useVdomWorker?o:Promise.resolve(o)}});