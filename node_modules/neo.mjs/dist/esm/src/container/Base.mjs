import e from"../component/Base.mjs";import t from"../layout/Base.mjs";import o from"../layout/Card.mjs";import r from"../layout/Fit.mjs";import s from"../layout/Grid.mjs";import i from"../layout/HBox.mjs";import m from"../layout/VBox.mjs";import a from"../util/Logger.mjs";import n from"../util/Array.mjs";import{isDescriptor as l}from"../core/ConfigSymbols.mjs";const d=({weight:e=0},{weight:t=0})=>e-t;export default Neo.setupClass(class extends e{static config={className:"Neo.container.Base",ntype:"container",baseCls:["neo-container"],itemDefaults_:{[l]:!0,merge:"deep",value:null},items_:{[l]:!0,clone:"shallow",cloneOnGet:"none",isEqual:()=>!1,value:[]},layout_:{ntype:"vbox",align:"stretch"},_vdom:{cn:[]}};add(e){let t=this;return t.insert(t.items?t.items.length:0,e)}afterSetAppName(e,t){let o=this;super.afterSetAppName(e,t),e&&o.items&&o.items.forEach(t=>{Neo.isString(t)||(t.appName=e)}),e&&o.layout&&(o.layout.appName=e)}afterSetLayout(e,t){let o=this;o.rendered&&(t?.removeRenderAttributes(),e?.applyRenderAttributes(),o.items.forEach((o,r)=>{t?.removeChildAttributes(o,r),e?.applyChildAttributes(o,r)})),t?.destroy?.()}afterSetMounted(e,t){if(void 0!==t){super.afterSetMounted(e,t);for(let t=0,{items:o}=this,{length:r}=o;t<r;t++)o[t].vdom.removeDom||(o[t].mounted=e)}}afterSetNeedsVdomUpdate(e,t){e||this.items?.forEach(e=>{"string"!=typeof e&&(e._needsVdomUpdate=!1,e.afterSetNeedsVdomUpdate?.(!1,!0))})}afterSetRendering(e,t){if(void 0!==t){let{items:t}=this,o=0,r=t.length;for(;o<r;o++)t[o].vdom.removeDom||(t[o].rendering=e)}}afterSetTheme(e,t){super.afterSetTheme(e,t),e&&this.items?.forEach(t=>{Neo.isString(t)||(t.theme=e)})}afterSetWindowId(e,t){super.afterSetWindowId(e,t);let{layout:o}=this;e&&this.items?.forEach(t=>{Neo.isString(t)||(t.windowId=e)}),e&&o&&!Neo.isString(o)&&(o.windowId=e)}beforeSetItems(e,t){if("Object"===Neo.typeOf(e)){let t,o,r=[];for(const s in e)o=e[s],o.reference=s,r.push(o),t||="weight"in o;t&&r.sort(d),e=r}return e}beforeSetLayout(e,t){return this.createLayout(e)}createItem(t,o){let r,s,i,m=this,a={appName:m.appName,parentId:m.id,parentIndex:o,windowId:m.windowId},n={...m.itemDefaults};switch(n&&(t.module&&delete n.ntype,t.ntype&&delete n.module),Neo.typeOf(t)){case"NeoClass":t=Neo.create({theme:t.config.theme||m.theme,...n,module:t,...a});break;case"NeoInstance":i=t.parent,i&&i!==m&&(i.remove?.(t,!1),delete t.vdom.removeDom,t.controller||m.getController()||!i.getController()||(t.controller={parent:i.getController()})),t.set(a),t.getStateProvider()?.createBindings(t);break;case"Object":n&&Neo.assignDefaults(t,n),t.module||t.ntype||t.className||(t.module=e),s=t.module,r=s&&!s.isClass&&Neo.isFunction(s),s&&!r&&(t.className=s.prototype.className,t.theme=n.theme||s.config.theme||m.theme),"this"===t.handlerScope&&(t.handlerScope=m,"String"===Neo.typeOf(t.handler)&&"Function"===Neo.typeOf(m[t.handler])&&(t.handler=m[t.handler])),Object.assign(t,a),r?t.vdom=Object.assign(t.vdom||{},{removeDom:!0}):t=Neo[t.className?"create":"ntype"](t);break;case"String":t=Neo.create({module:e,vdom:{text:t},...a})}return t}createItems(){let e,t=this,o=t._items,r=t.getVdomItemsRoot(),{layout:s}=t;r.cn=[],o.forEach((i,m)=>{o[m]=i=t.createItem(i,m),i instanceof Neo.core.Base?(s?.applyChildAttributes(i,m),e=i.createVdomReference()):e=i.vdom,r.cn.push(e)}),t.updateDepth=-1,t.update(),t.fire("itemsCreated",{id:t.id,items:o})}createLayout(e){if(e){let o=this,{appName:r,id:s,windowId:i}=o;e instanceof t&&e.isLayout?Object.assign(e,{appName:r,containerId:s,windowId:i}):(e=o.parseLayoutClass(e),Object.assign(e,{appName:r,containerId:s,windowId:i}),e=Neo.ntype(e))}return e}destroy(e=!1,t=!1){this.layout?.destroy(),this.items?.forEach(e=>{e.destroy?.(!1,!0)}),super.destroy(e,t)}getItem(e,t=this.items){let o,r,s=0,i=t.length;for(;s<i;s++){if(r=t[s],r.reference===e)return r;if(r.items&&(o=this.getItem(e,r.items),o))return o}return null}getVdomItemsRoot(){return this.getVdomRoot()}indexOf(e){let t=this,o=0,r=t.items?.length||0;for(Neo.isString(e)||(e=e.id);o<r;o++)if(t.items[o].id===e)return o;return-1}insert(e,t,o=!1){let r,s,i,m=this,{items:a}=m;if(Array.isArray(t)){for(r=0,s=t.length,i=[];r<s;r++)i.unshift(m.insert(e,t[s-1-r],!0));t=i}else t=m.createItem(t,e),m.layout.applyChildAttributes(t,e,!0),a.splice(e,0,t),m.items=a,m.getVdomItemsRoot().cn.splice(e,0,t.createVdomReference());return o||(m.updateDepth=-1,m.promiseUpdate().then(()=>{m.fire("insert",{index:e,item:t})})),t}async loadItems({options:e={},url:t}){let o=await fetch(t,e),r=await o.json();return r.modules?.length>0&&await Promise.all(r.modules.map(e=>(e.startsWith("http")||(e=("development"===Neo.config.environment?"../../":"../../../../")+e),import(e)))),r.items}mergeConfig(...e){let t,o=this,r=super.mergeConfig(...e);return r.items&&(t=o.constructor.config.items,"Object"===Neo.typeOf(r.items)?Neo.isArray(t)?o.items=Neo.clone(r.items,!0,!0):o.items=Neo.merge(Neo.clone(t),r.items):o._items=Neo.clone(r.items,!0,!0),delete r.items),r}moveTo(e,t){let o=this.items[e];return e!==t&&this.switchItems(t,e),o}onConstructed(){let e=this;e._layout=e.createLayout(e.layout),e._layout?.applyRenderAttributes(),super.onConstructed(),e.parseItemConfigs(e.items),e.createItems()}parseLayoutClass(e){return Neo.isObject(e)?e.ntype.startsWith("layout-")||(e.ntype=`layout-${e.ntype}`):e={ntype:e.startsWith("layout-")?e:`layout-${e}`},e}remove(e,t=!0,o=!1){let r=[...this.items],s=0,i=r.length;for(;s<i;s++)if(r[s].id===e.id)return this.removeAt(s,t,o)}removeAll(e=!0,t=!1){let o=this;o.items.forEach(t=>{e?t.destroy(!0,!0):t.mounted=!1}),o.items=[],o.getVdomItemsRoot().cn=[],t&&!e||o.update()}removeAt(e,t=!0,o=!1){let r,s=this,{items:i}=s;if(!(e>=i.length))return r=i[e],i.splice(e,1),s.getVdomItemsRoot().cn.splice(e,1),s.updateDepth=2,!o&&s.update(),t?(r.destroy(!0,o),null):(s.layout?.removeChildAttributes(r),r.mounted=!1,r);Neo.warn("Container.removeAt: index >= items.length. "+s.id)}removeLast(e=!0,t=!1){this.removeAt(this.items.length-1,e,t)}replaceAt(e,t,o=!0,r=!1){this.removeAt(e,o,!0),this.insert(e,t,r)}switchItems(e,t){let o=this,r=Neo.isNumber(e)?e:o.indexOf(e),s=Neo.isNumber(t)?t:o.indexOf(t);n.move(o.items,s,r),n.move(o.getVdomItemsRoot().cn,s,r),o.updateDepth=2,o.update()}});