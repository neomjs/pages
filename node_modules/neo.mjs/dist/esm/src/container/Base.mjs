import e from"../component/Base.mjs";import t from"../layout/Base.mjs";import o from"../layout/Card.mjs";import r from"../layout/Fit.mjs";import s from"../layout/Grid.mjs";import i from"../layout/HBox.mjs";import n from"../layout/VBox.mjs";import a from"../util/Logger.mjs";import m from"../util/Array.mjs";import{isDescriptor as l}from"../core/ConfigSymbols.mjs";const d=({weight:e=0},{weight:t=0})=>e-t;export default Neo.setupClass(class extends e{static config={className:"Neo.container.Base",ntype:"container",baseCls:["neo-container"],dragResortable_:!1,itemDefaults_:{[l]:!0,merge:"deep",value:null},items_:{[l]:!0,clone:"shallow",cloneOnGet:"none",isEqual:()=>!1,value:[]},layout_:{ntype:"vbox",align:"stretch"},sortZone:null,sortZoneCls:"Neo.draggable.container.SortZone",sortZoneConfig:null,_vdom:{cn:[]}};add(e,t=!1,o=!0){let r=this;return r.insert(r.items?r.items.length:0,e,t,o)}afterSetAppName(e,t){let o=this;super.afterSetAppName(e,t),e&&o.items&&o.items.forEach(t=>{Neo.isString(t)||(t.appName=e)}),e&&o.layout&&(o.layout.appName=e),o.sortZone&&(o.sortZone.appName=e)}afterSetLayout(e,t){let o=this;o.vnodeInitialized&&(t?.removeRenderAttributes(),e?.applyRenderAttributes(),o.items.forEach((o,r)=>{t?.removeChildAttributes(o,r),e?.applyChildAttributes(o,r)})),t?.destroy?.()}afterSetMounted(e,t){if(void 0!==t){super.afterSetMounted(e,t);for(let t=0,{items:o}=this,{length:r}=o;t<r;t++)o[t].vdom.removeDom||(o[t].mounted=e)}}afterSetNeedsVdomUpdate(e,t){e||this.items?.forEach(e=>{"string"!=typeof e&&(e._needsVdomUpdate=!1,e.afterSetNeedsVdomUpdate?.(!1,!0))})}afterSetIsVnodeInitializing(e,t){if(void 0!==t){let{items:t}=this,o=0,r=t.length;for(;o<r;o++)t[o].vdom.removeDom||(t[o].isVnodeInitializing=e)}}async afterSetDragResortable(e,t){let o,r=this;e&&!r.sortZone&&(r.sortZoneConfig?.module?(o=r.sortZoneConfig.module,r.isConstructed||await Promise.resolve()):(o=await r.loadSortZoneModule(),o=o.default),r.createSortZone(Neo.merge({module:o,appName:r.appName,boundaryContainerId:r.id,owner:r,windowId:r.windowId},r.sortZoneConfig)))}afterSetTheme(e,t){super.afterSetTheme(e,t),e&&this.items?.forEach(t=>{Neo.isString(t)||(t.theme=e)})}afterSetWindowId(e,t){super.afterSetWindowId(e,t);let o=this,{layout:r}=o;e&&o.items?.forEach(t=>{Neo.isString(t)||(t.windowId=e)}),e&&r&&!Neo.isString(r)&&(r.windowId=e),o.sortZone&&(o.sortZone.windowId=e)}beforeSetItems(e,t){if("Object"===Neo.typeOf(e)){let t,o,r=[];for(const s in e)o=e[s],o.reference=s,r.push(o),t||="weight"in o;t&&r.sort(d),e=r}return e}beforeSetLayout(e,t){return this.createLayout(e)}createItem(t,o,r=!0){let s,i,n,a=this,m={appName:a.appName,parentId:a.id,parentIndex:o,windowId:a.windowId},l={...a.itemDefaults};switch(l&&(t.module&&delete l.ntype,t.ntype&&delete l.module),Neo.typeOf(t)){case"NeoClass":t=Neo.create({theme:t.config.theme||a.theme,...l,module:t,...m});break;case"NeoInstance":n=t.parent,n&&n!==a&&(r&&(n.remove?.(t,!1),delete t.vdom.removeDom),n.windowId!==a.windowId&&(t[r?"mounted":"_mounted"]=!1),t.controller||a.getController()||!n.getController?.()||(t.controller={parent:n.getController()})),t.set(m),t.getStateProvider?.()?.createBindings(t);break;case"Object":l&&Neo.assignDefaults(t,l),t.module||t.ntype||t.className||(t.module=e),i=t.module,s=i&&!i.isClass&&Neo.isFunction(i),i&&!s&&(t.className=i.prototype.className,t.theme=l.theme||i.config.theme||a.theme),"this"===t.handlerScope&&(t.handlerScope=a,"String"===Neo.typeOf(t.handler)&&"Function"===Neo.typeOf(a[t.handler])&&(t.handler=a[t.handler])),Object.assign(t,m),s?t.vdom=Object.assign(t.vdom||{},{removeDom:!0}):t=Neo[t.className?"create":"ntype"](t);break;case"String":t=Neo.create({module:e,vdom:{text:t},...m})}return t}createItems(){let e,t=this,o=t._items,r=t.getVdomItemsRoot(),{layout:s}=t;r.cn=[],o.forEach((i,n)=>{o[n]=i=t.createItem(i,n),i instanceof Neo.core.Base?(s?.applyChildAttributes(i,n),e=i.createVdomReference()):e=i.vdom,r.cn.push(e)}),t.updateDepth=-1,t.isConstructed&&t.update(),t.fire("itemsCreated",{id:t.id,items:o})}createLayout(e){if(e){let o=this,{appName:r,id:s,windowId:i}=o;e instanceof t&&e.isLayout?Object.assign(e,{appName:r,containerId:s,windowId:i}):(e=o.parseLayoutClass(e),Object.assign(e,{appName:r,containerId:s,windowId:i}),e=Neo.ntype(e))}return e}createSortZone(e){this.sortZone=Neo.create(e)}destroy(e=!1,t=!1){this.layout?.destroy(),this.items?.forEach(e=>{e.destroy?.(!1,!0)}),super.destroy(e,t)}getItem(e,t=this.items){let o,r,s=0,i=t.length;for(;s<i;s++){if(r=t[s],r.reference===e)return r;if(r.items&&(o=this.getItem(e,r.items),o))return o}return null}getVdomItemsRoot(){return this.getVdomRoot()}indexOf(e){let t=this,o=0,r=t.items?.length||0;for(Neo.isString(e)||(e=e.id);o<r;o++)if(t.items[o].id===e)return o;return-1}insert(e,t,o=!1,r=!0){let s,i,n,a,m,l,d,u,p=this,{items:c}=p,h=null;if(Array.isArray(t)){for(s=0,a=t.length,u=[];s<a;s++)u.unshift(p.insert(e,t[a-1-s],!0,r));t=u}else{if(n=Neo.typeOf(t),"NeoInstance"===n){if(i=t.parent,i===p&&c.indexOf(t)===e)return t;i&&i!==p&&r&&(m=i,m.windowId===p.windowId&&(l=[p,...p.getParents()],d=[m,...m.getParents()],h=l.find(e=>d.includes(e))),h&&(m.remove(t,!1,!0,!0),r=!1))}t=p.createItem(t,e,r),p.layout?.applyChildAttributes(t,e,!0),c.splice(e,0,t),p.items=c,p.getVdomItemsRoot().cn.splice(e,0,t.createVdomReference())}return o||((h||p).updateDepth=-1,(h||p).promiseUpdate().then(()=>{p.fire("insert",{index:e,item:t})})),t}async loadItems({options:e={},url:t}){let o=this,r=await o.trap(fetch(t,e)),s=await o.trap(r.json());return s.modules?.length>0&&await o.trap(Promise.all(s.modules.map(e=>(e.startsWith("http")||(e=("development"===Neo.config.environment?"../../":"../../../../")+e),import(e))))),s.items}loadSortZoneModule(){return import("../draggable/container/SortZone.mjs")}mergeConfig(...e){let t,o=this,r=super.mergeConfig(...e);return r.items&&(t=o.constructor.config.items,"Object"===Neo.typeOf(r.items)?Neo.isArray(t)?o.items=Neo.clone(r.items,!0,!0):o.items=Neo.merge(Neo.clone(t),r.items):o._items=Neo.clone(r.items,!0,!0),delete r.items),r}moveTo(e,t){let o=this.items[e];return e!==t&&this.switchItems(t,e),o}onConstructed(){let e=this,o=e.layout;!o||o instanceof t||(o=Neo.clone(o,!0)),e._layout=e.createLayout(o),e._layout?.applyRenderAttributes(),super.onConstructed(),e.parseItemConfigs(e._items),e.createItems()}parseLayoutClass(e){return Neo.isObject(e)?e.ntype.startsWith("layout-")||(e.ntype=`layout-${e.ntype}`):e={ntype:e.startsWith("layout-")?e:`layout-${e}`},e}remove(e,t=!0,o=!1,r=!1){let s=[...this.items],i=0,n=s.length;for(;i<n;i++)if(s[i].id===e.id)return this.removeAt(i,t,o,r)}removeAll(e=!0,t=!1){let o=this;o.items.forEach(t=>{e?t.destroy(!0,!0):t.mounted=!1}),o.items=[],o.getVdomItemsRoot().cn=[],t&&!e||o.update()}removeAt(e,t=!0,o=!1,r=!1){let s,i=this,{items:n}=i;if(!(e>=n.length))return s=n[e],n.splice(e,1),i.getVdomItemsRoot().cn.splice(e,1),i.updateDepth=2,!o&&i.update(),t?(s.destroy(!0,o),null):(i.layout?.removeChildAttributes(s),r||(s.mounted=!1),s);Neo.warn("Container.removeAt: index >= items.length. "+i.id)}removeLast(e=!0,t=!1){this.removeAt(this.items.length-1,e,t)}replaceAt(e,t,o=!0,r=!1){this.removeAt(e,o,!0),this.insert(e,t,r)}switchItems(e,t){let o=this,r=Neo.isNumber(e)?e:o.indexOf(e),s=Neo.isNumber(t)?t:o.indexOf(t);m.move(o.items,s,r),m.move(o.getVdomItemsRoot().cn,s,r),o.updateDepth=2,o.update()}toJSON(){let e=this;return{...super.toJSON(),dragResortable:e.dragResortable,itemCount:e.items?.length||0,itemDefaults:e.itemDefaults,items:e.items?.map(t=>{const o=Neo.typeOf(t);return"NeoInstance"===o?t.id:"Object"===o&&Neo.isFunction(t.module)&&!t.module.isClass?{...t,module:t.module.toString()}:e.serializeConfig(t)}),layout:e.layout?.toJSON()}}});