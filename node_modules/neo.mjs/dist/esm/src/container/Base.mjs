import e from"../component/Base.mjs";import t from"../layout/Base.mjs";import o from"../layout/Card.mjs";import s from"../layout/Fit.mjs";import i from"../layout/Grid.mjs";import r from"../layout/HBox.mjs";import a from"../layout/VBox.mjs";import n from"../util/Logger.mjs";import m from"../util/Array.mjs";import{isDescriptor as l}from"../core/ConfigSymbols.mjs";const d=({weight:e=0},{weight:t=0})=>e-t;export default Neo.setupClass(class extends e{static config={className:"Neo.container.Base",ntype:"container",baseCls:["neo-container"],itemDefaults_:{[l]:!0,merge:"deep",value:null},items_:{[l]:!0,clone:"shallow",cloneOnGet:"none",isEqual:()=>!1,value:[]},layout_:{ntype:"vbox",align:"stretch"},_vdom:{cn:[]}};add(e){let t=this;return t.insert(t.items?t.items.length:0,e)}afterSetAppName(e,t){let o=this;super.afterSetAppName(e,t),e&&o.items&&o.items.forEach(t=>{Neo.isString(t)||(t.appName=e)}),e&&o.layout&&(o.layout.appName=e)}afterSetLayout(e,t){let o=this;o.vnodeInitialized&&(t?.removeRenderAttributes(),e?.applyRenderAttributes(),o.items.forEach((o,s)=>{t?.removeChildAttributes(o,s),e?.applyChildAttributes(o,s)})),t?.destroy?.()}afterSetMounted(e,t){if(void 0!==t){super.afterSetMounted(e,t);for(let t=0,{items:o}=this,{length:s}=o;t<s;t++)o[t].vdom.removeDom||(o[t].mounted=e)}}afterSetNeedsVdomUpdate(e,t){e||this.items?.forEach(e=>{"string"!=typeof e&&(e._needsVdomUpdate=!1,e.afterSetNeedsVdomUpdate?.(!1,!0))})}afterSetIsVnodeInitializing(e,t){if(void 0!==t){let{items:t}=this,o=0,s=t.length;for(;o<s;o++)t[o].vdom.removeDom||(t[o].isVnodeInitializing=e)}}afterSetTheme(e,t){super.afterSetTheme(e,t),e&&this.items?.forEach(t=>{Neo.isString(t)||(t.theme=e)})}afterSetWindowId(e,t){super.afterSetWindowId(e,t);let{layout:o}=this;e&&this.items?.forEach(t=>{Neo.isString(t)||(t.windowId=e)}),e&&o&&!Neo.isString(o)&&(o.windowId=e)}beforeSetItems(e,t){if("Object"===Neo.typeOf(e)){let t,o,s=[];for(const i in e)o=e[i],o.reference=i,s.push(o),t||="weight"in o;t&&s.sort(d),e=s}return e}beforeSetLayout(e,t){return this.createLayout(e)}createItem(t,o){let s,i,r,a=this,n={appName:a.appName,parentId:a.id,parentIndex:o,windowId:a.windowId},m={...a.itemDefaults};switch(m&&(t.module&&delete m.ntype,t.ntype&&delete m.module),Neo.typeOf(t)){case"NeoClass":t=Neo.create({theme:t.config.theme||a.theme,...m,module:t,...n});break;case"NeoInstance":r=t.parent,r&&r!==a&&(r.remove?.(t,!1),delete t.vdom.removeDom,t.controller||a.getController()||!r.getController?.()||(t.controller={parent:r.getController()})),t.set(n),t.getStateProvider?.()?.createBindings(t);break;case"Object":m&&Neo.assignDefaults(t,m),t.module||t.ntype||t.className||(t.module=e),i=t.module,s=i&&!i.isClass&&Neo.isFunction(i),i&&!s&&(t.className=i.prototype.className,t.theme=m.theme||i.config.theme||a.theme),"this"===t.handlerScope&&(t.handlerScope=a,"String"===Neo.typeOf(t.handler)&&"Function"===Neo.typeOf(a[t.handler])&&(t.handler=a[t.handler])),Object.assign(t,n),s?t.vdom=Object.assign(t.vdom||{},{removeDom:!0}):t=Neo[t.className?"create":"ntype"](t);break;case"String":t=Neo.create({module:e,vdom:{text:t},...n})}return t}createItems(){let e,t=this,o=t._items,s=t.getVdomItemsRoot(),{layout:i}=t;s.cn=[],o.forEach((r,a)=>{o[a]=r=t.createItem(r,a),r instanceof Neo.core.Base?(i?.applyChildAttributes(r,a),e=r.createVdomReference()):e=r.vdom,s.cn.push(e)}),t.updateDepth=-1,t.isConstructed&&t.update(),t.fire("itemsCreated",{id:t.id,items:o})}createLayout(e){if(e){let o=this,{appName:s,id:i,windowId:r}=o;e instanceof t&&e.isLayout?Object.assign(e,{appName:s,containerId:i,windowId:r}):(e=o.parseLayoutClass(e),Object.assign(e,{appName:s,containerId:i,windowId:r}),e=Neo.ntype(e))}return e}destroy(e=!1,t=!1){this.layout?.destroy(),this.items?.forEach(e=>{e.destroy?.(!1,!0)}),super.destroy(e,t)}getItem(e,t=this.items){let o,s,i=0,r=t.length;for(;i<r;i++){if(s=t[i],s.reference===e)return s;if(s.items&&(o=this.getItem(e,s.items),o))return o}return null}getVdomItemsRoot(){return this.getVdomRoot()}indexOf(e){let t=this,o=0,s=t.items?.length||0;for(Neo.isString(e)||(e=e.id);o<s;o++)if(t.items[o].id===e)return o;return-1}insert(e,t,o=!1){let s,i,r,a=this,{items:n}=a;if(Array.isArray(t)){for(s=0,i=t.length,r=[];s<i;s++)r.unshift(a.insert(e,t[i-1-s],!0));t=r}else t=a.createItem(t,e),a.layout.applyChildAttributes(t,e,!0),n.splice(e,0,t),a.items=n,a.getVdomItemsRoot().cn.splice(e,0,t.createVdomReference());return o||(a.updateDepth=-1,a.promiseUpdate().then(()=>{a.fire("insert",{index:e,item:t})})),t}async loadItems({options:e={},url:t}){let o=await fetch(t,e),s=await o.json();return s.modules?.length>0&&await Promise.all(s.modules.map(e=>(e.startsWith("http")||(e=("development"===Neo.config.environment?"../../":"../../../../")+e),import(e)))),s.items}mergeConfig(...e){let t,o=this,s=super.mergeConfig(...e);return s.items&&(t=o.constructor.config.items,"Object"===Neo.typeOf(s.items)?Neo.isArray(t)?o.items=Neo.clone(s.items,!0,!0):o.items=Neo.merge(Neo.clone(t),s.items):o._items=Neo.clone(s.items,!0,!0),delete s.items),s}moveTo(e,t){let o=this.items[e];return e!==t&&this.switchItems(t,e),o}onConstructed(){let e=this,o=e.layout;!o||o instanceof t||(o=Neo.clone(o,!0)),e._layout=e.createLayout(o),e._layout?.applyRenderAttributes(),super.onConstructed(),e.parseItemConfigs(e.items),e.createItems()}parseLayoutClass(e){return Neo.isObject(e)?e.ntype.startsWith("layout-")||(e.ntype=`layout-${e.ntype}`):e={ntype:e.startsWith("layout-")?e:`layout-${e}`},e}remove(e,t=!0,o=!1){let s=[...this.items],i=0,r=s.length;for(;i<r;i++)if(s[i].id===e.id)return this.removeAt(i,t,o)}removeAll(e=!0,t=!1){let o=this;o.items.forEach(t=>{e?t.destroy(!0,!0):t.mounted=!1}),o.items=[],o.getVdomItemsRoot().cn=[],t&&!e||o.update()}removeAt(e,t=!0,o=!1){let s,i=this,{items:r}=i;if(!(e>=r.length))return s=r[e],r.splice(e,1),i.getVdomItemsRoot().cn.splice(e,1),i.updateDepth=2,!o&&i.update(),t?(s.destroy(!0,o),null):(i.layout?.removeChildAttributes(s),s.mounted=!1,s);Neo.warn("Container.removeAt: index >= items.length. "+i.id)}removeLast(e=!0,t=!1){this.removeAt(this.items.length-1,e,t)}replaceAt(e,t,o=!0,s=!1){this.removeAt(e,o,!0),this.insert(e,t,s)}switchItems(e,t){let o=this,s=Neo.isNumber(e)?e:o.indexOf(e),i=Neo.isNumber(t)?t:o.indexOf(t);m.move(o.items,i,s),m.move(o.getVdomItemsRoot().cn,i,s),o.updateDepth=2,o.update()}});