import e from"../core/Base.mjs";import o from"../util/ClassSystem.mjs";import t from"./client/ComponentService.mjs";import n from"./client/DataService.mjs";import s from"./client/InstanceService.mjs";import i from"./client/InteractionService.mjs";import r from"./client/RuntimeService.mjs";import c from"../data/connection/WebSocket.mjs";import a from"../manager/Window.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.ai.Client",singleton:!0,socketConfig:null,url:"ws://127.0.0.1:8081"};isConnected=!1;logs=[];serviceMap=null;services=null;socket=null;construct(e){super.construct(e);let o=this;o.services={component:Neo.create(t,{client:o}),data:Neo.create(n,{client:o}),instance:Neo.create(s,{client:o}),interaction:Neo.create(i,{client:o}),runtime:Neo.create(r,{client:o})};const{component:c,data:a,instance:d,interaction:p,runtime:m}=o.services;o.serviceMap={get_component:c,get_computed_styles:c,get_dom_rect:c,get_vdom:c,get_vdom_vnode:c,get_vnode:c,highlight_component:c,query_component:c,query_vdom:c,set_component:c,find_instances:d,get_instance_properties:d,set_instance_properties:d,get_record:a,inspect_state_provider:a,inspect_store:a,list_stores:a,modify_state_provider:a,get_dom_event:m,get_drag:m,get_method_source:m,get_route:m,get_window:m,inspect_class:m,patch_code:m,reload_page:m,set_route:m,simulate_event:p},Neo.currentWorker.on({connect:o.onAppWorkerWindowConnect,disconnect:o.onAppWorkerWindowDisconnect,scope:o}),o.connect()}connect(){let e=this;try{let t=new URL(Neo.config.neuralLinkUrl||e.url),n="Unknown App";if(Neo.config.appPath){const e=Neo.config.appPath.match(/apps\/([^\/]+)\//);e&&(n=e[1])}t.searchParams.set("appWorkerId",Neo.worker.App.id),t.searchParams.set("appName",n),e.socket=o.beforeSetInstance(e.socketConfig,c,{serverAddress:t.toString(),listeners:{close:e.onSocketClose,error:e.onSocketError,message:e.onSocketMessage,open:e.onSocketOpen,scope:e}})}catch(e){console.error("Neo.ai.Client: Failed to create WebSocket connection",e)}}async handleRequest(e,o){let t,n=this,s=null;for(t in n.serviceMap)if(e.startsWith(t)){s=n.serviceMap[t];break}const i=Neo.snakeToCamel(e);if(s){const e=s[i];if(Neo.isFunction(e))return e.call(s,o);if(Neo.isPromise(e))return await e.call(s,o)}if(s&&"function"==typeof s[i])return s[i](o);throw new Error(`Unknown method: ${e}`)}onAppWorkerWindowConnect(e){if(this.isConnected){const o=a.get(e.windowId),{appName:t,windowId:n}=e;this.sendNotification("window_connected",{appName:t,chrome:o?.chrome,innerRect:o?.innerRect,outerRect:o?.outerRect,windowId:n})}}onAppWorkerWindowDisconnect({windowId:e}){this.isConnected&&this.sendNotification("window_disconnected",{windowId:e})}async onSocketMessage({data:e}){if(e.method)try{const o=await this.handleRequest(e.method,e.params);this.sendResponse(e.id,o)}catch(o){console.error("Neo.ai.Client: Failed to handle message",o),this.sendError(e.id,o.message,o.stack)}}onSocketOpen(e){console.log("Neo.ai.Client: Connected to MCP Server"),this.isConnected=!0,this.logs.length>0&&(this.logs.forEach(e=>{this.sendNotification("console_log",e)}),this.logs.length=0);const o=Neo.worker.App;this.socket.sendMessage({jsonrpc:"2.0",method:"register",params:{appWorkerId:o.id,environment:Neo.config.environment,isSharedWorker:o.isSharedWorker,userAgent:navigator.userAgent}}),a.items.forEach(e=>{this.sendNotification("window_connected",{appName:e.appName,chrome:e.chrome,innerRect:e.innerRect,outerRect:e.outerRect,windowId:e.id})});const t=Neo.manager?.DragCoordinator;t?.activeTargetZone&&this.sendNotification("drag_active",{sortGroup:t.activeTargetZone.sortGroup,sourceZone:t.activeTargetZone.id})}onSocketClose(e){console.log("Neo.ai.Client: Disconnected"),this.isConnected=!1}onSocketError(e){console.error("Neo.ai.Client: WebSocket Error",e)}sendError(e,o,t){this.isConnected&&this.socket.sendMessage({jsonrpc:"2.0",id:e,error:{code:-32603,message:o,data:{stack:t}}})}sendNotification(e,o){this.isConnected&&this.socket.sendMessage({jsonrpc:"2.0",method:e,params:o})}sendResponse(e,o){this.isConnected&&this.socket.sendMessage({jsonrpc:"2.0",id:e,result:o})}});