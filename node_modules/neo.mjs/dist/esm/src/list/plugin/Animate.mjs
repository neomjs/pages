import t from"../../plugin/Base.mjs";import e from"../../util/Css.mjs";export default Neo.setupClass(class extends t{static transitionEasings=["ease","ease-in","ease-out","ease-in-out","linear"];static config={className:"Neo.list.plugin.Animate",ntype:"plugin-list-animate",columns:null,itemMargin:10,ownerRect:null,rows:null,transitionDuration_:500,transitionEasing_:"ease-in-out",transitionTimeoutId:null};construct(t){super.construct(t);let e=this,{owner:i}=e;i.itemHeight&&i.itemWidth||console.error("list.plugin.Animate requires fixed itemHeight and itemWidth values",i),e.adjustCreateItem(),i.onStoreFilter=e.onStoreFilter.bind(e),i.onStoreSort=e.onStoreSort.bind(e),this.updateTransitionDetails()}adjustCreateItem(){let t=this,{owner:e}=t;t.ownerCreateItem=e.createItem.bind(e),e.createItem=t.createItem.bind(e,t)}afterSetTransitionDuration(t,e){this.isConstructed&&this.updateTransitionDetails(Neo.isNumber(e))}afterSetTransitionEasing(t,e){this.isConstructed&&this.updateTransitionDetails(!!e)}beforeSetTransitionEasing(t,e){return this.beforeSetEnumValue(t,e,"transitionEasing")}createItem(t,e,i){let n=t.ownerCreateItem(e,i),{owner:o}=t,s=t.getItemPosition(e,i),r=n.style||{};return t.ownerRect?(Object.assign(r,{height:`${o.itemHeight}px`,position:"absolute",transform:`translate(${s.x}px, ${s.y}px)`,width:`${o.itemWidth}px`}),n.style=r,n):null}destroy(...t){e.deleteRules(this.windowId,`#${this.owner.id} .neo-list-item`),super.destroy(...t)}getItemPosition(t,e){let i=this,n=e%i.columns,o=i.itemMargin,s=i.owner,r=Math.floor(e/i.columns);return{x:n*(o+s.itemWidth)+o,y:r*(o+s.itemHeight)+o}}getItemIndex(t,e,i){if(!i)return t.index;let n=this.owner,o=n.getKeyProperty();return e.indexOf(n.getItemId(t.record[o]))}onOwnerMounted(){let t=this,e=t.owner;e.getDomRect().then((i=>{Object.assign(t,{columns:Math.floor(i.width/e.itemWidth),ownerRect:i,rows:Math.floor(i.height/e.itemHeight)}),e.store.getCount()>0&&e.createItems()}))}onStoreFilter(t){let e,i,n,o,s=this,r=s.owner,a=r.getKeyProperty(),m=!1,l=[],d=[],u=[],c=s.transitionTimeoutId,h=!!c,p=r.vdom;c&&(clearTimeout(c),s.transitionTimeoutId=null),n=h?p.cn.map((t=>t.id)):[],t.items.forEach(((e,o)=>{i={index:o,record:e},t.oldItems.includes(e)?d.push(i):(h&&n.includes(r.getItemId(e[a]))&&(i.reAdded=!0),l.push(i))})),t.oldItems.forEach(((e,i)=>{t.items.includes(e)||u.push({index:i,record:e})})),l.forEach((t=>{t.reAdded||(e=s.getItemIndex(t,n,h),e>-1&&(m=!0,p.cn.splice(e,0,s.createItem(s,t.record,t.index)),t.item=p.cn[e],t.item.style.opacity=0))})),m&&r.update(),s.timeout(50).then((()=>{n=p.cn.map((t=>t.id)),l.forEach((t=>{e=s.getItemIndex(t,n,h),e>-1&&(p.cn[e].style.opacity=1)})),d.forEach((t=>{e=s.getItemIndex(t,n,!0),e>-1&&(o=s.getItemPosition(t.record,t.index),Object.assign(p.cn[e].style,{opacity:1,transform:`translate(${o.x}px, ${o.y}px)`}))})),u.forEach((t=>{e=s.getItemIndex(t,n,h),e>-1&&(t.item=p.cn[e],t.item.style.opacity=0)})),r.update(),s.triggerTransitionCallback()}))}onStoreSort(t){let e=this;Neo.list.Component&&e.owner instanceof Neo.list.Component?e.sortComponentList(t):e.sortBaseList(t)}sortBaseList(t){let e,i=this,n=!1,o=i.owner,s=o.getKeyProperty(),r=[],a=t.previousItems.map((t=>t[s])),m=o.vdom;m.cn.length>0&&(t.items.forEach(((t,i)=>{e=a.indexOf(t[s]),r.push(m.cn[e]),e!==i&&(n=!0)})),n&&(m.cn=r,o.update(),i.timeout(50).then((()=>{o.createItems()}))))}sortComponentList(t){let e,i,n,o=this,s=o.owner,r=s.getKeyProperty(),a=t.previousItems.map((t=>t[r])),m=s.vdom;s.sortItems(t),a=s.items.map((t=>s.getItemRecordId(t[r]))),m.cn.length>0&&(t.items.forEach(((t,s)=>{e=a.indexOf(t[r]),i=m.cn[e],n=o.getItemPosition(t,s),i.style.transform=`translate(${n.x}px, ${n.y}px)`})),s.update())}triggerTransitionCallback(){let t=this;t.transitionTimeoutId=setTimeout((()=>{t.transitionTimeoutId=null,t.owner.createItems()}),t.transitionDuration)}async updateTransitionDetails(t=!1){let i=this,n=i.transitionDuration,o=i.transitionEasing,{id:s}=i.owner;t&&await e.deleteRules(i.windowId,`#${s} .neo-list-item`),e.insertRules(i.windowId,[`#${s} .neo-list-item {`,`transition: opacity ${n}ms ${o}, transform ${n}ms ${o}`,"}"].join(""))}});