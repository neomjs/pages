import e from"../collection/Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.manager.VDomUpdate",mergedCallbackMap:null,postUpdateQueueMap:null,singleton:!0};descendantInFlightMap=new Map;inFlightUpdateMap=null;promiseCallbackMap=null;construct(t){super.construct(t);const a=this;a.inFlightUpdateMap=new Map,a.mergedCallbackMap=Neo.create(e,{keyProperty:"ownerId"}),a.postUpdateQueueMap=Neo.create(e,{keyProperty:"ownerId"}),a.promiseCallbackMap=new Map}addPromiseCallback(e,t){let a=this;a.promiseCallbackMap.has(e)||a.promiseCallbackMap.set(e,[]),a.promiseCallbackMap.get(e).push(t)}executeCallbacks(e,t,a){let l=this,d=l.mergedCallbackMap.get(e),p=t?[t]:[];d&&a&&(a.forEach(e=>{d.children.has(e)&&(l.executePromiseCallbacks(e,...p),d.children.delete(e))}),0===d.children.size&&l.mergedCallbackMap.remove(e)),l.executePromiseCallbacks(e,...p)}executePromiseCallbacks(e,t){let a=this,l=a.promiseCallbackMap.get(e);l&&(l.forEach(e=>e(t)),a.promiseCallbackMap.delete(e))}getAdjustedUpdateDepth(e){let t,a=Neo.getComponent(e),l=this.mergedCallbackMap.get(e),d=a?.updateDepth??1;return l?(l.children.forEach(e=>{t=-1===e.childUpdateDepth?-1:e.distance+e.childUpdateDepth,-1===t?d=-1:-1!==d&&(d=Math.max(d,t))}),d):null}hasInFlightDescendants(e){return this.descendantInFlightMap.has(e)}getInFlightUpdateDepth(e){return this.inFlightUpdateMap.get(e)}getMergedChildIds(e){const t=this.mergedCallbackMap.get(e);if(t){const a=new Set(t.children.keys());Neo.getComponent(e);return t.children.forEach((t,l)=>{if(t.distance>1){let t=Neo.getComponent(l);for(;t&&t.parentId&&t.parentId!==e;)t=Neo.getComponent(t.parentId),t&&a.add(t.id)}}),a}return null}registerInFlightUpdate(e,t){this.inFlightUpdateMap.set(e,t);Neo.manager.Component.getParentIds(Neo.getComponent(e)).forEach(t=>{let a=this.descendantInFlightMap.get(t);a||(a=new Map,this.descendantInFlightMap.set(t,a)),a.set(e,!0)})}registerMerged(e,t,a,l){let d=this,p=d.mergedCallbackMap.get(e);p||(p={ownerId:e,children:new Map},d.mergedCallbackMap.add(p)),p.children.set(t,{childUpdateDepth:a,distance:l})}registerPostUpdate(e,t,a){let l=this,d=l.postUpdateQueueMap.get(e);d||(d={ownerId:e,children:[]},l.postUpdateQueueMap.add(d)),d.children.push({childId:t,resolve:a})}triggerPostUpdates(e){let t,a=this,l=a.postUpdateQueueMap.get(e);l&&(l.children.forEach(e=>{t=Neo.getComponent(e.childId),t&&(e.resolve&&a.addPromiseCallback(t.id,e.resolve),t.update())}),a.postUpdateQueueMap.remove(l))}unregisterInFlightUpdate(e){this.inFlightUpdateMap.delete(e),this.descendantInFlightMap.forEach((t,a)=>{t.has(e)&&(t.delete(e),0===t.size&&this.descendantInFlightMap.delete(a))})}});