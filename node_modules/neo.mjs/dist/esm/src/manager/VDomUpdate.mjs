import e from"../collection/Base.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.manager.VDomUpdate",mergedCallbackMap:null,postUpdateQueueMap:null,singleton:!0};descendantInFlightMap=new Map;inFlightUpdateMap=null;preUpdateMap=new Map;promiseCallbackMap=null;construct(t){super.construct(t);const a=this;a.inFlightUpdateMap=new Map,a.mergedCallbackMap=Neo.create(e,{keyProperty:"ownerId"}),a.postUpdateQueueMap=Neo.create(e,{keyProperty:"ownerId"}),a.promiseCallbackMap=new Map}addPromiseCallback(e,t){let a=this;a.promiseCallbackMap.has(e)||a.promiseCallbackMap.set(e,[]),a.promiseCallbackMap.get(e).push(t)}executeCallbacks(e,t,a){let l=this,p=l.mergedCallbackMap.get(e),s=t?[t]:[];if(p&&a){for(const e of a)p.children.has(e)&&(l.executePromiseCallbacks(e,...s),p.children.delete(e));0===p.children.size&&l.mergedCallbackMap.remove(e)}l.executePromiseCallbacks(e,...s)}executePreUpdates(e){let t=this.preUpdateMap.get(e);t&&(this.preUpdateMap.delete(e),t())}executePromiseCallbacks(e,t){let a=this,l=a.promiseCallbackMap.get(e);if(l){for(let e=0,a=l.length;e<a;e++)l[e](t);a.promiseCallbackMap.delete(e)}}getAdjustedUpdateDepth(e){let t,a=Neo.getComponent(e),l=this.mergedCallbackMap.get(e),p=a?.updateDepth??1;if(l){for(const e of l.children.values())t=-1===e.childUpdateDepth?-1:e.distance+e.childUpdateDepth,-1===t?p=-1:-1!==p&&(p=Math.max(p,t));return p}return null}hasInFlightDescendants(e){return this.descendantInFlightMap.has(e)}getInFlightUpdateDepth(e){return this.inFlightUpdateMap.get(e)}getMergedChildIds(e){const t=this.mergedCallbackMap.get(e);if(t){const a=new Set(t.children.keys());for(const[l,p]of t.children)if(p.distance>1){let t=Neo.getComponent(l);for(;t&&t.parentId&&t.parentId!==e;)t=Neo.getComponent(t.parentId),t&&a.add(t.id)}return a}return null}registerInFlightUpdate(e,t){this.inFlightUpdateMap.set(e,t);const a=Neo.manager.Component.getParentIds(Neo.getComponent(e));for(let t=0,l=a.length;t<l;t++){let l=a[t],p=this.descendantInFlightMap.get(l);p||(p=new Map,this.descendantInFlightMap.set(l,p)),p.set(e,!0)}}registerMerged(e,t,a,l){let p=this,s=p.mergedCallbackMap.get(e);s||(s={ownerId:e,children:new Map},p.mergedCallbackMap.add(s)),s.children.set(t,{childUpdateDepth:a,distance:l})}registerPostUpdate(e,t,a){let l=this,p=l.postUpdateQueueMap.get(e);p||(p={ownerId:e,children:[]},l.postUpdateQueueMap.add(p)),p.children.push({childId:t,resolve:a})}registerPreUpdate(e,t){this.preUpdateMap.set(e,t)}triggerPostUpdates(e){let t,a=this,l=a.postUpdateQueueMap.get(e);if(l){for(let e=0,p=l.children.length;e<p;e++){let p=l.children[e];t=Neo.getComponent(p.childId),t&&(p.resolve&&a.addPromiseCallback(t.id,p.resolve),t.update())}a.postUpdateQueueMap.remove(l)}}unregisterInFlightUpdate(e){this.inFlightUpdateMap.delete(e);for(const[t,a]of this.descendantInFlightMap)a.has(e)&&(a.delete(e),0===a.size&&this.descendantInFlightMap.delete(t))}});