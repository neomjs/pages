import e from"../core/Base.mjs";import o from"./Component.mjs";import t from"./Focus.mjs";import n from"../util/Logger.mjs";import r from"../util/Array.mjs";import i from"../util/VDom.mjs";import s from"../util/VNode.mjs";const a=["bubble","delegate","local","scope","vnodeId"],l={change:"onChange",click:"onClick",contextmenu:"onContextMenu",dblclick:"onDoubleClick",focusin:"onFocusIn",focusout:"onFocusOut",input:"onChange",keydown:"onKeyDown",keyup:"onKeyUp",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseup:"onMouseUp",scroll:"onScroll",wheel:"onWheel"},d=["change","click","contextmenu","dblclick","drag:end","drag:move","drag:start","focusin","focusout","input","intersect","keydown","keyup","mousedown","mouseenter","mouseleave","mouseup","neonavigate","scroll","selectionchange","touchmove","wheel"];class c extends e{static config={className:"Neo.manager.DomEvent",items:{},map:{},singleton:!0};async addResizeObserver(e,o){let{id:t,windowId:n}=e,r=await Neo.currentWorker.getAddon("ResizeObserver",n);o.delegate?.startsWith("#")&&(t=o.delegate.substring(1)),r.register({id:t,windowId:n})}fire(e){let n,r,i,s,a=this,l=!0,d=e.data||{},{eventName:u}=e,p=0,m=null,g=d.path.map(e=>e.id),f=o.getParentPath(g),b=f.length;for(;p<b&&(i=f[p],n=Neo.getComponent(i),n&&!n.disabled);p++){if("scroll"===u&&n.saveScrollPosition&&"function"==typeof n.onScrollCapture&&n.onScrollCapture(d),m=a.items[i]?.[u],m&&Array.isArray(m)&&m.every(e=>{let o;return e&&e.fn&&(r="resize"===u?d.id===n.id&&d.id:a.verifyDelegationPath(e,d.path,f),!1!==r&&(s=!1,"mouseenter"!==u&&"mouseleave"!==u||(s=!c.verifyMouseEnterLeave(n,d,r,u)),s||(d=Neo.clone(d,!0,!0),d.component=n,d.currentTarget=r,Neo.isString(e.fn)&&a.bindCallback(e.fn,"fn",e.scope,e),o=e.fn.apply(e.scope||globalThis,[d]),e.bubble||(l=!1)))),!1!==o}),"focusin"===u||"focusout"===u){t["on"+Neo.capitalize(u)]({componentPath:f,data:d});break}if(!l||d.cancelBubble)break}if("contextmenu"===u&&d.ctrlKey)Neo.util?.Logger?.onContextMenu(d);else if(u.startsWith("drag:")||u.startsWith("drop")){let e=d.dragZoneId&&Neo.get(d.dragZoneId);e&&(u.startsWith("drag:")?e["drag:move"===u?"onDragMove":"onDragEnd"]?.(d):(e.fire(u,d),e[{drop:"onDrop","drop:enter":"onDropEnter","drop:leave":"onDropLeave"}[u]].call(e,d)))}}generateListenerConfig(e,o){return{bubble:e.bubble,delegate:e.delegate,eventName:e.eventName,id:o.id,opts:e,priority:e.priority,scope:e.scope||o,vnodeId:e.vnodeId||o.vdom.id}}getEventName(e){let o=null;return Neo.isObject(e)&&Object.keys(e).forEach(e=>{a.includes(e)||(o=e)}),o}getListener(e){let o,t=this.items;if(t?.[e.id])return o=t[e.id][e.eventName],o||null}mountDomListeners(e){let o=this.items[e.id],t=[];o&&(Object.entries(o).forEach(([o,n])=>{n.forEach(n=>{if("resize"===(o=n.eventName))this.addResizeObserver(e,n);else if(o&&(n.local||!d.includes(o))){let e={};n.opts&&(Object.hasOwn(n.opts,"capture")&&(e.capture=n.opts.capture),Object.hasOwn(n.opts,"once")&&(e.once=n.opts.once),Object.hasOwn(n.opts,"passive")&&(e.passive=n.opts.passive)),t.push({name:o,handler:l[o]||"domEventListener",options:e,vnodeId:n.vnodeId})}})}),t.length>0&&Neo.worker.App.promiseMessage(e.windowId,{action:"addDomListener",appName:e.appName,events:t}).then(e=>{}).catch(e=>{console.log("App: Got error attempting to add a domListener",e)}))}register(e){let o,t,n,r,i=!1,{eventName:s,id:a,opts:l,scope:c}=e,u=this.items,p=typeof l;if(e.ownerId&&(a=e.ownerId),"function"===p||"string"===p?o=l:(o=l.fn,c=l.scope||c),u[a]||(u[a]={}),u[a][s]?(t=u[a][s],Object.keys(t).forEach(n=>{t[n].fn.toString()===o.toString()&&t[n].scope===c&&t[n].delegate===e.delegate&&(i=!0)})):u[a][s]=[],!0===i)return!1;r=Neo.getId("dom-event"),e.listenerId=r;let m=e.local||Neo.isObject(l)&&l.local||!1;return n={bubble:e.hasOwnProperty("bubble")?e.bubble:!l.hasOwnProperty("bubble")||l.bubble,delegate:e.delegate,eventName:s,fn:o,id:r,local:m,mounted:!m&&d.includes(s),originalConfig:e.originalConfig,ownerId:e.ownerId,priority:e.priority||l.priority||1,scope:c,vnodeId:e.vnodeId},this.map[r]=n,u[a][s].push(n),u[a][s].sort((e,o)=>o.priority-e.priority),!0}unregister(e,o){console.log("unregister",e),console.log(this.generateListenerConfig(e,o))}updateDomListeners(e,o,t){let i,s,l,d=this,c=d.items[e.id]||{};Array.isArray(o)?(Array.isArray(t)&&t.forEach(e=>{if(!o.includes(e))for(l=c[d.getEventName(e)]||[],i=0,s=l.length;i<s;i++)if(l[i].originalConfig===e){r.remove(l,l[i]);break}}),o.forEach(o=>{Object.entries(o).forEach(([t,n])=>{a.includes(t)||d.register({bubble:o.bubble||n.bubble,delegate:o.delegate||n.delegate||"#"+(e.vdom.id||e.id),eventName:t,id:e.vdom.id||e.id,opts:n,originalConfig:o,ownerId:e.id,priority:o.priority||n.priority||1,scope:o.scope||e,vnodeId:o.vnodeId||n.vnodeId||e.vdom.id})})}),e.mounted&&o?.length>0&&d.timeout(100).then(()=>{d.mountDomListeners(e)})):n.logError("Component.domListeners have to be an array",e)}verifyDelegationPath(e,o,t){let n,{delegate:r}=e,i=0,s=o.length;if("function"==typeof r)i=r(o),null!=i&&(n=o[i].id);else{let e,t,a,l,d=r.split(" ");for(t=d.length-1;t>=0;t--){for(e=!1,a=d[t],l=a.startsWith("#"),(l||a.startsWith("."))&&(a=a.substring(1));i<s;i++)if(l&&o[i].id===a||o[i].cls.includes(a)){e=!0,n=o[i].id;break}if(!e)return!1}}for(let t=i;t<s;t++)if(o[t].id===e.vnodeId)return n;if(t?.length>0){let e=t[0];for(let t=i;t<s;t++)if(o[t].id===e)return n}return!1}static verifyMouseEnterLeave(e,o,t,n){let r,s="mouseenter"===n?o.fromElementId:o.toElementId;return!(s&&s!==t&&(r=i.find(e.vdom,t),!r||r.vdom&&i.find(r.vdom,s)))}}export default Neo.setupClass(c);