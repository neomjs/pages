import e from"../core/Base.mjs";import t from"./Component.mjs";import o from"./Focus.mjs";import r from"../util/Logger.mjs";import n from"../util/Array.mjs";import i from"../util/VDom.mjs";const s=["bubble","delegate","local","scope","vnodeId"],d=["change","click","contextmenu","dblclick","drag:end","drag:move","drag:start","focusin","focusout","input","intersect","keydown","keyup","mousedown","mouseenter","mouseleave","mouseup","neonavigate","scroll","selectionchange","touchmove","wheel"];class a extends e{static config={className:"Neo.manager.DomEvent",items:{},map:{},singleton:!0};addResizeObserver(e,t){Neo.main.addon.ResizeObserver||console.error("For using resize domListeners, you must include main.addon.ResizeObserver.",t);let{id:o,windowId:r}=e;Neo.main.addon.ResizeObserver.register({id:o,windowId:r})}fire(e){let r,n,i,s,d=this,l=!0,m=e.data||{},{eventName:u}=e,c=0,p=null,g=m.path.map((e=>e.id)),f=t.getParentPath(g),b=f.length;for(;c<b&&(i=f[c],r=Neo.getComponent(i),r&&!r.disabled);c++){if(p=d.items[i]?.[u],p&&Array.isArray(p)&&p.every((e=>{let t;return e&&e.fn&&(n="resize"===u?m.id===r.id&&m.id:d.verifyDelegationPath(e,m.path),!1!==n&&(s=!1,"mouseenter"!==u&&"mouseleave"!==u||(s=!a.verifyMouseEnterLeave(r,m,n,u)),s||(m=Neo.clone(m,!0,!0),m.component=r,m.currentTarget=n,Neo.isString(e.fn)&&d.bindCallback(e.fn,"fn",e.scope,e),t=e.fn.apply(e.scope||globalThis,[m]),e.bubble||(l=!1)))),!1!==t})),"focusin"===u||"focusout"===u){o["on"+Neo.capitalize(u)]({componentPath:f,data:m});break}if(!l||m.cancelBubble)break}if("contextmenu"===u&&m.ctrlKey)Neo.util?.Logger?.onContextMenu(m);else if(u.startsWith("drop")){let e=m.dragZoneId&&Neo.get(m.dragZoneId);e&&(e.fire(u,m),e[{drop:"onDrop","drop:enter":"onDropEnter","drop:leave":"onDropLeave"}[u]].call(e,m))}}generateListenerConfig(e,t){return{bubble:e.bubble,delegate:e.delegate,eventName:e.eventName,id:t.id,opts:e,priority:e.priority,scope:e.scope||t,vnodeId:e.vnodeId||t.vdom.id}}getEventName(e){let t=null;return Neo.isObject(e)&&Object.keys(e).forEach((e=>{s.includes(e)||(t=e)})),t}getListener(e){let t,o=this.items;if(o?.[e.id])return t=o[e.id][e.eventName],t||null}mountDomListeners(e){let t=this.items[e.id],o=[];t&&(Object.entries(t).forEach((([t,r])=>{r.forEach((r=>{"resize"===(t=r.eventName)?this.addResizeObserver(e,r):!t||!r.local&&d.includes(t)||o.push({name:t,handler:"domEventListener",vnodeId:r.vnodeId})}))})),o.length>0&&Neo.worker.App.promiseMessage("main",{action:"addDomListener",appName:e.appName,events:o,windowId:e.windowId}).then((e=>{})).catch((e=>{console.log("App: Got error attempting to add a domListener",e)})))}register(e){let t,o,r,n,i=!1,{eventName:s,id:a,opts:l,scope:m}=e,u=this.items,c=typeof l;return"function"===c||"string"===c?t=l:(t=l.fn,m=l.scope||m),u[a]||(u[a]={}),u[a][s]?(o=u[a][s],Object.keys(o).forEach((r=>{o[r].fn.toString()===t.toString()&&o[r].scope===m&&o[r].delegate===e.delegate&&(i=!0)}))):u[a][s]=[],!0!==i&&(n=Neo.getId("dom-event"),e.listenerId=n,r={bubble:e.hasOwnProperty("bubble")?e.bubble:!l.hasOwnProperty("bubble")||l.bubble,delegate:e.delegate,eventName:s,fn:t,id:n,mounted:!e.local&&d.includes(s),originalConfig:e.originalConfig,ownerId:e.ownerId,priority:e.priority||l.priority||1,scope:m,vnodeId:e.vnodeId},this.map[n]=r,u[a][s].push(r),u[a][s].sort(((e,t)=>t.priority-e.priority)),!0)}unregister(e,t){console.log("unregister",e),console.log(this.generateListenerConfig(e,t))}updateDomListeners(e,t,o){let i,d,a,l=this,m=l.items[e.id]||{};Array.isArray(t)?(Array.isArray(o)&&o.forEach((e=>{if(!t.includes(e))for(a=m[l.getEventName(e)]||[],i=0,d=a.length;i<d;i++)if(a[i].originalConfig===e){n.remove(a,a[i]);break}})),t.forEach((t=>{Object.entries(t).forEach((([o,r])=>{s.includes(o)||l.register({bubble:t.bubble||r.bubble,delegate:t.delegate||r.delegate||"#"+(e.vdom.id||e.id),eventName:o,id:e.vdom.id||e.id,opts:r,originalConfig:t,ownerId:e.id,priority:t.priority||r.priority||1,scope:t.scope||e,vnodeId:t.vnodeId||r.vnodeId||e.vdom.id})}))})),e.mounted&&t?.length>0&&l.timeout(100).then((()=>{l.mountDomListeners(e)}))):r.logError("Component.domListeners have to be an array",e)}verifyDelegationPath(e,t){let o,{delegate:r}=e,n=0,i=t.length;if("function"==typeof r)n=r(t),null!=n&&(o=t[n].id);else{let e,s,d,a,l=r.split(" ");for(s=l.length-1;s>=0;s--){for(e=!1,d=l[s],a=d.startsWith("#"),(a||d.startsWith("."))&&(d=d.substr(1));n<i;n++)if(a&&t[n].id===d||t[n].cls.includes(d)){e=!0,o=t[n].id;break}if(!e)return!1}}for(;n<i;n++)if(t[n].id===e.vnodeId)return o;return!1}static verifyMouseEnterLeave(e,t,o,r){let n,s="mouseenter"===r?t.fromElementId:t.toElementId;return!(s&&s!==o&&(n=i.find(e.vdom,o),!n||n.vdom&&i.find(n.vdom,s)))}}export default Neo.setupClass(a);