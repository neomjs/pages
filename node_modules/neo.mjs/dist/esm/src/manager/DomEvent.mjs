import e from"../core/Base.mjs";import o from"./Component.mjs";import t from"./Focus.mjs";import n from"../util/Logger.mjs";import r from"../util/Array.mjs";import i from"../util/VDom.mjs";import s from"../util/VNode.mjs";const a=["bubble","delegate","local","scope","vnodeId"],l={change:"onChange",click:"onClick",contextmenu:"onContextMenu",dblclick:"onDoubleClick",focusin:"onFocusIn",focusout:"onFocusOut",input:"onChange",keydown:"onKeyDown",keyup:"onKeyUp",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mousemove:"onMouseMove",mouseup:"onMouseUp",scroll:"onScroll",wheel:"onWheel"},d=["change","click","contextmenu","dblclick","drag:end","drag:move","drag:start","focusin","focusout","input","intersect","keydown","keyup","mousedown","mouseenter","mouseleave","mouseup","neonavigate","scroll","selectionchange","touchmove","wheel"];class u extends e{static config={className:"Neo.manager.DomEvent",items:{},map:{},singleton:!0};mountTimeouts={};async addResizeObserver(e,o){let{id:t,windowId:n}=e,r=await Neo.currentWorker.getAddon("ResizeObserver",n);o.delegate?.startsWith("#")&&(t=o.delegate.substring(1)),r.register({id:t,windowId:n})}fire(e){let n,r,i,s,a=this,l=!0,d=e.data||{},{eventName:c}=e,m=0,p=null,g=d.path.map(e=>e.id),f=o.getParentPath(g),b=f.length;for(;m<b&&(i=f[m],n=Neo.getComponent(i),n&&!n.disabled);m++){if("scroll"===c&&n.saveScrollPosition&&"function"==typeof n.onScrollCapture&&n.onScrollCapture(d),p=a.items[i]?.[c],p&&Array.isArray(p)&&p.every(e=>{let o;return e&&e.fn&&(r="resize"===c?d.id===n.id&&d.id:a.verifyDelegationPath(e,d.path,f),!1!==r&&(s=!1,"mouseenter"!==c&&"mouseleave"!==c||(s=!u.verifyMouseEnterLeave(n,d,r,c)),s||(d=Neo.clone(d,!0,!0),d.component=n,d.currentTarget=r,Neo.isString(e.fn)&&a.bindCallback(e.fn,"fn",e.scope,e),o=e.fn.apply(e.scope||globalThis,[d]),e.bubble||(l=!1)))),!1!==o}),"focusin"===c||"focusout"===c){t["on"+Neo.capitalize(c)]({componentPath:f,data:d});break}if(!l||d.cancelBubble)break}if("contextmenu"===c&&d.ctrlKey)Neo.util?.Logger?.onContextMenu(d);else if(c.startsWith("drag:")||c.startsWith("drop")){let e=d.dragZoneId&&Neo.get(d.dragZoneId);e&&(c.startsWith("drag:")?e["drag:move"===c?"onDragMove":"onDragEnd"]?.(d):(e.fire(c,d),e[{drop:"onDrop","drop:enter":"onDropEnter","drop:leave":"onDropLeave"}[c]].call(e,d)))}}generateListenerConfig(e,o){return{bubble:e.bubble,delegate:e.delegate,eventName:e.eventName,id:o.id,opts:e,priority:e.priority,scope:e.scope||o,vnodeId:e.vnodeId||o.vdom.id}}getEventName(e){let o=null;return Neo.isObject(e)&&Object.keys(e).forEach(e=>{a.includes(e)||(o=e)}),o}getListener(e){let o,t=this.items;if(t?.[e.id])return o=t[e.id][e.eventName],o||null}mountDomListeners(e){let o=this,t=o.items[e.id],n=[];t&&(Object.entries(t).forEach(([t,r])=>{r.forEach(r=>{if("resize"===(t=r.eventName))o.addResizeObserver(e,r);else if(t&&(r.local||!d.includes(t))){let e={};r.opts&&(Object.hasOwn(r.opts,"capture")&&(e.capture=r.opts.capture),Object.hasOwn(r.opts,"once")&&(e.once=r.opts.once),Object.hasOwn(r.opts,"passive")&&(e.passive=r.opts.passive)),n.push({name:t,handler:l[t]||"domEventListener",options:e,vnodeId:r.vnodeId})}})}),n.length>0&&Neo.worker.App.promiseMessage(e.windowId,{action:"addDomListener",appName:e.appName,events:n}).then(e=>{}).catch(e=>{console.log("App: Got error attempting to add a domListener",e)}))}register(e){let o,t,n,r,i=!1,{eventName:s,id:a,opts:l,scope:u}=e,c=this.items,m=typeof l;if(e.ownerId&&(a=e.ownerId),"function"===m||"string"===m?o=l:(o=l.fn,u=l.scope||u),c[a]||(c[a]={}),c[a][s]?(t=c[a][s],Object.keys(t).forEach(n=>{t[n].fn.toString()===o.toString()&&t[n].scope===u&&t[n].delegate===e.delegate&&(i=!0)})):c[a][s]=[],!0===i)return!1;r=Neo.getId("dom-event"),e.listenerId=r;let p=e.local||Neo.isObject(l)&&l.local||!1;return n={bubble:e.hasOwnProperty("bubble")?e.bubble:!l.hasOwnProperty("bubble")||l.bubble,delegate:e.delegate,eventName:s,fn:o,id:r,local:p,mounted:!p&&d.includes(s),originalConfig:e.originalConfig,ownerId:e.ownerId,priority:e.priority||l.priority||1,scope:u,vnodeId:e.vnodeId},this.map[r]=n,c[a][s].push(n),c[a][s].sort((e,o)=>o.priority-e.priority),!0}unregister(e,o){console.log("unregister",e),console.log(this.generateListenerConfig(e,o))}updateDomListeners(e,o,t){let i,s,l,d=this,u=d.items[e.id]||{};Array.isArray(o)?(Array.isArray(t)&&t.forEach(e=>{if(!o.includes(e))for(l=u[d.getEventName(e)]||[],i=0,s=l.length;i<s;i++)if(l[i].originalConfig===e){r.remove(l,l[i]);break}}),o.forEach(o=>{Object.entries(o).forEach(([t,n])=>{a.includes(t)||d.register({bubble:o.bubble||n.bubble,delegate:o.delegate||n.delegate||"#"+(e.vdom.id||e.id),eventName:t,id:e.vdom.id||e.id,opts:n,originalConfig:o,ownerId:e.id,priority:o.priority||n.priority||1,scope:o.scope||e,vnodeId:o.vnodeId||n.vnodeId||e.vdom.id})})}),e.mounted&&o?.length>0&&(d.mountTimeouts[e.id]&&clearTimeout(d.mountTimeouts[e.id]),d.mountTimeouts[e.id]=setTimeout(()=>{d.mountDomListeners(e),delete d.mountTimeouts[e.id]},50))):n.logError("Component.domListeners have to be an array",e)}verifyDelegationPath(e,o,t){let n,{delegate:r}=e,i=0,s=o.length;if("function"==typeof r)i=r(o),null!=i&&(n=o[i].id);else{let e,t,a,l,d=r.split(" ");for(t=d.length-1;t>=0;t--){for(e=!1,a=d[t],l=a.startsWith("#"),(l||a.startsWith("."))&&(a=a.substring(1));i<s;i++)if(l&&o[i].id===a||o[i].cls.includes(a)){e=!0,n=o[i].id;break}if(!e)return!1}}for(let t=i;t<s;t++)if(o[t].id===e.vnodeId)return n;if(t?.length>0){let e=t[0];for(let t=i;t<s;t++)if(o[t].id===e)return n}return!1}static verifyMouseEnterLeave(e,o,t,n){let r,s="mouseenter"===n?o.fromElementId:o.toElementId;return!(s&&s!==t&&(r=i.find(e.vdom,t),!r||r.vdom&&i.find(r.vdom,s)))}}export default Neo.setupClass(u);