import e from"../core/Base.mjs";import t from"./Component.mjs";import o from"./Focus.mjs";import r from"../util/Logger.mjs";import n from"../util/Array.mjs";import i from"../util/VDom.mjs";import s from"../util/VNode.mjs";const a=["bubble","delegate","local","scope","vnodeId"],d=["change","click","contextmenu","dblclick","drag:end","drag:move","drag:start","focusin","focusout","input","intersect","keydown","keyup","mousedown","mouseenter","mouseleave","mouseup","neonavigate","scroll","selectionchange","touchmove","wheel"];class l extends e{static config={className:"Neo.manager.DomEvent",items:{},map:{},singleton:!0};async addResizeObserver(e,t){let{id:o,windowId:r}=e,n=await Neo.currentWorker.getAddon("ResizeObserver",r);t.delegate?.startsWith("#")&&(o=t.delegate.substring(1)),n.register({id:o,windowId:r})}fire(e){let r,n,i,s,a=this,d=!0,m=e.data||{},{eventName:c}=e,u=0,g=null,p=m.path.map(e=>e.id),f=t.getParentPath(p),b=f.length;for(;u<b&&(i=f[u],r=Neo.getComponent(i),r&&!r.disabled);u++){if("scroll"===c&&r.saveScrollPosition&&"function"==typeof r.onScrollCapture&&r.onScrollCapture(m),g=a.items[i]?.[c],g&&Array.isArray(g)&&g.every(e=>{let t;return e&&e.fn&&(n="resize"===c?m.id===r.id&&m.id:a.verifyDelegationPath(e,m.path,f),!1!==n&&(s=!1,"mouseenter"!==c&&"mouseleave"!==c||(s=!l.verifyMouseEnterLeave(r,m,n,c)),s||(m=Neo.clone(m,!0,!0),m.component=r,m.currentTarget=n,Neo.isString(e.fn)&&a.bindCallback(e.fn,"fn",e.scope,e),t=e.fn.apply(e.scope||globalThis,[m]),e.bubble||(d=!1)))),!1!==t}),"focusin"===c||"focusout"===c){o["on"+Neo.capitalize(c)]({componentPath:f,data:m});break}if(!d||m.cancelBubble)break}if("contextmenu"===c&&m.ctrlKey)Neo.util?.Logger?.onContextMenu(m);else if(c.startsWith("drag:")||c.startsWith("drop")){let e=m.dragZoneId&&Neo.get(m.dragZoneId);e&&(c.startsWith("drag:")?e["drag:move"===c?"onDragMove":"onDragEnd"]?.(m):(e.fire(c,m),e[{drop:"onDrop","drop:enter":"onDropEnter","drop:leave":"onDropLeave"}[c]].call(e,m)))}}generateListenerConfig(e,t){return{bubble:e.bubble,delegate:e.delegate,eventName:e.eventName,id:t.id,opts:e,priority:e.priority,scope:e.scope||t,vnodeId:e.vnodeId||t.vdom.id}}getEventName(e){let t=null;return Neo.isObject(e)&&Object.keys(e).forEach(e=>{a.includes(e)||(t=e)}),t}getListener(e){let t,o=this.items;if(o?.[e.id])return t=o[e.id][e.eventName],t||null}mountDomListeners(e){let t=this.items[e.id],o=[];t&&(Object.entries(t).forEach(([t,r])=>{r.forEach(r=>{"resize"===(t=r.eventName)?this.addResizeObserver(e,r):!t||!r.local&&d.includes(t)||o.push({name:t,handler:"domEventListener",vnodeId:r.vnodeId})})}),o.length>0&&Neo.worker.App.promiseMessage(e.windowId,{action:"addDomListener",appName:e.appName,events:o}).then(e=>{}).catch(e=>{console.log("App: Got error attempting to add a domListener",e)}))}register(e){let t,o,r,n,i=!1,{eventName:s,id:a,opts:l,scope:m}=e,c=this.items,u=typeof l;return e.ownerId&&(a=e.ownerId),"function"===u||"string"===u?t=l:(t=l.fn,m=l.scope||m),c[a]||(c[a]={}),c[a][s]?(o=c[a][s],Object.keys(o).forEach(r=>{o[r].fn.toString()===t.toString()&&o[r].scope===m&&o[r].delegate===e.delegate&&(i=!0)})):c[a][s]=[],!0!==i&&(n=Neo.getId("dom-event"),e.listenerId=n,r={bubble:e.hasOwnProperty("bubble")?e.bubble:!l.hasOwnProperty("bubble")||l.bubble,delegate:e.delegate,eventName:s,fn:t,id:n,mounted:!e.local&&d.includes(s),originalConfig:e.originalConfig,ownerId:e.ownerId,priority:e.priority||l.priority||1,scope:m,vnodeId:e.vnodeId},this.map[n]=r,c[a][s].push(r),c[a][s].sort((e,t)=>t.priority-e.priority),!0)}unregister(e,t){console.log("unregister",e),console.log(this.generateListenerConfig(e,t))}updateDomListeners(e,t,o){let i,s,d,l=this,m=l.items[e.id]||{};Array.isArray(t)?(Array.isArray(o)&&o.forEach(e=>{if(!t.includes(e))for(d=m[l.getEventName(e)]||[],i=0,s=d.length;i<s;i++)if(d[i].originalConfig===e){n.remove(d,d[i]);break}}),t.forEach(t=>{Object.entries(t).forEach(([o,r])=>{a.includes(o)||l.register({bubble:t.bubble||r.bubble,delegate:t.delegate||r.delegate||"#"+(e.vdom.id||e.id),eventName:o,id:e.vdom.id||e.id,opts:r,originalConfig:t,ownerId:e.id,priority:t.priority||r.priority||1,scope:t.scope||e,vnodeId:t.vnodeId||r.vnodeId||e.vdom.id})})}),e.mounted&&t?.length>0&&l.timeout(100).then(()=>{l.mountDomListeners(e)})):r.logError("Component.domListeners have to be an array",e)}verifyDelegationPath(e,t,o){let r,{delegate:n}=e,i=0,s=t.length;if("function"==typeof n)i=n(t),null!=i&&(r=t[i].id);else{let e,o,a,d,l=n.split(" ");for(o=l.length-1;o>=0;o--){for(e=!1,a=l[o],d=a.startsWith("#"),(d||a.startsWith("."))&&(a=a.substring(1));i<s;i++)if(d&&t[i].id===a||t[i].cls.includes(a)){e=!0,r=t[i].id;break}if(!e)return!1}}for(let o=i;o<s;o++)if(t[o].id===e.vnodeId)return r;if(o?.length>0){let e=o[0];for(let o=i;o<s;o++)if(t[o].id===e)return r}return!1}static verifyMouseEnterLeave(e,t,o,r){let n,s="mouseenter"===r?t.fromElementId:t.toElementId;return!(s&&s!==o&&(n=i.find(e.vdom,o),!n||n.vdom&&i.find(n.vdom,s)))}}export default Neo.setupClass(l);