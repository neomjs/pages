import e from"./Base.mjs";import t from"../util/VDom.mjs";import r from"../util/VNode.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.manager.Component",singleton:!0};wrapperNodes=new Map;construct(e){super.construct(e);let t=this;Neo.first=t.getFirst.bind(t),Neo.getComponent=t.get.bind(t)}addVnodeComponentReferences(e,r){e={...e};let n,o,s,i,d,p=this,h=e?.childNodes?[...e.childNodes]:[];return e.childNodes=h,h.forEach(((e,l)=>{n=e.id,e.componentId||n===r||(o=p.get(n),o||(o=p.wrapperNodes.get(n),o&&(s=o.id,i=t.find(o.parent.vdom,{componentId:s},!1),i&&(i.vdom.id=n))),o&&(s=o.id,d={componentId:s},s!==n&&(d.id=n))),h[l]=o?d:p.addVnodeComponentReferences(e,r)})),e}down(e,t,r=!0){Neo.isString(e)&&(e=this.getById(e));let n,o,s,i,d=this,p=[],h=null,l=0,u=[];if(Neo.isString(t)?t={ntype:t}:t||(t={}),o=Object.entries(t),s=o.length,o.forEach((([t,r])=>{(e[t]===r||"ntype"===t&&d.hasPrototypePropertyValue(e,t,r))&&p.push(!0)})),p.length===s){if(r)return e;u.push(e)}for(n=d.find({parentId:e.id}),i=n.length;l<i;l++)if(h=d.down(n[l],t,r),r){if(null!==h)return h}else h.length>0&&u.push(...h);return r?null:u}findParentComponent(e){let t,r=this,n=0,o=e?.length||0;for(;n<o;n++)if(t=e[n],t&&r.has(t))return t;return null}get(e,t=!0){if(t){let t=this.wrapperNodes.get(e);if(t)return t}return super.get(e)}getChildComponents(e){let t,r=this,n=r.find("parentId",e.id)||[],o=[];return n.forEach((e=>{o.push(e),t=r.getChildComponents(e),t&&o.push(...t)})),o}getChildIds(e,t=[]){return r.getChildIds(e,t)}getChildren(e){let t,n=[];return r.getChildIds(e.vnode).forEach((e=>{t=this.get(e),t&&n.push(t)})),n}getFirst(e,t=!0){let r=[],n=Neo.apps[Object.keys(Neo.apps)[0]].mainView;if(Neo.isString(e)){const t=/(\w*)(\[[^\]]*\])|(\w*)/g;let n;for(;n=t.exec(e);){let e,[,o,s,i]=n;if(o=o||i,e={ntype:o},s){const t=/\[(.*?)\]/,r=s.match(t);if(r){r[1].split(",").forEach((t=>{const[r,n]=t.split("=");e[r]=n.replace(/"/g,"")}))}}r.push(e),t.lastIndex++}}else Neo.isObject(e)?r.push(e):Neo.isArray(e)&&(r=e);return r.reduce(((e,r)=>{if(e){let n=e.down(r,t);if(n)return n}return null}),n)}getParentIds(e){let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e.id);return t}getParentPath(e){let t=this,r=[],n=0,o=e?.length||0;for(;n<o;n++)(t.has(e[n])||t.wrapperNodes.get(e[n]))&&r.push(e[n]);return r}getParents(e){Neo.isString(e)&&(e=this.get(e));let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e);return t}getVdomTree(e,t=-1){let r,n={...e};return e.cn&&(n.cn=[],e.cn.forEach((e=>{r=t,e.componentId&&(r=-1===t?-1:t>1?t-1:1,(-1===t||t>1)&&(e=this.get(e.componentId).vdom)),n.cn.push(this.getVdomTree(e,r))}))),n}getVnodeTree(e,t=-1){let r,n,o={...e};return e.childNodes&&(o.childNodes=[],e.childNodes.forEach((e=>{r=t,e.componentId&&(r=-1===t?-1:t>1?t-1:1,(-1===t||t>1)&&(n=this.get(e.componentId),n?.vnode&&(e=n.vnode))),o.childNodes.push(this.getVnodeTree(e,r))}))),o}hasPrototypePropertyValue(e,t,r){for(;null!==e;){if(e.hasOwnProperty(t)&&e[t]===r)return!0;e=e.__proto__}return!1}registerWrapperNode(e,t){this.wrapperNodes.set(e,t)}unregister(e){e&&(Neo.isString(e)?this.wrapperNodes.delete(e):e.id!==e.vdom.id&&this.wrapperNodes.delete(e.vdom.id)),super.unregister(e)}up(e,t,r=!0){let n,o,s,i=this.get(e),d=[];for(Neo.isString(t)?t={ntype:t}:t||(t={}),n=Object.entries(t),o=n.length;i?.parentId;){if(i=this.get(i.parentId),!i)return r?null:d;if(s=[],n.forEach((([e,t])=>{i[e]===t&&s.push(!0)})),s.length===o){if(r)return i;d.push(i)}}}});