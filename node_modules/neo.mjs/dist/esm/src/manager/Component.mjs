import e from"./Base.mjs";import t from"../util/VDom.mjs";import r from"../util/VNode.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.manager.Component",singleton:!0};childMap=new Map;wrapperNodes=new Map;construct(e){super.construct(e);let t=this;Neo.first=t.getFirst.bind(t),Neo.getComponent=t.get.bind(t)}addVnodeComponentReferences(e,r){e={...e};let n,i,s,d,o,p=this,l=e?.childNodes?[...e.childNodes]:[];return e.childNodes=l,l.forEach((e,h)=>{n=e.id,e.componentId||n===r||(i=p.get(n),i||(i=p.wrapperNodes.get(n),i&&(s=i.id,d=t.find(i.parent.vdom,{componentId:s},!1),d&&(d.vdom.id=n))),i&&(s=i.id,o={componentId:s,id:n})),l[h]=i?o:p.addVnodeComponentReferences(e,r)}),e}down(e,t,r=!0){Neo.isString(e)&&(e=this.getById(e));let n,i,s,d,o=this,p=[],l=null,h=0,a=[];if(Neo.isString(t)?t={ntype:t}:t||(t={}),i=Object.entries(t),s=i.length,i.forEach(([t,r])=>{(e[t]===r||"ntype"===t&&o.hasPrototypePropertyValue(e,t,r))&&p.push(!0)}),p.length===s){if(r)return e;a.push(e)}for(n=o.getDirectChildren(e.id),d=n.length;h<d;h++)if(l=o.down(n[h],t,r),r){if(null!==l)return l}else l.length>0&&a.push(...l);return r?null:a}findParentComponent(e){let t,r=this,n=0,i=e?.length||0;for(;n<i;n++)if(t=e[n],t&&r.has(t))return t;return null}get(e,t=!0){if(t){let t=this.wrapperNodes.get(e);if(t)return t}return super.get(e)}getChildComponents(e){let t,r=this,n=r.getDirectChildren(e.id),i=[];return n.forEach(e=>{i.push(e),t=r.getChildComponents(e),t&&i.push(...t)}),i}getChildIds(e,t=[]){return r.getChildIds(e,t)}getChildren(e){let t,n=[];return r.getChildIds(e.vnode).forEach(e=>{t=this.get(e),t&&n.push(t)}),n}getDirectChildren(e){if(!e)return[];let t,r=this,n=r.childMap.get(e);return n?(t=[],n.forEach(e=>{let i=r.get(e);i?t.push(i):n.delete(e)}),t):[]}getDistance(e,t){let r=this.get(e),n=0;for(;r?.parentId;){if(n++,r.parentId===t)return n;r=this.get(r.parentId)}return-1}getFirst(e,t=!0){let r=[],n=Object.values(Neo.apps)[0].mainView;if(Neo.isString(e)){const t=/(\w*)(\[[^\]]*\])|(\w*)/g;let n;for(;n=t.exec(e);){let e,[,i,s,d]=n;if(i=i||d,e={ntype:i},s){const t=/\[(.*?)\]/,r=s.match(t);if(r){r[1].split(",").forEach(t=>{const[r,n]=t.split("=");e[r]=n.replace(/"/g,"")})}}r.push(e),t.lastIndex++}}else Neo.isObject(e)?r.push(e):Neo.isArray(e)&&(r=e);return r.reduce((e,r)=>{if(e){let n=e.down(r,t);if(n)return n}return null},n)}getParentIds(e){let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e.id);return t}getParentPath(e){let t,r,n=this,i=[],s=0,d=e?.length||0;for(;s<d;s++)if(r=e[s],n.has(r)||n.wrapperNodes.get(r)){for(t=n.get(r);t;)i.push(t.id),t=t.parent;break}return i}getParents(e){Neo.isString(e)&&(e=this.get(e));let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e);return t}hasParent(e,t){let r=this.get(e);for(;r?.parentId;){if(r.parentId===t)return!0;r=this.get(r.parentId)}return!1}hasPrototypePropertyValue(e,t,r){for(;null!==e;){if(e.hasOwnProperty(t)&&e[t]===r)return!0;e=e.__proto__}return!1}onParentIdChange(e,t){let r,n=this,i=e.parentId;t&&(r=n.childMap.get(t),r&&(r.delete(e.id),0===r.size&&n.childMap.delete(t))),i&&(r=n.childMap.get(i),r||(r=new Set,n.childMap.set(i,r)),r.add(e.id))}register(e){super.register(e);const{id:t,parentId:r}=e;if(r){let e=this,n=e.childMap.get(r);n||(n=new Set,e.childMap.set(r,n)),n.add(t)}}registerWrapperNode(e,t){this.wrapperNodes.set(e,t)}unregister(e){let t=this,r=e;if(e&&(Neo.isString(e)&&(t.wrapperNodes.delete(e),r=t.get(e)),r)){const{id:e,parentId:n,vdom:i}=r;if(i&&e!==i.id&&t.wrapperNodes.delete(i.id),n){let r=t.childMap.get(n);r&&(r.delete(e),0===r.size&&t.childMap.delete(n))}}super.unregister(e)}up(e,t,r=!0){let n,i,s,d=this.get(e),o=[];for(Neo.isString(t)?t={ntype:t}:t||(t={}),n=Object.entries(t),i=n.length;d?.parentId;){if(d=this.get(d.parentId),!d)return r?null:o;if(s=[],n.forEach(([e,t])=>{d[e]===t&&s.push(!0)}),s.length===i){if(r)return d;o.push(d)}}}});