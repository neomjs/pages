import e from"./Base.mjs";import t from"../util/VDom.mjs";import r from"../util/VNode.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.manager.Component",singleton:!0};wrapperNodes=new Map;construct(e){super.construct(e);let t=this;Neo.first=t.getFirst.bind(t),Neo.getComponent=t.get.bind(t)}addVnodeComponentReferences(e,r){e={...e};let n,s,o,i,p,d=this,l=e?.childNodes?[...e.childNodes]:[];return e.childNodes=l,l.forEach((e,h)=>{n=e.id,e.componentId||n===r||(s=d.get(n),s||(s=d.wrapperNodes.get(n),s&&(o=s.id,i=t.find(s.parent.vdom,{componentId:o},!1),i&&(i.vdom.id=n))),s&&(o=s.id,p={componentId:o},o!==n&&(p.id=n))),l[h]=s?p:d.addVnodeComponentReferences(e,r)}),e}down(e,t,r=!0){Neo.isString(e)&&(e=this.getById(e));let n,s,o,i,p=this,d=[],l=null,h=0,u=[];if(Neo.isString(t)?t={ntype:t}:t||(t={}),s=Object.entries(t),o=s.length,s.forEach(([t,r])=>{(e[t]===r||"ntype"===t&&p.hasPrototypePropertyValue(e,t,r))&&d.push(!0)}),d.length===o){if(r)return e;u.push(e)}for(n=p.find({parentId:e.id}),i=n.length;h<i;h++)if(l=p.down(n[h],t,r),r){if(null!==l)return l}else l.length>0&&u.push(...l);return r?null:u}findParentComponent(e){let t,r=this,n=0,s=e?.length||0;for(;n<s;n++)if(t=e[n],t&&r.has(t))return t;return null}get(e,t=!0){if(t){let t=this.wrapperNodes.get(e);if(t)return t}return super.get(e)}getChildComponents(e){let t,r=this,n=r.find("parentId",e.id)||[],s=[];return n.forEach(e=>{s.push(e),t=r.getChildComponents(e),t&&s.push(...t)}),s}getChildIds(e,t=[]){return r.getChildIds(e,t)}getChildren(e){let t,n=[];return r.getChildIds(e.vnode).forEach(e=>{t=this.get(e),t&&n.push(t)}),n}getFirst(e,t=!0){let r=[],n=Neo.apps[Object.keys(Neo.apps)[0]].mainView;if(Neo.isString(e)){const t=/(\w*)(\[[^\]]*\])|(\w*)/g;let n;for(;n=t.exec(e);){let e,[,s,o,i]=n;if(s=s||i,e={ntype:s},o){const t=/\[(.*?)\]/,r=o.match(t);if(r){r[1].split(",").forEach(t=>{const[r,n]=t.split("=");e[r]=n.replace(/"/g,"")})}}r.push(e),t.lastIndex++}}else Neo.isObject(e)?r.push(e):Neo.isArray(e)&&(r=e);return r.reduce((e,r)=>{if(e){let n=e.down(r,t);if(n)return n}return null},n)}getParentIds(e){let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e.id);return t}getParentPath(e){let t=this,r=[],n=0,s=e?.length||0;for(;n<s;n++)(t.has(e[n])||t.wrapperNodes.get(e[n]))&&r.push(e[n]);return r}getParents(e){Neo.isString(e)&&(e=this.get(e));let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e);return t}hasPrototypePropertyValue(e,t,r){for(;null!==e;){if(e.hasOwnProperty(t)&&e[t]===r)return!0;e=e.__proto__}return!1}registerWrapperNode(e,t){this.wrapperNodes.set(e,t)}unregister(e){e&&(Neo.isString(e)?this.wrapperNodes.delete(e):e.id!==e.vdom.id&&this.wrapperNodes.delete(e.vdom.id)),super.unregister(e)}up(e,t,r=!0){let n,s,o,i=this.get(e),p=[];for(Neo.isString(t)?t={ntype:t}:t||(t={}),n=Object.entries(t),s=n.length;i?.parentId;){if(i=this.get(i.parentId),!i)return r?null:p;if(o=[],n.forEach(([e,t])=>{i[e]===t&&o.push(!0)}),o.length===s){if(r)return i;p.push(i)}}}});