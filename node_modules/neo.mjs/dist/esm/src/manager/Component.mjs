import e from"./Base.mjs";import t from"../util/VDom.mjs";import r from"../util/VNode.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.manager.Component",singleton:!0};wrapperNodes=new Map;construct(e){super.construct(e);let t=this;Neo.first=t.getFirst.bind(t),Neo.getComponent=t.get.bind(t)}addVnodeComponentReferences(e,r){e={...e};let n,s,i,o,d,p=this,l=e?.childNodes?[...e.childNodes]:[];return e.childNodes=l,l.forEach((e,h)=>{n=e.id,e.componentId||n===r||(s=p.get(n),s||(s=p.wrapperNodes.get(n),s&&(i=s.id,o=t.find(s.parent.vdom,{componentId:i},!1),o&&(o.vdom.id=n))),s&&(i=s.id,d={componentId:i},i!==n&&(d.id=n))),l[h]=s?d:p.addVnodeComponentReferences(e,r)}),e}down(e,t,r=!0){Neo.isString(e)&&(e=this.getById(e));let n,s,i,o,d=this,p=[],l=null,h=0,u=[];if(Neo.isString(t)?t={ntype:t}:t||(t={}),s=Object.entries(t),i=s.length,s.forEach(([t,r])=>{(e[t]===r||"ntype"===t&&d.hasPrototypePropertyValue(e,t,r))&&p.push(!0)}),p.length===i){if(r)return e;u.push(e)}for(n=d.find({parentId:e.id}),o=n.length;h<o;h++)if(l=d.down(n[h],t,r),r){if(null!==l)return l}else l.length>0&&u.push(...l);return r?null:u}findParentComponent(e){let t,r=this,n=0,s=e?.length||0;for(;n<s;n++)if(t=e[n],t&&r.has(t))return t;return null}get(e,t=!0){if(t){let t=this.wrapperNodes.get(e);if(t)return t}return super.get(e)}getChildComponents(e){let t,r=this,n=r.find("parentId",e.id)||[],s=[];return n.forEach(e=>{s.push(e),t=r.getChildComponents(e),t&&s.push(...t)}),s}getChildIds(e,t=[]){return r.getChildIds(e,t)}getChildren(e){let t,n=[];return r.getChildIds(e.vnode).forEach(e=>{t=this.get(e),t&&n.push(t)}),n}getFirst(e,t=!0){let r=[],n=Object.values(Neo.apps)[0].mainView;if(Neo.isString(e)){const t=/(\w*)(\[[^\]]*\])|(\w*)/g;let n;for(;n=t.exec(e);){let e,[,s,i,o]=n;if(s=s||o,e={ntype:s},i){const t=/\[(.*?)\]/,r=i.match(t);if(r){r[1].split(",").forEach(t=>{const[r,n]=t.split("=");e[r]=n.replace(/"/g,"")})}}r.push(e),t.lastIndex++}}else Neo.isObject(e)?r.push(e):Neo.isArray(e)&&(r=e);return r.reduce((e,r)=>{if(e){let n=e.down(r,t);if(n)return n}return null},n)}getParentIds(e){let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e.id);return t}getParentPath(e){let t,r,n=this,s=[],i=0,o=e?.length||0;for(;i<o;i++)if(r=e[i],n.has(r)||n.wrapperNodes.get(r)){for(t=n.get(r);t;)s.push(t.id),t=t.parent;break}return s}getParents(e){Neo.isString(e)&&(e=this.get(e));let t=[];for(;e?.parentId;)(e=this.get(e.parentId))&&t.push(e);return t}hasPrototypePropertyValue(e,t,r){for(;null!==e;){if(e.hasOwnProperty(t)&&e[t]===r)return!0;e=e.__proto__}return!1}registerWrapperNode(e,t){this.wrapperNodes.set(e,t)}unregister(e){e&&(Neo.isString(e)?this.wrapperNodes.delete(e):e.id!==e.vdom.id&&this.wrapperNodes.delete(e.vdom.id)),super.unregister(e)}up(e,t,r=!0){let n,s,i,o=this.get(e),d=[];for(Neo.isString(t)?t={ntype:t}:t||(t={}),n=Object.entries(t),s=n.length;o?.parentId;){if(o=this.get(o.parentId),!o)return r?null:d;if(i=[],n.forEach(([e,t])=>{o[e]===t&&i.push(!0)}),i.length===s){if(r)return o;d.push(o)}}}});