import e from"../../component/Base.mjs";import t from"../../util/Date.mjs";import n from"../../util/Array.mjs";const o=new Date,a=o.getDate(),r=o.getMonth(),s=o.getFullYear();class c extends e{static config={className:"Neo.calendar.view.YearComponent",baseCls:["neo-calendar-yearcomponent"],bind:{calendarStore:"stores.calendars",currentDate:e=>e.currentDate,eventStore:"stores.events",locale:e=>e.locale,scrollNewYearFromTop:e=>e.scrollNewYearFromTop,showWeekends:e=>e.showWeekends,weekStartDay:e=>e.weekStartDay},cachedUpdate:null,calendarStore_:null,currentDate_:null,dayNameFormat_:"narrow",eventIndicatorHigh_:3,eventIndicatorLow_:1,eventIndicatorMedium_:2,eventStore_:null,intlFormat_day:null,intlFormat_month:null,isUpdating_:!1,locale_:Neo.config.locale,monthNameFormat_:"long",needsEventUpdate:!1,owner:null,scrollNewYearFromTop:!1,showCellBorders_:!1,showDisabledDays_:!0,showWeekends_:!0,showWeekNumbers_:!0,sixWeeksPerMonth_:!1,useAnimations:!0,vdom:{cn:[{cls:["neo-content-wrapper"],cn:[{cls:["neo-year-header"],cn:[{},{cls:["neo-nav-button","neo-prev-button"]},{cls:["neo-nav-button","neo-next-button"]}]},{cls:["neo-months-container"]}]}]},weekStartDay_:0};construct(e){super.construct(e);let t=this;t.addDomListeners([{click:t.onNavButtonClick,delegate:".neo-nav-button",scope:t},{wheel:t.onWheel,scope:t}]),t.calendarStore.getCount()>0&&t.eventStore.getCount()>0&&t.createMonths(!0),t.updateHeaderYear()}afterSetCalendarStore(e,t){let n=this,o={load:n.onCalendarStoreLoad,recordChange:n.onCalendarStoreRecordChange,scope:n};t?.un(o),e?.on(o)}afterSetCurrentDate(e,t){if(this.isConstructed){let n=t.getFullYear(),o=e.getFullYear();o!==n&&this.changeYear(o-n)}}afterSetDayNameFormat(e,t){this.updateDayNamesRows(e,t)}afterSetEventIndicatorHigh(e,t){void 0!==t&&this.createMonths()}afterSetEventIndicatorLow(e,t){void 0!==t&&this.createMonths()}afterSetEventIndicatorMedium(e,t){void 0!==t&&this.createMonths()}afterSetEventStore(e,t){let n=this,o={load:n.onEventStoreLoad,recordChange:n.onEventStoreRecordChange,scope:n};t?.un(o),e?.on(o)}afterSetLocale(e,t){if(void 0!==t){let e=this;e.updateDayNamesRows(e.dayNameFormat,"",!0),e.updateMonthNameFormat(e.monthNameFormat,"")}}afterSetMonthNameFormat(e,t){this.updateMonthNameFormat(e,t)}afterSetMounted(e,t){super.afterSetMounted(e,t);let n=this;e&&n.needsEventUpdate&&(n.createMonths(),n.needsEventUpdate=!1)}afterSetShowCellBorders(e,t){let o=this.cls;n[e?"add":"remove"](o,"neo-show-cell-borders"),this.cls=o}afterSetShowWeekends(e,t){if(void 0!==t){let t,n,o,a,r,s=this,{vdom:c}=s,l=0;for(;l<12;l++)for(n=c.cn[0].cn[1].cn[l].cn,r=n.length,o=1;o<r;o++)for(a=1;a<8;a++)t=n[o].cn[a],t.cls.includes("neo-weekend")&&(e?delete t.removeDom:t.removeDom=!0);s.updateDayNamesRows(s.dayNameFormat,"")}}afterSetShowWeekNumbers(e,t){if(void 0!==t){let t,n,o,a=this,r=0;for(;r<12;r++)for(t=a.vdom.cn[0].cn[1].cn[r].cn,o=t.length,n=1;n<o;n++)t[n].cn[0].removeDom=!e;a.update()}}afterSetSixWeeksPerMonth(e,n){if(void 0!==n){let n=this,o=n.currentDate,a=0;for(o.setMonth(0),o.setDate(1);a<12;a++)n.vdom.cn[0].cn[1].cn[a].cn[7].removeDom=5===t.getWeeksOfMonth(o,n.weekStartDay)&&!e,o.setMonth(o.getMonth()+1);n.update()}}afterSetWeekStartDay(e,t){void 0!==t&&this.createMonths()}beforeSetDayNameFormat(e,n){return this.beforeSetEnumValue(e,n,"dayNameFormat",t.prototype.dayNameFormats)}beforeSetMonthNameFormat(e,n){return this.beforeSetEnumValue(e,n,"monthNameFormat",t.prototype.monthNameFormats)}cacheUpdate(e=this.currentDate){this.cachedUpdate=e}changeYear(e){let t,n,o,a=this;a.useAnimations&&(a.isUpdating||(a.isUpdating=!0,a.getDomRect().then(r=>{t=a.scrollNewYearFromTop&&e<0||!a.scrollNewYearFromTop&&e>0,n=a.vdom,o=t?0:-r.height,n.cn.push({cls:["neo-relative"],cn:[{cls:["neo-animation-wrapper"],cn:[{cls:["neo-content-wrapper"],cn:[{cls:["neo-year-header"],cn:[{text:a.currentDate.getFullYear()},{cls:["neo-nav-button","neo-prev-button"]},{cls:["neo-nav-button","neo-next-button"]}]},{cls:["neo-months-container"]}]}],style:{height:2*r.height+"px",transform:`translateY(${o}px)`,width:`${r.width}px`}}]}),a.createMonths(!0,n.cn[1].cn[0].cn[0].cn[1]),n.cn[1].cn[0].cn[t?"unshift":"push"](n.cn[0]),n.cn.splice(0,1),a.promiseUpdate().then(()=>{o=t?-r.height:0,n.cn[0].cn[0].style.transform=`translateY(${o}px)`,a.update(),a.timeout(300).then(()=>{n.cn[0]=n.cn[0].cn[0].cn[t?1:0],a.triggerVdomUpdate()})})})))}createDayNamesRow(){let e,t,n=this,o=n.currentDate,a=0,r={cls:["neo-calendar-week"],cn:[{cls:["neo-cell","neo-top-left-spacer"]}]};for(o.setDate(n.currentDate.getDate()-n.currentDate.getDay()+n.weekStartDay);a<7;a++)t={cls:["neo-cell","neo-weekday-cell"],text:n.intlFormat_day.format(o)},e=o.getDay(),n.showWeekends||0!==e&&6!==e||(t.removeDom=!0),r.cn.push(t),o.setDate(o.getDate()+1);return r}createMonthContent(e,n){let o,c,l,d,h,i,m,u,D,p,g=this,{calendarStore:v,eventStore:f}=g,w=n.getDate(),S=n.getMonth(),y=n.getFullYear(),F=t.clone(n),M=g.currentDate,N=M.getMonth(),k=M.getFullYear(),C=t.getDaysInMonth(n),b=t.getFirstDayOffset(n,g.weekStartDay),Y=0,_=t.clone(n);for(p=(C+b)/7>5?6:5,h=1-b,F.setDate(h),_.setDate(h+7);Y<6;Y++){for(D={cls:["neo-calendar-week"],removeDom:Y===p&&!g.sixWeeksPerMonth,cn:[{cls:["neo-cell","neo-weeknumber-cell"],removeDom:!g.showWeekNumbers,text:t.getWeekOfYear(_)}]},_.setDate(_.getDate()+7),u=0;u<7;u++)m=h>0&&h<=C,o=g.getCellId(y,S+1,h),d=F.getDay(),c={id:o,cls:m?["neo-cell"]:["neo-cell","neo-disabled"],tabIndex:m?-1:null,cn:[{cls:["neo-cell-content"],text:m?h:g.showDisabledDays?F.getDate():""}]},l=c.cls,0!==d&&6!==d||(l.push("neo-weekend"),g.showWeekends||(c.removeDom=!0)),s===y&&r===S&&a===h&&c.cn[0].cls.push("neo-today"),k===y&&N===S&&h===w&&l.push("neo-selected"),c.removeDom||(i=f.getDayRecords(F),i=i.filter(e=>v.get(e.calendarId).active),i.length>=g.eventIndicatorHigh?l.push("neo-events-high"):i.length>=g.eventIndicatorMedium?l.push("neo-events-medium"):i.length>=g.eventIndicatorLow&&l.push("neo-events-low")),D.cn.push(c),F.setDate(F.getDate()+1),h++;e.cn.push(D)}return e}createMonths(e=!1,n){let o=this;if(o.mounted){let a,r=o.currentDate,{vdom:s}=o,c=n||s.cn[0].cn[1],l=0;for(c.cn=[];l<12;l++)r.setMonth(l),r.setDate(1),a={cls:["neo-month"],cn:[{cls:["neo-month-name"],text:o.intlFormat_month.format(r)},o.createDayNamesRow()]},a=o.createMonthContent(a,t.clone(r)),c.cn.push(a);!e&&o.update()}else o.needsEventUpdate=!0}getCellId(e,t,n){return(n=n.toString()).length<2&&(n="0"+n),(t=t.toString()).length<2&&(t="0"+t),this.id+"__"+e+"-"+t+"-"+n}onCalendarStoreLoad(e){this.eventStore.getCount()>0&&this.createMonths()}onCalendarStoreRecordChange(e){this.createMonths()}onEventStoreLoad(e){this.calendarStore.getCount()>0&&this.createMonths()}onEventStoreRecordChange(e){this.createMonths()}onNavButtonClick(e){let{currentDate:t}=this;t.setFullYear(t.getFullYear()+(e.path[0].cls.includes("neo-next-button")?1:-1)),this.getStateProvider().setData({currentDate:t})}onWheel(e){if(Math.abs(e.deltaY)>Math.abs(e.deltaX)){let t=this,{currentDate:n}=t;n.setFullYear(n.getFullYear()+(e.deltaY>0?1:-1)),t.getStateProvider().setData({currentDate:n})}}triggerVdomUpdate(e=!1){if(!e){let e=this;e.isUpdating=!0,e.promiseUpdate().then(()=>{e.isUpdating=!1})}}updateDayNamesRows(e,t,n=!1){let o=this;if(o.intlFormat_day=new Intl.DateTimeFormat(o.locale,{weekday:e}),void 0!==t){let e,t,a,r=o.currentDate,{vdom:s}=o,c=1;for(r.setDate(o.currentDate.getDate()-o.currentDate.getDay()+o.weekStartDay);c<8;c++){for(t=0;t<12;t++)e=r.getDay(),a=s.cn[0].cn[1].cn[t].cn[1].cn[c],a.text=o.intlFormat_day.format(r),o.showWeekends||0!==e&&6!==e?delete a.removeDom:a.removeDom=!0;r.setDate(r.getDate()+1)}!n&&o.update()}}updateHeaderYear(){this.vdom.cn[0].cn[0].cn[0].text=this.currentDate.getFullYear()}updateMonthNameFormat(e,t,n=!1){let o=this;if(o.intlFormat_month=new Intl.DateTimeFormat(o.locale,{month:e}),void 0!==t){let{currentDate:e,vdom:t}=o,a=0;for(;a<12;a++)e.setMonth(a),e.setDate(1),t.cn[0].cn[1].cn[a].cn[0].text=o.intlFormat_month.format(e);!n&&o.update()}}}export default Neo.setupClass(c);