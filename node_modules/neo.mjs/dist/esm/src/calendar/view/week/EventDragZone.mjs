import e from"../../../util/Date.mjs";import t from"../../../draggable/DragProxyComponent.mjs";import a from"../../../draggable/DragZone.mjs";import r from"../../../util/Array.mjs";import n from"../../../util/VDom.mjs";export default Neo.setupClass(class extends a{static config={className:"Neo.calendar.view.week.EventDragZone",addDragProxyCls:!1,enableResizingAcrossOppositeEdge:!0,axisEndTime:0,axisStartTime:0,columnHeight:0,columnTop:0,currentInterval:0,eventDuration:0,eventRecord:null,forceUpdate:!1,hasOverflow:!1,intervalSize:15,keepEndDate:!1,keepStartDate:!1,moveHorizontal:!1,moveInMainThread:!1,newEndDate:null,newStartDate:null,scrollFactorLeft:3,useProxyWrapper:!1};addBodyCursorCls(){Neo.applyDeltas(this.appName,{id:"document.body",cls:{add:["neo-cursor-move"]}})}adjustEndDate(e){return 0===e.getHours()&&0===e.getMinutes()?e.setMinutes(e.getMinutes()-1):23===e.getHours()&&59===e.getMinutes()||e.getMinutes()%this.intervalSize===0||e.setMinutes(e.getMinutes()+1),e}afterSetProxyParentId(e,t){if(e&&void 0!==t){let t=this;t.dragProxy?.vdom.cn[0].id&&Neo.applyDeltas(t.appName,{action:"moveNode",id:t.dragProxy.id,index:0,parentId:e})}}async createDragProxy(e,a=!0){let o=this,s=Neo.getComponent(o.getDragElementRoot().id)||o.owner,i=o.dragProxyConfig?.vdom,d=n.clone(i||o.dragElement);d.cn[2].removeDom=!1;const l={module:t,appName:o.appName,moveInMainThread:o.moveInMainThread,parentId:o.proxyParentId,windowId:o.windowId,...o.dragProxyConfig,vdom:o.useProxyWrapper?{cn:[d]}:d};return l.cls=l.cls||[],l.cls.push("neo-focus"),s&&l.cls.push(s.getTheme()),d.cls&&!o.useProxyWrapper&&l.cls.push(...d.cls),o.addDragProxyCls&&r.add(l.cls,o.dragProxyCls),Object.assign(l.style,{height:`${e.height}px`,top:e.y-o.columnTop+"px",width:`${e.width}px`}),a?o.dragProxy=Neo.create(l):l}dragEnd(t){super.dragEnd(t);let a,r,o=this,{owner:s}=o,i=o.eventRecord;o.keepStartDate?(a=o.newEndDate,r=o.newStartDate||i.startDate):(r=new Date(n.find(s.vdom,o.proxyParentId).vdom.flag+"T12:00:00.000Z"),r.setHours(o.axisStartTime),r.setMinutes(o.currentInterval*o.intervalSize),o.keepEndDate?(a=o.newEndDate||i.endDate,r=o.newStartDate||r):(a=e.clone(r),a.setMinutes(a.getMinutes()+o.eventDuration))),a=o.adjustEndDate(a),i.setSilent({endDate:a,startDate:r}),Object.assign(o,{currentInterval:0,hasOverflow:!1,keepEndDate:!1,keepStartDate:!1,newEndDate:null,newStartDate:null,proxyParentId:null}),s.getStateProvider().getStore("events").doSort(),s.updateEvents()}dragMove(t){let a,r,n,o,s,i,d,l,u,c,p,m,g,D,f=this,{axisEndTime:v,axisStartTime:h,columnHeight:x,eventDuration:y,intervalSize:w,keepEndDate:M,keepStartDate:E,owner:P}=f,S=0,H=t.targetPath,I=H.length,N=f.eventRecord,T=!1,{timeAxis:j}=P;if(f.dragProxy){if(!M&&!E)for(;S<I;S++)if(H[S].cls.includes("neo-c-w-column")){f.proxyParentId=H[S].id;break}if(u=60*(v-h)/w,l=x/u,m=Math.min(x,t.clientY-f.offsetY-f.columnTop),r=Math.floor(m/l),s=e.clone(N.endDate),g=e.clone(N.startDate),M&&h>g.getHours()&&(g.setHours(h),g.setMinutes(0),y=(s-g)/60/1e3),E&&v<s.getHours()&&(s.setHours(v),s.setMinutes(0),y=(s-g)/60/1e3),M||(r=Math.min(r,u-y/w)),n=[{id:f.dragProxy.id,style:{}}],M||E)if(a=e.clone(N.startDate),a.setHours(h),a.setMinutes(0),p=P.minimumEventDuration/w,D=(N.startDate-a)/w/60/1e3,M){if(c=D+y/w,f.enableResizingAcrossOppositeEdge){if(f.forceUpdate&&r>c-p&&r<c+p)return;r>=c+p?(T=!0,f.forceUpdate=!0,s.setHours(h),s.setMinutes(r*w),s=f.adjustEndDate(s),f.newEndDate=s,g.setHours(h),g.setMinutes(c*w),f.newStartDate=g,o=(s-g)/60/60/1e3,n[0].style.top=`calc(${c*l/x*100}% + 1px)`):(f.forceUpdate=!1,f.newStartDate=null)}T||(r=Math.min(r,c-p))}else if(E){if(c=D-y/w,f.enableResizingAcrossOppositeEdge)if(r=Math.max(-y/w,r),r<=c-p)T=!0,f.forceUpdate=!0,s.setHours(h),s.setMinutes(y+c*w),s=f.adjustEndDate(s),f.newEndDate=s,g.setHours(h),g.setMinutes(y+r*w),f.newStartDate=g,o=(s-g)/60/60/1e3,m=(y/w+r)*l,m=m/x*100,n[0].style.top=`calc(${m}% + 1px)`;else{if(f.forceUpdate&&r<c+p)return;f.forceUpdate&&r>=c+p&&f.currentInterval!==r&&(f.forceUpdate=!1,f.newStartDate=null,n[0].style.top=`calc(${D*l/x*100}% + 1px)`)}T||(r=Math.max(r,c+p))}E||(r=Math.max(0,r)),f.currentInterval!==r&&(T||(M||(s.setHours(h),s.setMinutes(y+r*w)),E?(f.newEndDate=s,o=(s-N.startDate)/60/60/1e3):(g.setHours(h),g.setMinutes(r*w),m=r*l,m=m/x*100,n[0].style.top=`calc(${m}% + 1px)`),M&&(o=(N.endDate-g)/60/60/1e3)),s=f.adjustEndDate(s),n.push({id:f.dragProxy.vdom.cn[2].id,innerHTML:P.intlFormat_time.format(s)}),(M||E)&&(d=Math.round(o/(v-h)*100*1e3)/1e3,n[0].style.height=`calc(${d}% - 2px)`),n.push({id:f.dragProxy.vdom.cn[0].id,innerHTML:P.intlFormat_time.format(g)}),f.dragProxy.vdom.cn[0].id&&(i=(o&&60*o||y)/j.interval,i<=2?j.rowHeight/i<25&&!f.hasOverflow&&(n.push({id:f.dragProxy.id,cls:{add:["neo-overflow"]}}),f.hasOverflow=!0):f.hasOverflow&&(n.push({id:f.dragProxy.id,cls:{remove:["neo-overflow"]}}),f.hasOverflow=!1),Neo.applyDeltas(f.appName,n))),f.currentInterval=r}}async dragStart(e){let t=this,a=await t.owner.getDomRect([t.getDragElementRoot().id,e.path[1].id]),r=(t.eventRecord.endDate-t.eventRecord.startDate)/60/1e3,n=e.clientX-a[0].left,o=e.clientY-a[0].top;Object.assign(t,{columnHeight:a[1].height,columnTop:a[1].top,dragElementRect:a[0],eventDuration:Math.round(r/t.intervalSize)*t.intervalSize,offsetX:n,offsetY:o}),await t.createDragProxy(a[0]),t.fire("dragStart",{dragElementRect:a[0],id:t.id,offsetX:n,offsetY:o}),t.dragMove(e)}removeBodyCursorCls(){Neo.applyDeltas(this.appName,{id:"document.body",cls:{remove:["neo-cursor-move"]}})}});