import e from"../../../util/Date.mjs";import t from"../../../draggable/DragProxyComponent.mjs";import a from"../../../draggable/DragZone.mjs";import r from"../../../util/Array.mjs";import o from"../../../util/VDom.mjs";export default Neo.setupClass(class extends a{static config={className:"Neo.calendar.view.week.EventDragZone",addDragProxyCls:!1,enableResizingAcrossOppositeEdge:!0,axisEndTime:0,axisStartTime:0,columnHeight:0,columnTop:0,currentInterval:0,eventDuration:0,eventRecord:null,forceUpdate:!1,hasOverflow:!1,intervalSize:15,keepEndDate:!1,keepStartDate:!1,moveHorizontal:!1,moveInMainThread:!1,newEndDate:null,newStartDate:null,scrollFactorLeft:3,useProxyWrapper:!1};addBodyCursorCls(){Neo.applyDeltas(this.windowId,{id:"document.body",cls:{add:["neo-cursor-move"]}})}adjustEndDate(e){return 0===e.getHours()&&0===e.getMinutes()?e.setMinutes(e.getMinutes()-1):23===e.getHours()&&59===e.getMinutes()||e.getMinutes()%this.intervalSize===0||e.setMinutes(e.getMinutes()+1),e}afterSetProxyParentId(e,t){if(e&&void 0!==t){let t=this;t.dragProxy?.vdom.cn[0].id&&Neo.applyDeltas(t.windowId,{action:"moveNode",id:t.dragProxy.id,index:0,parentId:e})}}async createDragProxy(e,a=!0){let n=this,s=Neo.getComponent(n.getDragElementRoot().id)||n.owner,i=n.dragProxyConfig?.vdom,d=o.clone(i||n.dragElement);d.cn[2].removeDom=!1;const l={module:t,appName:n.appName,moveInMainThread:n.moveInMainThread,parentId:n.proxyParentId,windowId:n.windowId,...n.dragProxyConfig,vdom:n.useProxyWrapper?{cn:[d]}:d};return l.cls=l.cls||[],l.cls.push("neo-focus"),s&&l.cls.push(s.getTheme()),d.cls&&!n.useProxyWrapper&&l.cls.push(...d.cls),n.addDragProxyCls&&r.add(l.cls,n.dragProxyCls),Object.assign(l.style,{height:`${e.height}px`,top:e.y-n.columnTop+"px",width:`${e.width}px`}),a?n.dragProxy=Neo.create(l):l}dragEnd(t){super.dragEnd(t);let a,r,n=this,{owner:s}=n,i=n.eventRecord;n.keepStartDate?(a=n.newEndDate,r=n.newStartDate||i.startDate):(r=new Date(o.find(s.vdom,n.proxyParentId).vdom.flag+"T12:00:00.000Z"),r.setHours(n.axisStartTime),r.setMinutes(n.currentInterval*n.intervalSize),n.keepEndDate?(a=n.newEndDate||i.endDate,r=n.newStartDate||r):(a=e.clone(r),a.setMinutes(a.getMinutes()+n.eventDuration))),a=n.adjustEndDate(a),i.setSilent({endDate:a,startDate:r}),Object.assign(n,{currentInterval:0,hasOverflow:!1,keepEndDate:!1,keepStartDate:!1,newEndDate:null,newStartDate:null,proxyParentId:null}),s.getStateProvider().getStore("events").doSort(),s.updateEvents()}dragMove(t){let a,r,o,n,s,i,d,l,u,c,p,m,g,D,f=this,{axisEndTime:v,axisStartTime:h,columnHeight:w,eventDuration:x,intervalSize:y,keepEndDate:M,keepStartDate:E,owner:P}=f,S=0,I=t.targetPath,H=I.length,C=f.eventRecord,T=!1,{timeAxis:j}=P;if(f.dragProxy){if(!M&&!E)for(;S<H;S++)if(I[S].cls.includes("neo-c-w-column")){f.proxyParentId=I[S].id;break}if(u=60*(v-h)/y,l=w/u,m=Math.min(w,t.clientY-f.offsetY-f.columnTop),r=Math.floor(m/l),s=e.clone(C.endDate),g=e.clone(C.startDate),M&&h>g.getHours()&&(g.setHours(h),g.setMinutes(0),x=(s-g)/60/1e3),E&&v<s.getHours()&&(s.setHours(v),s.setMinutes(0),x=(s-g)/60/1e3),M||(r=Math.min(r,u-x/y)),o=[{id:f.dragProxy.id,style:{}}],M||E)if(a=e.clone(C.startDate),a.setHours(h),a.setMinutes(0),p=P.minimumEventDuration/y,D=(C.startDate-a)/y/60/1e3,M){if(c=D+x/y,f.enableResizingAcrossOppositeEdge){if(f.forceUpdate&&r>c-p&&r<c+p)return;r>=c+p?(T=!0,f.forceUpdate=!0,s.setHours(h),s.setMinutes(r*y),s=f.adjustEndDate(s),f.newEndDate=s,g.setHours(h),g.setMinutes(c*y),f.newStartDate=g,n=(s-g)/60/60/1e3,o[0].style.top=`calc(${c*l/w*100}% + 1px)`):(f.forceUpdate=!1,f.newStartDate=null)}T||(r=Math.min(r,c-p))}else if(E){if(c=D-x/y,f.enableResizingAcrossOppositeEdge)if(r=Math.max(-x/y,r),r<=c-p)T=!0,f.forceUpdate=!0,s.setHours(h),s.setMinutes(x+c*y),s=f.adjustEndDate(s),f.newEndDate=s,g.setHours(h),g.setMinutes(x+r*y),f.newStartDate=g,n=(s-g)/60/60/1e3,m=(x/y+r)*l,m=m/w*100,o[0].style.top=`calc(${m}% + 1px)`;else{if(f.forceUpdate&&r<c+p)return;f.forceUpdate&&r>=c+p&&f.currentInterval!==r&&(f.forceUpdate=!1,f.newStartDate=null,o[0].style.top=`calc(${D*l/w*100}% + 1px)`)}T||(r=Math.max(r,c+p))}E||(r=Math.max(0,r)),f.currentInterval!==r&&(T||(M||(s.setHours(h),s.setMinutes(x+r*y)),E?(f.newEndDate=s,n=(s-C.startDate)/60/60/1e3):(g.setHours(h),g.setMinutes(r*y),m=r*l,m=m/w*100,o[0].style.top=`calc(${m}% + 1px)`),M&&(n=(C.endDate-g)/60/60/1e3)),s=f.adjustEndDate(s),o.push({id:f.dragProxy.vdom.cn[2].id,textContent:P.intlFormat_time.format(s)}),(M||E)&&(d=Math.round(n/(v-h)*100*1e3)/1e3,o[0].style.height=`calc(${d}% - 2px)`),o.push({id:f.dragProxy.vdom.cn[0].id,textContent:P.intlFormat_time.format(g)}),f.dragProxy.vdom.cn[0].id&&(i=(n&&60*n||x)/j.interval,i<=2?j.rowHeight/i<25&&!f.hasOverflow&&(o.push({id:f.dragProxy.id,cls:{add:["neo-overflow"]}}),f.hasOverflow=!0):f.hasOverflow&&(o.push({id:f.dragProxy.id,cls:{remove:["neo-overflow"]}}),f.hasOverflow=!1),Neo.applyDeltas(f.windowId,o))),f.currentInterval=r}}async dragStart(e){let t=this,a=await t.owner.getDomRect([t.getDragElementRoot().id,e.path[1].id]),r=(t.eventRecord.endDate-t.eventRecord.startDate)/60/1e3,o=e.clientX-a[0].left,n=e.clientY-a[0].top;Object.assign(t,{columnHeight:a[1].height,columnTop:a[1].top,dragElementRect:a[0],eventDuration:Math.round(r/t.intervalSize)*t.intervalSize,offsetX:o,offsetY:n}),await t.createDragProxy(a[0]),t.fire("dragStart",{dragElementRect:a[0],id:t.id,offsetX:o,offsetY:n}),t.dragMove(e)}removeBodyCursorCls(){Neo.applyDeltas(this.windowId,{id:"document.body",cls:{remove:["neo-cursor-move"]}})}});