import e from"../../../../plugin/Base.mjs";import t from"../../../../util/Date.mjs";import n from"../EventDragZone.mjs";import a from"../../../../util/VDom.mjs";const r=Symbol.for("newRecordSymbol");export default Neo.setupClass(class extends e{static config={className:"Neo.calendar.view.week.plugin.DragDrop",ntype:"plugin-calendar-week-dragdrop",isDragging:!1,resizablePluginType:"calendar-week-eventresizable"};construct(e){super.construct(e);let t=this,n={scope:t,delegate:".neo-c-w-column"},a={scope:t,delegate:".neo-event"};t.owner.addDomListeners([{"drag:end":t.onColumnDragEnd,...n},{"drag:end":t.onEventDragEnd,...a},{"drag:move":t.onColumnDragMove,...n},{"drag:move":t.onEventDragMove,...a},{"drag:start":t.onColumnDragStart,...n},{"drag:start":t.onEventDragStart,...a}])}adjustResizeEvent(e){return e.path.shift(),e.targetPath.shift(),e.target=e.path[0],e}getEventDragZone(e){let{appName:t,owner:a,windowId:r}=this,{eventDragZone:i,timeAxis:o}=a,s={axisEndTime:o.getTime(a.endTime),axisStartTime:o.getTime(a.startTime),dragElement:e.dragElement,enableResizingAcrossOppositeEdge:e.enableResizingAcrossOppositeEdge,eventRecord:e.eventRecord,proxyParentId:e.proxyParentId};return i?i.set(s):a.eventDragZone=i=Neo.create({module:n,appName:t,owner:a,scrollContainerId:a.getScrollContainer().id,windowId:r,...s,dragProxyConfig:{style:{transition:"none",willChange:"height"}}}),i}isActiveCalendar(){let{owner:e}=this,{calendarStore:t}=e,n=e.data.activeCalendarId||t.getAt(0)[t.keyProperty];return t.get(n).active}isTopLevelColumn(e){return e[0].cls.includes("neo-c-w-column")}isTopLevelEvent(e){return e.path[0].cls.includes("neo-event")}onColumnDragEnd(e){let t=this,{owner:n}=t,a=t[r];a&&t.isTopLevelColumn(e.path)&&(t.isDragging=!1,delete t[r],Neo.applyDeltas(t.appName,{id:n.getEventId(a.id),style:{opacity:1}}).then((()=>{n.eventDragZone.dragEnd(),n.getPlugin(t.resizablePluginType).onDragEnd(e)})))}onColumnDragMove(e){let t=this;t.isActiveCalendar()&&t.isTopLevelColumn(e.path)&&t.owner.eventDragZone?.dragMove(e)}async onColumnDragStart(e){let n=this;if(n.isActiveCalendar()&&n.isTopLevelColumn(e.targetPath)){let i,o,s,g,d,{owner:l}=n,m=l.timeAxis.getTime(l.startTime),{calendarStore:p}=l,v=e.path[0].rect,u=15,c=60*(l.timeAxis.getTime(l.endTime)-m)/u,D=v.height/c,E=Math.min(v.height,e.clientY-v.top),h=Math.floor(E/D),w=new Date(a.find(l.vdom,e.path[0].id).vdom.flag+"T12:00:00.000Z");n.isDragging=!0,w.setHours(m),w.setMinutes(Math.min(h*u,c*u-l.minimumEventDuration)),o=t.clone(w),o.setMinutes(o.getMinutes()+l.minimumEventDuration),0===o.getHours()&&0===o.getMinutes()&&o.setMinutes(o.getMinutes()-1),d=l.eventStore.add({calendarId:l.data.activeCalendarId||p.getAt(0)[p.keyProperty],endDate:o,startDate:w,title:"New Event"})[0],n[r]=d,await n.timeout(50),g=l.getEventId(d.id),i=a.find(l.vdom,g).vdom,s=n.getEventDragZone({dragElement:i,enableResizingAcrossOppositeEdge:!0,eventRecord:d,proxyParentId:e.path[0].id}),l.getPlugin(n.resizablePluginType).onDragStart(e),await s.dragStart(e),await n.timeout(50),n.isDragging&&Neo.applyDeltas(n.appName,{id:g,style:{opacity:0}})}}onEventDragEnd(e){let t=this,{owner:n}=t,{eventDragZone:a}=n;n.enableDrag&&(a.dragEnd(),t.isTopLevelEvent(e)?a.removeBodyCursorCls():(e=t.adjustResizeEvent(e),n.getPlugin(t.resizablePluginType).onDragEnd(e)),t.isDragging=!1)}onEventDragMove(e){let t=this,{owner:n}=t;n.enableDrag&&(t.isTopLevelEvent(e)||(e=t.adjustResizeEvent(e)),n.eventDragZone.dragMove(e))}onEventDragStart(e){let t=this,{owner:n}=t,r=n.data;if(n.enableDrag){let i,o,s=t.isTopLevelEvent(e);s||(e=t.adjustResizeEvent(e)),t.isDragging=!0,i=a.find(n.vdom,e.path[0].id).vdom,o=t.getEventDragZone({dragElement:i,enableResizingAcrossOppositeEdge:r.events.enableResizingAcrossOppositeEdge,eventRecord:n.eventStore.get(i.flag),proxyParentId:e.path[1].id}),s?o.addBodyCursorCls():n.getPlugin(t.resizablePluginType).onDragStart(e),o.dragStart(e)}}});