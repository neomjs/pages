import e from"./Base.mjs";import t from"../util/Array.mjs";import{isDescriptor as o}from"../core/ConfigSymbols.mjs";import{resolveCallback as s}from"../util/Function.mjs";const n=Symbol("eventMap");export default Neo.setupClass(class extends e{static config={className:"Neo.core.Observable",ntype:"mixin-observable",listeners_:{[o]:!0,merge:"deep",value:{}}};addListener(e,t,o,s,r,c){let i,a,l,d=this,p=0,f="object"==typeof e,h=!1,m=typeof t;if("object"==typeof s&&"function"===m&&(s.fn=t,t=s,m="object",s=null),f)e.hasOwnProperty("delay")&&(p=e.delay,delete e.delay),e.hasOwnProperty("once")&&(h=e.once,delete e.once),e.hasOwnProperty("order")&&(c=e.order,delete e.order),e.hasOwnProperty("scope")&&(o=e.scope,delete e.scope),Object.entries(e).forEach(([e,t])=>{Neo.isObject(t)?d.addListener(e,{delay:p,once:h,order:c,scope:o,...t}):d.addListener(e,{delay:p,fn:t,once:h,order:c,scope:o})});else if("object"===m)p=p||t.delay,s=s||t.eventId,i=t.fn,h=h||t.once,c=c||t.order,o=o||t.scope;else if("function"===m)i=t;else{if("string"!==m)throw new Error("Invalid addListener call: "+e);i=t}return f?null:(d[n]??={},l={fn:i,id:s||Neo.getId("event")},r&&(l.data=r),p>0&&(l.delay=p),h&&(l.once=h),o&&(l.scope=o),(a=d[n][e])?(a.forEach(t=>{(t.id===s||t.fn===i&&t.scope===o)&&console.error("Duplicate event handler attached:",e,d)}),"number"==typeof c?a.splice(c,0,l):"before"===c?a.unshift(l):a.push(l)):d[n][e]=[l],l.id)}afterSetListeners(e,t){t&&Object.keys(t).length>0&&this.un(t),e&&Object.keys(e).length>0&&this.on(e)}callback(e,t=this,o){if(e){const n=s(e,t);n.fn.apply(n.scope,o)}}delayedCallback(e,t,o){this.timeout(o).then(()=>{e.fn.apply(e.scope,t)})}fire(e){let o,r,c,i,a,l=this,d=[].slice.call(arguments,1),p=l[n];if(p&&p[e])for(c=[...p[e]],a=c.length,i=0;i<a;i++){r=c[i],o=r.delay;const n=s(r.fn,r.scope||l);n.scope&&!n.scope.id?t.remove(p[e],r):l.suspendEvents||(1===d.length&&Neo.isObject(d[0])&&(d[0].source=l.id),r.once&&t.remove(p[e],r),Neo.isNumber(o)&&o>0?l.delayedCallback(n,r.data?d.concat(r.data):d,o):n.fn.apply(n.scope,r.data?d.concat(r.data):d))}}on(...e){return this.addListener(...e)}removeListener(e,t,o){let s,r,c,i,a,l=this;l[n]??={},Neo.isFunction(t)?l.removeListener({[e]:t,scope:o}):Neo.isObject(e)?(e.scope&&(o=e.scope,delete e.scope),Object.entries(e).forEach(([e,t])=>{for(i=l[n][e]||[],s=0,r=i.length;s<r;s++)if(c=i[s],c.fn.name===(Neo.isString(t)?t:t.name)&&c.scope===o){i.splice(s,1);break}})):Neo.isString(t)&&(i=l[n][e],a=!1,i.forEach((e,o)=>{if(e.id===t)return a=o}),!1!==a&&i.splice(a,1))}un(...e){this.removeListener(...e)}});