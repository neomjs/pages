import e from"./Base.mjs";import s from"../util/Array.mjs";import{resolveCallback as t}from"../util/Function.mjs";export default Neo.setupClass(class extends e{static config={className:"Neo.core.Observable",ntype:"mixin-observable",mixin:!0};addListener(e,s,t,o,r,n){let i,c,l,a=this,d=0,p="object"==typeof e,f=!1,u=typeof s;if("object"==typeof o&&"function"===u&&(o.fn=s,s=o,u="object",o=null),p)e.hasOwnProperty("delay")&&(d=e.delay,delete e.delay),e.hasOwnProperty("once")&&(f=e.once,delete e.once),e.hasOwnProperty("order")&&(n=e.order,delete e.order),e.hasOwnProperty("scope")&&(t=e.scope,delete e.scope),Object.entries(e).forEach((([e,s])=>{Neo.isObject(s)?a.addListener(e,{delay:d,once:f,order:n,scope:t,...s}):a.addListener(e,{delay:d,fn:s,once:f,order:n,scope:t})}));else if("object"===u)d=d||s.delay,o=o||s.eventId,i=s.fn,f=f||s.once,n=n||s.order,t=t||s.scope;else if("function"===u)i=s;else{if("string"!==u)throw new Error("Invalid addListener call: "+e);i=s}return p?null:(l={fn:i,id:o||Neo.getId("event")},r&&(l.data=r),d>0&&(l.delay=d),f&&(l.once=f),t&&(l.scope=t),(c=a.listeners?.[e])?(c.forEach((s=>{(s.id===o||s.fn===i&&s.scope===t)&&console.error("Duplicate event handler attached:",e,a)})),"number"==typeof n?c.splice(n,0,l):"before"===n?c.unshift(l):c.push(l)):a.listeners[e]=[l],l.id)}callback(e,s=this,o){if(e){const r=t(e,s);r.fn.apply(r.scope,o)}}delayedCallback(e,s,t){this.timeout(t).then((()=>{e.fn.apply(e.scope,s)}))}fire(e){let o,r,n,i,c,l=this,a=[].slice.call(arguments,1),d=l.listeners;if(d&&d[e])for(n=[...d[e]],c=n.length,i=0;i<c;i++){r=n[i],o=r.delay;const c=t(r.fn,r.scope||l);c.scope&&!c.scope.id?s.remove(d[e],r):l.suspendEvents||(1===a.length&&Neo.isObject(a[0])&&(a[0].source=l.id),r.once&&s.remove(d[e],r),Neo.isNumber(o)&&o>0?l.delayedCallback(c,r.data?a.concat(r.data):a,o):c.fn.apply(c.scope,r.data?a.concat(r.data):a))}}initObservable(e){let s,t=this,o=t.__proto__,r=o.constructor;for(e.listeners&&(t.listeners=e.listeners,delete e.listeners),s=t.listeners,t.listeners={},s&&(Neo.isObject(s)&&(s={...s}),t.addListener(s));o?.constructor.isClass;)r=o.constructor,r.observable&&!r.listeners&&Object.assign(r,{addListener:t.addListener,fire:t.fire,listeners:{},on:t.on,removeListener:t.removeListener,un:t.un}),o=o.__proto__}on(...e){return this.addListener(...e)}removeListener(e,s,t){let o,r,n,i,c,l=this;Neo.isFunction(s)?l.removeListener({[e]:s,scope:t}):Neo.isObject(e)?(e.scope&&(t=e.scope,delete e.scope),Object.entries(e).forEach((([e,s])=>{for(i=l.listeners[e]||[],o=0,r=i.length;o<r;o++)if(n=i[o],n.fn.name===(Neo.isString(s)?s:s.name)&&n.scope===t){i.splice(o,1);break}}))):Neo.isString(s)&&(i=l.listeners[e],c=!1,i.forEach(((e,t)=>{if(e.id===s)return c=t})),!1!==c&&i.splice(c,1))}un(...e){this.removeListener(...e)}});