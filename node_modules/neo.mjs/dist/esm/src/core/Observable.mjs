import e from"./Base.mjs";import t from"../util/Array.mjs";import{isDescriptor as o}from"../core/ConfigSymbols.mjs";import{resolveCallback as s}from"../util/Function.mjs";const r=Symbol("eventMap");export default Neo.setupClass(class extends e{static config={className:"Neo.core.Observable",ntype:"mixin-observable",listeners_:{[o]:!0,merge:"deep",value:{}}};addListener(e,t,o,s,n,c){let i,a,l,d=this,p=0,f="object"==typeof e,h=!1,m=typeof t;if("object"==typeof s&&"function"===m&&(s.fn=t,t=s,m="object",s=null),f)e.hasOwnProperty("delay")&&(p=e.delay,delete e.delay),e.hasOwnProperty("once")&&(h=e.once,delete e.once),e.hasOwnProperty("order")&&(c=e.order,delete e.order),e.hasOwnProperty("scope")&&(o=e.scope,delete e.scope),Object.entries(e).forEach(([e,t])=>{Neo.isObject(t)?d.addListener(e,{delay:p,once:h,order:c,scope:o,...t}):d.addListener(e,{delay:p,fn:t,once:h,order:c,scope:o})});else if("object"===m)p=p||t.delay,s=s||t.eventId,i=t.fn,h=h||t.once,c=c||t.order,o=o||t.scope;else if("function"===m)i=t;else{if("string"!==m)throw new Error("Invalid addListener call: "+e);i=t}return f?null:(d[r]??={},l={fn:i,id:s||Neo.getId("event")},n&&(l.data=n),p>0&&(l.delay=p),h&&(l.once=h),o&&(l.scope=o),(a=d[r][e])?(a.forEach(t=>{(t.id===s||t.fn===i&&t.scope===o)&&console.error("Duplicate event handler attached:",e,d)}),"number"==typeof c?a.splice(c,0,l):"before"===c?a.unshift(l):a.push(l)):d[r][e]=[l],l.id)}afterSetListeners(e,t){t&&Object.keys(t).length>0&&this.un(t),e&&Object.keys(e).length>0&&this.on(e)}callback(e,t=this,o){if(e){const r=s(e,t);r.fn.apply(r.scope,o)}}delayedCallback(e,t,o){this.timeout(o).then(()=>{e.fn.apply(e.scope,t)})}fire(e){let o,n,c,i,a,l=this,d=[].slice.call(arguments,1),p=l[r];if(p&&p[e])for(c=[...p[e]],a=c.length,i=0;i<a;i++){n=c[i],o=n.delay;const r=s(n.fn,n.scope||l);r.scope&&!r.scope.id?t.remove(p[e],n):l.suspendEvents||(1===d.length&&Neo.isObject(d[0])&&(d[0].source=l.id),n.once&&t.remove(p[e],n),Neo.isNumber(o)&&o>0?l.delayedCallback(r,n.data?d.concat(n.data):d,o):r.fn.apply(r.scope,n.data?d.concat(n.data):d))}}on(...e){return this.addListener(...e)}removeListener(e,t,o){let s,n,c,i,a,l=this;l[r]??={},Neo.isFunction(t)?l.removeListener({[e]:t,scope:o}):Neo.isObject(e)?(e.scope&&(o=e.scope,delete e.scope),Object.entries(e).forEach(([e,t])=>{for(i=l[r][e]||[],s=0,n=i.length;s<n;s++)if(c=i[s],c.fn.name===(Neo.isString(t)?t:t.name)&&c.scope===o){i.splice(s,1);break}})):Neo.isString(t)&&(i=l[r][e],a=!1,i.forEach((e,o)=>{if(e.id===t)return a=o}),!1!==a&&i.splice(a,1))}un(...e){this.removeListener(...e)}toJSON(){let e=this,t={},o=e[r];return o&&Object.entries(o).forEach(([o,s])=>{s.length>0&&(t[o]=s.map(t=>e.serializeConfig(t)))}),{...super.toJSON(),listeners:t}}});