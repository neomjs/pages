import{exec as e}from"child_process";import{promisify as t}from"util";import r from"../../../src/core/Base.mjs";import i from"./config.mjs";const n=t(e);export default Neo.setupClass(class extends r{static config={className:"DevIndex.services.GitHub",singleton:!0,graphqlUrl:"https://api.github.com/graphql",restUrl:"https://api.github.com",rateLimit:{core:{remaining:5e3,reset:null,limit:5e3},search:{remaining:30,reset:null,limit:30},graphql:{remaining:5e3,reset:null,limit:5e3},integration_manifest:{remaining:5e3,reset:null,limit:5e3}}};#e=null;async#t(){if(this.#e)return this.#e;const e=process.env.GH_TOKEN||process.env.GITHUB_TOKEN;if(e)return this.#e=e.trim(),this.#e;try{const{stdout:e}=await n("gh auth token");return this.#e=e.trim(),this.#e}catch(e){throw console.error("[GitHub] Failed to get auth token from environment or `gh` CLI."),new Error("Authentication failed. Please set GH_TOKEN/GITHUB_TOKEN or run `gh auth login`.")}}#r(e){const t=e.headers,r=t.get("x-ratelimit-resource"),i=r&&this.rateLimit[r]?r:"core",n=this.rateLimit[i],s=t.get("x-ratelimit-remaining"),a=t.get("x-ratelimit-reset"),o=t.get("x-ratelimit-limit");null!==s&&(n.remaining=parseInt(s,10)),null!==a&&(n.reset=parseInt(a,10)),null!==o&&(n.limit=parseInt(o,10)),e.ok&&null===s&&5e3===n.remaining&&(this._headerWarned||(console.warn("[GitHub] Warning: `x-ratelimit-*` headers not found. Falling back to body (if available)."),this._headerWarned=!0))}#i(e){if(!e)return;const t=this.rateLimit.graphql;void 0!==e.remaining&&(t.remaining=e.remaining),void 0!==e.limit&&(t.limit=e.limit),e.resetAt&&(t.reset=Math.floor(new Date(e.resetAt).getTime()/1e3))}async query(e,t={},r=3,i=""){const n=await this.#t(),s=i?`[GitHub] [${i}]`:"[GitHub]";try{const a=await fetch(this.graphqlUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`bearer ${n}`,"User-Agent":"Neo.mjs-DevIndex/1.0"},body:JSON.stringify({query:e,variables:t})});if(this.#r(a),!a.ok){if((a.status>=500||403===a.status)&&r>0){let n=2e3*(4-r);if(403===a.status){this.rateLimit.graphql.remaining>0&&(console.warn(`${s} ⚠️ Abuse Detection triggered (403 with quota). Backing off for 10s...`),n=1e4)}return console.log(`${s} Error ${a.status}. Retrying in ${n}ms...`),await new Promise(e=>setTimeout(e,n)),this.query(e,t,r-1,i)}throw new Error(`GraphQL Error: ${a.status} ${a.statusText}`)}const o=await a.json();if(o.data?.rateLimit&&this.#i(o.data.rateLimit),o.errors){const n=o.errors.map(e=>e.message).join(", ");if(n.includes("Could not resolve to a User")||n.includes("NOT_FOUND"))throw new Error(`GraphQL Fatal Error: ${n}`);if(o.errors.some(e=>e.message?.includes("502")||e.message?.includes("504"))&&r>0){const n=2e3*(4-r);return console.log(`${s} Gateway Error in body. Retrying in ${n}ms...`),await new Promise(e=>setTimeout(e,n)),this.query(e,t,r-1,i)}if(n.includes("IP allow list enabled")&&(console.warn(`${s} Partial Data Warning: ${n}`),o.data))return o.data;throw new Error(`GraphQL Query Errors: ${n}`)}return o.data}catch(n){if(n.message.includes("Could not resolve to a User")||n.message.includes("NOT_FOUND")||n.message.includes("GraphQL Fatal Error"))throw n;if(r>0&&(n.message.includes("fetch")||n.message.includes("network")||n.message.includes("terminated")))return console.log(`${s} Network/Terminated Error: ${n.message}. Retrying...`),await new Promise(e=>setTimeout(e,2e3)),this.query(e,t,r-1,i);throw console.error(`${s} GraphQL Query Failed:`,n.message),n}}async rest(e,t=""){const r=await this.#t(),i=`${this.restUrl}/${e.startsWith("/")?e.slice(1):e}`,n=t?`[GitHub] [${t}]`:"[GitHub]";try{const e=await fetch(i,{method:"GET",headers:{Accept:"application/vnd.github.v3+json",Authorization:`bearer ${r}`,"User-Agent":"Neo.mjs-DevIndex/1.0"}});if(this.#r(e),!e.ok)throw 403===e.status&&(this.rateLimit.core.remaining=0),new Error(`REST Error: ${e.status} ${e.statusText}`);return await e.json()}catch(t){throw console.error(`${n} REST Request Failed (${e}):`,t.message),t}}async getLoginById(e){const t=`\n            query { \n                node(id: "${e}") {\n                    ... on User {\n                        login\n                    }\n                    ... on Organization {\n                        login\n                    }\n                }\n            }`;try{const r=await this.query(t,{},1,`ID:${e}`);return r?.node?.login?r.node.login:null}catch(e){if(e.message.includes("NOT_FOUND")||e.message.includes("Could not resolve"))return null;throw e}}async getLoginByDatabaseId(e){const t=`\n            query { \n                user(databaseId: ${e}) {\n                    login\n                } \n            }`;try{const r=await this.query(t,{},1,`DB_ID:${e}`);return r?.user?.login?r.user.login:null}catch(e){if(e.message.includes("NOT_FOUND")||e.message.includes("Could not resolve"))return null;throw e}}});