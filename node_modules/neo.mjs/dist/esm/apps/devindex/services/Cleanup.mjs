import e from"../../../src/core/Base.mjs";import o from"./config.mjs";import t from"./Storage.mjs";export default Neo.setupClass(class extends e{static config={className:"DevIndex.services.Cleanup",singleton:!0};async run(){console.log("[Cleanup] Starting data hygiene check...");let e=await t.getUsers(),s=await t.getTracker(),a=await t.getBlocklist(),l=await t.getAllowlist(),n=await t.getVisited(),r=await t.getFailed();const i=e.length,c=s.length,g=Date.now(),u=[];for(const[e,o]of r){g-new Date(o).getTime()>2592e6&&(console.log(`[Cleanup] Expiring failed user (TTL > 30d): ${e}`),u.push(e),r.delete(e))}const p=new Set(u);l.forEach(e=>{const o=e.toLowerCase();s.some(e=>e.login.toLowerCase()===o)||a.has(o)||(console.log(`[Cleanup] Resurrecting allowlisted user: ${e}`),s.push({login:e,lastUpdate:null}))}),e=e.filter(e=>{const t=e.l.toLowerCase();if(a.has(t))return console.log(`[Cleanup] Removing blocklisted user: ${e.l}`),!1;if(p.has(t))return console.log(`[Cleanup] Pruning expired failed user: ${e.l}`),!1;const s=e.tc>=o.github.minTotalContributions,n=l.has(t);return!(!s&&!n)||(console.log(`[Cleanup] Pruning user below threshold (${e.tc}): ${e.l}`),!1)});const w=new Set(e.map(e=>e.l.toLowerCase()));s=s.filter(e=>{const o=e.login.toLowerCase();return!a.has(o)&&(!!l.has(o)||(!(e.lastUpdate&&!w.has(o))||(r.has(o)?(console.warn(`[Cleanup] Keeping failed user in tracker (Penalty Box): ${e.login}`),!0):(console.log(`[Cleanup] Pruning orphaned user (scanned but low value): ${e.login}`),!1))))}),e.sort((e,o)=>(o.tc||0)-(e.tc||0)),s.sort((e,o)=>e.login.localeCompare(o.login));const h=Array.from(a).sort(),d=Array.from(l).sort(),m=Array.from(n).sort();await t.writeJson(o.paths.users,e);const f={};s.forEach(e=>f[e.login]=e.lastUpdate),await t.writeJson(o.paths.tracker,f),await t.writeJson(o.paths.blocklist,h),await t.writeJson(o.paths.allowlist,d),await t.writeJson(o.paths.visited,m),await t.saveFailed(r),u.length>0&&console.log(`[Cleanup] Removed ${u.length} expired users from Penalty Box.`),console.log("[Cleanup] Complete."),console.log(`  Users: ${i} -> ${e.length} (-${i-e.length})`),console.log(`  Tracker: ${c} -> ${s.length} (-${c-s.length})`)}});