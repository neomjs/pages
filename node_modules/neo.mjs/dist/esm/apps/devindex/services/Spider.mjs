import e from"../../../src/core/Base.mjs";import r from"./config.mjs";import t from"./GitHub.mjs";import o from"./Storage.mjs";class a extends e{static config={className:"DevIndex.services.Spider",singleton:!0};static keywords=["algorithm","analytics","api","architecture","audio","automation","benchmark","blockchain","browser","build","cache","canvas","cli","compiler","component","concurrency","crypto","data","database","debugger","design","distributed","editor","emulator","engine","framework","frontend","game","geometry","graphics","grid","gui","image","kernel","language","library","linux","machine-learning","mathematics","middleware","mobile","network","neural","operating-system","optimization","parser","performance","physics","platform","protocol","realtime","renderer","runtime","security","server","simulation","state-management","terminal","testing","tool","ui","utility","video","virtual-machine","visualization","wasm","web"];static communityTargets=["PyLadies","WomenWhoCode","RLadies","DjangoGirls","RailsGirls","GirlDevelopIt","ladies-of-code"];async run(e=null){console.log("[Spider] Starting discovery run...");const t=await o.getVisited(),a=await o.getBlocklist(),i=await o.getTracker(),n=new Set(i.map(e=>e.login.toLowerCase())),s=i.filter(e=>null===e.lastUpdate).length;if(s>=r.spider.maxPendingUsers)return console.log(`[Spider] Backpressure Valve Triggered: Backlog (${s}) exceeds threshold (${r.spider.maxPendingUsers}).`),void console.log("[Spider] Aborting discovery run to let the Updater catch up.");const c={visited:t,blocklist:a,existingLogins:n,newCandidates:new Set,newVisited:new Set,totalFound:0},l=this.pickStrategy(i,e);console.log(`[Spider] Strategy Selected: ${l.name} (${l.description})`);try{"search"===l.type?await this.runSearch(l.query,c,l.sort,l.order):"stargazer"===l.type?await this.runStargazer(l.username,c):"network_walker"===l.type?await this.runNetworkWalker(l.username,c):"community_scan"===l.type&&await this.runCommunityScan(l.target,c)}catch(e){console.error("[Spider] Fatal error:",e)}finally{console.log("--------------------------------------------------"),console.log("[Spider] Run Complete."),console.log(`[Spider] Total New Candidates Discovered: ${c.totalFound}`),console.log("--------------------------------------------------")}}pickStrategy(e,t=null){const o=Math.random();if(t)switch(t){case"community":case"community_scan":if(Math.random()<.5){const e=a.communityTargets[Math.floor(Math.random()*a.communityTargets.length)];return{name:"Discovery: Community Scan (Forced)",description:`org:${e}`,type:"community_scan",target:e}}return this.getBioSignalStrategy();case"keyword":const r=a.keywords[Math.floor(Math.random()*a.keywords.length)];return{name:"Discovery: Keyword (Forced)",description:`topic:${r}`,type:"search",query:`topic:${r} stars:>50`};case"temporal":const t=this.getRandomDateRange();return{name:"Discovery: Temporal (Forced)",description:`created:${t}`,type:"search",query:`created:${t} stars:>50`};case"network_walker":if(e.length>0){const r=e[Math.floor(Math.random()*e.length)];return{name:"Discovery: Network Walker (Forced)",description:`following of ${r.login}`,type:"network_walker",username:r.login}}console.warn("[Spider] Cannot force Network Walker: No existing users. Falling back to Core.");break;case"stargazer":if(e.length>0){const r=e[Math.floor(Math.random()*e.length)];return{name:"Discovery: Stargazer Leap (Forced)",description:`user:${r.login}`,type:"stargazer",username:r.login}}console.warn("[Spider] Cannot force Stargazer: No existing users. Falling back to Core.")}if("search"===t||o<.25){const e=r.github.minStars+Math.floor(19e3*Math.pow(Math.random(),3)),t=e+1e3+Math.floor(2e3*Math.random());return{name:"Core: High Stars (Sliced)",description:`stars:${e}..${t}`,type:"search",query:`stars:${e}..${t}`}}if(o<.45){const e=a.keywords[Math.floor(Math.random()*a.keywords.length)];return{name:"Discovery: Keyword",description:`topic:${e}`,type:"search",query:`topic:${e} stars:>50`}}if(o<.6){const e=this.getRandomDateRange();return{name:"Discovery: Temporal",description:`created:${e}`,type:"search",query:`created:${e} stars:>50`}}if(o<.9&&e.length>0){const r=e[Math.floor(Math.random()*e.length)];return{name:"Discovery: Network Walker",description:`following of ${r.login}`,type:"network_walker",username:r.login}}if(o<.95){if(Math.random()<.5){const e=a.communityTargets[Math.floor(Math.random()*a.communityTargets.length)];return{name:"Discovery: Community Scan",description:`org:${e}`,type:"community_scan",target:e}}return this.getBioSignalStrategy()}if(e.length>0){const r=e[Math.floor(Math.random()*e.length)];return{name:"Discovery: Stargazer Leap",description:`user:${r.login}`,type:"stargazer",username:r.login}}return this.getBioSignalStrategy()}getBioSignalStrategy(){const e=["stars","forks","updated"],r=e[Math.floor(Math.random()*e.length)],t=Math.random()<.5?"desc":"asc";return{name:"Discovery: Bio Signals",description:`topic search (sort:${r}-${t})`,type:"search",sort:r,order:t,query:"women-in-tech+OR+pyladies+OR+django-girls+OR+rails-girls"}}getRandomDateRange(){const e=Math.floor(11*Math.random())+2015,r=Math.floor(12*Math.random())+1,t=Math.floor(20*Math.random())+1,o=new Date(e,r-1,t),a=new Date(e,r-1,t+7),i=e=>e.toISOString().split("T")[0];return`${i(o)}..${i(a)}`}async runCommunityScan(e,r){if(t.rateLimit.core.remaining<50)return void this.logRateLimit("Skipping Community Scan","core");console.log(`[Spider] ðŸ‘©â€ðŸ’» Scanning Community Cluster: ${e}`);const{newCandidates:o,existingLogins:a,blocklist:i}=r;try{console.log(`[Spider] Fetching members for ${e}...`);let n=[];try{n=await t.rest(`orgs/${e}/public_members?per_page=100`)}catch(t){if(t.message.includes("404"))return console.warn(`[Spider] ${e} is not an Org. Trying as User...`),void await this.runStargazer(e,r);throw t}if(Array.isArray(n)){for(const e of n){const r=e.login,t=r.toLowerCase();i.has(t)||a.has(t)||o.add(r)}console.log(`[Spider] Found ${n.length} members.`)}console.log(`[Spider] Fetching top repos for ${e}...`);const s=await t.rest(`orgs/${e}/repos?sort=updated&per_page=5`);Array.isArray(s)&&s.length>0&&await this.processRepositories(s,r),await this.saveCheckpoint(r)}catch(r){console.error(`[Spider] Community Scan failed for ${e}: ${r.message}`)}}async runSearch(e,o,a="stars",i="desc"){console.log(`[Spider] Search Query: ${e} (Sort: ${a} ${i})`);for(let n=1;n<=3;n++){if(t.rateLimit.search.remaining<2){this.logRateLimit("Stopping search","search");break}console.log(`[Spider] Fetching page ${n}...`);const s=await t.rest(`search/repositories?q=${e}&sort=${a}&order=${i}&per_page=${r.github.perPage}&page=${n}`);if(!s||!s.items||0===s.items.length){console.log("[Spider] No more results.");break}await this.processRepositories(s.items,o),await this.saveCheckpoint(o)}}async runNetworkWalker(e,r){if(t.rateLimit.core.remaining<50)return void this.logRateLimit("Skipping Network Walker run","core");console.log(`[Spider] ðŸ•¸ï¸ Walking network of ${e}...`);const{newCandidates:o,existingLogins:a,blocklist:i}=r;try{const n=await t.rest(`users/${e}/following?per_page=100`);if(Array.isArray(n)){for(const e of n){if("User"!==e.type)continue;const r=e.login,t=r.toLowerCase();i.has(t)||a.has(t)||o.add(r)}console.log(`[Spider] Found ${n.length} following, ${o.size} new candidates.`)}await this.saveCheckpoint(r)}catch(r){console.error(`[Spider] Network Walker failed for ${e}: ${r.message}`)}}async runStargazer(e,o){if(t.rateLimit.core.remaining<50)return void this.logRateLimit("Skipping Stargazer run","core");console.log(`[Spider] Fetching starred repos for ${e}...`);const a=await t.rest(`users/${e}/starred?per_page=${r.github.perPage}`);a&&0!==a.length?(await this.processRepositories(a,o),await this.saveCheckpoint(o)):console.log("[Spider] User has no starred repos.")}async processRepositories(e,r){const{visited:o,newVisited:a,blocklist:i,existingLogins:n,newCandidates:s}=r;console.log(`[Spider] Processing ${e.length} repositories...`);for(const r of e){if(t.rateLimit.core.remaining<50){this.logRateLimit("Stopping repo processing","core");break}const e=`repo:${r.full_name}`;if(o.has(e))continue;a.add(e),process.stdout.write(`  Scanning ${r.full_name}... `);const c=await this.fetchContributors(r.full_name);let l=0;for(const e of c){const r=e.toLowerCase();i.has(r)||(e.includes("[bot]")||n.has(r)||s.has(e)||(s.add(e),l++))}console.log(`Found ${c.length} contributors, ${l} new.`)}}async saveCheckpoint(e){const{newCandidates:r,newVisited:a,visited:i}=e;if(r.size>0){console.log(`[Spider] Checkpoint: Discovered ${r.size} new candidates. (API Quota: ${t.rateLimit.core.remaining})`);const a=Array.from(r).map(e=>({login:e,lastUpdate:null}));await o.updateTracker(a),e.totalFound=(e.totalFound||0)+r.size,r.clear()}a.size>0&&(await o.updateVisited(a),a.forEach(e=>i.add(e)),a.clear())}logRateLimit(e,r="core"){const{remaining:o,reset:a}=t.rateLimit[r],i=Math.floor(Date.now()/1e3);let n="";if(a){n=` Recovers in ~${Math.ceil((a-i)/60)} minutes.`}console.warn(`[Spider] RATE LIMIT CRITICAL (${r}): ${o}. ${e}.${n}`)}async fetchContributors(e){try{const r=10,o=await t.rest(`repos/${e}/contributors?per_page=${r}`);return Array.isArray(o)?o.filter(e=>"User"===e.type).map(e=>e.login):[]}catch(r){return(r.message.includes("403")||r.message.includes("rate limit"))&&(console.warn(`[Spider] ðŸš¨ Rate limit hit scanning ${e}. Forcing shutdown.`),t.rateLimit.core.remaining=0),console.error(`[Spider] Failed to fetch contributors for ${e}: ${r.message}`),[]}}}export default Neo.setupClass(a);