import e from"../../../src/core/Base.mjs";import t from"./config.mjs";import s from"./GitHub.mjs";import o from"./Storage.mjs";export default Neo.setupClass(class extends e{static config={className:"DevIndex.services.OptOut",singleton:!0,optOutRepoOwner:"neomjs",optOutRepoName:"devindex-opt-out"};async run(){console.log("[OptOut] Checking for new opt-out requests...");const e=(await o.getOptOutSync()).lastCheck;let t=e,n=!0,r=null,u=[],a=[];for(;n;){const o="\n                query($owner: String!, $name: String!, $cursor: String) {\n                    repository(owner: $owner, name: $name) {\n                        stargazers(first: 100, orderBy: {field: STARRED_AT, direction: DESC}, after: $cursor) {\n                            pageInfo {\n                                hasNextPage\n                                endCursor\n                            }\n                            edges {\n                                starredAt\n                                node {\n                                    login\n                                }\n                            }\n                        }\n                    }\n                }",a={owner:this.optOutRepoOwner,name:this.optOutRepoName,cursor:r};let i;try{i=await s.query(o,a,3,"OptOut Stars")}catch(e){if(e.message.includes("NOT_FOUND")||e.message.includes("Could not resolve"))return void console.warn(`[OptOut] Opt-out repository ${this.optOutRepoOwner}/${this.optOutRepoName} not found. Skipping.`);throw e}const c=i?.repository?.stargazers;if(!c)break;const d=c.edges||[];let p=!1;for(const s of d){const o=s.starredAt,n=s.node.login;if(e&&o<=e){p=!0;break}(!t||o>t)&&(t=o),u.push(n)}if(p)break;n=c.pageInfo.hasNextPage,r=c.pageInfo.endCursor}const i=await this.processIssues();i&&(u.push(...i.optedOutLogins),a.push(...i.issuesToClose));const c=[...new Set(u)];if(c.length>0){console.log(`[OptOut] Found ${c.length} new opt-out requests.`),await o.addToBlocklist(c),await o.deleteUsers(c);const e=c.map(e=>({login:e,delete:!0}));await o.updateTracker(e),await o.updateFailed(c,!1),await o.saveOptOutSync({lastCheck:t}),console.log(`[OptOut] Processed opt-outs and updated sync state to ${t}.`)}else 0===u.length&&console.log("[OptOut] No new opt-out requests found.");a.length>0&&await this.closeIssues(a)}async processIssues(){console.log("[OptOut] Checking for new opt-out issue requests...");let e=!0,t=null,o=[],n=[];for(;e;){const r='\n                query($owner: String!, $name: String!, $cursor: String) {\n                    repository(owner: $owner, name: $name) {\n                        issues(first: 100, states: OPEN, labels: ["devindex-opt-out"], after: $cursor) {\n                            pageInfo {\n                                hasNextPage\n                                endCursor\n                            }\n                            nodes {\n                                id\n                                number\n                                author {\n                                    login\n                                }\n                            }\n                        }\n                    }\n                }',u={owner:this.optOutRepoOwner,name:this.optOutRepoName,cursor:t};let a;try{a=await s.query(r,u,3,"OptOut Issues")}catch(e){if(e.message.includes("NOT_FOUND")||e.message.includes("Could not resolve"))return null;throw e}const i=a?.repository?.issues;if(!i)break;const c=i.nodes||[];for(const e of c)e.author&&e.author.login&&(o.push(e.author.login),n.push(e.id));e=i.pageInfo.hasNextPage,t=i.pageInfo.endCursor}return{optedOutLogins:o,issuesToClose:n}}async closeIssues(e){for(const t of e)try{const e="\n                    mutation($subjectId: ID!, $body: String!) {\n                        addComment(input: {subjectId: $subjectId, body: $body}) {\n                            clientMutationId\n                        }\n                    }";await s.query(e,{subjectId:t,body:"Your opt-out request has been processed. You have been removed from the active DevIndex databases and added to the blocklist.\n\nIf you wish to be re-indexed in the future, you may submit an Opt-In request.\n\n*This issue has been automatically closed.*"},3,`OptOut Comment ${t}`);const o="\n                    mutation($issueId: ID!) {\n                        closeIssue(input: {issueId: $issueId}) {\n                            clientMutationId\n                        }\n                    }";await s.query(o,{issueId:t},3,`OptOut Close ${t}`),console.log(`[OptOut] Closed issue ${t}`)}catch(e){console.error(`[OptOut] Failed to close issue ${t}:`,e.message)}}});