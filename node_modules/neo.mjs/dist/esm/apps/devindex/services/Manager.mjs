import{Command as e}from"commander";import a from"inquirer";import t from"../../../src/core/Base.mjs";import r from"./config.mjs";import s from"./Storage.mjs";import n from"./Updater.mjs";import i from"./Spider.mjs";import o from"./Cleanup.mjs";import c from"./OptOut.mjs";import m from"./OptIn.mjs";export default Neo.setupClass(class extends t{static config={className:"DevIndex.services.Manager",singleton:!0};async initAsync(){await super.initAsync();const t=new e;t.name("devindex-cli").description("DevIndex Backend Services CLI").version("1.0.0"),t.command("update").description("Update existing users with stale data").option("-l, --limit <number>","Number of users to update",e=>parseInt(e,10),r.spider.batchSize).action(async e=>{console.log("[Manager] Options:",e),await o.run(),await this.runUpdate(e.limit)}),t.command("add [username]").description("Add or update a specific user").action(async e=>{if(!e){e=(await a.prompt([{type:"input",name:"username",message:"Enter GitHub username to add:",validate:e=>""!==e.trim()||"Username is required"}])).username}await this.runAdd(e)}),t.command("spider").description("Run the discovery spider to find new users").option("-s, --strategy <type>","Force specific strategy (random, community, keyword, temporal, stargazer, search)").action(async e=>{let t=e.strategy;if(!t){t=(await a.prompt([{type:"select",name:"strategy",message:"Select Discovery Strategy:",choices:[{name:"ðŸŽ² Random (Default)",value:null},{name:"ðŸ•¸ï¸ Network Walker (Social Graph)",value:"network_walker"},{name:"ðŸ‘©â€ðŸ’» Community Scan (Diversity)",value:"community"},{name:"ðŸ”‘ Keyword Search",value:"keyword"},{name:"â³ Temporal Slicing",value:"temporal"},{name:"ðŸŒŸ Stargazer Leap",value:"stargazer"},{name:"ðŸ” Core High Stars",value:"search"}]}])).strategy}await o.run(),await i.run(t)}),t.command("cleanup").description("Run data hygiene checks (purge, sort, filter)").action(async()=>{await o.run()}),t.command("optout").description("Process star-based opt-outs").action(async()=>{await c.run()}),t.command("optin").description("Process star-based opt-ins").action(async()=>{await m.run()}),await s.ready(),await t.parseAsync(process.argv)}async runUpdate(e){console.log(`[Manager] Running Update Mode (Limit: ${e})...`);const a=await s.getTracker(),t=(new Date).toISOString().split("T")[0],r=a.filter(e=>!e.lastUpdate||!e.lastUpdate.startsWith(t)),i=r.length;if(console.log(`[Manager] Backlog size: ${i} users (pending update today).`),0===i)return void console.log("[Manager] All users are up to date.");const o=r.sort((e,a)=>e.lastUpdate?a.lastUpdate?e.lastUpdate.localeCompare(a.lastUpdate):1:-1).slice(0,e).map(e=>e.login);await n.processBatch(o,i)}async runAdd(e){console.log(`[Manager] Adding/Updating user: ${e}`),await n.processBatch([e])}});