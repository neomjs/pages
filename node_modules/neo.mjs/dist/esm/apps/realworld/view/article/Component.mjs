import t from"../../../../src/component/Base.mjs";import e from"./CreateCommentComponent.mjs";import o from"../../../../src/util/Array.mjs";import n from"../../../../src/util/VDom.mjs";export default Neo.setupClass(class extends t{static config={className:"RealWorld.view.article.Component",author_:null,baseCls:["article-page"],body_:null,commentComponent:null,commentComponents:[],comments_:null,createCommentComponent:null,createdAt_:null,favorited_:!1,favoritesCount_:null,tagList_:null,title_:null,_vdom:{cn:[{cls:["banner"],cn:[{cls:["container"],cn:[{tag:"h1",flag:"title"},{cls:["article-meta"],cn:[{tag:"a",flag:"userimage",cn:[{tag:"img"}]},{cls:["info"],cn:[{tag:"a",cls:["author"],flag:"username"},{tag:"span",cls:["date"],flag:"createdAt"}]},{tag:"button",cls:["btn","btn-sm","btn-outline-secondary","follow-button"],cn:[{tag:"i",flag:"followIcon"},{vtype:"text",flag:"followAuthor"},{vtype:"text",flag:"username"}]},{tag:"button",cls:["btn","btn-sm","btn-outline-secondary","edit-button"],flag:"edit-button",removeDom:!0,cn:[{tag:"i",cls:["ion-edit"]},{vtype:"text",text:" Edit Article"}]},{vtype:"text",html:"&nbsp;&nbsp;"},{tag:"button",cls:["btn","btn-sm","btn-outline-primary","favorite-button"],flag:"favorited",cn:[{tag:"i",cls:["ion-heart"]},{vtype:"text",html:"&nbsp;"},{vtype:"text"},{vtype:"text",text:" Post "},{tag:"span",cls:["counter"],flag:"favoritesCount"}]},{tag:"button",cls:["btn","btn-sm","btn-outline-danger","delete-button"],flag:"delete-button",removeDom:!0,cn:[{tag:"i",cls:["ion-trash-a"]},{vtype:"text",text:" Delete Article"}]}]}]}]},{cls:["container","page"],cn:[{cls:["row","article-content"],cn:[{cls:["col-md-12"],flag:"body",cn:[]}]},{tag:"hr"},{cls:["article-actions"],flag:"article-actions",cn:[{cls:["article-meta"],cn:[{tag:"a",flag:"userimage",cn:[{tag:"img"}]},{cls:["info"],cn:[{tag:"a",cls:["author"],flag:"username"},{tag:"span",cls:["date"],text:"January 20th"}]},{tag:"button",cls:["btn","btn-sm","btn-outline-secondary","follow-button"],cn:[{tag:"i",flag:"followIcon"},{vtype:"text",flag:"followAuthor"},{vtype:"text",flag:"username"}]},{vtype:"text",html:"&nbsp;&nbsp;"},{tag:"button",cls:["btn","btn-sm","btn-outline-primary","favorite-button"],flag:"favorited",cn:[{tag:"i",cls:["ion-heart"]},{vtype:"text",html:"&nbsp;"},{vtype:"text"},{vtype:"text",text:" Post "},{tag:"span",cls:["counter"],flag:"favoritesCount"}]}]}]},{cls:"row",cn:[{cls:["col-xs-12","col-md-8","offset-md-2"],flag:"comments-section",cn:[]}]}]}]}};construct(t){super.construct(t);let e=this;e.addDomListeners([{click:{fn:e.onDeleteButtonClick,delegate:".delete-button",scope:e}},{click:{fn:e.onEditButtonClick,delegate:".edit-button",scope:e}},{click:{fn:e.onFavoriteButtonClick,delegate:".favorite-button",scope:e}},{click:{fn:e.onFollowButtonClick,delegate:".follow-button",scope:e}}]),e.getController().on({afterSetCurrentUser:e.onCurrentUserChange,scope:e})}onConstructed(){let t=this,o=t.getController().currentUser;t.createCommentComponent=Neo.create({module:e,parentId:t.id,userImage:o?.image||null}),n.getByFlag(t.vdom,"comments-section").cn.unshift(t.createCommentComponent.vdom),t.update(),super.onConstructed()}afterSetAuthor(t,e){if(t){let e=this,o=e.vdom;n.getFlags(o,"followAuthor").forEach(e=>{e.text=t.following?" Unfollow ":" Follow "}),n.getFlags(o,"followIcon").forEach(e=>{e.cls=t.following?["ion-minus-round"]:["ion-plus-round"]}),n.getFlags(o,"userimage").forEach(e=>{e.href="#/profile/"+t.username,e.cn[0].src=t.image}),n.getFlags(o,"username").forEach(e=>{e.href="#/profile/"+t.username,e.text=t.username}),e.update(),e.onCurrentUserChange()}}afterSetBody(t,e){t&&Neo.main.addon.Markdown.markdownToHtml(t).then(t=>{n.getByFlag(this.vdom,"body").cn[0]={cn:[{tag:"p",html:t}]},this.update()})}async afterSetComments(t,e){if(Array.isArray(t)){let e,o,a=this,l=n.getByFlag(a.vdom,"comments-section");a.commentComponent||(o=await import("./CommentComponent.mjs"),a.commentComponent=o.default),l.cn=[l.cn.shift()],t.forEach((t,o)=>{e={author:t.author,body:t.body,commentId:t.id,createdAt:t.createdAt,updatedAt:t.updatedAt},a.commentComponents[o]?a.commentComponents[o].set(e,!0):a.commentComponents[o]=Neo.create({module:a.commentComponent,parentId:a.id,...e}),l.cn.push(a.commentComponents[o].vdom)}),a.update()}}afterSetCreatedAt(t,e){t&&(n.getByFlag(this.vdom,"createdAt").text=new Intl.DateTimeFormat("en-US",{day:"numeric",month:"long",year:"numeric"}).format(new Date(t)),this.update())}afterSetFavorited(t,e){let a=this;n.getFlags(a.vdom,"favorited").forEach(e=>{e.cn[2].text=t?"Unfavorite":"Favorite",o.add(e.cls,t?"btn-primary":"btn-outline-primary"),o.remove(e.cls,t?"btn-outline-primary":"btn-primary")}),a.update(),Neo.isBoolean(e)&&a.getController().favoriteArticle(a.slug,t).then(t=>{a.favoritesCount=t.json.article.favoritesCount})}afterSetFavoritesCount(t,e){Neo.isNumber(t)&&(n.getFlags(this.vdom,"favoritesCount").forEach(e=>{e.text=`(${t})`}),this.update())}afterSetTagList(t,e){let o,a=n.getByFlag(this.vdom,"body");Array.isArray(t)&&t.length>0?(o={tag:"ul",cls:["tag-list"],cn:[]},t.forEach(t=>{o.cn.push({tag:"li",cls:["tag-default","tag-pill","tag-outline"],text:t})}),a.cn[1]=o):a.cn[1]&&(a.cn[1].removeDom=!0),this.update()}afterSetTitle(t,e){n.getByFlag(this.vdom,"title").text=t,this.update()}onCurrentUserChange(){console.log("### onCurrentUserChange");let t,e=this,o=e.getController().currentUser,a=e.vdom;e.author&&o&&(t=e.author.username===o.username,a.cn[0].cn[0].cn[1].cn[2].removeDom=t,a.cn[0].cn[0].cn[1].cn[5].removeDom=t,n.getByFlag(a,"article-actions").removeDom=t,n.getByFlag(a,"delete-button").removeDom=!t,n.getByFlag(a,"edit-button").removeDom=!t,e.update())}onDeleteButtonClick(t){this.getController().deleteArticle(this.slug)}onEditButtonClick(t){Neo.Main.setRoute({value:"/editor/"+this.slug})}onFavoriteButtonClick(t){this.favorited=!this.favorited}onFollowButtonClick(t){let e=this;e.getController().followUser(e.author.username,!e.author.following).then(t=>{e.author=t.json.profile})}});