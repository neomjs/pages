import e from"../api/Article.mjs";import t from"../../../src/controller/Component.mjs";import o from"../api/Favorite.mjs";import{LOCAL_STORAGE_KEY as n}from"../api/config.mjs";import r from"../api/Profile.mjs";import s from"../api/Tag.mjs";import i from"../api/User.mjs";export default Neo.setupClass(class extends t{static observable=!0;static config={className:"RealWorld.view.MainContainerController",articleComponent:null,articlesOffset_:0,createComponent:null,currentUser_:null,hashString:null,homeComponent:null,profileComponent:null,settingsComponent:null,signUpComponent:null};afterSetArticlesOffset(e,t){Neo.isNumber(t)&&this.getArticles()}afterSetCurrentUser(e,t){if("object"==typeof t){let t=this;t.getReference("header").set({loggedIn:!!e,userImage:e?e.image:null,userName:e?e.username:null}).then(()=>{t.timeout(200).then(()=>{t.fire("afterSetCurrentUser",e)})})}}deleteArticle(t){e.delete({slug:t}).then(e=>{Neo.Main.setRoute({value:"/"})})}deleteComment(t){let o=this,n=o.hashString.split("/").pop();return e.deleteComment(n,t).then(e=>{o.getComments(n)})}favoriteArticle(e,t){return o[t?"add":"remove"](e)}followUser(e,t){return r[t?"follow":"unfollow"](e)}getArticle(t){return e.get({slug:t})}getArticles(t={},o={}){return e.get({params:{limit:10,offset:this.articlesOffset,...t},...o})}getComments(t){e.getComments(t).then(e=>{this.articleComponent.comments=e.json.comments})}getCurrentUser(e){e&&i.get({resource:"/user"}).then(e=>{this.currentUser=e.json.user})}getProfile(e){let t=this;r.get({slug:e}).then(e=>{t.profileComponent.updateContent({...e.json.profile,myProfile:e.json.profile.username===t.currentUser?.username})})}getTags(){s.get().then(e=>{this.homeComponent.tagList.tags=e.json.tags})}login(e){this.currentUser=e,Neo.main.addon.LocalStorage.createLocalStorageItem({key:n,value:e.token}).then(()=>{this.timeout(50).then(()=>{Neo.Main.setRoute({value:"/"})})})}logout(){this.currentUser=null,Neo.main.addon.LocalStorage.destroyLocalStorageItem({key:n}).then(()=>{this.timeout(50).then(()=>{Neo.Main.setRoute({value:"/"})})})}onComponentConstructed(){super.onComponentConstructed(),Neo.config.hash||this.onHashChange({appNames:["RealWorld"],hash:{"/":""},hashString:"/"},null)}onConstructed(){super.onConstructed(),i.on("ready",this.getCurrentUser,this)}async onHashChange(e,t){let o,n,r,s,i=this,a=i.component,m=e.hash,l=e.hashString;if(a.isConstructed)switch(i.hashString=l,a.items[0].activeItem=Object.keys(m)[0],"/"===l?r=["homeComponent",()=>import("./HomeComponent.mjs"),"home"]:l.includes("/article/")?r=["articleComponent",()=>import("./article/Component.mjs"),"article"]:l.includes("/editor")?r=["createComponent",()=>import("./article/CreateComponent.mjs"),"editor"]:l.includes("/profile/")?r=["profileComponent",()=>import("./user/ProfileComponent.mjs"),"profile"]:m.hasOwnProperty("/login")?(r=["signUpComponent",()=>import("./user/SignUpComponent.mjs"),"signup"],o="signin"):m.hasOwnProperty("/register")?(r=["signUpComponent",()=>import("./user/SignUpComponent.mjs"),"signup"],o="signup"):m.hasOwnProperty("/settings")&&(r=["settingsComponent",()=>import("./user/SettingsComponent.mjs"),"settings"]),r&&(n=await i.promiseView(...r),o&&(n.mode=o)),t&&t.hash&&(t.hash.hasOwnProperty("/login")&&m.hasOwnProperty("/register")||t.hash.hasOwnProperty("/register")&&m.hasOwnProperty("/login"))||(a.items.length>2&&a.removeAt(1,!1,!0),n&&a.insert(1,n)),n.reference){case"article":s=l.split("/").pop(),i.getArticle(s).then(e=>{let t=e.json.article,o=t.body;delete t.body,i.articleComponent.set(t).then(()=>{i.articleComponent.body=o})}),i.getComments(s);break;case"editor":s=l.split("/").pop(),"editor"!==s?i.getArticle(s).then(e=>{const t=e.json.article;i.createComponent.set({body:t.body,description:t.description,slug:t.slug,tagList:t.tagList,title:t.title})}):i.createComponent.resetForm();break;case"home":i.homeComponent.loggedIn=!!i.currentUser,i.homeComponent.getArticles(),i.getTags();break;case"profile":i.getProfile(l.split("/").pop());break;case"settings":i.currentUser&&i.timeout(50).then(()=>{i.settingsComponent.onCurrentUserChange(i.currentUser)});break;case"signup":n.errors=[]}else a.on("constructed",()=>{i.onHashChange(e,t)})}postComment(t={}){let o=this,n=o.hashString.split("/").pop();return e.postComment(n,t).then(e=>{o.getComments(n)})}async promiseView(e,t,o){let n=this;return n[e]||(t=await t(),n[e]=Neo.create({module:t.default,parentId:n.component.id,reference:o})),n[e]}saveUser(e){return i.post(e)}updateSettings(e={}){return i.put({...e,resource:"/user"}).then(e=>(e.json.errors||(this.currentUser=e.json.user),e))}});