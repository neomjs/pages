import e from"../../shared/content/Component.mjs";import{marked as t}from"../../../../../node_modules/marked/lib/marked.esm.js";const a=/^---\n([\s\S]*?)\n---\n/,i=/(<h1[^>]*>.*?<\/h1>)/,n=/(\d{4,})/,l=/## Timeline\s*\n([\s\S]*)/,s=/^- ([\dTZ:.-]+) @(\w+) (.*)$/,r=/\b([0-9a-f]{7,40})\b/g;export default Neo.setupClass(class extends e{static config={className:"Portal.view.news.tickets.Component",cls:["portal-news-tickets-component"],commitsUrl:"https://github.com/neomjs/neo/commit/",domListeners:{resize:"onResize"},repoUserUrl:"https://github.com/",updateSectionsStore:!1};#e=null;#t=null;timelineData=null;construct(e){super.construct(e),this.getStateProvider().setData("contentComponentId",this.id)}formatTimestamp(e){if(!e)return"";let t=this,a=new Date(e),i=new Date;return a.toDateString()===i.toDateString()?(t.#t||(t.#t=new Intl.DateTimeFormat("default",{hour:"numeric",minute:"numeric"})),t.#t.format(a)):(t.#e||(t.#e=new Intl.DateTimeFormat("default",{day:"numeric",hour:"numeric",minute:"numeric",month:"short",year:"numeric"})),t.#e.format(a))}frontMatterToHtml(e){let t=this,a='<table class="neo-frontmatter-table"><tbody>';return Object.entries(e).forEach(([e,i])=>{let l;l="subIssues"===e&&Array.isArray(i)?i.map(e=>`<div class="neo-sub-issue">${e.replace(n,'<a href="#/news/tickets/$1">$1</a>').replace("[x]",'<i class="fa-solid fa-circle-check"></i>').replace("[ ]",'<i class="fa-regular fa-circle"></i>')}</div>`).join(""):"author"===e?`<a href="${t.repoUserUrl}${i}" target="_blank">${i}</a>`:"createdAt"===e||"closedAt"===e||"updatedAt"===e?t.formatTimestamp(i):"labels"===e&&Array.isArray(i)?t.getBadgesHtml(i):"state"===e?t.getStateBadgeHtml(i):t.formatFrontMatterValue(i),a+=`<tr><td>${e}</td><td>${l}</td></tr>`}),a+="</tbody></table>",t.useFrontmatterDetails?`<details id="neo-ticket-summary-details-${t.id}"><summary>Frontmatter</summary>${a}</details>`:a}getBadgesHtml(e){if(!e||0===e.length)return"";let t=this,a='<div class="neo-ticket-labels">';return e.forEach(e=>{a+=t.getLabelBadgeHtml(e)}),a+="</div>",a}async doFetchContent(e){let t,a,i,n=this,{windowId:l}=n;i=n.getContentPath(e),e.isLeaf&&i&&(a=await fetch(i),t=await a.text(),n.value=t,n.toggleCls("lab",e.name?.startsWith("Lab:")),Neo.main.addon.IntersectionObserver.observe({disconnect:!0,id:n.id,observe:[".neo-timeline-item[data-record-id]"],windowId:l}))}getContentPath({path:e}){return e?Neo.config.basePath+e:null}getLabelBadgeHtml(e){let t=this.getStateProvider().getStore("labels").get(e);return t?`<span class="neo-badge" style="background-color:${t.color};color:${t.textColor}">${e}</span>`:`<span class="neo-badge">${e}</span>`}getStateBadgeHtml(e){if(!e)return"";let t="neo-badge neo-state-badge",a="fa-circle-dot";return"CLOSED"===e.toUpperCase()?(t+=" neo-state-closed",a="fa-circle-check"):t+=" neo-state-open",`<span class="${t}"><i class="fa-regular ${a}"></i>${Neo.capitalize(e.toLowerCase())}</span>`}modifyMarkdown(e){let t=this,{parentId:n}=t.record,s=null,r=null,o=[],d=null,c=e.match(a),m="",g="";if(t.timelineData=[],c){let e=t.parseFrontMatter(c[1]);e.author&&(s=e.author),e.createdAt&&(r=t.formatTimestamp(e.createdAt)),e.labels&&(o=e.labels),e.state&&(d=e.state)}let u=e.match(l);u&&(m=t.renderTimeline(u[1]),e=e.replace(l,""));let p="";if(c){let i=t.parseFrontMatter(c[1]);p=t.frontMatterToHtml(i),e=e.replace(a,"")}let $=super.modifyMarkdown(e),f="";if($=$.replace(i,e=>(f=e.replace("<h1",`<h1 id="ticket-title-${t.id}"`),"")),o.length>0||d||n&&"Backlog"!==n){if(g='<div class="neo-ticket-labels">',d&&(g+=t.getStateBadgeHtml(d)),n&&"Backlog"!==n&&(g+=`\n                    <a class="neo-badge neo-release-badge" href="#/news/releases/${n.substring(1)}">\n                        <i class="fa-solid fa-code-branch"></i> ${n}\n                    </a>`),o.length>0){let e,a=t.getStateProvider().getStore("labels");o.forEach(t=>{e=a.get(t),g+=e?`<span class="neo-badge" style="background-color:${e.color};color:${e.textColor}">${t}</span>`:`<span class="neo-badge">${t}</span>`})}g+="</div>",f+=g}let h=`timeline-${t.record.id}-0`;t.timelineData.unshift({id:h,image:t.repoUserUrl+s+".png",name:"Description",tag:"body"});let b=`\n            <div id="${h}" class="neo-timeline-item comment body-item" data-record-id="${h}">\n                <div id="${h}-target" class="neo-timeline-avatar">\n                    <img src="${t.repoUserUrl}${s}.png" alt="${s}">\n                </div>\n                <div class="neo-timeline-content">\n                    <div class="neo-timeline-header">\n                        <a class="neo-timeline-user" href="${t.repoUserUrl}${s}" target="_blank">${s}</a>\n                        <span class="neo-timeline-date">commented on ${r}</span>\n                    </div>\n                    <div class="neo-timeline-body">${$}</div>\n                </div>\n            </div>`,v=`ticket-timeline-${t.id}`;return m=m?m.replace('<div class="neo-ticket-timeline">',`<div id="${v}" class="neo-ticket-timeline">`+b):`<div id="${v}" class="neo-ticket-timeline">${b}</div>`,t.getStateProvider().getStore("sections").data=t.timelineData,t.timelineData=null,p+f+m}onResize(e){this.fire("toggleSummary")}renderTimeline(e){let a,i,n,l,o,d=this,{commitsUrl:c,repoUserUrl:m}=d,g='<div class="neo-ticket-timeline">',u=e.split("\n"),p=[],$=null,f=null,h=0,b=u.length;const v=()=>{if(p.length>0){a=`timeline-${d.record.id}-${d.timelineData.length+1}`,d.timelineData.push({id:a,image:m+$+".png",name:`Comment (${$})`,tag:"comment"});let e=t.parse(p.join("\n"));g+=`\n                    <div id="${a}" class="neo-timeline-item comment" data-record-id="${a}">\n                        <div id="${a}-target" class="neo-timeline-avatar">\n                            <img src="${m}${$}.png" alt="${$}">\n                        </div>\n                        <div class="neo-timeline-content">\n                            <div class="neo-timeline-header">\n                                <a class="neo-timeline-user" href="${m}${$}" target="_blank">${$}</a>\n                                <span class="neo-timeline-date">${d.formatTimestamp(f)}</span>\n                            </div>\n                            <div class="neo-timeline-body">${e}</div>\n                        </div>\n                    </div>`,p=[],$=null,f=null}};for(;h<b;h++)if(i=u[h],n=i.match(s)){v();let[e,i,s,u]=n;l="fa-circle-dot",o="";const p=[{key:"added the `",icon:"fa-tag"},{key:"removed the `",icon:"fa-tag"},{key:"assigned",icon:"fa-user-pen"},{key:"closed",icon:"fa-circle-check",color:"#8250df"},{key:"reopened",icon:"fa-circle-dot",color:"#2da44e"},{key:"referenced",icon:"fa-link"},{key:"cross-referenced",icon:"fa-link"},{key:"milestoned",icon:"fa-sign-post"},{key:"sub-issue",icon:"fa-diagram-project"}].find(e=>u.includes(e.key));let $=null;p&&(l=p.icon,p.color&&($=p.color));let f=t.parseInline(u);if("fa-tag"===l){f=f.replace(/<code>(.*?)<\/code>/g,(e,t)=>d.getLabelBadgeHtml(t));let e=u.match(/`([^`]+)`/);if(e){let t=e[1],a=d.getStateProvider().getStore("labels").get(t);a&&($=a.color)}}f=f.replace(r,`<a href="${c}$1" target="_blank">$1</a>`),a=`timeline-${d.record.id}-${d.timelineData.length+1}`;let h,b=u.split(" ")[0];if("added"===b||"removed"===b)if(u.includes("sub-issue")){let e=u.match(/#(\d+)/);h=e?`${Neo.capitalize(b)} sub-issue #${e[1]}`:`${Neo.capitalize(b)} sub-issue`}else{let e=u.match(/`([^`]+)`/);b=e?e[1]:"Label",h=`${Neo.capitalize(b)} (${s})`}else h=`${Neo.capitalize(b)} (${s})`;d.timelineData.push({color:$,icon:l,id:a,name:h,tag:"event"}),g+=`\n                    <div id="${a}" class="neo-timeline-item event" data-record-id="${a}">\n                        <div id="${a}-target" class="neo-timeline-badge" ${$?`style="color: ${$}"`:""}><i class="fa-solid ${l}"></i></div>\n                        <div class="neo-timeline-body">\n                            <a class="neo-timeline-user" href="${m}${s}" target="_blank">${s}</a> ${f} <span class="neo-timeline-date">on ${d.formatTimestamp(i)}</span>\n                        </div>\n                    </div>`}else if(i.startsWith("### @")){let e=i.match(/^### @(\w+) - ([\dTZ:.-]+)$/);e?(v(),$=e[1],f=e[2]):$&&p.push(i)}else $&&p.push(i);return v(),g+="</div>",g}});