import e from"../../shared/content/Component.mjs";import{marked as t}from"../../../../../node_modules/marked/lib/marked.esm.js";const a=/^---\n([\s\S]*?)\n---\n/,i=/(<h1[^>]*>.*?<\/h1>)/,n=/(\d{4,})/,l=/## Timeline\s*\n([\s\S]*)/,r=/^- ([\dTZ:.-]+) @(\w+) (.*)$/,o=/\b([0-9a-f]{7,40})\b/g;export default Neo.setupClass(class extends e{static config={className:"Portal.view.news.tickets.Component",cls:["portal-news-tickets-component"],commitsUrl:"https://github.com/neomjs/neo/commit/",repoUserUrl:"https://github.com/",updateSectionsStore:!1};#e=null;#t=null;timelineData=null;construct(e){super.construct(e),this.getStateProvider().setData("contentComponentId",this.id)}formatTimestamp(e){if(!e)return"";let t=this,a=new Date(e),i=new Date;return a.toDateString()===i.toDateString()?(t.#t||(t.#t=new Intl.DateTimeFormat("default",{hour:"numeric",minute:"numeric"})),t.#t.format(a)):(t.#e||(t.#e=new Intl.DateTimeFormat("default",{day:"numeric",hour:"numeric",minute:"numeric",month:"short",year:"numeric"})),t.#e.format(a))}frontMatterToHtml(e){let t=this,a='<table class="neo-frontmatter-table"><tbody>';return Object.entries(e).forEach(([e,i])=>{let l;l="subIssues"===e&&Array.isArray(i)?i.map(e=>`<div class="neo-sub-issue">${e.replace(n,'<a href="#/news/tickets/$1">$1</a>').replace("[x]",'<i class="fa-solid fa-circle-check"></i>').replace("[ ]",'<i class="fa-regular fa-circle"></i>')}</div>`).join(""):"author"===e?`<a href="${t.repoUserUrl}${i}" target="_blank">${i}</a>`:"createdAt"===e||"closedAt"===e||"updatedAt"===e?t.formatTimestamp(i):"labels"===e&&Array.isArray(i)?t.getBadgesHtml(i):"state"===e?t.getStateBadgeHtml(i):t.formatFrontMatterValue(i),a+=`<tr><td>${e}</td><td>${l}</td></tr>`}),a+="</tbody></table>",t.useFrontmatterDetails?`<details><summary>Frontmatter</summary>${a}</details>`:a}getBadgesHtml(e){if(!e||0===e.length)return"";let t=this,a='<div class="neo-ticket-labels">';return e.forEach(e=>{a+=t.getLabelBadgeHtml(e)}),a+="</div>",a}async doFetchContent(e){let t,a,i,n=this,{windowId:l}=n;i=n.getContentPath(e),e.isLeaf&&i&&(a=await fetch(i),t=await a.text(),n.value=t,n.toggleCls("lab",e.name?.startsWith("Lab:")),Neo.main.addon.IntersectionObserver.observe({disconnect:!0,id:n.id,observe:[".neo-timeline-item[data-record-id]"],windowId:l}))}getContentPath({path:e}){return e?Neo.config.basePath+e:null}getLabelBadgeHtml(e){let t=this.getStateProvider().getStore("labels").get(e);return t?`<span class="neo-badge" style="background-color:${t.color};color:${t.textColor}">${e}</span>`:`<span class="neo-badge">${e}</span>`}getStateBadgeHtml(e){if(!e)return"";let t="neo-badge neo-state-badge",a="fa-circle-dot";return"CLOSED"===e.toUpperCase()?(t+=" neo-state-closed",a="fa-circle-check"):t+=" neo-state-open",`<span class="${t}"><i class="fa-regular ${a}"></i>${Neo.capitalize(e.toLowerCase())}</span>`}modifyMarkdown(e){let t=this,{parentId:n}=t.record,r=null,o=null,s=[],d=null,c=e.match(a),m="",g="";if(t.timelineData=[],c){let e=t.parseFrontMatter(c[1]);e.author&&(r=e.author),e.createdAt&&(o=t.formatTimestamp(e.createdAt)),e.labels&&(s=e.labels),e.state&&(d=e.state)}let p=e.match(l);p&&(m=t.renderTimeline(p[1]),e=e.replace(l,""));let u="";if(c){let i=t.parseFrontMatter(c[1]);u=t.frontMatterToHtml(i),e=e.replace(a,"")}let f=super.modifyMarkdown(e),$="";if(f=f.replace(i,e=>($=e.replace("<h1",`<h1 id="ticket-title-${t.id}"`),"")),s.length>0||d||n&&"Latest"!==n){if(g='<div class="neo-ticket-labels">',d&&(g+=t.getStateBadgeHtml(d)),n&&"Latest"!==n&&(g+=`\n                    <a class="neo-badge neo-release-badge" href="#/news/releases/${n.substring(1)}">\n                        <i class="fa-solid fa-code-branch"></i> ${n}\n                    </a>`),s.length>0){let e,a=t.getStateProvider().getStore("labels");s.forEach(t=>{e=a.get(t),g+=e?`<span class="neo-badge" style="background-color:${e.color};color:${e.textColor}">${t}</span>`:`<span class="neo-badge">${t}</span>`})}g+="</div>",$+=g}let h=`timeline-${t.record.id}-0`;t.timelineData.unshift({id:h,image:t.repoUserUrl+r+".png",name:"Description",tag:"body"});let b=`\n            <div id="${h}" class="neo-timeline-item comment body-item" data-record-id="${h}">\n                <div id="${h}-target" class="neo-timeline-avatar">\n                    <img src="${t.repoUserUrl}${r}.png" alt="${r}">\n                </div>\n                <div class="neo-timeline-content">\n                    <div class="neo-timeline-header">\n                        <a class="neo-timeline-user" href="${t.repoUserUrl}${r}" target="_blank">${r}</a>\n                        <span class="neo-timeline-date">commented on ${o}</span>\n                    </div>\n                    <div class="neo-timeline-body">${f}</div>\n                </div>\n            </div>`,v=`ticket-timeline-${t.id}`;return m=m?m.replace('<div class="neo-ticket-timeline">',`<div id="${v}" class="neo-ticket-timeline">`+b):`<div id="${v}" class="neo-ticket-timeline">${b}</div>`,t.getStateProvider().getStore("sections").data=t.timelineData,t.timelineData=null,u+$+m}renderTimeline(e){let a,i,n,l,s,d=this,{commitsUrl:c,repoUserUrl:m}=d,g='<div class="neo-ticket-timeline">',p=e.split("\n"),u=[],f=null,$=null,h=0,b=p.length;const v=()=>{if(u.length>0){a=`timeline-${d.record.id}-${d.timelineData.length+1}`,d.timelineData.push({id:a,image:m+f+".png",name:`Comment (${f})`,tag:"comment"});let e=t.parse(u.join("\n"));g+=`\n                    <div id="${a}" class="neo-timeline-item comment" data-record-id="${a}">\n                        <div id="${a}-target" class="neo-timeline-avatar">\n                            <img src="${m}${f}.png" alt="${f}">\n                        </div>\n                        <div class="neo-timeline-content">\n                            <div class="neo-timeline-header">\n                                <a class="neo-timeline-user" href="${m}${f}" target="_blank">${f}</a>\n                                <span class="neo-timeline-date">${d.formatTimestamp($)}</span>\n                            </div>\n                            <div class="neo-timeline-body">${e}</div>\n                        </div>\n                    </div>`,u=[],f=null,$=null}};for(;h<b;h++)if(i=p[h],n=i.match(r)){v();let[e,i,r,p]=n;l="fa-circle-dot",s="";const u=[{key:"added the `",icon:"fa-tag"},{key:"removed the `",icon:"fa-tag"},{key:"assigned",icon:"fa-user-pen"},{key:"closed",icon:"fa-circle-check",color:"#8250df"},{key:"reopened",icon:"fa-circle-dot",color:"#2da44e"},{key:"referenced",icon:"fa-link"},{key:"cross-referenced",icon:"fa-link"},{key:"milestoned",icon:"fa-sign-post"},{key:"sub-issue",icon:"fa-diagram-project"}].find(e=>p.includes(e.key));let f=null;u&&(l=u.icon,u.color&&(f=u.color));let $=t.parseInline(p);if("fa-tag"===l){$=$.replace(/<code>(.*?)<\/code>/g,(e,t)=>d.getLabelBadgeHtml(t));let e=p.match(/`([^`]+)`/);if(e){let t=e[1],a=d.getStateProvider().getStore("labels").get(t);a&&(f=a.color)}}$=$.replace(o,`<a href="${c}$1" target="_blank">$1</a>`),a=`timeline-${d.record.id}-${d.timelineData.length+1}`;let h=p.split(" ")[0];if("added"===h||"removed"===h){let e=p.match(/`([^`]+)`/);h=e?e[1]:"Label"}d.timelineData.push({color:f,icon:l,id:a,name:`${Neo.capitalize(h)} (${r})`,tag:"event"}),g+=`\n                    <div id="${a}" class="neo-timeline-item event" data-record-id="${a}">\n                        <div id="${a}-target" class="neo-timeline-badge" ${f?`style="color: ${f}"`:""}><i class="fa-solid ${l}"></i></div>\n                        <div class="neo-timeline-body">\n                            <a class="neo-timeline-user" href="${m}${r}" target="_blank">${r}</a> ${$} <span class="neo-timeline-date">on ${d.formatTimestamp(i)}</span>\n                        </div>\n                    </div>`}else if(i.startsWith("### @")){let e=i.match(/^### @(\w+) - ([\dTZ:.-]+)$/);e?(v(),f=e[1],$=e[2]):f&&u.push(i)}else f&&u.push(i);return v(),g+="</div>",g}});