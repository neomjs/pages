import e from"../../../../../src/component/Canvas.mjs";export default Neo.setupClass(class extends e{static delayable={ensureFinalAlignment:{type:"debounce",timer:300}};static config={className:"Portal.view.news.tickets.TimelineCanvas",listeners:{resize:"onResize"},_vdom:{tag:"div",cls:["neo-ticket-timeline-wrapper"],style:{width:"100%",height:"100%"},cn:[{tag:"canvas",style:{width:"100%",height:"100%"}}]}};canvasId=null;isCanvasReady=!1;lastRecords=null;ensureFinalAlignment(){let e=this;e.lastRecords&&e.onTimelineDataLoad(e.lastRecords,!0)}async afterSetOffscreenRegistered(e,a){let t=this;if(e){await Portal.canvas.Helper.importTicketCanvas(),await Portal.canvas.TicketCanvas.initGraph({canvasId:t.getCanvasId(),windowId:t.windowId}),t.isCanvasReady=!0,Neo.main.addon.ResizeObserver.register({id:t.id,windowId:t.windowId}),await t.updateSize();let e=t.getStateProvider().getStore("sections");e.getCount()>0&&t.onTimelineDataLoad(e.items)}else a&&(t.isCanvasReady=!1,await Portal.canvas.TicketCanvas.clearGraph())}getCanvasId(){let e=this;return e.canvasId||(e.canvasId=e.vdom.cn[0].id),e.canvasId}onConstructed(){super.onConstructed();let e=this;e.getStateProvider().getStore("sections").on("load",e.onTimelineDataLoad,e)}async onResize(e){let a=this;await a.updateSize(e.contentRect),a.lastRecords&&(await a.onTimelineDataLoad(a.lastRecords,!0),a.ensureFinalAlignment())}async onTimelineDataLoad(e,a=!1){let t=this;if(e&&!Array.isArray(e)&&e.items&&(e=e.items),!Array.isArray(e))return;if(!t.isCanvasReady)return;let i=!a;i&&t.lastRecords&&e[0]?.id===t.lastRecords[0]?.id&&(i=!1),t.lastRecords=e;let s,n=e.map(e=>`${e.id}-target`);try{if(s=await t.waitForDomRect({attempts:20,delay:50,id:n}),t.lastRecords!==e)return;if(!(s&&s.some(e=>e)))return;a||await t.updateSize();let r=await t.getDomRect(t.getCanvasId()),d=[],o=0;n.forEach((a,t)=>{let i=s[t],n=e[t];if(i){let e=i.height/2,a=i.y-r.y+e,s=i.x-r.x+i.width/2,l=i.height>32?6:3;d.push({color:n.color,id:n.id,radius:e+l,y:a,x:s}),0===t&&(o=a)}}),await Portal.canvas.TicketCanvas.updateGraphData({nodes:d,reset:i,startY:o})}catch(e){console.error("TimelineCanvas update failed",e)}}async updateSize(e){let a=this;e&&0!==e.width&&0!==e.height||(e=await a.waitForDomRect({id:a.getCanvasId()})),await Portal.canvas.TicketCanvas.updateSize({width:e.width,height:e.height})}});