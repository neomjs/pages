import e from"../../../../../src/component/Canvas.mjs";export default Neo.setupClass(class extends e{static config={className:"Portal.view.news.tickets.TimelineCanvas",listeners:{resize:"onResize"},_vdom:{tag:"div",cls:["neo-ticket-timeline-wrapper"],style:{width:"100%",height:"100%"},cn:[{tag:"canvas",style:{width:"100%",height:"100%"}}]}};canvasId=null;isCanvasReady=!1;lastRecords=null;onConstructed(){super.onConstructed();let e=this;e.getStateProvider().getStore("sections").on("load",e.onTimelineDataLoad,e)}async afterSetOffscreenRegistered(e,t){let a=this;if(e){await Portal.canvas.Helper.importTicketCanvas(),await Portal.canvas.TicketCanvas.initGraph({canvasId:a.getCanvasId(),windowId:a.windowId}),a.isCanvasReady=!0,Neo.main.addon.ResizeObserver.register({id:a.id,windowId:a.windowId}),await a.updateSize();let e=a.getStateProvider().getStore("sections");e.getCount()>0&&a.onTimelineDataLoad(e.items)}else t&&(a.isCanvasReady=!1,await Portal.canvas.TicketCanvas.clearGraph())}getCanvasId(){let e=this;return e.canvasId||(e.canvasId=e.vdom.cn[0].id),e.canvasId}async onResize(e){let t=this;await t.updateSize(e.contentRect),t.lastRecords&&t.onTimelineDataLoad(t.lastRecords,!0)}async onTimelineDataLoad(e,t=!1){let a=this;if(e&&!Array.isArray(e)&&e.items&&(e=e.items),!Array.isArray(e))return;if(!a.isCanvasReady)return;a.lastRecords=e;let i,s,n=e.map(e=>`${e.id}-target`),r=a.getStateProvider().getData("contentComponentId"),o=`ticket-timeline-${r}`;try{if(i=await a.waitForDomRect({attempts:20,delay:50,id:n}),a.lastRecords!==e)return;if(r&&(s=await a.getDomRect(o)),!(i&&i.some(e=>e)))return;t||await a.updateSize();let d=await a.getDomRect(a.getCanvasId()),c=[],l=0;n.forEach((t,a)=>{let s=i[a],n=e[a];if(s){let e=s.height/2,t=s.y-d.y+e,i=s.x-d.x+s.width/2,r=s.height>32?6:3;c.push({color:n.color,id:n.id,radius:e+r,y:t,x:i}),0===a&&(l=t)}}),await Portal.canvas.TicketCanvas.updateGraphData({nodes:c,reset:!t,startY:l})}catch(e){console.error("TimelineCanvas update failed",e)}}async updateSize(e){let t=this;e&&0!==e.width&&0!==e.height||(e=await t.waitForDomRect({id:t.getCanvasId()})),await Portal.canvas.TicketCanvas.updateSize({width:e.width,height:e.height})}});