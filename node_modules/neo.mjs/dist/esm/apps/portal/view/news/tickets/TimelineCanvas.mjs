import e from"../../shared/Canvas.mjs";export default Neo.setupClass(class extends e{static delayable={ensureFinalAlignment:{type:"debounce",timer:300}};static config={className:"Portal.view.news.tickets.TimelineCanvas",importMethodName:"importTicketCanvas",rendererClassName:"Portal.canvas.TicketCanvas",_vdom:{tag:"div",cls:["neo-ticket-timeline-wrapper"],style:{width:"100%",height:"100%"},cn:[{tag:"canvas",style:{width:"100%",height:"100%"}}]}};lastRecords=null;ensureFinalAlignment(){let e=this;e.lastRecords&&e.onTimelineDataLoad(e.lastRecords,!0)}async afterSetOffscreenRegistered(e,t){let a=this;if(await super.afterSetOffscreenRegistered(e,t),e){let e=a.getStateProvider().getStore("sections");e.getCount()>0&&a.onTimelineDataLoad(e.items)}}getCanvasId(){let e=this;return e.canvasId||(e.canvasId=e.vdom.cn[0].id),e.canvasId}onConstructed(){super.onConstructed();let e=this;e.getStateProvider().getStore("sections").on("load",e.onTimelineDataLoad,e)}async onResize(e){let t=this;await t.updateSize(e.contentRect),t.lastRecords&&(await t.onTimelineDataLoad(t.lastRecords,!0),t.ensureFinalAlignment())}async onTimelineDataLoad(e,t=!1){let a=this;if(e&&!Array.isArray(e)&&e.items&&(e=e.items),!Array.isArray(e))return;if(!a.isCanvasReady)return;let s=!t;s&&a.lastRecords&&e[0]?.id===a.lastRecords[0]?.id&&(s=!1),a.lastRecords=e;let i,r=e.map(e=>`${e.id}-target`);try{if(i=await a.waitForDomRect({attempts:20,delay:50,id:r}),a.lastRecords!==e)return;if(!(i&&i.some(e=>e)))return;t||await a.updateSize();let n=await a.getDomRect(a.getCanvasId()),o=[],d=0;r.forEach((t,a)=>{let s=i[a],r=e[a];if(s){let e=s.height/2,t=s.y-n.y+e,i=s.x-n.x+s.width/2,l=s.height>32?6:3;o.push({color:r.color,id:r.id,radius:e+l,y:t,x:i}),0===a&&(d=t)}}),await a.renderer.updateGraphData({nodes:o,reset:s,startY:d})}catch(e){console.error("TimelineCanvas update failed",e)}}});