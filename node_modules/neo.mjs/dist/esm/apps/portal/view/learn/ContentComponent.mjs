import e from"../../../../src/component/Base.mjs";import t from"../../../../src/code/LivePreview.mjs";import{marked as o}from"../../../../node_modules/marked/lib/marked.esm.js";const s=/`([^`]+)`/g,r=/<!--\s*\/lab\s*-->/g,n=/<!--\s*lab\s*-->/g,a=/```(javascript|html|css|json)\s+live-preview\s*\n([\s\S]*?)\n\s*```/g,i=/```json\s+neo-component\s*\n([\s\S]*?)\n\s*```/g,c=/```(javascript|html|css|json)\s+readonly\s*\n([\s\S]*?)\n\s*```/g;export default Neo.setupClass(class extends e{static config={className:"Portal.view.learn.ContentComponent",baseCls:["learn-content"],bind:{record:e=>e.currentPageRecord},record_:null,tag:"article"};customComponents=[];livePreviews=[];construct(e){super.construct(e);let t=this;t.addDomListeners({click:t.onClick,intersect:"onIntersect",scope:t}),Neo.main.addon.HighlightJS.loadFiles({appName:t.appName})}afterSetMounted(e,t){super.afterSetMounted(e,t);let o=this;e?o.timeout(50).then(()=>{Neo.main.addon.IntersectionObserver.register({callback:"findTopmostItem",id:o.id,root:`#${o.parentId}`,windowId:o.windowId})}):void 0!==t&&(o.customComponents.forEach(e=>{e.mounted=!1}),o.livePreviews.forEach(e=>{e.mounted=!1}))}async afterSetRecord(e,t){if(e){let o=this;t&&o.destroyChildInstances(),await o.doFetchContent(e),t&&(await o.timeout(50),Neo.main.DomAccess.scrollTo({direction:"top",id:o.parentId,value:0}))}}destroy(...e){this.destroyChildInstances(),super.destroy(...e)}destroyChildInstances(){let e=this;e.customComponents.forEach(e=>{e.destroy()}),e.customComponents=[],e.livePreviews.forEach(e=>{e.destroy()}),e.livePreviews=[]}async doFetchContent(e){let s,r,n,a,i,c,d,l=this,{appName:p,windowId:m}=l,h=l.getStateProvider().getData("contentPath"),u=h.includes("/learn/")?"":"pages/";h+=`${u+e.id.replaceAll(".","/")}.md`,e.isLeaf&&h&&(s={appName:p,autoInitVnode:!0,autoMount:!0,parentComponent:l,windowId:m},n=await fetch(h),r=await n.text(),r=l.updateContentSectionsStore(r),c={},d={},r=l.processNeoComponentsBlocks(r,c),r=l.processLivePreviewBlocks(r,d),r=await l.processReadonlyCodeBlocks(r,m),a=o.parse(r),a=l.insertLabDivs(a),l.toggleCls("lab",e.name?.startsWith("Lab:")),l.html=a,await l.timeout("development"===Neo.config.environment?100:150),Object.keys(c).forEach(e=>{i=Neo.create({...s,className:"Neo.component.Base",parentId:e,...c[e]}),l.customComponents.push(i)}),Object.keys(d).forEach(e=>{i=Neo.create({...s,module:t,parentId:e,value:d[e].code}),l.livePreviews.push(i)}),Neo.main.addon.IntersectionObserver.observe({disconnect:!0,id:l.id,observe:[".neo-h2",".neo-h3"],windowId:l.windowId}))}insertLabDivs(e){return e=(e=e.replace(n,'<div class="lab">')).replace(r,"</div>")}onClick({altKey:e,metaKey:t,shiftKey:o}){let s=this,{record:r}=s;e&&!t&&o?s.fire("edit",{component:s,record:r}):!e&&t&&o&&s.fire("refresh",{component:s,record:r})}processLivePreviewBlocks(e,t){return e.replace(a,(e,o,s)=>{const r=Neo.core.IdGenerator.getId("pre-live-preview");return t[r]={code:s,language:o},`<div id="${r}"></div>`})}processNeoComponentsBlocks(e,t){return e.replace(i,(e,o)=>{const s=Neo.core.IdGenerator.getId("learn-content-component");return t[s]=JSON.parse(o),`<div id="${s}"></div>`})}async processReadonlyCodeBlocks(e,t){let o,s=[],r=0,n=e.replace(c,(e,o,n)=>{const a=`__NEO-READONLY-TOKEN-${++r}__`;return s.push(Neo.main.addon.HighlightJS.highlightAuto({html:n,windowId:t}).then(e=>({after:`<pre data-javascript id="pre-readonly-${Neo.core.IdGenerator.getId()}">${e.trim()}</pre>`,token:a}))),a});return o=await Promise.all(s),o.forEach(e=>{n=n.replace(e.token,e.after)}),n}updateContentSectionsStore(e){let t,o,r,n=this,a=e.split("\n"),i=1,c=[];return a.forEach((e,d)=>{r=null,e.startsWith("#")&&"#"!==e.charAt(1)?(e=e.substring(1).trim(),r="h1"):e.startsWith("##")&&"#"!==e.charAt(2)?(e=e.substring(2).trim(),r="h2"):e.startsWith("###")&&"#"!==e.charAt(3)&&(e=e.substring(3).trim(),r="h3"),r&&(t=e.replace(s,"<code>$1</code>"),o=e.replaceAll("`",""),c.push({id:i,name:o,sourceId:n.id,tag:r}),a[d]=`<${r} class="neo-${r}" data-record-id="${i}">${t}</${r}>`,i++)}),n.getStateProvider().getStore("contentSections").data=c,a.join("\n")}});