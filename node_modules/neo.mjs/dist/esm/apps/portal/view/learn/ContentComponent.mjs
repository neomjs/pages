import e from"../../../../src/component/Base.mjs";import t from"../../../../src/code/LivePreview.mjs";import{marked as o}from"../../../../../../node_modules/marked/lib/marked.esm.js";const s=/`([^`]+)`/g,n=/<!--\s*\/lab\s*-->/g,r=/<!--\s*lab\s*-->/g,a=/```(javascript|html|css|json)\s+live-preview\s*\n([\s\S]*?)\n\s*```/g,i=/```json\s+neo-component\s*\n([\s\S]*?)\n\s*```/g,c=/```(javascript|html|css|json)\s+readonly\s*\n([\s\S]*?)\n\s*```/g;export default Neo.setupClass(class extends e{static config={className:"Portal.view.learn.ContentComponent",baseCls:["learn-content"],bind:{record:e=>e.currentPageRecord},record_:null,tag:"article"};customComponents=[];livePreviews=[];construct(e){super.construct(e);let t=this;t.addDomListeners({click:t.onClick,intersect:"onIntersect",scope:t}),Neo.main.addon.HighlightJS.loadFiles({appName:t.appName})}afterSetMounted(e,t){super.afterSetMounted(e,t);let o=this;e?o.timeout(50).then(()=>{Neo.main.addon.IntersectionObserver.register({callback:"findTopmostItem",id:o.id,root:`#${o.parentId}`,windowId:o.windowId})}):void 0!==t&&(o.customComponents.forEach(e=>{e.mounted=!1}),o.livePreviews.forEach(e=>{e.mounted=!1}))}async afterSetRecord(e,t){if(e){let o=this;t&&o.destroyChildInstances(),await o.doFetchContent(e),t&&(await o.timeout(50),Neo.main.DomAccess.scrollTo({direction:"top",id:o.parentId,value:0}))}}destroy(...e){this.destroyChildInstances(),super.destroy(...e)}destroyChildInstances(){let e=this;e.customComponents.forEach(e=>{e.destroy()}),e.customComponents=[],e.livePreviews.forEach(e=>{e.destroy()}),e.livePreviews=[]}async doFetchContent(e){let s,n,r,a,i,c,d,l=this,{appName:p,windowId:m}=l,h=l.getStateProvider().getData("contentPath"),u=h.includes("/learn/")?"":"pages/";h+=`${u+e.id.replaceAll(".","/")}.md`,e.isLeaf&&h&&(s={appName:p,autoMount:!0,autoRender:!0,parentComponent:l,windowId:m},r=await fetch(h),n=await r.text(),n=l.updateContentSectionsStore(n),n=`<h1 class='neo-h1'>${e.name}</h1>\n${n}`,c={},d={},n=l.processNeoComponentsBlocks(n,c),n=l.processLivePreviewBlocks(n,d),n=await l.processReadonlyCodeBlocks(n,m),a=o.parse(n),a=l.insertLabDivs(a),l.toggleCls("lab",e.name?.startsWith("Lab:")),l.html=a,await l.timeout("development"===Neo.config.environment?100:150),Object.keys(c).forEach(e=>{i=Neo.create({...s,className:"Neo.component.Base",parentId:e,...c[e]}),l.customComponents.push(i)}),Object.keys(d).forEach(e=>{i=Neo.create({...s,module:t,parentId:e,value:d[e].code}),l.livePreviews.push(i)}),Neo.main.addon.IntersectionObserver.observe({disconnect:!0,id:l.id,observe:[".neo-h2",".neo-h3"],windowId:l.windowId}))}insertLabDivs(e){return e=(e=e.replace(r,'<div class="lab">')).replace(n,"</div>")}onClick({altKey:e,metaKey:t,shiftKey:o}){let s=this,{record:n}=s;e&&!t&&o?s.fire("edit",{component:s,record:n}):!e&&t&&o&&s.fire("refresh",{component:s,record:n})}processLivePreviewBlocks(e,t){return e.replace(a,(e,o,s)=>{const n=Neo.core.IdGenerator.getId("pre-live-preview");return t[n]={code:s,language:o},`<div id="${n}"></div>`})}processNeoComponentsBlocks(e,t){return e.replace(i,(e,o)=>{const s=Neo.core.IdGenerator.getId("learn-content-component");return t[s]=JSON.parse(o),`<div id="${s}"></div>`})}async processReadonlyCodeBlocks(e,t){let o,s=[],n=0,r=e.replace(c,(e,o,r)=>{const a=`__NEO-READONLY-TOKEN-${++n}__`;return s.push(Neo.main.addon.HighlightJS.highlightAuto({html:r,windowId:t}).then(e=>({after:`<pre data-javascript id="pre-readonly-${Neo.core.IdGenerator.getId()}">${e.trim()}</pre>`,token:a}))),a});return o=await Promise.all(s),o.forEach(e=>{r=r.replace(e.token,e.after)}),r}updateContentSectionsStore(e){let t,o,n,r=this,a=e.split("\n"),i=1,c=[];return a.forEach((e,d)=>{n=null,e.startsWith("##")&&"#"!==e.charAt(2)?(e=e.substring(2).trim(),n="h2"):e.startsWith("###")&&"#"!==e.charAt(3)&&(e=e.substring(3).trim(),n="h3"),n&&(t=e.replace(s,"<code>$1</code>"),o=e.replaceAll("`",""),c.push({id:i,name:o,sourceId:r.id,tag:n}),a[d]=`<${n} class="neo-${n}" data-record-id="${i}">${t}</${n}>`,i++)}),r.getStateProvider().getStore("contentSections").data=c,a.join("\n")}});