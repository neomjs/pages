import e from"../../../../src/component/Base.mjs";import t from"../../../../src/code/LivePreview.mjs";import{marked as o}from"../../../../../../node_modules/marked/lib/marked.esm.js";const r=/<!--\s*\/lab\s*-->/g,n=/<!--\s*lab\s*-->/g,s=/<pre\s+data-javascript\s*>([\s\S]*?)<\/pre>/g,a=/<pre\s+data-neo\s*>([\s\S]*?)<\/pre>/g,i=/<pre\s+data-neo-component\s*>([\s\S]*?)<\/pre>/g;export default Neo.setupClass(class extends e{static config={className:"Portal.view.learn.ContentComponent",baseCls:["learn-content"],bind:{record:e=>e.currentPageRecord},record_:null,tag:"article"};customComponents=[];livePreviews=[];construct(e){super.construct(e);let t=this;t.addDomListeners({click:t.onClick,intersect:"onIntersect",scope:t}),Neo.main.addon.HighlightJS.loadFiles({appName:t.appName})}afterSetMounted(e,t){super.afterSetMounted(e,t);let o=this;e?o.timeout(50).then((()=>{Neo.main.addon.IntersectionObserver.register({callback:"findTopmostItem",id:o.id,root:`#${o.parentId}`,windowId:o.windowId})})):void 0!==t&&(o.customComponents.forEach((e=>{e.mounted=!1})),o.livePreviews.forEach((e=>{e.mounted=!1})))}async afterSetRecord(e,t){if(e){let o=this;t&&o.destroyChildInstances(),await o.doFetchContent(e),t&&(await o.timeout(50),Neo.main.DomAccess.scrollTo({direction:"top",id:o.parentId,value:0}))}}destroy(...e){this.destroyChildInstances(),super.destroy(...e)}destroyChildInstances(){let e=this;e.customComponents.forEach((e=>{e.destroy()})),e.customComponents=[],e.livePreviews.forEach((e=>{e.destroy()})),e.livePreviews=[]}async doFetchContent(e){let r,n,s,a,i,d,c,l,p=this,{appName:m,windowId:h}=p,u=p.getStateProvider().getData("contentPath");u+=`/pages/${e.id.replaceAll(".","/")}.md`,e.isLeaf&&u&&(r={appName:m,autoMount:!0,autoRender:!0,parentComponent:p,windowId:h},s=await fetch(u),n=await s.text(),n=p.updateContentSectionsStore(n),n=`<h1 class='neo-h1'>${e.name}</h1>\n${n}`,d=await p.highlightPreContent(n),c={},l={},d=p.extractNeoComponents(d,c),d=p.extractNeoContent(d,l),a=o.parse(d),a=p.insertLabDivs(a),p.toggleCls("lab",e.name?.startsWith("Lab:")),p.html=a,await p.timeout("development"===Neo.config.environment?100:150),Object.keys(c).forEach((e=>{i=Neo.create({...r,className:"Neo.component.Base",parentId:e,...c[e]}),p.customComponents.push(i)})),Object.keys(l).forEach((e=>{i=Neo.create({...r,module:t,parentId:e,value:l[e]}),p.livePreviews.push(i)})),Neo.main.addon.IntersectionObserver.observe({disconnect:!0,id:p.id,observe:[".neo-h2",".neo-h3"],windowId:p.windowId}))}extractNeoComponents(e,t){return e.replace(i,((e,o)=>{const r=Neo.core.IdGenerator.getId("learn-content-component");return t[r]=JSON.parse(o),`<div id="${r}"></div>`}))}extractNeoContent(e,t){return e.replace(a,((e,o)=>{const r=Neo.core.IdGenerator.getId("pre-live-preview");return t[r]=o,`<div id="${r}"></div>`}))}getHighlightPromise(e,t,o){return Neo.main.addon.HighlightJS.highlightAuto({html:e,windowId:this.windowId}).then((e=>({after:`<pre data-javascript id="${o}">${e}</pre>`,token:t})))}async highlightPreContent(e){const t=[];let o=0,r=e.replace(s,((e,r)=>{const n=`__NEO-PRE-TOKEN-${++o}__`;return t.push(this.getHighlightPromise(r,n,`pre-preview-${Neo.core.IdGenerator.getId()}`)),n}));return(await Promise.all(t)).forEach((e=>r=r.replace(e.token,e.after))),r}insertLabDivs(e){return e=(e=e.replace(n,'<div class="lab">')).replace(r,"</div>")}onClick({altKey:e,metaKey:t,shiftKey:o}){let r=this,{record:n}=r;e&&!t&&o?r.fire("edit",{component:r,record:n}):!e&&t&&o&&r.fire("refresh",{component:r,record:n})}updateContentSectionsStore(e){let t,o=this,r=e.split("\n"),n=1,s=[];return r.forEach(((e,a)=>{t=null,e.startsWith("##")&&"#"!==e.charAt(2)?(e=e.substring(2).trim(),t="h2"):e.startsWith("###")&&"#"!==e.charAt(3)&&(e=e.substring(3).trim(),t="h3"),t&&(s.push({id:n,name:e,sourceId:o.id,tag:t}),r[a]=`<${t} class="neo-${t}" data-record-id="${n}">${e}</${t}>`,n++)})),o.getStateProvider().getStore("contentSections").data=s,r.join("\n")}});