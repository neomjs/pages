import e from"../../../src/canvas/Base.mjs";const t="function"==typeof requestAnimationFrame,r=30;export default Neo.setupClass(class extends e{static colors={dark:{background:["rgba(30, 30, 35, 1)","rgba(20, 20, 25, 1)"],particlePalette:["#E0E0E0","#00BFFF","#3E63DD","#8BA6FF"],hexLine:"rgba(139, 166, 255, 0.1)",hexActive:"rgba(0, 191, 255, 0.15)",activePalette:["#00BFFF","#536DFE","#3E63DD","#00E5FF"],kernel:"rgba(62, 99, 221, 0.08)",runner:"#00BFFF",runnerPalette:["#00BFFF","#536DFE","#3E63DD","#00E5FF"],agentHead:"#FFFFFF",superHex:"rgba(62, 99, 221, 0.3)",strata:"rgba(139, 166, 255, 0.08)"},light:{background:["rgba(255, 255, 255, 1)","rgba(245, 247, 255, 1)"],particlePalette:["#3E63DD","#00BFFF","#536DFE","#283593"],hexLine:"rgba(62, 99, 221, 0.25)",hexActive:"rgba(0, 191, 255, 0.2)",activePalette:["#00BFFF","#536DFE","#3E63DD","#00E5FF"],kernel:"rgba(62, 99, 221, 0.08)",runner:"#00BFFF",runnerPalette:["#00BFFF","#536DFE","#3E63DD","#00E5FF"],agentHead:"#3E63DD",superHex:"rgba(62, 99, 221, 0.3)",strata:"rgba(62, 99, 221, 0.05)"}};static config={className:"Portal.canvas.ServicesCanvas",remote:{app:["updateSize"]},singleton:!0};animationId=null;canvasId=null;canvasSize=null;context=null;cellBuffer=null;runnerBuffer=null;kernelBuffer=null;strataBuffer=null;particleBuffer=null;projectionPoint={x:0,y:0,scale:0,visible:!1};projectionMatrix={cx:0,cy:0,cosX:0,sinX:0,cosY:0,sinY:0};superHexes=[];scale=1;rotation={x:-.4,y:0};clearGraph(){let e=this;super.clearGraph(),e.cellBuffer=null,e.runnerBuffer=null,e.kernelBuffer=null,e.strataBuffer=null,e.particleBuffer=null,e.superHexes=[],e.scale=1}onGraphMounted(e,t){this.updateSize({width:e,height:t})}drawHex(e,t,r,l,a){let n,i=this,o=!0;e.beginPath();for(let s=0;s<6;s++){const f=60*s+30,c=Math.PI/180*f,u=t+a*Math.cos(c),h=r+a*Math.sin(c);n=i.project(u,h,l),o?(e.moveTo(n.x,n.y),o=!1):e.lineTo(n.x,n.y)}e.closePath()}drawKernel(e,t,r){let l=this;if(!l.kernelBuffer)return;const a=l.kernelBuffer,n=a.length/2,i=l.scale,o=120*i,s=l.constructor.colors[l.theme];e.strokeStyle=s.kernel,e.lineWidth=2*i,e.lineJoin="round";let f=20*Math.sin(.2*l.time)*i,c=20*Math.cos(.2*l.time)*i;e.beginPath();for(let t=0;t<n;t++){let r=a[2*t]+f,n=a[2*t+1]+c;l.drawHex(e,r,n,400,o)}e.stroke()}drawStrata(e,t,r){let l=this;if(!l.strataBuffer)return;const a=l.strataBuffer,n=l.scale,i=l.constructor.colors[l.theme];e.fillStyle=i.strata;let o=30*Math.sin(.15*l.time)*n,s=30*Math.cos(.15*l.time)*n;for(let t=0;t<15;t++){let r=4*t,i=a[r]+o,f=a[r+1]+s,c=a[r+2],u=a[r+3]*n;l.drawHex(e,i,f,c,u),e.fill()}}drawGraph(e,t,l){let a=this;if(!a.cellBuffer)return;const n=a.cellBuffer,i=n.length/8,o=a.constructor.colors[a.theme],s=a.scale,f=r*s;e.lineWidth=1*s,e.lineJoin="round",e.beginPath(),e.strokeStyle=o.hexLine;for(let t=0;t<i;t++){let r=8*t,l=n[r+2],i=n[r+3],o=n[r+4];if(n[r+5]<=.01&&o>.1){let t=.95*f*o;a.drawHex(e,l,i,0,t)}}e.stroke(),e.lineWidth=2*s;for(let t of a.superHexes){let r=t.centerIdx,l=n[r+2],i=n[r+3],c=n[r+7],u=0;if(u=0===t.state?t.age/30:1===t.state?1:1-t.age/30,u>0){let t=o.activePalette[c];e.beginPath(),a.drawHex(e,l,i,0,2.5*f*u),e.strokeStyle=t,e.globalAlpha=.3*u,e.stroke(),e.fillStyle=o.superHex,e.fill();let r=a.project(l,i,0);e.beginPath(),e.arc(r.x,r.y,4*s*u*r.scale,0,2*Math.PI),e.fillStyle=t,e.globalAlpha=.8*u,e.fill()}}e.globalAlpha=1,e.lineWidth=1*s;for(let t=0;t<i;t++){let r=8*t,l=n[r+2],i=n[r+3],c=n[r+4],u=n[r+5],h=n[r+7];if(u>.01&&c>.5){let t=f*(.95+.1*u),r=o.activePalette[h];if(e.beginPath(),a.drawHex(e,l,i,0,t),e.fillStyle=o.hexActive,e.globalAlpha=.4*u,e.fill(),e.strokeStyle=r,e.lineWidth=(1+u)*s,e.globalAlpha=.8*u,e.stroke(),u>.3){e.beginPath();let n=-50*u;a.drawHex(e,l,i,n,t),e.strokeStyle=r,e.globalAlpha=.4*u,e.lineWidth=1*s,e.stroke()}e.globalAlpha=1,e.lineWidth=1*s}}}drawRunners(e){let t=this;if(!t.runnerBuffer)return;const l=t.runnerBuffer,a=t.constructor.colors[t.theme],n=t.scale,i=t.projectionPoint;e.lineCap="round";for(let o=0;o<30;o++){let s=10*o,f=l[s],c=l[s+1],u=l[s+2],h=l[s+3],d=l[s+5],p=l[s+7],g=l[s+8],B=l[s+9];if(t.project(f,c,0),!i.visible)continue;let M=i.x,x=i.y,b=i.scale,m=a.runnerPalette[p];if(0===g){let r=u-f,l=h-c,o=Math.sqrt(r*r+l*l);if(o>0){let s=12*d*n,u=f-r/o*s,h=c-l/o*s;t.project(u,h,0);let p=i.x,g=i.y,B=e.createLinearGradient(p,g,M,x);B.addColorStop(0,"rgba(0,0,0,0)"),B.addColorStop(.2,m),B.addColorStop(.6,m),B.addColorStop(1,a.agentHead),e.beginPath(),e.strokeStyle=B,e.lineWidth=3*n*b,e.moveTo(p,g),e.lineTo(M,x),e.stroke()}}else if(1===g){let t=r*n*1.5*B*b;e.beginPath(),e.arc(M,x,t,0,2*Math.PI),e.strokeStyle=m,e.lineWidth=2*n*b*(1-B),e.stroke(),e.beginPath(),e.moveTo(M,x),e.lineTo(M,x-30*n*b*Math.sin(B*Math.PI)),e.strokeStyle=a.agentHead,e.lineWidth=2*n*b,e.stroke()}e.beginPath(),e.fillStyle=a.agentHead;let F=4*n*b;e.moveTo(M,x-F),e.lineTo(M+F,x),e.lineTo(M,x+F),e.lineTo(M-F,x),e.closePath(),e.fill(),e.shadowBlur=10*n,e.shadowColor=m,e.shadowBlur=0}}drawParticles(e){let t=this;if(!t.particleBuffer)return;const r=t.particleBuffer,l=t.constructor.colors[t.theme],a=t.scale,n=t.projectionPoint;for(let i=0;i<200;i++){let o=8*i,s=r[o+6];if(s>0){let i=r[o],f=r[o+1],c=r[o+2],u=3*a*s;if(t.project(i,f,c),n.visible){let t=u*n.scale,a=r[o+7];e.fillStyle=l.particlePalette[a],e.globalAlpha=s,e.fillRect(n.x-t/2,n.y-t/2,t,t)}}}e.globalAlpha=1}initParticles(){let e=this;e.particleBuffer||(e.particleBuffer=new Float32Array(1600))}initKernel(e,t){let r=this;const l=120*r.scale,a=1.5*l,n=l*Math.sqrt(3),i=Math.ceil(e/a)+4,o=Math.ceil(t/n)+4,s=i*o;r.kernelBuffer=new Float32Array(2*s);let f=0,c=-2*a,u=-2*n;for(let e=0;e<i;e++)for(let t=0;t<o;t++){let l=c+e*a,i=u+t*n;e%2==1&&(i+=n/2),r.kernelBuffer[2*f]=l,r.kernelBuffer[2*f+1]=i,f++}}initNodes(e,t){let l=this;const a=l.scale,n=r*a,i=1.5*n,o=n*Math.sqrt(3),s=Math.ceil(e/i)+2,f=Math.ceil(t/o)+12,c=s*f;l.cellBuffer&&l.cellBuffer.length===8*c||(l.cellBuffer=new Float32Array(8*c));const u=l.cellBuffer;let h=0;for(let e=-1;e<s;e++)for(let t=-10;t<f-10;t++){let r=e*i,l=t*o;e%2==1&&(l+=o/2);let a=8*h;if(u[a]=e,u[a+1]=t,u[a+2]=r,u[a+3]=l,u[a+4]=1,u[a+5]=0,u[a+6]=0,u[a+7]=Math.floor(4*Math.random()),h++,h>=c)break}}initRunners(e,t){let r=this;r.runnerBuffer||(r.runnerBuffer=new Float32Array(300));const l=r.runnerBuffer;for(let a=0;a<30;a++){r.resetRunner(a,e,t);let n=10*a;l[n+4]=Math.random(),l[n+8]=0,l[n+9]=0}}initStrata(e,t){this.strataBuffer=new Float32Array(60);const l=this.strataBuffer;for(let a=0;a<15;a++){let n=4*a;l[n]=(Math.random()-.5)*e*2,l[n+1]=(Math.random()-.5)*t*3,l[n+2]=150+150*Math.random(),l[n+3]=90+Math.random()*r*4}}findNearestNode(e,t){let r=this.cellBuffer,l=r.length/8,a=1/0,n=-1;for(let i=0;i<l;i++){let l=8*i,o=(r[l+2]-e)**2+(r[l+3]-t)**2;o<a&&(a=o,n=l)}return n}resetRunner(e,t,r){let l=this,a=l.runnerBuffer,n=l.cellBuffer,i=10*e,o=n.length/8,s=8*Math.floor(Math.random()*o);a[i]=n[s+2],a[i+1]=n[s+3],a[i+2]=a[i],a[i+3]=a[i+1],a[i+4]=1,a[i+5]=(4*Math.random()+5)*l.scale,a[i+6]=s,a[i+7]=Math.floor(4*Math.random()),a[i+8]=0,a[i+9]=0}spawnParticles(e,t,r,l){let a=this;if(!a.particleBuffer)return;const n=a.particleBuffer,i=a.scale;let o=0;for(let a=0;a<200;a++){let s=8*a;if(n[s+6]<=0){let a=Math.random()*Math.PI*2,f=(3*Math.random()+2)*i;if("implode"===l){let r=60*i;n[s]=e+Math.cos(a)*r,n[s+1]=t+Math.sin(a)*r,n[s+2]=0,n[s+3]=-Math.cos(a)*f,n[s+4]=-Math.sin(a)*f,n[s+5]=0}else"upload"===l?(n[s]=e+20*(Math.random()-.5)*i,n[s+1]=t+20*(Math.random()-.5)*i,n[s+2]=0,n[s+3]=0,n[s+4]=0,n[s+5]=1.5*-f,n[s+4]=-1*i,n[s+5]=-5*i):(n[s]=e,n[s+1]=t,n[s+2]=0,n[s+3]=Math.cos(a)*f,n[s+4]=Math.sin(a)*f,n[s+5]=0);if(n[s+6]=1,n[s+7]=Math.floor(4*Math.random()),o++,o>=r)break}}}render(){let e=this;if(!e.canRender)return;const r=e.context,l=e.canvasSize?.width||100,a=e.canvasSize?.height||50;e.time+=.01,e.cellBuffer||e.initNodes(l,a),e.kernelBuffer||e.initKernel(l,a),e.strataBuffer||e.initStrata(l,a),e.runnerBuffer||e.initRunners(l,a),e.particleBuffer||e.initParticles(),e.updatePhysics(l,a),e.updateRotation(l,a),e.updateSuperHexes(l,a),e.updateRunners(l,a),e.updateParticles(),e.updateProjection(l,a),r.clearRect(0,0,l,a),e.gradients.bgGradient&&(r.fillStyle=e.gradients.bgGradient,r.fillRect(0,0,l,a)),e.drawKernel(r,l,a),e.drawStrata(r,l,a),e.drawGraph(r,l,a),e.drawRunners(r),e.drawParticles(r),e.animationId=t?requestAnimationFrame(e.renderLoop):setTimeout(e.renderLoop,1e3/60)}updateParticles(){if(!this.particleBuffer)return;const e=this.particleBuffer;for(let t=0;t<200;t++){let r=8*t;e[r+6]>0&&(e[r]+=e[r+3],e[r+1]+=e[r+4],e[r+2]+=e[r+5],e[r+6]-=.03)}}updateSuperHexes(e,t){let r=this;if(r.cellBuffer){if(r.superHexes.length<5){const e=r.cellBuffer,t=e.length/8;for(let l=0;l<20;l++){let l=8*Math.floor(Math.random()*t);if(e[l+6]>3){r.superHexes.push({centerIdx:l,age:0,state:0,neighbors:r.findNeighbors(l)});let t=e[l+2],a=e[l+3];r.spawnParticles(t,a,12,"implode"),e[l+6]=0;break}}}for(let e=r.superHexes.length-1;e>=0;e--){let t=r.superHexes[e];if(t.age++,0===t.state&&t.age>30)t.state=1,t.age=0;else if(1===t.state&&t.age>120)t.state=2,t.age=0;else if(2===t.state&&t.age>30){let l=t.centerIdx,a=r.cellBuffer[l+2],n=r.cellBuffer[l+3];r.spawnParticles(a,n,12,"upload"),t.neighbors.forEach(e=>{r.cellBuffer[e+4]=1}),r.superHexes.splice(e,1);continue}let l=1;l=0===t.state?1-t.age/30:1===t.state?0:t.age/30,t.neighbors.forEach(e=>{r.cellBuffer[e+4]=l})}}}findNeighbors(e){let t=this.cellBuffer,l=t[e+2],a=t[e+3],n=[e],i=t.length/8,o=this.scale,s=r*o*2.1;for(let r=0;r<i;r++){let i=8*r;if(i===e)continue;let o=t[i+2],f=t[i+3];Math.sqrt((o-l)**2+(f-a)**2)<s&&n.push(i)}return n}updatePhysics(e,t){let r=this;if(!r.cellBuffer)return;const l=r.cellBuffer,a=l.length/8,n=r.mouse.x,i=r.mouse.y,o=r.scale;for(let e=0;e<a;e++){let t=8*e,r=l[t+2],a=l[t+3],s=0;if(-1e3!==n){let e=r-n,t=a-i,l=e*e+t*t,f=250*o;if(l<f*f){s=(f-Math.sqrt(l))/f,s=Math.pow(s,2)}}let f=l[t+5],c=.8*s;f>c?l[t+5]*=.9:l[t+5]+=.3*(c-f),l[t+5]<.001&&(l[t+5]=0),l[t+6]>0&&(l[t+6]-=.05,l[t+6]<0&&(l[t+6]=0))}}updateRunners(e,t){let l=this;if(!l.runnerBuffer)return;const a=l.runnerBuffer,n=l.cellBuffer,i=l.scale;for(let o=0;o<30;o++){let s=10*o,f=a[s+8];if(0===f){let f=a[s+4],c=a[s+5];if(f<1){let e=a[s],t=a[s+1],r=a[s+2],i=a[s+3],o=r-e,f=i-t,u=Math.sqrt(o*o+f*f);if(u<c){a[s]=r,a[s+1]=i,a[s+4]=1;let e=l.findNearestNode(r,i);-1!==e&&Math.random()>.8?(a[s+8]=1,a[s+9]=0,a[s+6]=e):-1!==e&&(n[e+5]=1,n[e+6]+=.5,n[e+7]=a[s+7],a[s+6]=e)}else a[s]+=o/u*c,a[s+1]+=f/u*c}else{let n=a[s+6];if(void 0!==n&&-1!==n){let n=[1,1,1,1,1,1];if(-1e3!==l.mouse.x){let e=a[s],t=a[s+1];for(let a=0;a<6;a++){let o=(30+60*a)*Math.PI/180,s=r*i*Math.sqrt(3),f=e+Math.cos(o)*s,c=t+Math.sin(o)*s,u=(f-l.mouse.x)**2+(c-l.mouse.y)**2;n[a]+=1e5/(u+100)*5}}let f=n.reduce((e,t)=>e+t,0),c=Math.random()*f,u=0,h=0;for(let e=0;e<6;e++)if(u+=n[e],c<=u){h=e;break}let d=(30+60*h)*Math.PI/180,p=r*i*Math.sqrt(3),g=a[s],B=a[s+1],M=g+Math.cos(d)*p,x=B+Math.sin(d)*p;if(M<-50||M>e+50||x<-500||x>t+50){l.resetRunner(o,e,t);continue}a[s+2]=M,a[s+3]=x,a[s+4]=0}else l.resetRunner(o,e,t)}}else if(1===f){a[s+9]+=.02;let e=a[s+6];-1!==e&&(n[e+5]=.5+.5*Math.sin(10*a[s+9])),a[s+9]>=1&&(a[s+8]=0,-1!==e&&(n[e+6]+=5,n[e+5]=1,n[e+7]=a[s+7]))}}}updateRotation(e,t){let r=this,l=r.mouse.x,a=r.mouse.y,n=-.4,i=0;-1e3!==l&&(i=.4*(l/e-.5),n=.4*(a/t-.5)-.4),r.rotation.x+=.05*(n-r.rotation.x),r.rotation.y+=.05*(i-r.rotation.y)}updateProjection(e,t){let r=this,l=r.projectionMatrix;l.cx=e/2,l.cy=t/2,l.cosX=Math.cos(r.rotation.x),l.sinX=Math.sin(r.rotation.x),l.cosY=Math.cos(r.rotation.y),l.sinY=Math.sin(r.rotation.y)}project(e,t,r){let l=this.projectionMatrix,a=this.projectionPoint,n=1e3,i=e-l.cx,o=t-l.cy,s=r,f=i*l.cosY-s*l.sinY,c=s*l.cosY+i*l.sinY,u=o*l.cosX-c*l.sinX,h=c*l.cosX+o*l.sinX,d=n/(n+h);return a.x=f*d+l.cx,a.y=u*d+l.cy,a.scale=d,a.visible=h>-n,a}updateResources(e,t){let r=this,l=r.context;if(!l)return;const a=r.constructor.colors[r.theme],n=l.createLinearGradient(0,0,e,t);n.addColorStop(0,a.background[0]),n.addColorStop(1,a.background[1]),r.gradients.bgGradient=n}updateSize(e){let t=this;t.canvasSize=e,t.scale=Math.sqrt(e.width*e.height/2073600),t.context&&(t.context.canvas.width=e.width,t.context.canvas.height=e.height,t.cellBuffer=null,t.runnerBuffer=null,t.kernelBuffer=null,t.strataBuffer=null,t.debrisBuffer=null,t.initNodes(e.width,e.height),t.updateResources(e.width,e.height))}});