import e from"../../../src/core/Base.mjs";const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,n=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,o={r:64,g:196,b:255},a={influenceRange:150,minMod:.2,maxMod:1.5,pulseBounds:-200};export default Neo.setupClass(class extends e{static config={className:"Portal.canvas.TicketCanvas",remote:{app:["clearGraph","initGraph","updateGraphData","updateSize"]},singleton:!0};animationId=null;baseSpeed=.5;canvasId=null;canvasSize=null;context=null;lastFrameTime=0;nodes=[];pulseY=0;renderLoop=this.render.bind(this);startY=0;clearGraph(){let e=this;e.nodes=[],e.context=null,e.canvasId=null,e.canvasSize=null}getXAtY(e){let t=this;if(t.nodes.length<2)return t.nodes[0]?.x||38;if(e<t.nodes[0].y)return t.nodes[0].x;for(let n=0;n<t.nodes.length-1;n++){let o=t.nodes[n],a=t.nodes[n+1];if(e>=o.y&&e<=a.y){let t=(e-o.y)/(a.y-o.y);return o.x+(a.x-o.x)*t}}return t.nodes[t.nodes.length-1].x}hexToRgb(e){e=e.replace(n,function(e,t,n,o){return t+t+n+n+o+o});const o=t.exec(e);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:null}initGraph({canvasId:e,windowId:t}){let n=this,o=n.canvasId!==e;n.canvasId=e;const a=()=>{const s=Neo.currentWorker.canvasWindowMap[e]?.[t];s?(n.context=s.getContext("2d"),o&&n.renderLoop()):setTimeout(a,50)};a()}updateGraphData(e){let t=this;t.nodes=e.nodes||[],void 0!==e.startY&&(t.startY=e.startY),e.reset&&(t.pulseY=a.pulseBounds),t.nodes.length>0&&!t.animationId&&t.context&&t.renderLoop()}updateSize(e){let t=this;t.canvasSize=e,t.context&&(t.context.canvas.width=e.width,t.context.canvas.height=e.height)}render(){let e=this;if(!e.context)return;const t=e.context,n=e.canvasSize?.width||800,s=e.canvasSize?.height||600,r=Date.now();let l=s;e.nodes.length>0&&(l=e.nodes[e.nodes.length-1].y);let d=r-(e.lastFrameTime||r);e.lastFrameTime=r,d>100&&(d=16);let i=1/0,c=null;e.nodes.forEach(t=>{let n=Math.abs(e.pulseY-t.y);n<i&&(i=n,c=t)});const{influenceRange:h,minMod:u,maxMod:p,pulseBounds:g}=a;let f=p;if(i<h){let e=i/h;f=u+e*e*(p-u)}let{r:x,g:m,b:b}=o;if(c&&c.color&&i<100){let t=e.hexToRgb(c.color);if(t){let e=1-i/100;x+=(t.r-x)*e,m+=(t.g-m)*e,b+=(t.b-b)*e}}const M=`rgba(${Math.round(x)}, ${Math.round(m)}, ${Math.round(b)}`;e.pulseY+=e.baseSpeed*f*d,e.pulseY>l-g&&(e.pulseY=g);const I=.8*f*100;t.clearRect(0,0,n,s);const v=t.createLinearGradient(0,0,0,s);if(v.addColorStop(0,"rgba(150, 150, 150, 0.1)"),v.addColorStop(.5,"rgba(150, 150, 150, 0.3)"),v.addColorStop(1,"rgba(150, 150, 150, 0.1)"),t.strokeStyle=v,t.lineWidth=2,t.beginPath(),e.nodes.length>0){let n=e.nodes[0];t.moveTo(n.x,n.y);for(let n=1;n<e.nodes.length;n++){let o=e.nodes[n];t.lineTo(o.x,o.y)}}t.stroke();const S=e.pulseY;if(e.nodes.length>0&&S>e.nodes[0].y-I&&S<l){const n=t.createLinearGradient(0,S,0,S+I);n.addColorStop(0,`${M}, 0)`),n.addColorStop(.5,`${M}, 1)`),n.addColorStop(1,`${M}, 0)`),t.strokeStyle=n,t.lineWidth=4,t.beginPath();let o=e.getXAtY(S);t.moveTo(o,S),t.lineTo(e.getXAtY(S+I),Math.min(S+I,l)),t.stroke()}t.globalCompositeOperation="destination-out",t.fillStyle="#000",e.nodes.forEach(e=>{e.radius&&(t.beginPath(),t.arc(e.x,e.y,e.radius,0,2*Math.PI),t.fill())}),t.globalCompositeOperation="source-over",e.nodes.forEach(e=>{const n=e.radius||20,o=e.x,a=e.y,s=S+I,r=a-n;if(s>r&&S<a+n){const e=e=>Math.max(0,Math.min(1,(e-r)/(2*n))),l=e(S),d=e(s),i=-Math.PI/2+l*Math.PI,c=-Math.PI/2+d*Math.PI;t.strokeStyle=`${M}, 1)`,t.lineWidth=2,t.beginPath(),t.arc(o,a,n+2,i,c,!1),t.stroke();const h=-Math.PI/2-l*Math.PI,u=-Math.PI/2-d*Math.PI;t.beginPath(),t.arc(o,a,n+2,h,u,!0),t.stroke()}}),setTimeout(e.renderLoop,1e3/60)}});