import e from"./Base.mjs";const t="function"==typeof requestAnimationFrame,o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,s=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,n={r:64,g:196,b:255},a={influenceRange:150,minMod:.2,maxMod:1.5,pulseBounds:-200};export default Neo.setupClass(class extends e{static colors={dark:{spine:["rgba(62, 99, 221, 0.2)","rgba(64, 196, 255, 0.4)","rgba(62, 99, 221, 0.2)"]},light:{spine:["rgba(150, 150, 150, 0.1)","rgba(150, 150, 150, 0.3)","rgba(150, 150, 150, 0.1)"]}};static config={className:"Portal.canvas.TicketCanvas",remote:{app:["clearGraph","initGraph","setTheme","updateGraphData","updateSize"]},singleton:!0,theme:"light"};baseSpeed=.5;lastFrameTime=0;nodes=[];pulseY=0;pulseBottom=100;startY=0;clearGraph(){let e=this;super.clearGraph(),e.nodes=[],e.lastFrameTime=0,e.pulseBottom=0}getXAtY(e){let t=this;if(t.nodes.length<2)return t.nodes[0]?.x||38;if(e<t.nodes[0].y)return t.nodes[0].x;for(let o=0;o<t.nodes.length-1;o++){let s=t.nodes[o],n=t.nodes[o+1];if(e>=s.y&&e<=n.y){let t=(e-s.y)/(n.y-s.y);return s.x+(n.x-s.x)*t}}return t.nodes[t.nodes.length-1].x}getPhysics(e){let t=1/0,o=null;this.nodes.forEach(s=>{let n=Math.abs(e-s.y);n<t&&(t=n,o=s)});const{influenceRange:s,minMod:n,maxMod:r}=a;let l=r;if(t<s){let e=t/s;l=n+e*e*(r-n)}return{speedModifier:l,nearNode:o,minDist:t}}hexToRgb(e){e=e.replace(s,function(e,t,o,s){return t+t+o+o+s+s});const t=o.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}updateGraphData(e){let t=this;t.nodes=e.nodes||[],void 0!==e.startY&&(t.startY=e.startY),e.reset&&(t.pulseY=a.pulseBounds,t.pulseBottom=a.pulseBounds+100,t.lastFrameTime=0),t.nodes.length>0&&!t.animationId&&t.context&&t.renderLoop()}render(){let e=this;if(!e.canRender)return;const o=e.context,s=e.canvasSize?.width||800,r=e.canvasSize?.height||600,l=Date.now();let i=r;e.nodes.length>0&&(i=e.nodes[e.nodes.length-1].y);let d=l-(e.lastFrameTime||l);e.lastFrameTime=l,d>100&&(d=16);const p=e.getPhysics(e.pulseY),u=e.getPhysics(e.pulseBottom),{nearNode:h,minDist:c}=p;e.pulseY+=e.baseSpeed*p.speedModifier*d,e.pulseBottom+=e.baseSpeed*u.speedModifier*d,e.pulseBottom<e.pulseY+15&&(e.pulseBottom=e.pulseY+15),e.pulseY>i-a.pulseBounds&&(e.pulseY=a.pulseBounds,e.pulseBottom=a.pulseBounds+100);const m=e.pulseBottom-e.pulseY;let{r:g,g:f,b:b}=n;if(h&&h.color&&c<100){let t=e.hexToRgb(h.color);if(t){let e=1-c/100;g+=(t.r-g)*e,f+=(t.g-f)*e,b+=(t.b-b)*e}}const y=`rgba(${Math.round(g)}, ${Math.round(f)}, ${Math.round(b)}`;o.clearRect(0,0,s,r);const x=e.constructor.colors[e.theme],M=o.createLinearGradient(0,0,0,r);if(M.addColorStop(0,x.spine[0]),M.addColorStop(.5,x.spine[1]),M.addColorStop(1,x.spine[2]),o.strokeStyle=M,o.lineWidth=2,o.beginPath(),e.nodes.length>0){let t=e.nodes[0];o.moveTo(t.x,t.y);for(let t=1;t<e.nodes.length;t++){let s=e.nodes[t];o.lineTo(s.x,s.y)}}o.stroke();const Y=e.pulseY;if(e.nodes.length>0&&Y>e.nodes[0].y-m&&Y<i){const t=o.createLinearGradient(0,Y,0,Y+m);t.addColorStop(0,`${y}, 0)`),t.addColorStop(.5,`${y}, 1)`),t.addColorStop(1,`${y}, 0)`),o.strokeStyle=t,o.lineWidth=4,o.beginPath();let s=e.getXAtY(Y);o.moveTo(s,Y),o.lineTo(e.getXAtY(Y+m),Math.min(Y+m,i)),o.stroke()}o.globalCompositeOperation="destination-out",o.fillStyle="#000",e.nodes.forEach(e=>{e.radius&&(o.beginPath(),o.arc(e.x,e.y,e.radius,0,2*Math.PI),o.fill())}),o.globalCompositeOperation="source-over",e.nodes.forEach(e=>{const t=e.radius||20,s=e.x,n=e.y,a=Y+m;if(a>n-t&&Y<n+t){const e=e=>{let o=e-n;return o=Math.max(-t,Math.min(t,o)),Math.asin(o/t)},r=e(Y),l=e(a);o.strokeStyle=`${y}, 1)`,o.lineWidth=2,o.beginPath(),o.arc(s,n,t+2,r,l,!1),o.stroke();const i=Math.PI-r,d=Math.PI-l;o.beginPath(),o.arc(s,n,t+2,i,d,!0),o.stroke()}}),e.animationId=t?requestAnimationFrame(e.renderLoop):setTimeout(e.renderLoop,1e3/60)}});