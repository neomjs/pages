import e from"../../../src/core/Base.mjs";const t="#3E63DD",a="#8BA6FF",l="#00BFFF",s=150;export default Neo.setupClass(class extends e{static config={className:"Portal.canvas.HomeCanvas",remote:{app:["clearGraph","initGraph","pause","resume","updateMouseState","updateSize"]},singleton:!0};agentBuffer=null;canvasId=null;canvasSize=null;context=null;gradients={};isPaused=!1;mouse={x:-1e3,y:-1e3};nodeBuffer=null;packetBuffer=null;shockwaves=[];sparks=[];time=0;clearGraph(){let e=this;e.context=null,e.canvasId=null,e.canvasSize=null,e.nodeBuffer=null,e.agentBuffer=null,e.packetBuffer=null,e.shockwaves=[],e.sparks=[],e.isPaused=!1,e.gradients={}}drawAgents(e){let t=this;if(!t.agentBuffer)return;const a=t.agentBuffer;e.strokeStyle=l,e.fillStyle="#FFFFFF",e.lineCap="round";for(let l=0;l<20;l++){let s=6*l,o=a[s],r=a[s+1],i=a[s+2],h=a[s+3],n=a[s+5];Math.sqrt(i*i+h*h)>.1&&(e.beginPath(),e.lineWidth=2,e.globalAlpha=.6,e.moveTo(o,r),e.lineTo(o-4*i,r-4*h),e.stroke()),e.beginPath(),e.globalAlpha=1===n?1:.8;let f=1===n?3:2;e.arc(o,r,f,0,2*Math.PI),e.fill(),1===n&&(e.beginPath(),e.lineWidth=1,e.globalAlpha=.3,e.arc(o,r,8+2*Math.sin(10*t.time),0,2*Math.PI),e.stroke())}e.globalAlpha=1}drawNetwork(e,o,r){let i=this;if(!i.nodeBuffer)return;const h=i.nodeBuffer,n=s,f=i.mouse.x,d=i.mouse.y,u=o/2,c=r/2;e.lineWidth=1;for(let s=0;s<n;s++){let o=9*s,r=h[o+5],i=h[o+6],p=2===r?.05:1===r?.02:.01,g=(-1e3!==f?f-u:0)*p,M=(-1e3!==d?d-c:0)*p,m=h[o]+g,k=h[o+1]+M;for(let o=s+1;o<n;o++){let n=9*o,p=h[n+5],g=h[n+6];if(!(i===g&&-1!==i)&&!(i===o||g===s)&&!(-1===i&&-1===g))continue;let M=2===p?.05:1===p?.02:.01,w=(-1e3!==f?f-u:0)*M,y=(-1e3!==d?d-c:0)*M,B=h[n]+w,v=h[n+1]+y,x=m-B,b=k-v,F=x*x+b*b;if(F<4e4){let s=Math.sqrt(F),o=1-s/200;o*=.2+.1*r;let i=(m+B)/2-f,h=(k+v)/2-d;i*i+h*h<1e4?(o=Math.min(o+.5,1),e.strokeStyle=l,e.lineWidth=1.5):(e.strokeStyle=2===r?t:a,e.lineWidth=1-s/200+.5),e.beginPath(),e.globalAlpha=.5*o,e.moveTo(m,k),e.lineTo(B,v),e.stroke()}}}for(let s=0;s<n;s++){let o=9*s,r=h[o+4],n=h[o+5],p=h[o+6],g=h[o+7],M=h[o+8],m=2===n?.05:1===n?.02:.01,k=(-1e3!==f?f-u:0)*m,w=(-1e3!==d?d-c:0)*m,y=h[o]+k,B=h[o+1]+w,v=y-f,x=B-d,b=Math.sqrt(v*v+x*x)<50;i.shockwaves.length>0&&i.shockwaves.forEach(e=>{let t=Math.sqrt((y-e.x)**2+(B-e.y)**2),a=e.age*e.speed;Math.abs(t-a)<20&&(b=!0)}),e.beginPath();let F=-1===p?1.5*r:r;F*=1+.15*Math.sin(2*i.time+g)+M,b&&(F*=1.5),e.arc(y,B,F,0,2*Math.PI),M>.1?(e.fillStyle=l,e.globalAlpha=Math.min(1,.5+M)):2===n?(e.fillStyle=b?"#FFFFFF":t,e.globalAlpha=b?1:.8):-2===p?(e.fillStyle=l,e.globalAlpha=.6+.3*Math.sin(10*i.time+g)):1===n?(e.fillStyle=b?l:a,e.globalAlpha=.5):(e.fillStyle="#808080",e.globalAlpha=.2),e.fill()}e.globalAlpha=1}drawPackets(e){if(!this.packetBuffer)return;const t=this.packetBuffer;e.fillStyle="#FFFFFF",e.shadowBlur=5,e.shadowColor=l;for(let a=0;a<20;a++){let l=5*a,s=t[l+4];if(s>0){let a=t[l],o=t[l+1];e.beginPath(),e.globalAlpha=Math.min(2*s,1),e.arc(a,o,2,0,2*Math.PI),e.fill()}}e.shadowBlur=0,e.globalAlpha=1}drawShockwaves(e){let a=this;if(0!==a.shockwaves.length){e.lineCap="round";for(let s=a.shockwaves.length-1;s>=0;s--){let o=a.shockwaves[s];o.age++;let r=o.age/o.maxAge;if(r>=1){a.shockwaves.splice(s,1);continue}let i=(1-Math.pow(1-r,3))*o.maxRadius,h=1-r;e.beginPath(),e.strokeStyle=l,e.globalAlpha=.8*h,e.lineWidth=4*(1-r),e.shadowBlur=10,e.shadowColor=l,e.arc(o.x,o.y,.99*i,0,2*Math.PI),e.stroke(),e.beginPath(),e.strokeStyle=t,e.globalAlpha=.8*h,e.lineWidth=4*(1-r),e.shadowBlur=10,e.shadowColor=t,e.arc(o.x,o.y,1.01*i,0,2*Math.PI),e.stroke(),e.beginPath(),e.strokeStyle="#FFFFFF",e.globalAlpha=h,e.lineWidth=6*(1-r),e.shadowBlur=20,e.shadowColor="#FFFFFF",e.arc(o.x,o.y,i,0,2*Math.PI),e.stroke(),e.fillStyle=t,e.globalAlpha=.05*h,e.fill()}e.shadowBlur=0,e.globalAlpha=1}}drawSparks(e){let t=this;if(0!==t.sparks.length){e.strokeStyle="#4B0082",e.shadowBlur=0,e.lineWidth=2;for(let a of t.sparks)e.globalAlpha=a.life,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x-2*a.vx,a.y-2*a.vy),e.stroke();e.globalAlpha=1}}initAgents(e,t){let a=this;a.agentBuffer||(a.agentBuffer=new Float32Array(120));const l=a.agentBuffer;for(let a=0;a<20;a++){let s=6*a;l[s]=Math.random()*e,l[s+1]=Math.random()*t,l[s+2]=4*(Math.random()-.5),l[s+3]=4*(Math.random()-.5),l[s+4]=-1,l[s+5]=0}}initGraph({canvasId:e,windowId:t}){let a=this,l=a.canvasId!==e;a.canvasId=e;const s=()=>{const o=Neo.currentWorker.canvasWindowMap[e]?.[t];o?(a.context=o.getContext("2d"),a.updateSize({width:o.width,height:o.height}),l&&a.renderLoop()):setTimeout(s,50)};s()}initNodes(e,t){let a=this;a.nodeBuffer||(a.nodeBuffer=new Float32Array(1350));const l=a.nodeBuffer,o=e/2,r=t/2,i=(1+Math.sqrt(5))/2,h=.8*Math.sqrt(e*t/s),n=Math.floor(15);let f=[];for(let a=0;a<s;a++){let s=9*a,d=a<n;d&&f.push(a);let u=2*a*Math.PI*i,c=Math.sqrt(a)*h,p=o+c*Math.cos(u),g=r+c*Math.sin(u);p=(p%e+e)%e,g=(g%t+t)%t,l[s]=p,l[s+1]=g,l[s+2]=.2*(Math.random()-.5),l[s+3]=.2*(Math.random()-.5);let M=Math.floor(3*Math.random());l[s+5]=M,l[s+4]=d?4+2*M:2+1.5*M,l[s+6]=d?-1:-2,l[s+7]=Math.random()*Math.PI*2,l[s+8]=0}for(let e=n;e<s;e++){let t=9*e,a=l[t],s=l[t+1],o=1/0,r=-1;for(let e of f){let t=9*e,i=a-l[t],h=s-l[t+1],n=i*i+h*h;n<o&&(o=n,r=e)}l[t+6]=r}}initPackets(){let e=this;e.packetBuffer||(e.packetBuffer=new Float32Array(100))}pause(){this.isPaused=!0}resume(){let e=this;e.isPaused&&(e.isPaused=!1,e.renderLoop())}renderLoop=this.render.bind(this);render(){let e=this;if(!e.context||e.isPaused)return;const t=e.context,a=e.canvasSize?.width||100,l=e.canvasSize?.height||50;e.time+=.01,e.nodeBuffer||e.initNodes(a,l),e.agentBuffer||e.initAgents(a,l),e.packetBuffer||e.initPackets(),e.updatePhysics(a,l),e.updateAgents(a,l),e.updatePackets(),e.updateSparks(),t.clearRect(0,0,a,l),e.gradients.bgGradient&&(t.fillStyle=e.gradients.bgGradient,t.fillRect(0,0,a,l)),e.drawNetwork(t,a,l),e.drawPackets(t),e.drawAgents(t),e.drawShockwaves(t),e.drawSparks(t),setTimeout(e.renderLoop,1e3/60)}updateMouseState(e){let t=this;if(e.leave)t.mouse.x=-1e3,t.mouse.y=-1e3;else if(void 0!==e.x&&(t.mouse.x=e.x),void 0!==e.y&&(t.mouse.y=e.y),e.click){t.shockwaves.push({x:e.x,y:e.y,age:0,maxAge:40,maxRadius:300});for(let a=0;a<40;a++){let a=Math.random()*Math.PI*2,l=15*Math.random()+5;t.sparks.push({x:e.x,y:e.y,vx:Math.cos(a)*l,vy:Math.sin(a)*l,life:1,decay:.02+.03*Math.random()})}}}updatePackets(){let e=this;if(!e.packetBuffer||!e.nodeBuffer)return;const t=e.packetBuffer,a=e.nodeBuffer;for(let e=0;e<20;e++){let l=5*e;if(t[l+4]<=0){if(Math.random()<.02){let e=9*Math.floor(150*Math.random()),s=a[e+6];if(-1!==s){let o=9*s,r=a[e],i=a[e+1],h=a[o]-r,n=a[o+1]-i,f=Math.sqrt(h*h+n*n);if(f<200){t[l]=r,t[l+1]=i;let e=4;t[l+2]=h/f*e,t[l+3]=n/f*e,t[l+4]=f/e}}}}else t[l]+=t[l+2],t[l+1]+=t[l+3],t[l+4]--}}updateSparks(){let e=this;for(let t=e.sparks.length-1;t>=0;t--){let a=e.sparks[t];a.x+=a.vx,a.y+=a.vy,a.vx*=.9,a.vy*=.9,a.life-=a.decay,a.life<=0&&e.sparks.splice(t,1)}}updateAgents(e,t){let a=this;if(!a.agentBuffer||!a.nodeBuffer)return;const l=a.agentBuffer,s=a.nodeBuffer,o=a.mouse.x,r=a.mouse.y;for(let a=0;a<20;a++){let i=6*a,h=l[i+4],n=l[i+5];if(-1===h||Math.random()<.005){const e=Math.floor(15);l[i+4]=Math.floor(Math.random()*e),h=l[i+4],l[i+5]=0}if(-1!==h&&0===n){let e=9*h,t=s[e],a=s[e+1],o=t-l[i],r=a-l[i+1],n=Math.sqrt(o*o+r*r);if(n<10)l[i+5]=1,l[i+2]*=.1,l[i+3]*=.1,s[e+8]=1;else{let e=.05;l[i+2]+=o/n*e,l[i+3]+=r/n*e}}else 1===n&&Math.random()<.02&&(l[i+4]=-1,l[i+5]=0,l[i+2]+=4*(Math.random()-.5),l[i+3]+=4*(Math.random()-.5));if(-1e3!==o){let e=l[i]-o,t=l[i+1]-r,a=e*e+t*t;if(a<1e4){let s=Math.sqrt(a),o=(100-s)/100;l[i+2]+=e/s*o*1.5,l[i+3]+=t/s*o*1.5,l[i+5]=0}}let f=Math.sqrt(l[i+2]**2+l[i+3]**2);f>4&&(l[i+2]*=4/f,l[i+3]*=4/f),l[i]+=l[i+2],l[i+1]+=l[i+3],l[i]<0&&(l[i]=e),l[i]>e&&(l[i]=0),l[i+1]<0&&(l[i+1]=t),l[i+1]>t&&(l[i+1]=0)}}updatePhysics(e,t){let a=this;if(!a.nodeBuffer)return;const l=a.nodeBuffer,o=a.mouse.x,r=a.mouse.y,i=Math.floor(15);for(let h=0;h<s;h++){let s=9*h,n=l[s+6],f=-1===n;if(!f&&(-2!==n&&Math.random()<5e-4&&(l[s+6]=-2,l[s+2]+=2*(Math.random()-.5),l[s+3]+=2*(Math.random()-.5)),-2===n)){l[s+2]+=.1*(Math.random()-.5),l[s+3]+=.1*(Math.random()-.5);for(let e=0;e<i;e++){let t=9*e,a=l[t],o=l[t+1];if(Math.sqrt((a-l[s])**2+(o-l[s+1])**2)<60){l[s+6]=e;break}}}if(!f&&-2!==l[s+6]){let e=9*n,t=l[e],a=l[e+1],o=t-l[s],r=a-l[s+1],i=Math.sqrt(o*o+r*r);if(i>50){let e=5e-4*(i-50);l[s+2]+=o*e,l[s+3]+=r*e}}if(-1e3!==o){let e=l[s]-o,t=l[s+1]-r,a=e*e+t*t;if(a<22500){let o=Math.sqrt(a),r=(150-o)/150;l[s+2]+=e/o*r*.5,l[s+3]+=t/o*r*.5}}a.shockwaves.length>0&&a.shockwaves.forEach(e=>{let t=e.age/e.maxAge;if(t<1){let a=(1-Math.pow(1-t,3))*e.maxRadius,o=l[s]-e.x,r=l[s+1]-e.y,i=Math.sqrt(o*o+r*r);if(Math.abs(i-a)<20){let e=1-t;l[s+2]+=o/i*e*10,l[s+3]+=r/i*e*10}}}),l[s+2]*=.95,l[s+3]*=.95,l[s+8]*=.99;if(f){let o=(Math.cos(.002*l[s]+.5*a.time)+Math.sin(.002*l[s+1]+.5*a.time))*Math.PI;l[s+2]+=.05*Math.cos(o),l[s+3]+=.05*Math.sin(o);let r=t/2,i=e/2-l[s],h=r-l[s+1],n=Math.sqrt(i*i+h*h),f=.4*Math.min(e,t);if(n>f){let e=.001*(n-f);l[s+2]+=i/n*e,l[s+3]+=h/n*e}}else Math.abs(l[s+2])<.2&&(l[s+2]+=.02*(Math.random()-.5)),Math.abs(l[s+3])<.2&&(l[s+3]+=.02*(Math.random()-.5));l[s]+=l[s+2],l[s+1]+=l[s+3];const d=20;l[s]<d&&(l[s]=d,l[s+2]*=-1),l[s]>e-d&&(l[s]=e-d,l[s+2]*=-1),l[s+1]<d&&(l[s+1]=d,l[s+3]*=-1),l[s+1]>t-d&&(l[s+1]=t-d,l[s+3]*=-1)}}updateResources(e,t){let a=this.context;if(!a)return;const l=a.createLinearGradient(0,0,e,t);l.addColorStop(0,"rgba(62, 99, 221, 0.05)"),l.addColorStop(1,"rgba(139, 166, 255, 0.05)"),this.gradients.bgGradient=l}updateSize(e){let t=this;t.canvasSize=e,t.context&&(t.context.canvas.width=e.width,t.context.canvas.height=e.height,t.initNodes(e.width,e.height),t.initAgents(e.width,e.height),t.updateResources(e.width,e.height))}});