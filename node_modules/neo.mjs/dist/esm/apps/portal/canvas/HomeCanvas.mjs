import e from"./Base.mjs";const t="function"==typeof requestAnimationFrame,a="#3E63DD",l="#536DFE",o="#00BFFF",r=150;export default Neo.setupClass(class extends e{static colors={dark:{agentHead:"#FFFFFF",background:["rgba(62, 99, 221, 0.15)","rgba(139, 166, 255, 0.15)"],nodeHigh:"#FFFFFF",packet:"#FFFFFF",shockwave:"#FFFFFF",spark:"#4B0082"},light:{agentHead:"#3E63DD",background:["rgba(62, 99, 221, 0.05)","rgba(139, 166, 255, 0.05)"],nodeHigh:"#3E63DD",packet:"#3E63DD",shockwave:"#3E63DD",spark:"#4B0082"}};static config={className:"Portal.canvas.HomeCanvas",singleton:!0};agentBuffer=null;nodeBuffer=null;packetBuffer=null;shockwaves=[];sparks=[];scale=1;clearGraph(){let e=this;super.clearGraph(),e.nodeBuffer=null,e.agentBuffer=null,e.packetBuffer=null,e.shockwaves=[],e.sparks=[],e.scale=1}onGraphMounted(e,t){this.updateSize({width:e,height:t})}drawAgents(e){let t=this;if(!t.agentBuffer)return;const a=t.agentBuffer,l=t.constructor.colors[t.theme],r=t.scale;e.strokeStyle=o,e.fillStyle=l.agentHead,e.lineCap="round";for(let l=0;l<20;l++){let o=6*l,s=a[o],h=a[o+1],n=a[o+2],i=a[o+3],f=a[o+5];Math.sqrt(n*n+i*i)>.1*r&&(e.beginPath(),e.lineWidth=2*r,e.globalAlpha=.6,e.moveTo(s,h),e.lineTo(s-4*n,h-4*i),e.stroke()),e.beginPath(),e.globalAlpha=1===f?1:.8;let c=(1===f?3:2)*r;e.arc(s,h,c,0,2*Math.PI),e.fill(),1===f&&(e.beginPath(),e.lineWidth=1*r,e.globalAlpha=.3,e.arc(s,h,(8+2*Math.sin(10*t.time))*r,0,2*Math.PI),e.stroke())}e.globalAlpha=1}drawNetwork(e,t,s){let h=this;if(!h.nodeBuffer)return;const n=h.nodeBuffer,i=r,f=h.mouse.x,c=h.mouse.y,d=t/2,u=s/2,g=h.constructor.colors[h.theme],p=h.scale;e.lineWidth=1*p;for(let t=0;t<i;t++){let r=9*t,s=n[r+5],h=n[r+6],g=2===s?.05:1===s?.02:.01,M=(-1e3!==f?f-d:0)*g,k=(-1e3!==c?c-u:0)*g,m=n[r]+M,w=n[r+1]+k;for(let r=t+1;r<i;r++){let i=9*r,g=n[i+5],M=n[i+6];if(!(h===M&&-1!==h)&&!(h===r||M===t)&&!(-1===h&&-1===M))continue;let k=2===g?.05:1===g?.02:.01,b=(-1e3!==f?f-d:0)*k,B=(-1e3!==c?c-u:0)*k,y=n[i]+b,v=n[i+1]+B,A=m-y,F=w-v,x=A*A+F*F;if(x<4e4*p*p){let t=Math.sqrt(x),r=1-t/(200*p);r*=.2+.1*s;let h=(m+y)/2-f,n=(w+v)/2-c;h*h+n*n<1e4*p*p?(r=Math.min(r+.5,1),e.strokeStyle=o,e.lineWidth=1.5*p):(e.strokeStyle=2===s?a:l,e.lineWidth=(1-t/(200*p)+.5)*p),e.beginPath(),e.globalAlpha=.5*r,e.moveTo(m,w),e.lineTo(y,v),e.stroke()}}}for(let t=0;t<i;t++){let r=9*t,s=n[r+4],i=n[r+5],M=n[r+6],k=n[r+7],m=n[r+8];if(p<.5&&0===i)continue;let w=2===i?.05:1===i?.02:.01,b=(-1e3!==f?f-d:0)*w,B=(-1e3!==c?c-u:0)*w,y=n[r]+b,v=n[r+1]+B,A=y-f,F=v-c,x=Math.sqrt(A*A+F*F)<50*p;h.shockwaves.length>0&&h.shockwaves.forEach(e=>{let t=Math.sqrt((y-e.x)**2+(v-e.y)**2),a=e.age*e.speed;Math.abs(t-a)<20*p&&(x=!0)}),e.beginPath();let P=-1===M?1.5*s:s;P*=1+.15*Math.sin(2*h.time+k)+m,x&&(P*=1.5),e.arc(y,v,P,0,2*Math.PI),m>.1?(e.fillStyle=o,e.globalAlpha=Math.min(1,.5+m)):2===i?(e.fillStyle=x?g.nodeHigh:a,e.globalAlpha=x?1:.8):-2===M?(e.fillStyle=o,e.globalAlpha=.6+.3*Math.sin(10*h.time+k)):1===i?(e.fillStyle=x?o:l,e.globalAlpha=.5):(e.fillStyle="#808080",e.globalAlpha=.2),e.fill()}e.globalAlpha=1}drawPackets(e){let t=this;if(!t.packetBuffer)return;const a=t.packetBuffer,l=t.constructor.colors[t.theme];e.fillStyle=l.packet,e.shadowBlur=5,e.shadowColor=o;for(let t=0;t<20;t++){let l=5*t,o=a[l+4];if(o>0){let t=a[l],r=a[l+1];e.beginPath(),e.globalAlpha=Math.min(2*o,1),e.arc(t,r,2,0,2*Math.PI),e.fill()}}e.shadowBlur=0,e.globalAlpha=1}drawShockwaves(e){let t=this;if(0===t.shockwaves.length)return;const l=t.constructor.colors[t.theme],r=t.scale;e.lineCap="round";for(let s=t.shockwaves.length-1;s>=0;s--){let h=t.shockwaves[s];h.age++;let n=h.age/h.maxAge;if(n>=1){t.shockwaves.splice(s,1);continue}let i=(1-Math.pow(1-n,3))*h.maxRadius,f=1-n;e.beginPath(),e.strokeStyle=o,e.globalAlpha=.8*f,e.lineWidth=4*(1-n)*r,e.shadowBlur=10*r,e.shadowColor=o,e.arc(h.x,h.y,.99*i,0,2*Math.PI),e.stroke(),e.beginPath(),e.strokeStyle=a,e.globalAlpha=.8*f,e.lineWidth=4*(1-n)*r,e.shadowBlur=10*r,e.shadowColor=a,e.arc(h.x,h.y,1.01*i,0,2*Math.PI),e.stroke(),e.beginPath(),e.strokeStyle=l.shockwave,e.globalAlpha=f,e.lineWidth=6*(1-n)*r,e.shadowBlur=20*r,e.shadowColor=l.shockwave,e.arc(h.x,h.y,i,0,2*Math.PI),e.stroke(),e.fillStyle=a,e.globalAlpha=.05*f,e.fill()}e.shadowBlur=0,e.globalAlpha=1}drawSparks(e){let t=this;if(0===t.sparks.length)return;const a=t.constructor.colors[t.theme],l=t.scale;e.strokeStyle=a.spark,e.shadowBlur=0,e.lineWidth=2*l;for(let a of t.sparks)e.globalAlpha=a.life,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x-2*a.vx,a.y-2*a.vy),e.stroke();e.globalAlpha=1}initAgents(e,t){let a=this;a.agentBuffer||(a.agentBuffer=new Float32Array(120));const l=a.agentBuffer,o=a.scale;for(let a=0;a<20;a++){let r=6*a;l[r]=Math.random()*e,l[r+1]=Math.random()*t,l[r+2]=4*(Math.random()-.5)*o,l[r+3]=4*(Math.random()-.5)*o,l[r+4]=-1,l[r+5]=0}}initNodes(e,t){let a=this;a.nodeBuffer||(a.nodeBuffer=new Float32Array(1350));const l=a.nodeBuffer,o=e/2,s=t/2,h=(1+Math.sqrt(5))/2,n=.8*Math.sqrt(e*t/r),i=Math.floor(15),f=a.scale;let c=[];for(let a=0;a<r;a++){let r=9*a,d=a<i;d&&c.push(a);let u=2*a*Math.PI*h,g=Math.sqrt(a)*n,p=o+g*Math.cos(u),M=s+g*Math.sin(u);p=(p%e+e)%e,M=(M%t+t)%t,l[r]=p,l[r+1]=M,l[r+2]=.2*(Math.random()-.5)*f,l[r+3]=.2*(Math.random()-.5)*f;let k=Math.floor(3*Math.random());l[r+5]=k,l[r+4]=(d?4+2*k:2+1.5*k)*f,l[r+6]=d?-1:-2,l[r+7]=Math.random()*Math.PI*2,l[r+8]=0}for(let e=i;e<r;e++){let t=9*e,a=l[t],o=l[t+1],r=1/0,s=-1;for(let e of c){let t=9*e,h=a-l[t],n=o-l[t+1],i=h*h+n*n;i<r&&(r=i,s=e)}l[t+6]=s}}initPackets(){let e=this;e.packetBuffer||(e.packetBuffer=new Float32Array(100))}renderLoop=this.render.bind(this);render(){let e=this;if(!e.canRender)return;const a=e.context,l=e.canvasSize?.width||100,o=e.canvasSize?.height||50;e.time+=.01,e.nodeBuffer||e.initNodes(l,o),e.agentBuffer||e.initAgents(l,o),e.packetBuffer||e.initPackets(),e.updatePhysics(l,o),e.updateAgents(l,o),e.updatePackets(),e.updateSparks(),a.clearRect(0,0,l,o),e.gradients.bgGradient&&(a.fillStyle=e.gradients.bgGradient,a.fillRect(0,0,l,o)),e.drawNetwork(a,l,o),e.drawPackets(a),e.drawAgents(a),e.drawShockwaves(a),e.drawSparks(a),e.animationId=t?requestAnimationFrame(e.renderLoop):setTimeout(e.renderLoop,1e3/60)}onMouseClick(e){let t=this,a=t.scale;t.shockwaves.push({x:e.x,y:e.y,age:0,maxAge:40,maxRadius:300*a});for(let l=0;l<40;l++){let l=Math.random()*Math.PI*2,o=(15*Math.random()+5)*a;t.sparks.push({x:e.x,y:e.y,vx:Math.cos(l)*o,vy:Math.sin(l)*o,life:1,decay:.02+.03*Math.random()})}}updatePackets(){let e=this;if(!e.packetBuffer||!e.nodeBuffer)return;const t=e.packetBuffer,a=e.nodeBuffer,l=e.scale;for(let e=0;e<20;e++){let o=5*e;if(t[o+4]<=0){if(Math.random()<.02){let e=9*Math.floor(150*Math.random()),r=a[e+6];if(-1!==r){let s=9*r,h=a[e],n=a[e+1],i=a[s]-h,f=a[s+1]-n,c=Math.sqrt(i*i+f*f);if(c<200*l){t[o]=h,t[o+1]=n;let e=4*l;t[o+2]=i/c*e,t[o+3]=f/c*e,t[o+4]=c/e}}}}else t[o]+=t[o+2],t[o+1]+=t[o+3],t[o+4]--}}updateSparks(){let e=this;for(let t=e.sparks.length-1;t>=0;t--){let a=e.sparks[t];a.x+=a.vx,a.y+=a.vy,a.vx*=.9,a.vy*=.9,a.life-=a.decay,a.life<=0&&e.sparks.splice(t,1)}}updateAgents(e,t){let a=this;if(!a.agentBuffer||!a.nodeBuffer)return;const l=a.agentBuffer,o=a.nodeBuffer,r=a.mouse.x,s=a.mouse.y,h=a.scale;for(let a=0;a<20;a++){let n=6*a,i=l[n+4],f=l[n+5];if(-1===i||Math.random()<.005){const e=Math.floor(15);l[n+4]=Math.floor(Math.random()*e),i=l[n+4],l[n+5]=0}if(-1!==i&&0===f){let e=9*i,t=o[e],a=o[e+1],r=t-l[n],s=a-l[n+1],f=Math.sqrt(r*r+s*s);if(f<10*h)l[n+5]=1,l[n+2]*=.1,l[n+3]*=.1,o[e+8]=1;else{let e=.05*h;l[n+2]+=r/f*e,l[n+3]+=s/f*e}}else 1===f&&Math.random()<.02&&(l[n+4]=-1,l[n+5]=0,l[n+2]+=4*(Math.random()-.5)*h,l[n+3]+=4*(Math.random()-.5)*h);if(-1e3!==r){let e=l[n]-r,t=l[n+1]-s,a=e*e+t*t;if(a<1e4*h*h){let o=Math.sqrt(a),r=(100*h-o)/(100*h);l[n+2]+=e/o*r*1.5*h,l[n+3]+=t/o*r*1.5*h,l[n+5]=0}}let c=Math.sqrt(l[n+2]**2+l[n+3]**2);c>4*h&&(l[n+2]*=4*h/c,l[n+3]*=4*h/c),l[n]+=l[n+2],l[n+1]+=l[n+3],l[n]<0&&(l[n]=e),l[n]>e&&(l[n]=0),l[n+1]<0&&(l[n+1]=t),l[n+1]>t&&(l[n+1]=0)}}updatePhysics(e,t){let a=this;if(!a.nodeBuffer)return;const l=a.nodeBuffer,o=a.mouse.x,s=a.mouse.y,h=Math.floor(15),n=a.scale;for(let i=0;i<r;i++){let r=9*i,f=l[r+6],c=-1===f;if(!c&&(-2!==f&&Math.random()<5e-4&&(l[r+6]=-2,l[r+2]+=2*(Math.random()-.5)*n,l[r+3]+=2*(Math.random()-.5)*n),-2===f)){l[r+2]+=.1*(Math.random()-.5)*n,l[r+3]+=.1*(Math.random()-.5)*n;for(let e=0;e<h;e++){let t=9*e,a=l[t],o=l[t+1];if(Math.sqrt((a-l[r])**2+(o-l[r+1])**2)<60*n){l[r+6]=e;break}}}if(!c&&-2!==l[r+6]){let e=9*f,t=l[e],a=l[e+1],o=t-l[r],s=a-l[r+1],h=Math.sqrt(o*o+s*s);if(h>50*n){let e=5e-4*(h-50*n);l[r+2]+=o*e,l[r+3]+=s*e}}if(-1e3!==o){let e=l[r]-o,t=l[r+1]-s,a=e*e+t*t;if(a<22500*n*n){let o=Math.sqrt(a),s=(150*n-o)/(150*n);l[r+2]+=e/o*s*.5*n,l[r+3]+=t/o*s*.5*n}}a.shockwaves.length>0&&a.shockwaves.forEach(e=>{let t=e.age/e.maxAge;if(t<1){let a=(1-Math.pow(1-t,3))*e.maxRadius,o=l[r]-e.x,s=l[r+1]-e.y,h=Math.sqrt(o*o+s*s);if(Math.abs(h-a)<20*n){let e=1-t;l[r+2]+=o/h*e*10*n,l[r+3]+=s/h*e*10*n}}}),l[r+2]*=.95,l[r+3]*=.95,l[r+8]*=.99;if(c){let o=(Math.cos(.002*l[r]/n+.5*a.time)+Math.sin(.002*l[r+1]/n+.5*a.time))*Math.PI;l[r+2]+=.05*Math.cos(o)*n,l[r+3]+=.05*Math.sin(o)*n;let s=t/2,h=e/2-l[r],i=s-l[r+1],f=Math.sqrt(h*h+i*i),c=.4*Math.min(e,t);if(f>c){let e=.001*(f-c);l[r+2]+=h/f*e,l[r+3]+=i/f*e}}else Math.abs(l[r+2])<.2*n&&(l[r+2]+=.02*(Math.random()-.5)*n),Math.abs(l[r+3])<.2*n&&(l[r+3]+=.02*(Math.random()-.5)*n);l[r]+=l[r+2],l[r+1]+=l[r+3];const d=20*n;l[r]<d&&(l[r]=d,l[r+2]*=-1),l[r]>e-d&&(l[r]=e-d,l[r+2]*=-1),l[r+1]<d&&(l[r+1]=d,l[r+3]*=-1),l[r+1]>t-d&&(l[r+1]=t-d,l[r+3]*=-1)}}updateResources(e,t){let a=this,l=a.context;if(!l)return;const o=a.constructor.colors[a.theme],r=l.createLinearGradient(0,0,e,t);r.addColorStop(0,o.background[0]),r.addColorStop(1,o.background[1]),a.gradients.bgGradient=r}updateSize(e){let t=this;t.canvasSize=e,t.scale=Math.sqrt(e.width*e.height/2073600),t.context&&(t.context.canvas.width=e.width,t.context.canvas.height=e.height,t.initNodes(e.width,e.height),t.initAgents(e.width,e.height),t.updateResources(e.width,e.height))}});