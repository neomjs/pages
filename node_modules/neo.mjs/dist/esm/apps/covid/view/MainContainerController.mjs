import e from"../../../src/controller/Component.mjs";import a from"../../../src/util/Array.mjs";import t from"../Util.mjs";class o extends e{static config={className:"Covid.view.MainContainerController",ntype:"maincontainer-controller",activeMainTabIndex:0,apiFallbackSummaryUrl:"https://raw.githubusercontent.com/neomjs/pages/main/resources_pub/data/cvid_static/all.json",apiFallbackUrl:"https://raw.githubusercontent.com/neomjs/pages/main/resources_pub/data/cvid_static_countries.json",apiSummaryUrl:"https://disease.sh/v3/covid-19/all",apiUrl:"https://disease.sh/v3/covid-19/countries",countryRecord:null,data:null,mainTabs:["table","mapboxglmap","worldmap","gallery","helix","attribution"],mapboxglMapHasData:!1,summaryData:null,worldMapHasData:!1};addStoreItems(e){let a=this,t=a.getReference("country-field"),o=t.store,n=a.mainTabs[a.activeMainTabIndex],l=a.getReference(n);e.forEach(e=>{e.country.includes('"')&&(e.country=e.country.replace('"',"'")),e.casesPerOneMillion=e.casesPerOneMillion>e.cases?"N/A":e.casesPerOneMillion||0,e.infected=e.casesPerOneMillion}),a.data=e,o.getCount()<1&&(o.data=e,a.onCountryFieldChange({component:t,value:t.value})),["gallery","helix","table"].includes(n)?l&&(l.store.data=e):"mapboxglmap"===n?(a.getReference("mapboxglmap").chartData=e,a.mapboxglMapHasData=!0):"worldmap"===n&&(l.loadData(e),a.worldMapHasData=!0)}applySummaryData(e){let a,o=this,n=o.getReference("total-stats");o.summaryData=e,n.items[0].vdom.cn[1].text=t.formatNumber({value:e.cases}),n.items[1].vdom.cn[1].text=t.formatNumber({value:e.active}),n.items[2].vdom.cn[1].text=t.formatNumber({value:e.recovered}),n.items[3].vdom.cn[1].text=t.formatNumber({value:e.deaths}),n.updateDepth=2,n.update(),n=o.getReference("last-update"),a=n.vdom,a.text="Last Update: "+new Intl.DateTimeFormat("default",{hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(e.updated)),n.update()}getTabIndex(e){return e&&e.mainview?this.mainTabs.indexOf(e.mainview):0}getView(e){return this.getReference(this.mainTabs[e])}loadData(){let e=this,a=Neo.config.useFallbackApi?e.apiFallbackUrl:e.apiUrl;fetch(a).then(e=>e.json()).catch(e=>console.log("Can’t access "+a,e)).then(a=>e.addStoreItems(a))}loadSummaryData(){let e=this,a=Neo.config.useFallbackApi?e.apiFallbackSummaryUrl:e.apiSummaryUrl;fetch(a).then(e=>e.json()).catch(e=>console.log("Can’t access "+a,e)).then(a=>e.applySummaryData(a)),e.timeout(2e3).then(()=>{e.summaryData||e.onLoadSummaryDataFail()})}onComponentConstructed(){super.onComponentConstructed(),Neo.config.hash||this.onHashChange({country:"all",hash:{mainview:"table"},hashString:"mainview=table"},null)}onConstructed(){super.onConstructed();let e=this;e.loadData(),e.loadSummaryData(),e.component.on("mounted",e.onMainViewMounted,e)}onCountryFieldChange(e){let a,t=e.component,o=t.store,n=e.value;o.getCount()>0&&(Neo.isRecord(n)?(a=n,n=n[t.displayField]):a=n&&o.find("country",n)?.[0],this.setState({country:n,countryRecord:a||null}))}onHashChange(e,a){let t,n,l=this,r=l.getTabIndex(e.hash),s=l.getView(r),i=e.hash?.country;l.getReference("tab-container").activeIndex=r,l.activeMainTabIndex=r,s?(l.setState({country:i||null}),n=s.ntype,l.data&&s.store?.getCount()<1&&(s.store.data=l.data),"mapboxgl"===n&&l.data?(l.mapboxStyle&&(s.mapboxStyle=s[l.mapboxStyle],delete l.mapboxStyle),l.mapboxglMapHasData||(s.chartData=l.data,l.mapboxglMapHasData=!0),t=l.getStateProvider().data.countryRecord,t&&o.selectMapboxGlCountry(s,t),s.autoResize()):"covid-world-map"===n&&l.data&&(l.worldMapHasData||(s.loadData(l.data),l.worldMapHasData=!0))):l.timeout(10).then(()=>{l.onHashChange(e,a)})}onLoadSummaryDataFail(){let e=this.getReference("table");e.vdom.cn[0].cn[1].cn.push({cls:["neo-box-label","neo-label"],style:{margin:"20px"},html:["Summary data did not arrive after 2s.</br>","Please double-check if the API is offline:</br></br>",'<a target="_blank" href="https://disease.sh/all">NovelCOVID/API all endpoint</a></br></br>',"and if so please try again later."].join("")}),e.update()}onMainViewMounted(){let e=this;Neo.main.DomAccess.addScript({async:!0,defer:!0,src:"https://buttons.github.io/buttons.js",windowId:e.windowId}),e.getReference("tab-container").on("moveTo",e.onTabMove,e)}onReloadDataButtonClick(e){this.loadData(),this.loadSummaryData()}onRemoveFooterButtonClick(e){let a=this,t=a.getReference("tab-container").getActiveCard();a.component.remove(a.getReference("footer"),!0),"covid-mapboxgl-container"===t.ntype&&a.getReference("mapboxglmap").autoResize()}onSwitchThemeButtonClick(e){let t,o,n,l,r,s=this,i=e.component,c=s.component,m=s.getReference("logo"),d=s.getReference("mapboxglmap"),u="Theme Light"===i.text;u?(t="Theme Dark",n="fa fa-moon",l=d?.mapboxStyleLight,r="neo-theme-light"):(t="Theme Light",n="fa fa-sun",l=d?.mapboxStyleDark,r="neo-theme-dark"),m.vdom.src="https://raw.githubusercontent.com/neomjs/pages/main/resources_pub/images/apps/covid/"+("neo-theme-dark"===r?"covid_logo_dark.jpg":"covid_logo_light.jpg"),m.update(),o=[...c.cls],c.cls.forEach(e=>{e.includes("neo-theme")&&a.remove(o,e)}),a.add(o,r),c.cls=o,i.set({iconCls:n,text:t}),d?d.mapboxStyle=l:s.mapboxStyle=u?"mapboxStyleLight":"mapboxStyleDark"}onTabMove(e){a.move(this.mainTabs,e.fromIndex,e.toIndex)}static selectMapboxGlCountry(e,a){const t={FRA:["match",["get","NAME"],["France"],!0,!1],NOR:["match",["get","NAME"],["Norway"],!0,!1],default:["match",["get","ISO_A3"],[a.countryInfo.iso3],!0,!1]};e.setFilter({layerId:"ne-10m-admin-0-countries-4s7rvf",value:t[a.countryInfo.iso3]||t.default}),e.flyTo({lat:a.countryInfo.lat,lng:a.countryInfo.long}),e.zoom=5}}export default Neo.setupClass(o);