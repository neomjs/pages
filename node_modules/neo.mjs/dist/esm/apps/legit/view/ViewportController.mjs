import e from"../../../src/controller/Component.mjs";import t from"../service/Legit.mjs";export default Neo.setupClass(class extends e{static config={className:"Legit.view.ViewportController",pollingInterval:1e3};addDialog=null;currentTreeState=null;running=!1;async initAsync(){await super.initAsync();const e=this;await t.ready(),e.getReference("new-file-button").disabled=!1,e.getReference("save-button").disabled=!1,setInterval(e.poll.bind(e),e.pollingInterval)}async onAddFileDialogSave(e){const a=this.addDialog,n=a.getReference("filename"),o=`${t.path}/${n.value}`;a.hide(),console.log("onAddFileDialogSave",n.value),await t.writeFile({data:"",path:o}),this.setState({currentFile:o})}onCommitColumnRenderer(e){return"author"===e.dataField?e.value.name:"timestamp"===e.dataField?new Intl.DateTimeFormat("default",{hour:"numeric",minute:"numeric",second:"numeric"}).format(new Date(1e3*e.value)):e.value}onFileItemClick(e){console.log("onFileItemClick",e)}async onEditorChange(e){}async onNewFileButtonClick(e){let t=this,{addDialog:a}=t,n=e.component,{appName:o,theme:i,windowId:l}=n;n.disabled=!0,a?a.show():import("./AddFileDialog.mjs").then(e=>{t.addDialog=Neo.create({module:e.default,animateTargetId:n.id,appName:o,listeners:{hide:e=>{n.disabled=!1}},parentComponent:t.component,theme:i,windowId:l})})}async onSaveButtonClick(e){const a=this,n=a.getReference("code-live-preview"),o=a.getState("currentFile");console.log("onSaveButtonClick",a.getState("currentFile"),n.value),await t.writeFile({data:n.value,path:`${t.path}/${o}`})}async onTreeListSelect({records:e}){const a=this.getReference("code-live-preview"),n=e?.[0],o=n.id.includes(".md")?"markdown":"neomjs";if(n?.isLeaf){this.setState({currentFile:n.id});const e=await t.readFile(`${t.path}/${n.id}`,"utf-8");await a.set({language:o,value:e})}}async poll(){let e=this;if(!e.running)try{e.running=!0;let a=await t.readFile(t.path+"/.legit/head","utf-8");if(e.currentTreeState===a)return;const n=e.getStore("commitStore"),o=e.getStore("fileStore"),i=await t.loadTreeDelta(e.currentTreeState,a);n.data=await t.loadHistory(),console.log("TREE DELTA:",i);for(const e of i.deleted)console.log("Deleted FROM TREE: "+e),o.remove(e);for(const e of i.added)console.log("Added From Tree:"+e),o.insert(0,{id:e,name:e,parentId:null});for(const e of i.modified)console.log("MODIFIED From Tree:"+e);e.currentTreeState=a}finally{e.running=!1;let t=e.getReference("files-tree").selectionModel;t.hasSelection()||t.selectAt(0)}}});