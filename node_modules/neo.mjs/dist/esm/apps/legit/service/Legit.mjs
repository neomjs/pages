import t from"../../../src/core/Base.mjs";export default Neo.setupClass(class extends t{static config={className:"Legit.service.Legit",fs:null,legitFs:null,path:"/.legit/branches/anonymous",singleton:!0};async initAsync(){await super.initAsync();const t=this;try{const{openLegitFs:e}=await import("https://esm.sh/@legit-sdk/core"),i=await import("https://esm.sh/memfs");t.fs=i.default,t.legitFs=await e({storageFs:t.fs,gitRoot:"/",serverUrl:"http://localhost:9999/"}),globalThis.legitFs=t.legitFs,await t.#t()}catch(t){console.error("Failed to initialize Legit Service",t)}}async loadHistory(t="anonymous"){await this.ready();try{const e=await this.legitFs.readFile(`/.legit/branches/${t}/.legit/history`,"utf-8");return JSON.parse(e)}catch(e){return console.warn(`Failed to load history for branch ${t}`,e),[]}}async loadTree(t){await this.ready();const e=this,i={},a=await e.readdir(t);for(const s of a){if((await e.stat(t+s)).isDirectory())i[s]=await e.loadTree(t+s+"/");else{const a=await crypto.subtle.digest("SHA-1",await e.readFile(t+s));i[s]={hash:a,name:s}}}return{hash:"",subEntries:i}}async loadTreeDelta(t,e){await this.ready();const i=this,a=e.slice(0,2),s=e.slice(2);let r={};if(t){const e=t.slice(0,2),a=t.slice(2);r=await i.loadTree("/.legit/commits/"+e+"/"+a+"/")}const n=await i.loadTree("/.legit/commits/"+a+"/"+s+"/"),o=[],l=[],c=[];function d(t,e=""){const i={};if(t.subEntries)for(const[a,s]of Object.entries(t.subEntries)){const t=e?`${e}/${a}`:a;s.subEntries?Object.assign(i,d(s,t)):i[t]=s.hash}return i}const h=""!==t?d(r):{},w=d(n);for(const t in h)t in w||o.push(t);for(const t in w)t in h||l.push(t);for(const t in w)if(t in h){const e=new Uint8Array(h[t]),i=new Uint8Array(w[t]);e.length===i.length&&e.every((t,e)=>t===i[e])||c.push(t)}return{deleted:o,added:l,modified:c}}async readFile(t,e){return await this.ready(),this.legitFs.readFile(t,e)}async readdir(t){return await this.ready(),this.legitFs.readdir(t)}async#t(){const t=this;let e=await fetch("../../learn/benefits/FormsEngine.md");e=await e.text(),await t.writeFile({data:e,path:`${t.path}/FormsEngine.md`,skipReady:!0}),e=await fetch("../../learn/benefits/OffTheMainThread.md"),e=await e.text(),await t.writeFile({data:e,path:`${t.path}/OffTheMainThread.md`,skipReady:!0}),await t.writeFile({data:["import Viewport from '../../examples/component/multiWindowHelix/Viewport.mjs';","","class MainView extends Viewport {","    static config = {","        className           : 'Portal.view.MultiWindowHelix',","        showGitHubStarButton: false,","        theme               : 'neo-theme-dark'","    }","}","","MainView = Neo.setupClass(MainView);"].join("\n"),path:`${t.path}/Helix.mjs`,skipReady:!0}),await t.writeFile({data:["import Viewport from '../../examples/component/multiWindowCoronaGallery/Viewport.mjs';","","class MainView extends Viewport {","    static config = {","        className           : 'Portal.view.MultiWindowHelix',","        showGitHubStarButton: false,","        theme               : 'neo-theme-dark'","    }","}","","MainView = Neo.setupClass(MainView);"].join("\n"),path:`${t.path}/Gallery.mjs`,skipReady:!0})}async stat(t){return await this.ready(),this.legitFs.stat(t)}async writeFile({data:t,options:e,path:i,skipReady:a=!1}){return!a&&await this.ready(),this.legitFs.writeFile(i,t,e)}});