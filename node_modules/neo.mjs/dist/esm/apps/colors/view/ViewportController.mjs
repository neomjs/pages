import e from"../../../src/controller/Component.mjs";export default Neo.setupClass(class extends e{static config={className:"Colors.view.ViewportController"};connectedApps=[];intervalId=null;#e=!1;#t=!1;widgetIndexMap={"bar-chart":2,"pie-chart":1,grid:0};async createBrowserWindow(e){if(this.getStateProvider().getData("openWidgetsAsPopups")){let t=this.getReference(e),a=await this.component.getDomRect(t.vdom.id);await this.#a(e,a)}else{let t,{config:a,windowConfigs:n}=Neo,{environment:o}=a,i=Object.keys(n)[0],{basePath:s}=n[i];"development"!==o&&(s=`${s+o}/`),t=`${s}apps/colors/childapps/widget/index.html?name=${e}`,await Neo.Main.windowOpen({url:t,windowName:"_blank"})}}destroy(...e){this.intervalId&&clearInterval(this.intervalId),super.destroy(...e)}async onAppConnect(e){if("ColorsWidget"===e.appName){let t=this,a=Neo.apps[e.windowId].mainView,{windowId:n}=e,o=await Neo.Main.getByPath({path:"document.URL",windowId:n}),i=new URL(o).searchParams.get("name"),s=t.getReference(i),r=s.up("panel");t.#t||r.hide(),t.connectedApps.push(i),t.getReference(`detach-${i}-button`).disabled=!0,a.add(s,!1,!t.#t)}}async onAppDisconnect(e){let t=this;if(t.#t||t.#e)return void(t.#t=!1);let{appName:a,windowId:n}=e,o=t.getReference("dashboard"),i=await Neo.Main.getByPath({path:"document.URL",windowId:n}),s=new URL(i).searchParams.get("name"),r=t.getReference(s);if("ColorsWidget"===a){let e=o.items[t.widgetIndexMap[s]];e.getReference("bodyContainer").add(r),e.show(),t.getReference(`detach-${s}-button`).disabled=!1}else"Colors"===a&&Neo.Main.windowClose({names:t.connectedApps,windowId:n})}onChangeAmountColors(e){this.updateDataProperty(e,"amountColors",e.value)}onChangeAmountColumns(e){this.updateDataProperty(e,"amountColumns",parseInt(e.value.name))}onChangeAmountRows(e){this.updateDataProperty(e,"amountRows",parseInt(e.value.name))}onChangeOpenWidgetsAsPopups(e){this.setState("openWidgetsAsPopups",e.value)}onConstructed(){super.onConstructed();let e=this;Neo.currentWorker.on({connect:e.onAppConnect,disconnect:e.onAppDisconnect,scope:e})}onComponentConstructed(){super.onComponentConstructed(),this.updateWidgets()}async onDetachBarChartButtonClick(e){await this.createBrowserWindow("bar-chart")}async onDetachGridButtonClick(e){await this.createBrowserWindow("grid")}async onDetachPieChartButtonClick(e){await this.createBrowserWindow("pie-chart")}async onDragBoundaryEntry(e){let t=this,{windowId:a}=t,{sortZone:n}=e,o=e.draggedItem.reference.replace("-panel",""),i=t.getReference(o);t.#e=!0,n.dragProxy.add(i,!0),await Neo.Main.windowClose({names:o,windowId:a}),t.#e=!1,t.#t=!1,n.isWindowDragging=!1,n.dragProxy.style={opacity:1},Neo.main.addon.DragDrop.setConfigs({isWindowDragging:!1,windowId:a})}async onDragBoundaryExit(e){let t,{draggedItem:a,proxyRect:n,sortZone:o}=e,i=a.reference.replace("-panel","");this.#t=!0,n.height+=50,t=await this.#a(i,n),o.startWindowDrag({dragData:e,...t})}async onEnableWindowManagementClick(e){let t=await Neo.main.addon.DragDrop.requestWindowManagementPermission({windowId:this.windowId}),a=this.getReference("window-management-button");t.success?(a.text="W-M enabled",a.iconCls="fa fa-check-square",a.disabled=!0):(a.text="W-M disabled",a.iconCls="fa fa-exclamation-triangle")}onStartButtonClick(e){let t=this,a=1e3/60;t.setState({isUpdating:!0}),t.intervalId||(t.intervalId=setInterval(()=>{t.updateWidgets()},a))}onStopButtonClick(e){let t=this;t.setState({isUpdating:!1}),t.intervalId&&(clearInterval(t.intervalId),t.intervalId=null)}async#a(e,t){let a,{windowId:n}=this,{config:o,windowConfigs:i}=Neo,{environment:s}=o,r=Object.keys(i)[0],{basePath:d}=i[r];"development"!==s&&(d=`${d+s}/`),a=`${d}apps/colors/childapps/widget/index.html?name=${e}`;let g=await Neo.Main.getWindowData({windowId:n}),{height:p,width:c,x:l,y:w}=t,u=p-50,h=l+g.screenLeft,m=w+(g.outerHeight-g.innerHeight+g.screenTop);return await Neo.Main.windowOpen({url:a,windowFeatures:`height=${u},left=${h},top=${m},width=${c}`,windowName:e}),{popupHeight:u,popupLeft:h,popupTop:m,popupWidth:c,windowName:e}}updateCharts(e){this.getReference("bar-chart").chartData=e,this.getReference("pie-chart").chartData=e}updateDataProperty(e,t,a){let n=this.getStateProvider();n.setData(t,a),null===e.oldValue||n.getData("isUpdating")||this.updateWidgets()}updateGrid(e){let t=this.getReference("grid"),{store:a}=t;a.getCount()?t.bulkUpdateRecords(e):this.getStateProvider().getData("amountRows")===e.length&&(a.data=e)}async updateWidgets(){let e,t=this,a=t.getStateProvider();if(Colors.backend){if(e=await Colors.backend.ColorService.read({amountColors:a.getData("amountColors"),amountColumns:a.getData("amountColumns"),amountRows:a.getData("amountRows")}),!t.isDestroyed){let{data:a}=e;t.updateGrid(a.tableData),t.updateCharts(a.summaryData)}}else await t.timeout(50),t.updateWidgets()}});