"use strict";(self.webpackChunkneo_mjs=self.webpackChunkneo_mjs||[]).push([[827],{827(e,t,s){s.d(t,{default:()=>a});var n=s(247),o=s(439);s(691);class c extends n.A{static observable=!0;static config={className:"Neo.data.connection.WebSocket",ntype:"socket-connection",backoffStrategy:e=>Math.min(1e3*Math.pow(2,e-1),3e4),socket_:null};channel=null;maxReconnectAttempts=5;messageCallbacks={};messageId=1;reconnectAttempts=0;serverAddress=null;construct(e){super.construct(e),this.createSocket()}async attemptReconnect(e,t){let s=this;if(s.reconnectAttempts++,s.reconnectAttempts<s.maxReconnectAttempts){const n=s.backoffStrategy(s.reconnectAttempts);s.fire("reconnecting",{attempt:s.reconnectAttempts,maxAttempts:s.maxReconnectAttempts,delay:n}),console.log(`WebSocket reconnect attempt ${s.reconnectAttempts}/${s.maxReconnectAttempts} in ${n}ms`),await s.timeout(n),s.isDestroyed||(s.createSocket(),e&&s.on("open",{callback:e,scope:t||s,single:!0}))}else console.error("Max reconnection attempts reached"),s.fire("reconnect_failed")}beforeSend(e){let{channel:t}=this;return JSON.stringify(t?{channel:t,data:e}:e)}beforeSetSocket(e,t){if(e){let t=this;Object.assign(e,{onclose:t.onClose.bind(t),onerror:t.onError.bind(t),onmessage:t.onMessage.bind(t),onopen:t.onOpen.bind(t)}),(0,o.iI)(e,"send",t.beforeSend,t)}return e}close(e,t){this.socket.close(e,t)}createSocket(){this.socket=new WebSocket(this.serverAddress)}destroy(...e){this.close(),super.destroy(...e)}onClose(e,t,s){this.fire("close",{event:e,reason:t,wasClean:s}),s&&1e3===e.code||(console.warn("WebSocket closed abnormally, attempting reconnect..."),this.attemptReconnect())}onError(e){this.fire("error",{error:e})}onMessage(e){let t=this,s=JSON.parse(e.data);t.fire("message",{data:s}),s.mId&&(t.messageCallbacks[s.mId].resolve(s.data),delete t.messageCallbacks[s.mId])}onOpen(){this.reconnectAttempts=0,this.fire("open",{scope:this})}promiseMessage(e){let t=this;return new Promise((s,n)=>{t.messageCallbacks[t.messageId]={reject:n,resolve:s},t.sendMessage({data:e,mId:t.messageId}),t.messageId++})}sendMessage(e){let t=this,{socket:s}=t,n=e;switch(s.readyState){case WebSocket.CLOSED:case WebSocket.CLOSING:t.attemptReconnect(function(){t.sendMessage(n)});break;case WebSocket.CONNECTING:t.on("open",function(){t.sendMessage(n)},t,{once:!0});break;case WebSocket.OPEN:s.send(e)}}}const a=Neo.setupClass(c)}}]);